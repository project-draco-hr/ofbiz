{
  List errorList=new ArrayList();
  GenericValue shipmentPackageRouteSeg=(GenericValue)shipmentPackageRouteSegs.get(0);
  Document fdxShipReplyDocument=null;
  try {
    fdxShipReplyDocument=UtilXml.readXmlDocument(fDXShipReplyString,false);
  }
 catch (  SAXException se) {
    String errorMessage="Error parsing the FDXShipReply: " + se.toString();
    Debug.logError(se,errorMessage,module);
  }
catch (  ParserConfigurationException pe) {
    String errorMessage="Error parsing the FDXShipReply: " + pe.toString();
    Debug.logError(pe,errorMessage,module);
  }
catch (  IOException ioe) {
    String errorMessage="Error parsing the FDXShipReply: " + ioe.toString();
    Debug.logError(ioe,errorMessage,module);
  }
  if (UtilValidate.isEmpty(fdxShipReplyDocument)) {
    return ServiceUtil.returnError("Error parsing the FDXShipReply.");
  }
  Element rootElement=fdxShipReplyDocument.getDocumentElement();
  handleErrors(rootElement,errorList);
  if (UtilValidate.isNotEmpty(errorList)) {
    return ServiceUtil.returnError(errorList);
  }
  Element trackingElement=UtilXml.firstChildElement(rootElement,"Tracking");
  String trackingNumber=UtilXml.childElementValue(trackingElement,"TrackingNumber");
  Element labelElement=UtilXml.firstChildElement(rootElement,"Labels");
  String encodedImageString=UtilXml.childElementValue(labelElement,"OutboundLabel");
  if (UtilValidate.isEmpty(encodedImageString)) {
    Debug.logError("Cannot find FDXShipReply label. FDXShipReply document is: " + fDXShipReplyString,module);
    return ServiceUtil.returnError("Cannot get FDXShipReply label for shipment package route segment " + shipmentPackageRouteSeg + ".  FedEx response is: "+ fDXShipReplyString);
  }
  byte[] labelBytes=Base64.base64Decode(encodedImageString.getBytes());
  if (labelBytes != null) {
    shipmentPackageRouteSeg.setBytes("labelImage",labelBytes);
  }
 else {
    Debug.log("Failed to either decode returned FedEx label or no data found in Labels/OutboundLabel.");
  }
  shipmentPackageRouteSeg.set("trackingCode",trackingNumber);
  shipmentPackageRouteSeg.set("labelHtml",encodedImageString);
  shipmentPackageRouteSeg.store();
  shipmentRouteSegment.set("trackingIdNumber",trackingNumber);
  shipmentRouteSegment.put("carrierServiceStatusId","SHRSCS_CONFIRMED");
  shipmentRouteSegment.store();
  return ServiceUtil.returnSuccess("FedEx Shipment Confirmed.");
}
