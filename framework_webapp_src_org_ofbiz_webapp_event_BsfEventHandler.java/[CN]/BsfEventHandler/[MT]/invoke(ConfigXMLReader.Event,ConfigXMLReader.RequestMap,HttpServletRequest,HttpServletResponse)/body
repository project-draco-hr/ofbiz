{
  ServletContext context=(ServletContext)request.getAttribute("servletContext");
  ClassLoader cl=Thread.currentThread().getContextClassLoader();
  if (cl == null)   cl=this.getClass().getClassLoader();
  if (context == null) {
    throw new EventHandlerException("Problem getting ServletContext");
  }
  try {
    BSFManager bsfManager=new BSFManager();
    bsfManager.setClassLoader(cl);
    bsfManager.declareBean("request",request,HttpServletRequest.class);
    bsfManager.declareBean("response",response,HttpServletResponse.class);
    String scriptType=BSFManager.getLangFromFilename(event.invoke);
    InputStream scriptStream=null;
    String scriptString=null;
    String cacheName=null;
    if (event.path == null || event.path.length() == 0) {
      cacheName=event.invoke;
      scriptString=eventCache.get(cacheName);
      if (scriptString == null) {
synchronized (eventCache) {
          if (scriptString == null) {
            if (Debug.verboseOn()) {
              Debug.logVerbose("Loading BSF Script at location: " + cacheName,module);
            }
            URL scriptUrl=FlexibleLocation.resolveLocation(cacheName);
            if (scriptUrl == null) {
              throw new EventHandlerException("BSF script not found at location [" + cacheName + "]");
            }
            scriptStream=scriptUrl.openStream();
            scriptString=IOUtils.getStringFromReader(new InputStreamReader(scriptStream));
            scriptStream.close();
            eventCache.put(cacheName,scriptString);
          }
        }
      }
    }
 else {
      cacheName=context.getServletContextName() + ":" + event.path+ event.invoke;
      scriptString=eventCache.get(cacheName);
      if (scriptString == null) {
synchronized (eventCache) {
          if (scriptString == null) {
            scriptStream=context.getResourceAsStream(event.path + event.invoke);
            if (scriptStream == null) {
              throw new EventHandlerException("Could not find BSF script file in webapp context: " + event.path + event.invoke);
            }
            scriptString=IOUtils.getStringFromReader(new InputStreamReader(scriptStream));
            scriptStream.close();
            eventCache.put(cacheName,scriptString);
          }
        }
      }
    }
    Object result=bsfManager.eval(scriptType,cacheName,0,0,scriptString);
    if (result != null && !(result instanceof String)) {
      throw new EventHandlerException("Event did not return a String result, it returned a " + result.getClass().getName());
    }
    return (String)result;
  }
 catch (  BSFException e) {
    throw new EventHandlerException("BSF Error",e);
  }
catch (  IOException e) {
    throw new EventHandlerException("Problems reading script",e);
  }
}
