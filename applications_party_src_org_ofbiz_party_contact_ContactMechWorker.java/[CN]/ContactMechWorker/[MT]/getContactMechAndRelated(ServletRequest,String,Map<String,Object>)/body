{
  Delegator delegator=(Delegator)request.getAttribute("delegator");
  boolean tryEntity=true;
  if (request.getAttribute("_ERROR_MESSAGE_") != null)   tryEntity=false;
  if ("true".equals(request.getParameter("tryEntity")))   tryEntity=true;
  String donePage=request.getParameter("DONE_PAGE");
  if (donePage == null)   donePage=(String)request.getAttribute("DONE_PAGE");
  if (donePage == null || donePage.length() <= 0)   donePage="viewprofile";
  target.put("donePage",donePage);
  String contactMechTypeId=request.getParameter("preContactMechTypeId");
  if (contactMechTypeId == null)   contactMechTypeId=(String)request.getAttribute("preContactMechTypeId");
  if (contactMechTypeId != null)   tryEntity=false;
  String contactMechId=request.getParameter("contactMechId");
  if (request.getAttribute("contactMechId") != null)   contactMechId=(String)request.getAttribute("contactMechId");
  GenericValue contactMech=null;
  if (contactMechId != null) {
    target.put("contactMechId",contactMechId);
    List<GenericValue> partyContactMechs=null;
    try {
      partyContactMechs=EntityUtil.filterByDate(delegator.findByAnd("PartyContactMech",UtilMisc.toMap("partyId",partyId,"contactMechId",contactMechId),null,false),true);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    GenericValue partyContactMech=EntityUtil.getFirst(partyContactMechs);
    if (partyContactMech != null) {
      target.put("partyContactMech",partyContactMech);
      Collection<GenericValue> partyContactMechPurposes=null;
      try {
        partyContactMechPurposes=EntityUtil.filterByDate(partyContactMech.getRelated("PartyContactMechPurpose"),true);
      }
 catch (      GenericEntityException e) {
        Debug.logWarning(e,module);
      }
      if (UtilValidate.isNotEmpty(partyContactMechPurposes))       target.put("partyContactMechPurposes",partyContactMechPurposes);
    }
    try {
      contactMech=delegator.findOne("ContactMech",UtilMisc.toMap("contactMechId",contactMechId),false);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    if (contactMech != null) {
      target.put("contactMech",contactMech);
      contactMechTypeId=contactMech.getString("contactMechTypeId");
    }
  }
  if (contactMechTypeId != null) {
    target.put("contactMechTypeId",contactMechTypeId);
    try {
      GenericValue contactMechType=delegator.findOne("ContactMechType",UtilMisc.toMap("contactMechTypeId",contactMechTypeId),false);
      if (contactMechType != null)       target.put("contactMechType",contactMechType);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    Collection<GenericValue> purposeTypes=FastList.newInstance();
    Iterator<GenericValue> typePurposes=null;
    try {
      typePurposes=UtilMisc.toIterator(delegator.findByAnd("ContactMechTypePurpose",UtilMisc.toMap("contactMechTypeId",contactMechTypeId),null,false));
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    while (typePurposes != null && typePurposes.hasNext()) {
      GenericValue contactMechTypePurpose=typePurposes.next();
      GenericValue contactMechPurposeType=null;
      try {
        contactMechPurposeType=contactMechTypePurpose.getRelatedOne("ContactMechPurposeType",false);
      }
 catch (      GenericEntityException e) {
        Debug.logWarning(e,module);
      }
      if (contactMechPurposeType != null) {
        purposeTypes.add(contactMechPurposeType);
      }
    }
    if (purposeTypes.size() > 0)     target.put("purposeTypes",purposeTypes);
  }
  String requestName;
  if (contactMech == null) {
    if ("POSTAL_ADDRESS".equals(contactMechTypeId)) {
      if (request.getParameter("contactMechPurposeTypeId") != null || request.getAttribute("contactMechPurposeTypeId") != null) {
        requestName="createPostalAddressAndPurpose";
      }
 else {
        requestName="createPostalAddress";
      }
    }
 else     if ("TELECOM_NUMBER".equals(contactMechTypeId)) {
      requestName="createTelecomNumber";
    }
 else     if ("EMAIL_ADDRESS".equals(contactMechTypeId)) {
      requestName="createEmailAddress";
    }
 else {
      requestName="createContactMech";
    }
  }
 else {
    if ("POSTAL_ADDRESS".equals(contactMechTypeId)) {
      requestName="updatePostalAddress";
    }
 else     if ("TELECOM_NUMBER".equals(contactMechTypeId)) {
      requestName="updateTelecomNumber";
    }
 else     if ("EMAIL_ADDRESS".equals(contactMechTypeId)) {
      requestName="updateEmailAddress";
    }
 else {
      requestName="updateContactMech";
    }
  }
  target.put("requestName",requestName);
  if ("POSTAL_ADDRESS".equals(contactMechTypeId)) {
    GenericValue postalAddress=null;
    try {
      if (contactMech != null)       postalAddress=contactMech.getRelatedOne("PostalAddress",false);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    if (postalAddress != null)     target.put("postalAddress",postalAddress);
  }
 else   if ("TELECOM_NUMBER".equals(contactMechTypeId)) {
    GenericValue telecomNumber=null;
    try {
      if (contactMech != null)       telecomNumber=contactMech.getRelatedOne("TelecomNumber",false);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    if (telecomNumber != null)     target.put("telecomNumber",telecomNumber);
  }
  if ("true".equals(request.getParameter("useValues")))   tryEntity=true;
  target.put("tryEntity",Boolean.valueOf(tryEntity));
  try {
    Collection<GenericValue> contactMechTypes=delegator.findList("ContactMechType",null,null,null,null,true);
    if (contactMechTypes != null) {
      target.put("contactMechTypes",contactMechTypes);
    }
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e,module);
  }
}
