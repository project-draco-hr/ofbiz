{
  ServletRequest request=pageContext.getRequest();
  GenericDelegator delegator=(GenericDelegator)pageContext.getRequest().getAttribute("delegator");
  boolean tryEntity=true;
  if (request.getAttribute("_ERROR_MESSAGE_") != null)   tryEntity=false;
  if ("true".equals(request.getParameter("tryEntity")))   tryEntity=true;
  String donePage=request.getParameter("DONE_PAGE");
  if (donePage == null)   donePage=(String)request.getAttribute("DONE_PAGE");
  if (donePage == null || donePage.length() <= 0)   donePage="viewprofile";
  pageContext.setAttribute(donePageAttr,donePage);
  String contactMechTypeId=request.getParameter("preContactMechTypeId");
  if (contactMechTypeId == null)   contactMechTypeId=(String)request.getAttribute("preContactMechTypeId");
  if (contactMechTypeId != null)   tryEntity=false;
  String contactMechId=request.getParameter("contactMechId");
  if (request.getAttribute("contactMechId") != null)   contactMechId=(String)request.getAttribute("contactMechId");
  GenericValue contactMech=null;
  if (contactMechId != null) {
    pageContext.setAttribute(contactMechIdAttr,contactMechId);
    List partyContactMechs=null;
    try {
      partyContactMechs=EntityUtil.filterByDate(delegator.findByAnd("PartyContactMech",UtilMisc.toMap("partyId",partyId,"contactMechId",contactMechId)),true);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    GenericValue partyContactMech=EntityUtil.getFirst(partyContactMechs);
    if (partyContactMech != null) {
      pageContext.setAttribute(partyContactMechAttr,partyContactMech);
      Collection partyContactMechPurposes=null;
      try {
        partyContactMechPurposes=EntityUtil.filterByDate(partyContactMech.getRelated("PartyContactMechPurpose"),true);
      }
 catch (      GenericEntityException e) {
        Debug.logWarning(e,module);
      }
      if (partyContactMechPurposes != null && partyContactMechPurposes.size() > 0)       pageContext.setAttribute(partyContactMechPurposesAttr,partyContactMechPurposes);
    }
    try {
      contactMech=delegator.findByPrimaryKey("ContactMech",UtilMisc.toMap("contactMechId",contactMechId));
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    if (contactMech != null) {
      pageContext.setAttribute(contactMechAttr,contactMech);
      contactMechTypeId=contactMech.getString("contactMechTypeId");
    }
  }
  if (contactMechTypeId != null) {
    pageContext.setAttribute(contactMechTypeIdAttr,contactMechTypeId);
    try {
      GenericValue contactMechType=delegator.findByPrimaryKey("ContactMechType",UtilMisc.toMap("contactMechTypeId",contactMechTypeId));
      if (contactMechType != null)       pageContext.setAttribute(contactMechTypeAttr,contactMechType);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    Collection purposeTypes=new LinkedList();
    Iterator typePurposes=null;
    try {
      typePurposes=UtilMisc.toIterator(delegator.findByAnd("ContactMechTypePurpose",UtilMisc.toMap("contactMechTypeId",contactMechTypeId)));
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    while (typePurposes != null && typePurposes.hasNext()) {
      GenericValue contactMechTypePurpose=(GenericValue)typePurposes.next();
      GenericValue contactMechPurposeType=null;
      try {
        contactMechPurposeType=contactMechTypePurpose.getRelatedOne("ContactMechPurposeType");
      }
 catch (      GenericEntityException e) {
        Debug.logWarning(e,module);
      }
      if (contactMechPurposeType != null) {
        purposeTypes.add(contactMechPurposeType);
      }
    }
    if (purposeTypes.size() > 0)     pageContext.setAttribute(purposeTypesAttr,purposeTypes);
  }
  String requestName;
  if (contactMech == null) {
    if ("POSTAL_ADDRESS".equals(contactMechTypeId)) {
      if (request.getParameter("contactMechPurposeTypeId") != null || request.getAttribute("contactMechPurposeTypeId") != null) {
        requestName="createPostalAddressAndPurpose";
      }
 else {
        requestName="createPostalAddress";
      }
    }
 else     if ("TELECOM_NUMBER".equals(contactMechTypeId)) {
      requestName="createTelecomNumber";
    }
 else     if ("EMAIL_ADDRESS".equals(contactMechTypeId)) {
      requestName="createEmailAddress";
    }
 else {
      requestName="createContactMech";
    }
  }
 else {
    if ("POSTAL_ADDRESS".equals(contactMechTypeId)) {
      requestName="updatePostalAddress";
    }
 else     if ("TELECOM_NUMBER".equals(contactMechTypeId)) {
      requestName="updateTelecomNumber";
    }
 else     if ("EMAIL_ADDRESS".equals(contactMechTypeId)) {
      requestName="updateEmailAddress";
    }
 else {
      requestName="updateContactMech";
    }
  }
  pageContext.setAttribute(requestNameAttr,requestName);
  if ("POSTAL_ADDRESS".equals(contactMechTypeId)) {
    GenericValue postalAddress=null;
    try {
      if (contactMech != null)       postalAddress=contactMech.getRelatedOne("PostalAddress");
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    if (postalAddress != null)     pageContext.setAttribute(postalAddressAttr,postalAddress);
  }
 else   if ("TELECOM_NUMBER".equals(contactMechTypeId)) {
    GenericValue telecomNumber=null;
    try {
      if (contactMech != null)       telecomNumber=contactMech.getRelatedOne("TelecomNumber");
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,module);
    }
    if (telecomNumber != null)     pageContext.setAttribute(telecomNumberAttr,telecomNumber);
  }
  if ("true".equals(request.getParameter("useValues")))   tryEntity=true;
  pageContext.setAttribute(tryEntityAttr,new Boolean(tryEntity));
  try {
    Collection contactMechTypes=delegator.findAllCache("ContactMechType",null);
    if (contactMechTypes != null) {
      pageContext.setAttribute(contactMechTypesAttr,contactMechTypes);
    }
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e,module);
  }
}
