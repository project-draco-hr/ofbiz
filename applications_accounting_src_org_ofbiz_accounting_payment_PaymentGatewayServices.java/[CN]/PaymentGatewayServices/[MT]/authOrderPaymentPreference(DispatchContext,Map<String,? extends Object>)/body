{
  GenericDelegator delegator=dctx.getDelegator();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  String orderPaymentPreferenceId=(String)context.get("orderPaymentPreferenceId");
  BigDecimal overrideAmount=(BigDecimal)context.get("overrideAmount");
  if (overrideAmount != null) {
    if (overrideAmount.compareTo(BigDecimal.ZERO) < 0)     return ServiceUtil.returnError("Amount entered (" + overrideAmount + ") is negative.");
    if (overrideAmount.compareTo(BigDecimal.ZERO) == 0)     return ServiceUtil.returnError("Amount entered (" + overrideAmount + ") is zero.");
  }
  GenericValue orderHeader=null;
  GenericValue orderPaymentPreference=null;
  try {
    orderPaymentPreference=delegator.findByPrimaryKey("OrderPaymentPreference",UtilMisc.toMap("orderPaymentPreferenceId",orderPaymentPreferenceId));
    orderHeader=orderPaymentPreference.getRelatedOne("OrderHeader");
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError("Problems getting required information: orderPaymentPreference [" + orderPaymentPreferenceId + "]");
  }
  OrderReadHelper orh=new OrderReadHelper(orderHeader);
  BigDecimal totalRemaining=orh.getOrderGrandTotal();
  Long procAttempt=orderPaymentPreference.getLong("processAttempt");
  if (procAttempt == null) {
    procAttempt=new Long(0);
  }
  orderPaymentPreference.set("processAttempt",new Long(procAttempt.longValue() + 1));
  try {
    orderPaymentPreference.store();
    orderPaymentPreference.refresh();
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError("Unable to update OrderPaymentPreference record!");
  }
  boolean reAuth=false;
  if (orderPaymentPreference.get("statusId") != null && "PAYMENT_AUTHORIZED".equals(orderPaymentPreference.getString("statusId"))) {
    reAuth=true;
  }
  BigDecimal transAmount=null;
  if (overrideAmount != null) {
    transAmount=overrideAmount;
  }
 else {
    transAmount=orderPaymentPreference.getBigDecimal("maxAmount");
  }
  transAmount=transAmount.setScale(decimals,rounding);
  if ((transAmount != null) && (transAmount.compareTo(BigDecimal.ZERO) <= 0)) {
    Map<String,Object> results=ServiceUtil.returnSuccess();
    results.put("finished",Boolean.TRUE);
    results.put("errors",Boolean.FALSE);
    return results;
  }
  try {
    Map<String,Object> authPaymentResult=authPayment(dispatcher,userLogin,orh,orderPaymentPreference,totalRemaining,reAuth,transAmount);
    if (authPaymentResult != null) {
      BigDecimal thisAmount=(BigDecimal)authPaymentResult.get("processAmount");
      try {
        boolean processResult=processResult(dctx,authPaymentResult,userLogin,orderPaymentPreference);
        if (processResult) {
          Map<String,Object> results=ServiceUtil.returnSuccess();
          results.put("messages",authPaymentResult.get("customerRespMsgs"));
          results.put("processAmount",thisAmount);
          results.put("finished",Boolean.TRUE);
          results.put("errors",Boolean.FALSE);
          return results;
        }
 else {
          boolean needsNsfRetry=needsNsfRetry(orderPaymentPreference,authPaymentResult,delegator);
          if (needsNsfRetry) {
          }
          if (!needsNsfRetry) {
            if (UtilValidate.isNotEmpty(orderHeader.getString("autoOrderShoppingListId"))) {
              GenericValue productStore=orderHeader.getRelatedOne("ProductStore");
              if ("Y".equals(productStore.getString("autoOrderCcTryOtherCards"))) {
                List otherPaymentMethodAndCreditCardList=null;
                String billToPartyId=null;
                GenericValue billToParty=orh.getBillToParty();
                if (billToParty != null) {
                  billToPartyId=billToParty.getString("partyId");
                }
 else {
                }
                if (UtilValidate.isNotEmpty(billToPartyId)) {
                  otherPaymentMethodAndCreditCardList=delegator.findByAnd("PaymentMethodAndCreditCard",UtilMisc.toMap("partyId",billToPartyId,"paymentMethodTypeId","CREDIT_CARD"));
                  otherPaymentMethodAndCreditCardList=EntityUtil.filterByDate(otherPaymentMethodAndCreditCardList,true);
                }
                if (UtilValidate.isNotEmpty(otherPaymentMethodAndCreditCardList)) {
                  Iterator otherPaymentMethodAndCreditCardIter=otherPaymentMethodAndCreditCardList.iterator();
                  while (otherPaymentMethodAndCreditCardIter.hasNext()) {
                    GenericValue otherPaymentMethodAndCreditCard=(GenericValue)otherPaymentMethodAndCreditCardIter.next();
                    orderPaymentPreference.set("paymentMethodId",otherPaymentMethodAndCreditCard.getString("paymentMethodId"));
                    Map<String,Object> authRetryResult=authPayment(dispatcher,userLogin,orh,orderPaymentPreference,totalRemaining,reAuth,transAmount);
                    try {
                      boolean processRetryResult=processResult(dctx,authPaymentResult,userLogin,orderPaymentPreference);
                      if (processRetryResult) {
                        orderPaymentPreference.store();
                        Map<String,Object> results=ServiceUtil.returnSuccess();
                        results.put("messages",authRetryResult.get("customerRespMsgs"));
                        results.put("processAmount",thisAmount);
                        results.put("finished",Boolean.TRUE);
                        results.put("errors",Boolean.FALSE);
                        return results;
                      }
                    }
 catch (                    GeneralException e) {
                      String errMsg="Error saving and processing payment authorization results: " + e.toString();
                      Debug.logError(e,errMsg + "; authRetryResult: " + authRetryResult,module);
                      Map<String,Object> results=ServiceUtil.returnSuccess();
                      results.put(ModelService.ERROR_MESSAGE,errMsg);
                      results.put("finished",Boolean.FALSE);
                      results.put("errors",Boolean.TRUE);
                      return results;
                    }
                  }
                }
              }
            }
          }
          Map<String,Object> results=ServiceUtil.returnSuccess();
          results.put("messages",authPaymentResult.get("customerRespMsgs"));
          results.put("finished",Boolean.FALSE);
          results.put("errors",Boolean.FALSE);
          return results;
        }
      }
 catch (      GeneralException e) {
        String errMsg="Error saving and processing payment authorization results: " + e.toString();
        Debug.logError(e,errMsg + "; authPaymentResult: " + authPaymentResult,module);
        Map<String,Object> results=ServiceUtil.returnSuccess();
        results.put(ModelService.ERROR_MESSAGE,errMsg);
        results.put("finished",Boolean.FALSE);
        results.put("errors",Boolean.TRUE);
        return results;
      }
    }
 else {
      String errMsg="Invalid Order Payment Preference: maxAmount is 0";
      Debug.logInfo(errMsg,module);
      Map<String,Object> results=ServiceUtil.returnSuccess();
      results.put("finished",Boolean.FALSE);
      results.put("errors",Boolean.TRUE);
      results.put(ModelService.ERROR_MESSAGE,errMsg);
      orderPaymentPreference.set("statusId","PAYMENT_CANCELLED");
      try {
        orderPaymentPreference.store();
      }
 catch (      GenericEntityException e) {
        Debug.logError(e,"ERROR: Problem setting OrderPaymentPreference status to CANCELLED",module);
      }
      return results;
    }
  }
 catch (  GeneralException e) {
    String errMsg="Error processing payment authorization: " + e.toString();
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
}
