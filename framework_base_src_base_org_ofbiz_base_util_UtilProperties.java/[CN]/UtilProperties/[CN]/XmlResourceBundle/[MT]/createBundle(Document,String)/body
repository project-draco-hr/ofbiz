{
  Map<String,Object> propertyMap=null;
  Element resourceElement=doc.getDocumentElement();
  List propertyList=UtilXml.childElementList(resourceElement,"property");
  if (propertyList == null) {
    throw new Exception("XML properties file invalid or empty");
  }
  int pos=0;
  while (pos != -1) {
    for (Iterator p=propertyList.iterator(); p.hasNext(); ) {
      Element property=(Element)p.next();
      Element value=UtilXml.firstChildElement(property,"value","xml:lang",localeString);
      if (value != null) {
        if (propertyMap == null) {
          propertyMap=FastMap.newInstance();
        }
        propertyMap.put(property.getAttribute("key"),UtilXml.elementValue(value));
      }
    }
    if (propertyMap != null) {
      return new XmlResourceBundle(propertyMap,localeString,null);
    }
    pos=localeString.lastIndexOf("_",localeString.length());
    if (pos != -1) {
      localeString=localeString.substring(0,pos);
    }
  }
  return null;
}
