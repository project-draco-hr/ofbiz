{
  GenericValue visit=getVisit(session);
  if (visit != null) {
    visit.set("initialLocale",initialLocale);
    if (initialRequest != null)     visit.set("initialRequest",initialRequest.length() > 250 ? initialRequest.substring(0,250) : initialRequest);
    if (initialReferrer != null)     visit.set("initialReferrer",initialReferrer.length() > 250 ? initialReferrer.substring(0,250) : initialReferrer);
    if (initialUserAgent != null)     visit.set("initialUserAgent",initialUserAgent.length() > 250 ? initialUserAgent.substring(0,250) : initialUserAgent);
    visit.set("webappName",webappName);
    if (UtilProperties.propertyValueEquals("serverstats","stats.proxy.enabled","true")) {
      visit.set("clientIpAddress",request.getHeader("X-Forwarded-For"));
    }
 else {
      visit.set("clientIpAddress",request.getRemoteAddr());
    }
    visit.set("clientHostName",request.getRemoteHost());
    visit.set("clientUser",request.getRemoteUser());
    try {
      visit.store();
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,"Could not update visit:",module);
    }
  }
}
