{
  if (!UtilProperties.propertyValueEqualsIgnoreCase("serverstats","stats.persist.visit","false")) {
    GenericValue visit=(GenericValue)session.getAttribute("visit");
    if (visit == null) {
      GenericDelegator delegator=null;
      String delegatorName=(String)session.getAttribute("delegatorName");
      if (UtilValidate.isNotEmpty(delegatorName)) {
        delegator=GenericDelegator.getGenericDelegator(delegatorName);
      }
      if (delegator == null) {
        Debug.logError("Could not find delegator with delegatorName [" + delegatorName + "] in session, not creating Visit entity",module);
      }
 else {
        visit=delegator.makeValue("Visit",null);
        visit.set("visitId",delegator.getNextSeqId("Visit"));
        visit.set("sessionId",session.getId());
        visit.set("fromDate",new Timestamp(session.getCreationTime()));
        GenericValue visitor=(GenericValue)session.getAttribute("visitor");
        if (visitor != null) {
          visit.set("visitorId",visitor.get("visitorId"));
        }
        try {
          InetAddress address=InetAddress.getLocalHost();
          if (address != null) {
            visit.set("serverIpAddress",address.getHostAddress());
            visit.set("serverHostName",address.getHostName());
          }
 else {
            Debug.logError("Unable to get localhost internet address, was null",module);
          }
        }
 catch (        java.net.UnknownHostException e) {
          Debug.logError("Unable to get localhost internet address: " + e.toString(),module);
        }
        try {
          visit.create();
          session.setAttribute("visit",visit);
        }
 catch (        GenericEntityException e) {
          Debug.logError(e,"Could not create new visit:",module);
          visit=null;
        }
      }
    }
    if (visit == null) {
      Debug.logWarning("Could not find or create the visit...",module);
    }
    return visit;
  }
 else {
    return null;
  }
}
