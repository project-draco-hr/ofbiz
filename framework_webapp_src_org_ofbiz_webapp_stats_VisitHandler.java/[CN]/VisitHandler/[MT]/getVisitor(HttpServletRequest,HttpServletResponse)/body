{
  if (!UtilProperties.propertyValueEqualsIgnoreCase("serverstats","stats.persist.visitor","false")) {
    HttpSession session=request.getSession();
    GenericValue visitor=(GenericValue)session.getAttribute("visitor");
    if (visitor == null) {
      GenericDelegator delegator=null;
      String delegatorName=(String)session.getAttribute("delegatorName");
      if (UtilValidate.isNotEmpty(delegatorName)) {
        delegator=GenericDelegator.getGenericDelegator(delegatorName);
      }
      if (delegator == null) {
        Debug.logError("Could not find delegator with delegatorName [" + delegatorName + "] in session, not creating/getting Visitor entity",module);
      }
 else {
        String visitorId=null;
        Cookie[] cookies=request.getCookies();
        if (Debug.verboseOn())         Debug.logVerbose("Cookies:" + cookies,module);
        if (cookies != null) {
          for (int i=0; i < cookies.length; i++) {
            if (cookies[i].getName().equals(visitorCookieName)) {
              visitorId=cookies[i].getValue();
              break;
            }
          }
        }
        if (visitorId == null) {
          visitorId=delegator.getNextSeqId("Visitor");
          visitor=delegator.makeValue("Visitor",null);
          visitor.set("visitorId",visitorId);
          try {
            visitor.create();
          }
 catch (          GenericEntityException e) {
            Debug.logError(e,"Could not create new visitor:",module);
            visitor=null;
          }
        }
 else {
          try {
            visitor=delegator.findByPrimaryKey("Visitor",UtilMisc.toMap("visitorId",visitorId));
          }
 catch (          GenericEntityException e) {
            Debug.logError(e,"Could not find visitor with ID from cookie: " + visitorId,module);
            visitor=null;
          }
        }
      }
      if (visitor != null) {
        session.setAttribute("visitor",visitor);
        Cookie visitorCookie=new Cookie(visitorCookieName,visitor.getString("visitorId"));
        visitorCookie.setMaxAge(60 * 60 * 24* 365);
        visitorCookie.setPath("/");
        response.addCookie(visitorCookie);
      }
    }
    if (visitor == null) {
      Debug.logWarning("Could not find or create the visitor...",module);
    }
    return visitor;
  }
 else {
    return null;
  }
}
