{
  Map results=new HashMap();
  GenericValue content=null;
  if (view == null) {
    if (contentId == null) {
      throw new GeneralException("ContentId is null");
    }
    try {
      List lst=delegator.findByAndCache("SubContentDataResourceView",UtilMisc.toMap("contentId",contentId),null);
      if (lst != null && lst.size() > 0) {
        view=(GenericValue)lst.get(0);
      }
 else {
        throw new GeneralException("SubContentDataResourceView not found in renderSubContentAsText" + " for contentId=" + contentId);
      }
    }
 catch (    GenericEntityException e) {
      throw new GeneralException(e.getMessage());
    }
  }
  if (view != null) {
    Map contentMap=new HashMap();
    try {
      SimpleMapProcessor.runSimpleMapProcessor("org/ofbiz/content/ContentManagementMapProcessors.xml","contentIn",view,contentMap,new ArrayList(),locale);
    }
 catch (    MiniLangException e) {
      throw new IOException(e.getMessage());
    }
    content=delegator.makeValue("Content",contentMap);
  }
  results.put("view",view);
  results.put("content",content);
  if (view.get("contentTypeId").equals("WEB_SITE_PUB_PT") && view.get("dataResourceId") == null) {
    List relContentIds=delegator.findByAnd("ContentAssocDataResourceViewTo",UtilMisc.toMap("contentIdStart",view.get("contentId"),"statusId","CTNT_PUBLISHED","caContentAssocTypeId","PUBLISH_LINK"),UtilMisc.toList("caFromDate"));
    relContentIds=EntityUtil.filterByDate(relContentIds,UtilDateTime.nowTimestamp(),"caFromDate","caThruDate",true);
    if (relContentIds != null && relContentIds.size() > 0) {
      view=(GenericValue)relContentIds.get(0);
    }
 else {
      throw new GeneralException("No related content found for publish point contentId=" + contentId);
    }
  }
  if (locale != null) {
    String targetLocaleString=locale.toString();
    String thisLocaleString=(String)view.get("localeString");
    thisLocaleString=(thisLocaleString != null) ? thisLocaleString : "";
    if (UtilValidate.isNotEmpty(targetLocaleString) && !targetLocaleString.equalsIgnoreCase(thisLocaleString)) {
      GenericValue localeView=findAlternateLocaleContent(delegator,view,locale);
      if (localeView != null)       view=localeView;
    }
  }
  String templateDataResourceId=(String)view.get("templateDataResourceId");
  String dataResourceId=null;
  try {
    dataResourceId=(String)view.get("drDataResourceId");
  }
 catch (  Exception e) {
    dataResourceId=(String)view.get("dataResourceId");
    view=null;
  }
  if (templateContext == null) {
    templateContext=new HashMap();
  }
  if (UtilValidate.isEmpty(templateDataResourceId)) {
    if (UtilValidate.isNotEmpty(dataResourceId) || view != null)     DataResourceWorker.renderDataResourceAsTextCache(delegator,dataResourceId,out,templateContext,view,locale,mimeTypeId);
  }
 else {
    if (UtilValidate.isNotEmpty(dataResourceId) || view != null) {
      StringWriter sw=new StringWriter();
      DataResourceWorker.renderDataResourceAsTextCache(delegator,dataResourceId,sw,templateContext,view,locale,mimeTypeId);
      String s=sw.toString();
      if (UtilValidate.isNotEmpty(s))       s=s.trim();
      if (Debug.infoOn())       Debug.logInfo("renderContentAsTextCache, dataResourceId(2):" + dataResourceId,"");
      String reqdType=null;
      try {
        reqdType=DataResourceWorker.getDataResourceMimeType(delegator,dataResourceId,view);
      }
 catch (      GenericEntityException e) {
        throw new GeneralException(e.getMessage());
      }
      if (Debug.infoOn())       Debug.logInfo("renderContentAsTextCache, reqdType(2):" + reqdType,"");
      if (UtilValidate.isNotEmpty(reqdType)) {
        if (reqdType.toLowerCase().indexOf("xml") >= 0) {
          StringReader sr=new StringReader(s);
          try {
            NodeModel nodeModel=NodeModel.parse(new InputSource(sr));
            if (Debug.infoOn())             Debug.logInfo("renderTextAsStringCache, doc:" + nodeModel,"");
            templateContext.put("doc",nodeModel);
          }
 catch (          SAXException e) {
            throw new GeneralException(e.getMessage());
          }
catch (          ParserConfigurationException e2) {
            throw new GeneralException(e2.getMessage());
          }
        }
 else {
          templateContext.put("textData",sw.toString());
        }
      }
 else {
        templateContext.put("textData",sw.toString());
      }
    }
    DataResourceWorker.renderDataResourceAsTextCache(delegator,templateDataResourceId,out,templateContext,null,locale,mimeTypeId);
  }
  return results;
}
