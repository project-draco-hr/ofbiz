{
  Locale birtLocale=(Locale)context.get(BIRT_LOCALE);
  String birtImageDirectory=(String)context.get(BIRT_IMAGE_DIRECTORY);
  if (contentType == null) {
    contentType="text/html";
  }
  if (birtImageDirectory == null) {
    birtImageDirectory="/";
  }
  Debug.logInfo("Get report engine",module);
  IReportEngine engine=BirtContainer.getReportEngine();
  IRunAndRenderTask task=engine.createRunAndRenderTask(design);
  if (birtLocale != null) {
    Debug.logInfo("Set birt locale:" + birtLocale,module);
    task.setLocale(birtLocale);
  }
  Map<String,Object> parameters=UtilGenerics.cast(context.get(BirtWorker.BIRT_PARAMETERS));
  if (parameters != null) {
    Debug.logInfo("Set birt parameters:" + parameters,module);
    task.setParameterValues(parameters);
  }
  RenderOption options=new RenderOption();
  if ("text/html".equalsIgnoreCase(contentType)) {
    options.setOutputFormat(RenderOption.OUTPUT_FORMAT_HTML);
  }
 else   if ("application/pdf".equalsIgnoreCase(contentType)) {
    options.setOutputFormat(RenderOption.OUTPUT_FORMAT_PDF);
  }
 else   if ("application/vnd.ms-word".equalsIgnoreCase(contentType)) {
    options.setOutputFormat("doc");
  }
 else   if ("application/vnd.ms-excel".equalsIgnoreCase(contentType)) {
    options.setOutputFormat("xls");
  }
 else   if ("application/vnd.ms-powerpoint".equalsIgnoreCase(contentType)) {
    options.setOutputFormat("ppt");
  }
 else {
    throw new GeneralException("Unknown content type : " + contentType);
  }
  if (options.getOutputFormat().equalsIgnoreCase(RenderOption.OUTPUT_FORMAT_HTML)) {
    HTMLRenderOption htmlOptions=new HTMLRenderOption(options);
    htmlOptions.setImageDirectory(birtImageDirectory);
    htmlOptions.setBaseImageURL(birtImageDirectory);
    options.setImageHandler(imageHandler);
  }
 else   if (options.getOutputFormat().equalsIgnoreCase(RenderOption.OUTPUT_FORMAT_PDF)) {
    PDFRenderOption pdfOptions=new PDFRenderOption(options);
    pdfOptions.setOption(IPDFRenderOption.PAGE_OVERFLOW,Boolean.TRUE);
  }
 else   if (options.getOutputFormat().equalsIgnoreCase("xls")) {
    new EXCELRenderOption(options);
  }
  options.setOutputStream(output);
  task.setRenderOption(options);
  Debug.logInfo("Birt's locale is: " + task.getLocale(),module);
  Debug.logInfo("Run report's task",module);
  task.run();
  task.close();
}
