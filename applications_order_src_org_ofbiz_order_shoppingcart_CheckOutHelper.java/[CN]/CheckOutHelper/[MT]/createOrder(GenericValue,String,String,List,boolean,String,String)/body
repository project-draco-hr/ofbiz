{
  if (this.cart == null) {
    return null;
  }
  String orderId=this.cart.getOrderId();
  this.cart.clearAllItemStatus();
  String currencyFormat=UtilProperties.getPropertyValue("general.properties","currency.decimal.format","##0.00");
  DecimalFormat formatter=new DecimalFormat(currencyFormat);
  double cartTotal=this.cart.getGrandTotal();
  String grandTotalString=formatter.format(cartTotal);
  Double grandTotal=null;
  try {
    grandTotal=new Double(formatter.parse(grandTotalString).doubleValue());
  }
 catch (  ParseException e) {
    Debug.logError(e,"Problem getting parsed currency amount from DecimalFormat",module);
    String errMsg=UtilProperties.getMessage(resource,"checkhelper.could_not_create_order_parsing_totals",(cart != null ? cart.getLocale() : Locale.getDefault()));
    return ServiceUtil.returnError(errMsg);
  }
  Map context=this.cart.makeCartMap(this.dispatcher,areOrderItemsExploded);
  context.put("trackingCodeOrders",trackingCodeOrders);
  if (distributorId != null)   context.put("distributorId",distributorId);
  if (affiliateId != null)   context.put("affiliateId",affiliateId);
  String partyId=this.cart.getPartyId();
  String facilityId=this.cart.getFacilityId();
  String terminalId=this.cart.getTerminalId();
  String transactionId=cart.getTransactionId();
  String productStoreId=cart.getProductStoreId();
  context.put("grandTotal",grandTotal);
  context.put("userLogin",userLogin);
  context.put("partyId",partyId);
  context.put("productStoreId",productStoreId);
  context.put("transactionId",transactionId);
  context.put("originFacilityId",facilityId);
  context.put("visitId",visitId);
  context.put("terminalId",terminalId);
  context.put("webSiteId",webSiteId);
  Map storeResult=null;
  try {
    storeResult=dispatcher.runSync("storeOrder",context);
    orderId=(String)storeResult.get("orderId");
    if (orderId != null && orderId.length() > 0) {
      this.cart.setOrderId(orderId);
      if (this.cart.getFirstAttemptOrderId() == null) {
        this.cart.setFirstAttemptOrderId(orderId);
      }
    }
  }
 catch (  GenericServiceException e) {
    String service=e.getMessage();
    Map messageMap=UtilMisc.toMap("service",service);
    String errMsg=UtilProperties.getMessage(resource,"checkhelper.could_not_create_order_invoking_service",messageMap,(cart != null ? cart.getLocale() : Locale.getDefault()));
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
  if (ServiceUtil.isError(storeResult)) {
    String errMsg=UtilProperties.getMessage(resource,"checkhelper.did_not_complete_order_following_occurred",(cart != null ? cart.getLocale() : Locale.getDefault()));
    List resErrorMessages=new LinkedList();
    resErrorMessages.add(errMsg);
    resErrorMessages.add(ServiceUtil.getErrorMessage(storeResult));
    return ServiceUtil.returnError(resErrorMessages);
  }
  Iterator orderItems=((List)context.get("orderItems")).iterator();
  int counter=0;
  while (orderItems.hasNext()) {
    GenericValue orderItem=(GenericValue)orderItems.next();
    String productId=orderItem.getString("productId");
    if (productId != null) {
      try {
        GenericValue permUserLogin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","system"));
        GenericValue productStore=ProductStoreWorker.getProductStore(productStoreId,delegator);
        GenericValue product=delegator.findByPrimaryKey("Product",UtilMisc.toMap("productId",productId));
        if ("AGGREGATED".equals(product.getString("productTypeId"))) {
          org.ofbiz.product.config.ProductConfigWrapper config=this.cart.findCartItem(counter).getConfigWrapper();
          Map inputMap=new HashMap();
          inputMap.put("config",config);
          inputMap.put("facilityId",productStore.getString("inventoryFacilityId"));
          inputMap.put("orderId",orderId);
          inputMap.put("orderItemSeqId",orderItem.getString("orderItemSeqId"));
          inputMap.put("quantity",orderItem.getDouble("quantity"));
          inputMap.put("userLogin",permUserLogin);
          Map prunResult=dispatcher.runSync("createProductionRunFromConfiguration",inputMap);
          if (ServiceUtil.isError(prunResult)) {
            Debug.logError(ServiceUtil.getErrorMessage(prunResult) + " for input:" + inputMap,module);
          }
        }
 else         if ("MARKETING_PKG_AUTO".equals(product.getString("productTypeId"))) {
          Map inputMap=new HashMap();
          inputMap.put("facilityId",productStore.getString("inventoryFacilityId"));
          inputMap.put("orderId",orderId);
          inputMap.put("orderItemSeqId",orderItem.getString("orderItemSeqId"));
          inputMap.put("userLogin",permUserLogin);
          Map prunResult=dispatcher.runSync("createProductionRunForMktgPkg",inputMap);
          if (ServiceUtil.isError(prunResult)) {
            Debug.logError(ServiceUtil.getErrorMessage(prunResult) + " for input:" + inputMap,module);
          }
        }
      }
 catch (      Exception e) {
        String service=e.getMessage();
        Map messageMap=UtilMisc.toMap("service",service);
        String errMsg=UtilProperties.getMessage(resource,"checkhelper.could_not_create_order_invoking_service",messageMap,(cart != null ? cart.getLocale() : Locale.getDefault()));
        Debug.logError(e,errMsg,module);
        return ServiceUtil.returnError(errMsg);
      }
    }
    counter++;
  }
  Iterator shoppingCartItems=this.cart.items().iterator();
  while (shoppingCartItems.hasNext()) {
    ShoppingCartItem shoppingCartItem=(ShoppingCartItem)shoppingCartItems.next();
    String requirementId=shoppingCartItem.getRequirementId();
    if (requirementId != null) {
      try {
        Map inputMap=UtilMisc.toMap("requirementId",requirementId,"statusId","REQ_ORDERED");
        inputMap.put("userLogin",userLogin);
        Map outMap=dispatcher.runSync("updateRequirement",inputMap);
      }
 catch (      Exception e) {
        String service=e.getMessage();
        Map messageMap=UtilMisc.toMap("service",service);
        String errMsg=UtilProperties.getMessage(resource,"checkhelper.could_not_create_order_invoking_service",messageMap,(cart != null ? cart.getLocale() : Locale.getDefault()));
        Debug.logError(e,errMsg,module);
        return ServiceUtil.returnError(errMsg);
      }
    }
  }
  Map result=ServiceUtil.returnSuccess();
  result.put("orderId",orderId);
  result.put("orderAdditionalEmails",this.cart.getOrderAdditionalEmails());
  List toBeStored=new LinkedList();
  GenericValue party=null;
  try {
    party=this.delegator.findByPrimaryKey("Party",UtilMisc.toMap("partyId",partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e,UtilProperties.getMessage(resource_error,"OrderProblemsGettingPartyRecord",cart.getLocale()),module);
    party=null;
  }
  if (party != null) {
    Iterator emailIter=UtilMisc.toIterator(ContactHelper.getContactMechByType(party,"EMAIL_ADDRESS",false));
    while (emailIter != null && emailIter.hasNext()) {
      GenericValue email=(GenericValue)emailIter.next();
      GenericValue orderContactMech=this.delegator.makeValue("OrderContactMech",UtilMisc.toMap("orderId",orderId,"contactMechId",email.getString("contactMechId"),"contactMechPurposeTypeId","ORDER_EMAIL"));
      toBeStored.add(orderContactMech);
    }
  }
  String additionalEmails=this.cart.getOrderAdditionalEmails();
  List emailList=StringUtil.split(additionalEmails,",");
  if (emailList == null)   emailList=new ArrayList();
  Iterator eli=emailList.iterator();
  while (eli.hasNext()) {
    String email=(String)eli.next();
    String contactMechId=this.delegator.getNextSeqId("ContactMech").toString();
    GenericValue contactMech=this.delegator.makeValue("ContactMech",UtilMisc.toMap("contactMechId",contactMechId,"contactMechTypeId","EMAIL_ADDRESS","infoString",email));
    GenericValue orderContactMech=this.delegator.makeValue("OrderContactMech",UtilMisc.toMap("orderId",orderId,"contactMechId",contactMechId,"contactMechPurposeTypeId","ORDER_EMAIL"));
    toBeStored.add(contactMech);
    toBeStored.add(orderContactMech);
  }
  if (toBeStored.size() > 0) {
    try {
      if (Debug.verboseOn())       Debug.logVerbose("To Be Stored: " + toBeStored,module);
      this.delegator.storeAll(toBeStored);
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,UtilProperties.getMessage(resource_error,"OrderProblemsStoringOrderEmailContactInformation",cart.getLocale()),module);
    }
  }
  return result;
}
