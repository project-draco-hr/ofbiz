{
  List errorMessages=new ArrayList();
  String errMsg=null;
  if (singleUsePayments == null) {
    singleUsePayments=new ArrayList();
  }
  if (UtilValidate.isNotEmpty(selectedPaymentMethods)) {
    cart.clearPayments();
    if (UtilValidate.isNotEmpty(billingAccountId)) {
      Map billingAccountMap=(Map)selectedPaymentMethods.get("EXT_BILLACT");
      Double billingAccountAmt=(Double)billingAccountMap.get("amount");
      cart.setBillingAccount(billingAccountId,(billingAccountAmt != null ? billingAccountAmt.doubleValue() : 0.0));
      try {
        List billingAccountTerms=delegator.findByAnd("BillingAccountTerm",UtilMisc.toMap("billingAccountId",billingAccountId));
        if (UtilValidate.isNotEmpty(billingAccountTerms)) {
          Iterator billingAccountTermsIt=billingAccountTerms.iterator();
          while (billingAccountTermsIt.hasNext()) {
            GenericValue billingAccountTerm=(GenericValue)billingAccountTermsIt.next();
            if (!cart.hasOrderTerm(billingAccountTerm.getString("termTypeId"))) {
              cart.addOrderTerm(billingAccountTerm.getString("termTypeId"),billingAccountTerm.getDouble("termValue"),billingAccountTerm.getLong("termDays"));
            }
          }
        }
      }
 catch (      GenericEntityException gee) {
        Debug.logWarning("Error copying billing account terms to order terms: " + gee.getMessage(),module);
      }
    }
 else {
      cart.setBillingAccount(null,0.0);
    }
    if (selectedPaymentMethods.containsKey("EXT_BILLACT") && selectedPaymentMethods.size() == 1) {
      double accountCredit=this.availableAccountBalance(cart.getBillingAccountId());
      double amountToUse=cart.getBillingAccountAmount();
      if (amountToUse > 0 && amountToUse > accountCredit) {
        errMsg=UtilProperties.getMessage(resource,"checkhelper.insufficient_credit_available_on_account",(cart != null ? cart.getLocale() : Locale.getDefault()));
        errorMessages.add(errMsg);
      }
 else {
        amountToUse=accountCredit;
      }
      double grandTotal=cart.getGrandTotal();
      if (grandTotal > amountToUse) {
        cart.setBillingAccount(null,0.0);
        errMsg=UtilProperties.getMessage(resource,"checkhelper.insufficient_credit_available_on_account",(cart != null ? cart.getLocale() : Locale.getDefault()));
        errorMessages.add(errMsg);
      }
 else {
        amountToUse=grandTotal;
      }
      if (amountToUse > 0) {
        cart.setBillingAccount(billingAccountId,amountToUse);
        selectedPaymentMethods.put("EXT_BILLACT",UtilMisc.toMap("amount",new Double(amountToUse),"securityCode",null));
      }
    }
    Set paymentMethods=selectedPaymentMethods.keySet();
    Iterator i=paymentMethods.iterator();
    while (i.hasNext()) {
      String checkOutPaymentId=(String)i.next();
      String finAccountId=null;
      if (checkOutPaymentId.indexOf("|") > -1) {
        String[] splitStr=checkOutPaymentId.split("\\|");
        checkOutPaymentId=splitStr[0];
        if ("FIN_ACCOUNT".equals(checkOutPaymentId)) {
          finAccountId=splitStr[1];
        }
        Debug.log("Split checkOutPaymentId: " + splitStr[0] + " / "+ splitStr[1],module);
      }
      Double paymentAmount=null;
      String securityCode=null;
      if (selectedPaymentMethods.get(checkOutPaymentId) != null) {
        Map checkOutPaymentInfo=(Map)selectedPaymentMethods.get(checkOutPaymentId);
        paymentAmount=(Double)checkOutPaymentInfo.get("amount");
        securityCode=(String)checkOutPaymentInfo.get("securityCode");
      }
      boolean singleUse=singleUsePayments.contains(checkOutPaymentId);
      ShoppingCart.CartPaymentInfo inf=cart.addPaymentAmount(checkOutPaymentId,paymentAmount,singleUse);
      if (finAccountId != null) {
        inf.finAccountId=finAccountId;
      }
      if (securityCode != null) {
        inf.securityCode=securityCode;
      }
    }
  }
 else   if (cart.getGrandTotal() != 0.00) {
    errMsg=UtilProperties.getMessage(resource,"checkhelper.select_method_of_payment",(cart != null ? cart.getLocale() : Locale.getDefault()));
    errorMessages.add(errMsg);
  }
  return errorMessages;
}
