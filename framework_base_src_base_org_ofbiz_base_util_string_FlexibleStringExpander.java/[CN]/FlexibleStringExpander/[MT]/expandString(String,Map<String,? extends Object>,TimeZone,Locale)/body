{
  if (context == null) {
    return original;
  }
  if (original == null || original.length() < 3) {
    return original;
  }
  int start=original.indexOf("${");
  if (start == -1) {
    return original;
  }
 else {
    if (original.indexOf("}",start) == -1) {
      Debug.logWarning("Found a \"${\" without a closing \"}\" (curly-brace) in the String: " + original,module);
      return original;
    }
  }
  if (locale == null && context.containsKey("locale")) {
    locale=(Locale)context.get("locale");
  }
  if (locale == null && context.containsKey("autoUserLogin")) {
    locale=UtilMisc.ensureLocale(((Map)context.get("autoUserLogin")).get("lastLocale"));
  }
  if (timeZone == null) {
    timeZone=(TimeZone)context.get("timeZone");
    if (timeZone == null) {
      timeZone=TimeZone.getDefault();
    }
  }
  StringBuilder expanded=new StringBuilder();
  ParseElementHandler handler=new OnTheFlyHandler(expanded,context,timeZone,locale);
  parseString(original,handler);
  return expandString(expanded.toString(),context,timeZone,locale);
}
