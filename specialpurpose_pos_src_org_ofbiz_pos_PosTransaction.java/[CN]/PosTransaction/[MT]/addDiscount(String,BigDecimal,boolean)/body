{
  GenericValue adjustment=session.getDelegator().makeValue("OrderAdjustment");
  adjustment.set("orderAdjustmentTypeId","DISCOUNT_ADJUSTMENT");
  if (percent) {
    adjustment.set("sourcePercentage",discount.movePointRight(2));
  }
 else {
    adjustment.set("amount",discount);
  }
  if (productId != null) {
    trace("add item adjustment");
    ShoppingCartItem item=cart.findCartItem(productId,null,null,null,BigDecimal.ZERO);
    Integer itemAdj=skuDiscounts.get(productId);
    if (itemAdj != null) {
      item.removeAdjustment(itemAdj.intValue());
    }
    int idx=item.addAdjustment(adjustment);
    skuDiscounts.put(productId,new Integer(idx));
  }
 else {
    trace("add sale adjustment");
    if (cartDiscount > -1) {
      cart.removeAdjustment(cartDiscount);
    }
    cartDiscount=cart.addAdjustment(adjustment);
  }
}
