{
  if (UtilValidate.isEmpty(original)) {
    return null;
  }
  int origLen=original.length();
  ArrayList<StrElem> strElems=new ArrayList<StrElem>();
  int start=original.indexOf(openBracket);
  if (start == -1) {
    strElems.add(new ConstElem(original));
    strElems.trimToSize();
    return strElems;
  }
  int currentInd=0;
  int end=-1;
  while (start != -1) {
    end=original.indexOf(closeBracket,start);
    if (end == -1) {
      Debug.logWarning("Found a ${ without a closing } (curly-brace) in the String: " + original,module);
      break;
    }
    boolean escapedExpression=(start - 1 >= 0 && original.charAt(start - 1) == '\\');
    if (start > currentInd) {
      strElems.add(new ConstElem(original.substring(currentInd,escapedExpression ? start - 1 : start)));
    }
    if (original.indexOf("bsh:",start + 2) == start + 2 && !escapedExpression) {
      strElems.add(new BshElem(original.substring(start + 6,end)));
    }
 else     if (original.indexOf("groovy:",start + 2) == start + 2 && !escapedExpression) {
      strElems.add(new GroovyElem(original.substring(start + 9,end)));
    }
 else {
      int ptr=original.indexOf(openBracket,start + 2);
      while (ptr != -1 && end != -1 && ptr < end) {
        end=original.indexOf(closeBracket,end + 1);
        ptr=original.indexOf(openBracket,ptr + 2);
      }
      if (end == -1) {
        end=origLen;
      }
      String expression=original.substring(start + 2,end);
      if (escapedExpression) {
        strElems.add(new ConstElem(original.substring(start,end + 1)));
      }
 else       if (expression.contains("?currency(")) {
        strElems.add(new CurrElem(expression));
      }
 else       if (expression.contains(openBracket)) {
        strElems.add(new NestedVarElem(expression));
      }
 else {
        strElems.add(new VarElem(expression));
      }
    }
    currentInd=end + 1;
    if (currentInd > origLen) {
      currentInd=origLen;
    }
    start=original.indexOf(openBracket,currentInd);
  }
  if (currentInd < origLen) {
    strElems.add(new ConstElem(original.substring(currentInd)));
  }
  strElems.trimToSize();
  return strElems;
}
