{
  GenericValue orderPaymentPreference=(GenericValue)context.get("orderPaymentPreference");
  GenericValue authTransaction=(GenericValue)context.get("authTrans");
  if (authTransaction == null) {
    authTransaction=PaymentGatewayServices.getAuthTransaction(orderPaymentPreference);
  }
  if (authTransaction == null) {
    return ServiceUtil.returnError("No authorization transaction found for the OrderPaymentPreference; cannot refund");
  }
  Properties props=buildPccProperties(context);
  PcChargeApi api=getApi(props);
  if (api == null) {
    return ServiceUtil.returnError("PCCharge is not configured properly");
  }
  api.set(PcChargeApi.TROUTD,authTransaction.getString("referenceNum"));
  api.set(PcChargeApi.COMMAND,"2");
  PcChargeApi out=null;
  try {
    out=api.send();
  }
 catch (  IOException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
catch (  GeneralException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (out != null) {
    Map result=ServiceUtil.returnSuccess();
    String resultCode=out.get(PcChargeApi.RESULT);
    if ("CAPTURED".equals(resultCode)) {
      result.put("refundResult",new Boolean(true));
    }
 else {
      result.put("refundResult",new Boolean(false));
    }
    result.put("refundAmount",context.get("releaseAmount"));
    result.put("refundRefNum",out.get(PcChargeApi.TROUTD) != null ? out.get(PcChargeApi.TROUTD) : "");
    result.put("refundCode",out.get(PcChargeApi.AUTH_CODE));
    result.put("refundFlag",out.get(PcChargeApi.REFERENCE));
    result.put("refundMessage",out.get(PcChargeApi.RESULT));
    return result;
  }
 else {
    return ServiceUtil.returnError("Receive a null result from PcCharge");
  }
}
