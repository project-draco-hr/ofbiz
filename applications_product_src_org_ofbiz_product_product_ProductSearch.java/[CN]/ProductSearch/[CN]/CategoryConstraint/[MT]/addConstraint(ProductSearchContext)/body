{
  List productCategoryIdList=null;
  if (includeSubCategories) {
    Set productCategoryIdSet=FastSet.newInstance();
    ProductSearch.getAllSubCategoryIds(productCategoryId,productCategoryIdSet,productSearchContext.getDelegator(),productSearchContext.nowTimestamp);
    productCategoryIdList=FastList.newInstance();
    productCategoryIdList.addAll(productCategoryIdSet);
  }
 else {
    productCategoryIdList=UtilMisc.toList(productCategoryId);
  }
  if (exclude == null) {
    productSearchContext.includeCategoryIds.addAll(productCategoryIdList);
  }
 else   if (exclude.equals(Boolean.TRUE)) {
    productSearchContext.excludeCategoryIds.addAll(productCategoryIdList);
  }
 else   if (exclude.equals(Boolean.FALSE)) {
    productSearchContext.alwaysIncludeCategoryIds.addAll(productCategoryIdList);
  }
  productSearchContext.productSearchConstraintList.add(productSearchContext.getDelegator().makeValue("ProductSearchConstraint",UtilMisc.toMap("constraintName",constraintName,"infoString",this.productCategoryId,"includeSubCategories",this.includeSubCategories ? "Y" : "N")));
}
