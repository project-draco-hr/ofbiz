{
  BigDecimal total=ZERO;
  try {
    List orderItemBillings=orderHeader.getRelatedCache("OrderItemBilling");
    Set invoiceIds=new HashSet();
    for (Iterator iter=orderItemBillings.iterator(); iter.hasNext(); ) {
      GenericValue orderItemBilling=(GenericValue)iter.next();
      invoiceIds.add(orderItemBilling.get("invoiceId"));
    }
    List conditions=UtilMisc.toList(EntityCondition.makeCondition("statusId",EntityOperator.EQUALS,"PMNT_RECEIVED"),EntityCondition.makeCondition("invoiceId",EntityOperator.IN,invoiceIds));
    if (paymentMethodTypeId != null) {
      conditions.add(EntityCondition.makeCondition("paymentMethodTypeId",EntityOperator.EQUALS,paymentMethodTypeId));
    }
    EntityConditionList ecl=EntityCondition.makeCondition(conditions,EntityOperator.AND);
    List payments=orderHeader.getDelegator().findList("PaymentAndApplication",ecl,null,null,null,true);
    for (Iterator iter=payments.iterator(); iter.hasNext(); ) {
      GenericValue payment=(GenericValue)iter.next();
      if (payment.get("amountApplied") == null)       continue;
      total=total.add(payment.getBigDecimal("amountApplied")).setScale(scale,rounding);
    }
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,e.getMessage(),module);
  }
  return total;
}
