{
  Debug.logInfo("SagePay - Entered paymentRefund",module);
  Debug.logInfo("SagePay paymentRefund context : " + context,module);
  Delegator delegator=ctx.getDelegator();
  Map<String,Object> resultMap=new HashMap<String,Object>();
  Map<String,String> props=buildSagePayProperties(context,delegator);
  String vendorTxCode=(String)context.get("vendorTxCode");
  String amount=(String)context.get("amount");
  String currency=(String)context.get("currency");
  String description=(String)context.get("description");
  String relatedVPSTxId=(String)context.get("relatedVPSTxId");
  String relatedVendorTxCode=(String)context.get("relatedVendorTxCode");
  String relatedSecurityKey=(String)context.get("relatedSecurityKey");
  String relatedTxAuthNo=(String)context.get("relatedTxAuthNo");
  HttpClient httpClient=SagePayUtil.getHttpClient();
  HttpHost host=SagePayUtil.getHost(props);
  Map<String,String> parameters=new HashMap<String,String>();
  String vpsProtocol=props.get("protocolVersion");
  String vendor=props.get("vendor");
  parameters.put("VPSProtocol",vpsProtocol);
  parameters.put("TxType","REFUND");
  parameters.put("Vendor",vendor);
  parameters.put("VendorTxCode",vendorTxCode);
  parameters.put("Amount",amount);
  parameters.put("Currency",currency);
  parameters.put("Description",description);
  parameters.put("RelatedVPSTxId",relatedVPSTxId);
  parameters.put("RelatedVendorTxCode",relatedVendorTxCode);
  parameters.put("RelatedSecurityKey",relatedSecurityKey);
  parameters.put("RelatedTxAuthNo",relatedTxAuthNo);
  try {
    String successMessage=null;
    HttpPost httpPost=SagePayUtil.getHttpPost(props.get("refundUrl"),parameters);
    HttpResponse response=httpClient.execute(host,httpPost);
    Map<String,String> responseData=SagePayUtil.getResponseData(response);
    Debug.logInfo("response data -> " + responseData,module);
    String status=responseData.get("Status");
    String statusDetail=responseData.get("StatusDetail");
    resultMap.put("status",status);
    resultMap.put("statusDetail",statusDetail);
    if ("OK".equals(status)) {
      resultMap.put("vpsTxId",responseData.get("VPSTxId"));
      resultMap.put("txAuthNo",responseData.get("TxAuthNo"));
      successMessage="Payment Refunded";
    }
    if ("NOTAUTHED".equals(status)) {
      successMessage="Refund not authorized by the acquiring bank";
    }
    if ("MALFORMED".equals(status)) {
      successMessage="Refund request not formed properly or parameters missing";
    }
    if ("INVALID".equals(status)) {
      successMessage="Invalid information passed in parameters";
    }
    if ("ERROR".equals(status)) {
      successMessage="Problem at SagePay";
    }
    resultMap.put(ModelService.RESPONSE_MESSAGE,ModelService.RESPOND_SUCCESS);
    resultMap.put(ModelService.SUCCESS_MESSAGE,successMessage);
  }
 catch (  UnsupportedEncodingException uee) {
    String errorMsg="Error occured in encoding parameters for HttpPost (" + uee.getMessage() + ")";
    Debug.logError(uee,errorMsg,module);
    resultMap=ServiceUtil.returnError(errorMsg);
  }
catch (  ClientProtocolException cpe) {
    String errorMsg="Error occured in HttpClient execute(" + cpe.getMessage() + ")";
    Debug.logError(cpe,errorMsg,module);
    resultMap=ServiceUtil.returnError(errorMsg);
  }
catch (  IOException ioe) {
    String errorMsg="Error occured in HttpClient execute or getting response (" + ioe.getMessage() + ")";
    Debug.logError(ioe,errorMsg,module);
    resultMap=ServiceUtil.returnError(errorMsg);
  }
 finally {
    httpClient.getConnectionManager().shutdown();
  }
  return resultMap;
}
