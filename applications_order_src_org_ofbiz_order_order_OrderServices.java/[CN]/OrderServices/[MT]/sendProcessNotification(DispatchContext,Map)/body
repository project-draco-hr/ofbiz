{
  GenericDelegator delegator=ctx.getDelegator();
  LocalDispatcher dispatcher=ctx.getDispatcher();
  String adminEmailList=(String)context.get("adminEmailList");
  String assignedToUser=(String)context.get("assignedPartyId");
  String workEffortId=(String)context.get("workEffortId");
  Locale locale=(Locale)context.get("locale");
  GenericValue workEffort=null;
  GenericValue orderHeader=null;
  try {
    workEffort=delegator.findByPrimaryKey("WorkEffort",UtilMisc.toMap("workEffortId",workEffortId));
    String sourceReferenceId=workEffort.getString("sourceReferenceId");
    if (sourceReferenceId != null)     orderHeader=delegator.findByPrimaryKey("OrderHeader",UtilMisc.toMap("orderId",sourceReferenceId));
  }
 catch (  GenericEntityException e) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderProblemWithEntityLookup",locale));
  }
  GenericValue party=null;
  Collection assignedToEmails=null;
  try {
    party=delegator.findByPrimaryKey("Party",UtilMisc.toMap("partyId",assignedToUser));
  }
 catch (  GenericEntityException e) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderProblemWithEntityLookup",locale));
  }
  if (party != null)   assignedToEmails=ContactHelper.getContactMechByPurpose(party,"PRIMARY_EMAIL",false);
  Map templateData=new HashMap(context);
  String omgStatusId=WfUtil.getOMGStatus(workEffort.getString("currentStatusId"));
  templateData.putAll(orderHeader);
  templateData.putAll(workEffort);
  templateData.put("omgStatusId",omgStatusId);
  List assignments=null;
  if (workEffort != null) {
    try {
      assignments=workEffort.getRelated("WorkEffortPartyAssignment");
    }
 catch (    GenericEntityException e1) {
      Debug.logError(e1,"Problems getting assignements",module);
    }
  }
  templateData.put("assignments",assignments);
  StringBuffer emailList=new StringBuffer();
  if (assignedToEmails != null) {
    Iterator aei=assignedToEmails.iterator();
    while (aei.hasNext()) {
      GenericValue ct=(GenericValue)aei.next();
      if (ct != null && ct.get("infoString") != null) {
        if (emailList.length() > 1)         emailList.append(",");
        emailList.append(ct.getString("infoString"));
      }
    }
  }
  if (adminEmailList != null) {
    if (emailList.length() > 1)     emailList.append(",");
    emailList.append(adminEmailList);
  }
  String ofbizHome=System.getProperty("ofbiz.home");
  String templateName=ofbizHome + "/applications/order/email/default/emailprocessnotify.ftl";
  Map sendMailContext=new HashMap();
  sendMailContext.put("sendTo",emailList.toString());
  sendMailContext.put("sendFrom","workflow@ofbiz.org");
  sendMailContext.put("subject","Workflow Notification");
  sendMailContext.put("templateName",templateName);
  sendMailContext.put("templateData",templateData);
  try {
    dispatcher.runAsync("sendGenericNotificationEmail",sendMailContext);
  }
 catch (  GenericServiceException e) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderSendMailServiceFailed",locale) + e.getMessage());
  }
  return ServiceUtil.returnSuccess();
}
