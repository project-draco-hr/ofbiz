{
  int shipGroups=cart.getShipGroupSize();
  for (int gi=0; gi < shipGroups; gi++) {
    String shipmentMethodTypeId=cart.getShipmentMethodTypeId(gi);
    String carrierPartyId=cart.getCarrierPartyId(gi);
    Debug.log("Getting ship estimate for group #" + gi + " ["+ shipmentMethodTypeId+ " / "+ carrierPartyId+ "]",module);
    Map result=ShippingEvents.getShipGroupEstimate(dispatcher,delegator,cart,gi);
    if (("SALES_ORDER".equals(cart.getOrderType())) && (ServiceUtil.isError(result))) {
      Debug.logError(ServiceUtil.getErrorMessage(result),module);
      throw new GeneralException(ServiceUtil.getErrorMessage(result));
    }
    Double shippingTotal=(Double)result.get("shippingTotal");
    if (shippingTotal == null) {
      shippingTotal=new Double(0.00);
    }
    cart.setItemShipGroupEstimate(shippingTotal.doubleValue(),gi);
  }
  CheckOutHelper coh=new CheckOutHelper(dispatcher,delegator,cart);
  try {
    coh.calcAndAddTax();
  }
 catch (  GeneralException e) {
    Debug.logError(e,module);
    throw new GeneralException(e.getMessage());
  }
  Map validateResp=coh.validatePaymentMethods();
  if (ServiceUtil.isError(validateResp)) {
    throw new GeneralException(ServiceUtil.getErrorMessage(validateResp));
  }
  List toStore=new LinkedList();
  toStore.addAll(cart.makeOrderItems());
  toStore.addAll(cart.makeAllAdjustments());
  toStore.addAll(cart.makeAllShipGroupInfos());
  toStore.addAll(cart.makeAllOrderPaymentInfos(dispatcher));
  List dropShipGroupIds=FastList.newInstance();
  Iterator tsi=toStore.iterator();
  while (tsi.hasNext()) {
    GenericValue valueObj=(GenericValue)tsi.next();
    valueObj.set("orderId",orderId);
    if ("OrderItemShipGroup".equals(valueObj.getEntityName())) {
      if (valueObj.get("carrierRoleTypeId") == null) {
        valueObj.set("carrierRoleTypeId","CARRIER");
      }
      if (!UtilValidate.isEmpty(valueObj.get("supplierPartyId"))) {
        dropShipGroupIds.add(valueObj.getString("shipGroupSeqId"));
      }
    }
 else     if ("OrderAdjustment".equals(valueObj.getEntityName())) {
      if (valueObj.get("orderItemSeqId") == null || valueObj.getString("orderItemSeqId").length() == 0) {
        valueObj.set("orderItemSeqId",DataModelConstants.SEQ_ID_NA);
      }
      valueObj.set("orderAdjustmentId",delegator.getNextSeqId("OrderAdjustment"));
      valueObj.set("createdDate",UtilDateTime.nowTimestamp());
      valueObj.set("createdByUserLogin",userLogin.getString("userLoginId"));
    }
 else     if ("OrderPaymentPreference".equals(valueObj.getEntityName())) {
      if (valueObj.get("orderPaymentPreferenceId") == null) {
        valueObj.set("orderPaymentPreferenceId",delegator.getNextSeqId("OrderPaymentPreference"));
        valueObj.set("createdDate",UtilDateTime.nowTimestamp());
        valueObj.set("createdByUserLogin",userLogin.getString("userLoginId"));
      }
      if (valueObj.get("statusId") == null) {
        valueObj.set("statusId","PAYMENT_NOT_RECEIVED");
      }
    }
  }
  Debug.log("To Store Contains: " + toStore,module);
  try {
    delegator.storeAll(toStore);
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    throw new GeneralException(e.getMessage());
  }
  List orderItemShipGroupAssoc=new LinkedList();
  Map itemValuesBySeqId=new HashMap();
  Iterator oii=toStore.iterator();
  while (oii.hasNext()) {
    GenericValue v=(GenericValue)oii.next();
    if ("OrderItem".equals(v.getEntityName())) {
      itemValuesBySeqId.put(v.getString("orderItemSeqId"),v);
    }
 else     if ("OrderItemShipGroupAssoc".equals(v.getEntityName())) {
      orderItemShipGroupAssoc.add(v);
    }
  }
  String productStoreId=cart.getProductStoreId();
  String orderTypeId=cart.getOrderType();
  List resErrorMessages=new LinkedList();
  try {
    Debug.log("Calling reserve inventory...",module);
    reserveInventory(delegator,dispatcher,userLogin,locale,orderItemShipGroupAssoc,dropShipGroupIds,itemValuesBySeqId,orderTypeId,productStoreId,resErrorMessages);
  }
 catch (  GeneralException e) {
    Debug.logError(e,module);
    throw new GeneralException(e.getMessage());
  }
  if (resErrorMessages.size() > 0) {
    throw new GeneralException(ServiceUtil.getErrorMessage(ServiceUtil.returnError(resErrorMessages)));
  }
}
