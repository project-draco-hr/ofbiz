{
  LocalDispatcher dispatcher=ctx.getDispatcher();
  Delegator delegator=ctx.getDelegator();
  String orderId=(String)context.get("orderId");
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  Locale locale=(Locale)context.get("locale");
  Security security=ctx.getSecurity();
  boolean hasPermission=OrderServices.hasPermission(orderId,userLogin,"UPDATE",security,delegator);
  if (!hasPermission) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderYouDoNotHavePermissionToChangeThisOrdersStatus",locale));
  }
  GenericValue orderHeader=null;
  try {
    orderHeader=delegator.findByPrimaryKey("OrderHeader",UtilMisc.toMap("orderId",orderId));
  }
 catch (  GenericEntityException e) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorCannotGetOrderHeaderEntity",locale) + e.getMessage());
  }
  if (orderHeader == null) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorNoValidOrderHeaderFoundForOrderId",UtilMisc.toMap("orderId",orderId),locale));
  }
  List orderTaxAdjustments=null;
  try {
    orderTaxAdjustments=delegator.findByAnd("OrderAdjustment",UtilMisc.toMap("orderId",orderId,"orderAdjustmentTypeId","SALES_TAX"));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,"Unable to retrieve SALES_TAX adjustments for order : " + orderId,module);
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderUnableToRetrieveSalesTaxAdjustments",locale));
  }
  BigDecimal totalExistingOrderTax=ZERO;
  Iterator otait=UtilMisc.toIterator(orderTaxAdjustments);
  while (otait != null && otait.hasNext()) {
    GenericValue orderTaxAdjustment=(GenericValue)otait.next();
    if (orderTaxAdjustment.get("amount") != null) {
      totalExistingOrderTax=totalExistingOrderTax.add(orderTaxAdjustment.getBigDecimal("amount").setScale(taxDecimals,taxRounding));
    }
  }
  BigDecimal totalNewOrderTax=ZERO;
  OrderReadHelper orh=new OrderReadHelper(orderHeader);
  List shipGroups=orh.getOrderItemShipGroups();
  if (shipGroups != null) {
    Iterator itr=shipGroups.iterator();
    while (itr.hasNext()) {
      GenericValue shipGroup=(GenericValue)itr.next();
      String shipGroupSeqId=shipGroup.getString("shipGroupSeqId");
      List validOrderItems=orh.getValidOrderItems(shipGroupSeqId);
      if (validOrderItems != null) {
        List products=new ArrayList(validOrderItems.size());
        List amounts=new ArrayList(validOrderItems.size());
        List shipAmts=new ArrayList(validOrderItems.size());
        List itPrices=new ArrayList(validOrderItems.size());
        List allAdjustments=orh.getAdjustments();
        List orderHeaderAdjustments=OrderReadHelper.getOrderHeaderAdjustments(allAdjustments,shipGroupSeqId);
        BigDecimal orderSubTotal=OrderReadHelper.getOrderItemsSubTotal(validOrderItems,allAdjustments);
        BigDecimal orderShipping=OrderReadHelper.calcOrderAdjustments(orderHeaderAdjustments,orderSubTotal,false,false,true);
        BigDecimal orderPromotions=OrderReadHelper.calcOrderPromoAdjustmentsBd(allAdjustments);
        for (int i=0; i < validOrderItems.size(); i++) {
          GenericValue orderItem=(GenericValue)validOrderItems.get(i);
          String productId=orderItem.getString("productId");
          try {
            products.add(i,delegator.findByPrimaryKey("Product",UtilMisc.toMap("productId",productId)));
            amounts.add(i,OrderReadHelper.getOrderItemSubTotal(orderItem,allAdjustments,true,false));
            shipAmts.add(i,OrderReadHelper.getOrderItemAdjustmentsTotal(orderItem,allAdjustments,false,false,true));
            itPrices.add(i,orderItem.getBigDecimal("unitPrice"));
          }
 catch (          GenericEntityException e) {
            Debug.logError(e,"Cannot read order item entity : " + orderItem,module);
            return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderCannotReadTheOrderItemEntity",locale));
          }
        }
        GenericValue shippingAddress=orh.getShippingAddress(shipGroupSeqId);
        if (shippingAddress == null) {
          List billingAddressList=orh.getBillingLocations();
          if (billingAddressList.size() > 0) {
            shippingAddress=(GenericValue)billingAddressList.get(0);
          }
        }
        if (shippingAddress == null) {
          String facilityId=orderHeader.getString("originFacilityId");
          if (facilityId != null) {
            GenericValue facilityContactMech=ContactMechWorker.getFacilityContactMechByPurpose(delegator,facilityId,UtilMisc.toList("SHIP_ORIG_LOCATION","PRIMARY_LOCATION"));
            if (facilityContactMech != null) {
              try {
                shippingAddress=delegator.findByPrimaryKey("PostalAddress",UtilMisc.toMap("contactMechId",facilityContactMech.getString("contactMechId")));
              }
 catch (              GenericEntityException e) {
                Debug.logError(e,module);
              }
            }
          }
        }
        if (shippingAddress == null) {
          Debug.logWarning("Not calculating tax for Order [" + orderId + "] because there is no shippingAddress, and no address on the origin facility ["+ orderHeader.getString("originFacilityId")+ "]",module);
          continue;
        }
        Map serviceContext=UtilMisc.toMap("productStoreId",orh.getProductStoreId(),"itemProductList",products,"itemAmountList",amounts,"itemShippingList",shipAmts,"itemPriceList",itPrices,"orderShippingAmount",orderShipping);
        serviceContext.put("shippingAddress",shippingAddress);
        serviceContext.put("orderPromotionsAmount",orderPromotions);
        if (orh.getBillToParty() != null)         serviceContext.put("billToPartyId",orh.getBillToParty().getString("partyId"));
        if (orh.getBillFromParty() != null)         serviceContext.put("payToPartyId",orh.getBillFromParty().getString("partyId"));
        Map serviceResult=null;
        try {
          serviceResult=dispatcher.runSync("calcTax",serviceContext);
        }
 catch (        GenericServiceException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderProblemOccurredInTaxService",locale));
        }
        if (ServiceUtil.isError(serviceResult)) {
          return ServiceUtil.returnError(ServiceUtil.getErrorMessage(serviceResult));
        }
        List orderAdj=(List)serviceResult.get("orderAdjustments");
        List itemAdj=(List)serviceResult.get("itemAdjustments");
        if (UtilValidate.isNotEmpty(orderAdj)) {
          Iterator oai=orderAdj.iterator();
          while (oai.hasNext()) {
            GenericValue oa=(GenericValue)oai.next();
            if (oa.get("amount") != null) {
              totalNewOrderTax=totalNewOrderTax.add(oa.getBigDecimal("amount").setScale(taxDecimals,taxRounding));
            }
          }
        }
        if (UtilValidate.isNotEmpty(itemAdj)) {
          for (int i=0; i < itemAdj.size(); i++) {
            List itemAdjustments=(List)itemAdj.get(i);
            Iterator ida=itemAdjustments.iterator();
            while (ida.hasNext()) {
              GenericValue ia=(GenericValue)ida.next();
              if (ia.get("amount") != null) {
                totalNewOrderTax=totalNewOrderTax.add(ia.getBigDecimal("amount").setScale(taxDecimals,taxRounding));
              }
            }
          }
        }
      }
    }
    BigDecimal orderTaxDifference=totalNewOrderTax.subtract(totalExistingOrderTax).setScale(taxDecimals,taxRounding);
    if (orderTaxDifference.signum() != 0) {
      Map createOrderAdjContext=new HashMap();
      createOrderAdjContext.put("orderAdjustmentTypeId","SALES_TAX");
      createOrderAdjContext.put("orderId",orderId);
      createOrderAdjContext.put("orderItemSeqId","_NA_");
      createOrderAdjContext.put("shipGroupSeqId","_NA_");
      createOrderAdjContext.put("description","Tax adjustment due to order change");
      createOrderAdjContext.put("amount",orderTaxDifference);
      createOrderAdjContext.put("userLogin",userLogin);
      Map createOrderAdjResponse=null;
      try {
        createOrderAdjResponse=dispatcher.runSync("createOrderAdjustment",createOrderAdjContext);
      }
 catch (      GenericServiceException e) {
        String createOrderAdjErrMsg=UtilProperties.getMessage(resource_error,"OrderErrorCallingCreateOrderAdjustmentService",locale);
        Debug.logError(createOrderAdjErrMsg,module);
        return ServiceUtil.returnError(createOrderAdjErrMsg);
      }
      if (ServiceUtil.isError(createOrderAdjResponse)) {
        Debug.logError(ServiceUtil.getErrorMessage(createOrderAdjResponse),module);
        return ServiceUtil.returnError(ServiceUtil.getErrorMessage(createOrderAdjResponse));
      }
    }
  }
  return ServiceUtil.returnSuccess();
}
