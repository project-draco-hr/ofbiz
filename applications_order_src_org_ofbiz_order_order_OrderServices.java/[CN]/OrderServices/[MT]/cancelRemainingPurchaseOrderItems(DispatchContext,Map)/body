{
  GenericDelegator delegator=dctx.getDelegator();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  Locale locale=(Locale)context.get("locale");
  String orderId=(String)context.get("orderId");
  try {
    GenericValue orderHeader=delegator.findByPrimaryKey("OrderHeader",UtilMisc.toMap("orderId",orderId));
    if (UtilValidate.isEmpty(orderHeader)) {
      String errorMessage=UtilProperties.getMessage(resource_error,"OrderErrorOrderIdNotFound",UtilMisc.toMap("orderId",orderId),locale);
      Debug.logError(errorMessage,module);
      return ServiceUtil.returnError(errorMessage);
    }
    if (!"PURCHASE_ORDER".equals(orderHeader.getString("orderTypeId"))) {
      String errorMessage=UtilProperties.getMessage(resource_error,"OrderErrorOrderNotPurchaseOrder",UtilMisc.toMap("orderId",orderId),locale);
      Debug.logError(errorMessage,module);
      return ServiceUtil.returnError(errorMessage);
    }
    List orderItems=orderHeader.getRelated("OrderItem");
    Iterator oiit=orderItems.iterator();
    while (oiit.hasNext()) {
      GenericValue orderItem=(GenericValue)oiit.next();
      if (!"PRODUCT_ORDER_ITEM".equals(orderItem.getString("orderItemTypeId")))       continue;
      double orderItemQuantity=0;
      if (!UtilValidate.isEmpty(orderItem.get("quantity"))) {
        orderItemQuantity=orderItem.getDouble("quantity").doubleValue();
      }
      double orderItemCancelQuantity=0;
      if (!UtilValidate.isEmpty(orderItem.get("cancelQuantity"))) {
        orderItemCancelQuantity=orderItem.getDouble("cancelQuantity").doubleValue();
      }
      List shipmentReceipts=orderItem.getRelated("ShipmentReceipt");
      double receivedQuantity=0;
      Iterator srit=shipmentReceipts.iterator();
      while (srit.hasNext()) {
        GenericValue shipmentReceipt=(GenericValue)srit.next();
        if (!UtilValidate.isEmpty(shipmentReceipt.get("quantityAccepted"))) {
          receivedQuantity+=shipmentReceipt.getDouble("quantityAccepted").doubleValue();
        }
      }
      double quantityToCancel=orderItemQuantity - orderItemCancelQuantity - receivedQuantity;
      if (quantityToCancel > 0) {
        Map cancelOrderItemResult=dispatcher.runSync("cancelOrderItem",UtilMisc.toMap("orderId",orderId,"orderItemSeqId",orderItem.get("orderItemSeqId"),"cancelQuantity",new Double(quantityToCancel),"userLogin",userLogin));
        if (ServiceUtil.isError(cancelOrderItemResult))         return cancelOrderItemResult;
      }
      orderItem.refresh();
      if ("ITEM_APPROVED".equals(orderItem.getString("statusId"))) {
        Map changeOrderItemStatusResult=dispatcher.runSync("changeOrderItemStatus",UtilMisc.toMap("orderId",orderId,"orderItemSeqId",orderItem.get("orderItemSeqId"),"statusId","ITEM_COMPLETED","userLogin",userLogin));
        if (ServiceUtil.isError(changeOrderItemStatusResult))         return changeOrderItemStatusResult;
      }
    }
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
catch (  GenericServiceException se) {
    Debug.logError(se,module);
    return ServiceUtil.returnError(se.getMessage());
  }
  return ServiceUtil.returnSuccess();
}
