{
  Delegator delegator=ctx.getDelegator();
  String templateName=(String)context.get("templateName");
  Map<String,Object> templateData=UtilGenerics.checkMap(context.get("templateData"));
  String webSiteId=(String)context.get("webSiteId");
  Map<String,Object> result=null;
  if (templateData == null) {
    templateData=FastMap.newInstance();
  }
  try {
    setBaseUrl(delegator,webSiteId,templateData);
    URL templateUrl=UtilURL.fromResource(templateName);
    if (templateUrl == null) {
      Debug.logError("Problem getting the template URL: " + templateName + " not found",module);
      return ServiceUtil.returnError("Problem finding template; see logs");
    }
    Writer writer=new StringWriter();
    FreeMarkerWorker.renderTemplate(templateUrl.toExternalForm(),templateData,writer);
    String notificationBody=writer.toString();
    result=ServiceUtil.returnSuccess("Message body generated successfully");
    result.put("body",notificationBody);
  }
 catch (  IOException ie) {
    Debug.logError(ie,"Problems reading template",module);
    result=ServiceUtil.returnError("Template reading problem, see error logs");
  }
catch (  TemplateException te) {
    Debug.logError(te,"Problems processing template",module);
    result=ServiceUtil.returnError("Template processing problem, see error log");
  }
  return result;
}
