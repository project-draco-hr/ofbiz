{
  if (productId == null && product != null) {
    productId=product.getString("productId");
  }
  if (delegator == null && product != null) {
    delegator=product.getDelegator();
  }
  if (UtilValidate.isEmpty(mimeTypeId)) {
    mimeTypeId="text/html";
  }
  if (delegator == null) {
    throw new GeneralRuntimeException("Unable to find a delegator to use!");
  }
  String candidateFieldName=ModelUtil.dbNameToVarName(productContentTypeId);
  ModelEntity productModel=delegator.getModelEntity("Product");
  if (product == null) {
    product=delegator.findByPrimaryKeyCache("Product",UtilMisc.toMap("productId",productId));
  }
  if (UtilValidate.isEmpty(product)) {
    Debug.logWarning("No Product entity found for productId: " + productId,module);
    return;
  }
  if (productModel.isField(candidateFieldName)) {
    String candidateValue=product.getString(candidateFieldName);
    if (UtilValidate.isNotEmpty(candidateValue)) {
      outWriter.write(candidateValue);
      return;
    }
 else     if ("Y".equals(product.getString("isVariant"))) {
      GenericValue parent=ProductWorker.getParentProduct(productId,delegator);
      if (parent != null) {
        candidateValue=parent.getString(candidateFieldName);
        if (UtilValidate.isNotEmpty(candidateValue)) {
          outWriter.write(candidateValue);
          return;
        }
      }
    }
  }
  List<GenericValue> productContentList=delegator.findByAndCache("ProductContent",UtilMisc.toMap("productId",productId,"productContentTypeId",productContentTypeId),UtilMisc.toList("-fromDate"));
  productContentList=EntityUtil.filterByDate(productContentList);
  if (UtilValidate.isEmpty(productContentList) && ("Y".equals(product.getString("isVariant")))) {
    GenericValue parent=ProductWorker.getParentProduct(productId,delegator);
    if (UtilValidate.isNotEmpty(parent)) {
      productContentList=delegator.findByAndCache("ProductContent",UtilMisc.toMap("productId",parent.get("productId"),"productContentTypeId",productContentTypeId),UtilMisc.toList("-fromDate"));
      productContentList=EntityUtil.filterByDate(productContentList);
    }
  }
  GenericValue productContent=EntityUtil.getFirst(productContentList);
  if (productContent != null) {
    Map<String,Object> inContext=FastMap.newInstance();
    inContext.put("product",product);
    inContext.put("productContent",productContent);
    ContentWorker.renderContentAsText(dispatcher,delegator,productContent.getString("contentId"),outWriter,inContext,locale,mimeTypeId,partyId,roleTypeId,true);
  }
}
