{
  PackingSession session=(PackingSession)context.get("packingSession");
  String orderId=(String)context.get("orderId");
  String shipGroupSeqId=(String)context.get("shipGroupSeqId");
  Boolean updateQuantity=(Boolean)context.get("updateQuantity");
  if (updateQuantity == null) {
    updateQuantity=Boolean.FALSE;
  }
  String instructions=(String)context.get("handlingInstructions");
  session.setHandlingInstructions(instructions);
  String pickerPartyId=(String)context.get("pickerPartyId");
  session.setPickerPartyId(pickerPartyId);
  Map selInfo=(Map)context.get("selInfo");
  Map iteInfo=(Map)context.get("iteInfo");
  Map prdInfo=(Map)context.get("prdInfo");
  Map qtyInfo=(Map)context.get("qtyInfo");
  Map pkgInfo=(Map)context.get("pkgInfo");
  Map wgtInfo=(Map)context.get("wgtInfo");
  if (selInfo != null) {
    Iterator i=selInfo.keySet().iterator();
    while (i.hasNext()) {
      String rowKey=(String)i.next();
      String orderItemSeqId=(String)iteInfo.get(rowKey);
      String prdStr=(String)prdInfo.get(rowKey);
      if (UtilValidate.isEmpty(prdStr)) {
        prdStr=null;
      }
      String pkgStr=(String)pkgInfo.get(rowKey);
      String qtyStr=(String)qtyInfo.get(rowKey);
      String wgtStr=(String)wgtInfo.get(rowKey);
      Debug.log("Item: " + orderItemSeqId + " / Product: "+ prdStr+ " / Quantity: "+ qtyStr+ " /  Package: "+ pkgStr+ " / Weight: "+ wgtStr,module);
      String[] quantities;
      String[] packages;
      String[] weights;
      if (pkgStr.indexOf(",") != -1) {
        packages=pkgStr.split(",");
      }
 else {
        packages=new String[]{pkgStr};
      }
      if (packages == null || packages.length == 0) {
        return ServiceUtil.returnError("No packages defined for processing.");
      }
      if (qtyStr == null) {
        quantities=new String[packages.length];
        for (int p=0; p < packages.length; p++) {
          quantities[p]=(String)qtyInfo.get(rowKey + ":" + packages[p]);
        }
        if (quantities.length != packages.length) {
          return ServiceUtil.returnError("Packages and quantities do not match.");
        }
      }
 else {
        quantities=new String[]{qtyStr};
      }
      if (UtilValidate.isEmpty(wgtStr))       wgtStr="0";
      weights=new String[]{wgtStr};
      for (int p=0; p < packages.length; p++) {
        double quantity;
        int packageSeq;
        double weightSeq;
        try {
          quantity=Double.parseDouble(quantities[p]);
          packageSeq=Integer.parseInt(packages[p]);
          weightSeq=Double.parseDouble(weights[p]);
        }
 catch (        Exception e) {
          return ServiceUtil.returnError(e.getMessage());
        }
        try {
          session.addOrIncreaseLine(orderId,orderItemSeqId,shipGroupSeqId,prdStr,quantity,packageSeq,weightSeq,updateQuantity.booleanValue());
        }
 catch (        GeneralException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(e.getMessage());
        }
      }
    }
  }
  return ServiceUtil.returnSuccess();
}
