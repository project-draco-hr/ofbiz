{
  Delegator delegator=dctx.getDelegator();
  String productCategoryId=(String)context.get("productCategoryId");
  boolean limitView=((Boolean)context.get("limitView")).booleanValue();
  int defaultViewSize=((Integer)context.get("defaultViewSize")).intValue();
  Timestamp introductionDateLimit=(Timestamp)context.get("introductionDateLimit");
  Timestamp releaseDateLimit=(Timestamp)context.get("releaseDateLimit");
  List<String> orderByFields=UtilGenerics.checkList(context.get("orderByFields"));
  if (orderByFields == null)   orderByFields=FastList.newInstance();
  String entityName=getCategoryFindEntityName(delegator,orderByFields,introductionDateLimit,releaseDateLimit);
  String prodCatalogId=(String)context.get("prodCatalogId");
  boolean useCacheForMembers=(context.get("useCacheForMembers") == null || ((Boolean)context.get("useCacheForMembers")).booleanValue());
  boolean activeOnly=(context.get("activeOnly") == null || ((Boolean)context.get("activeOnly")).booleanValue());
  boolean checkViewAllow=(prodCatalogId != null && context.get("checkViewAllow") != null && ((Boolean)context.get("checkViewAllow")).booleanValue());
  String viewProductCategoryId=null;
  if (checkViewAllow) {
    viewProductCategoryId=CatalogWorker.getCatalogViewAllowCategoryId(delegator,prodCatalogId);
  }
  Timestamp nowTimestamp=UtilDateTime.nowTimestamp();
  int viewIndex=0;
  try {
    viewIndex=Integer.valueOf((String)context.get("viewIndexString")).intValue();
  }
 catch (  Exception e) {
    viewIndex=0;
  }
  int viewSize=defaultViewSize;
  try {
    viewSize=Integer.valueOf((String)context.get("viewSizeString")).intValue();
  }
 catch (  Exception e) {
    viewSize=defaultViewSize;
  }
  GenericValue productCategory=null;
  try {
    productCategory=delegator.findOne("ProductCategory",UtilMisc.toMap("productCategoryId",productCategoryId),true);
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e.getMessage(),module);
    productCategory=null;
  }
  int listSize=0;
  int lowIndex=0;
  int highIndex=0;
  if (limitView) {
    lowIndex=((viewIndex * viewSize) + 1);
    highIndex=(viewIndex + 1) * viewSize;
  }
 else {
    lowIndex=0;
    highIndex=0;
  }
  List<GenericValue> productCategoryMembers=null;
  if (productCategory != null) {
    try {
      if (useCacheForMembers) {
        productCategoryMembers=delegator.findByAnd(entityName,UtilMisc.toMap("productCategoryId",productCategoryId),orderByFields,true);
        if (activeOnly) {
          productCategoryMembers=EntityUtil.filterByDate(productCategoryMembers,true);
        }
        List<EntityCondition> filterConditions=FastList.newInstance();
        if (introductionDateLimit != null) {
          EntityCondition condition=EntityCondition.makeCondition(EntityCondition.makeCondition("introductionDate",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("introductionDate",EntityOperator.LESS_THAN_EQUAL_TO,introductionDateLimit));
          filterConditions.add(condition);
        }
        if (releaseDateLimit != null) {
          EntityCondition condition=EntityCondition.makeCondition(EntityCondition.makeCondition("releaseDate",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("releaseDate",EntityOperator.LESS_THAN_EQUAL_TO,releaseDateLimit));
          filterConditions.add(condition);
        }
        if (!filterConditions.isEmpty()) {
          productCategoryMembers=EntityUtil.filterByCondition(productCategoryMembers,EntityCondition.makeCondition(filterConditions,EntityOperator.AND));
        }
        if (UtilValidate.isNotEmpty(viewProductCategoryId)) {
          productCategoryMembers=CategoryWorker.filterProductsInCategory(delegator,productCategoryMembers,viewProductCategoryId);
          listSize=productCategoryMembers.size();
        }
        listSize=productCategoryMembers.size();
        if (highIndex > listSize) {
          highIndex=listSize;
        }
        if (limitView) {
          if (UtilValidate.isNotEmpty(productCategoryMembers)) {
            productCategoryMembers=productCategoryMembers.subList(lowIndex - 1,highIndex);
          }
        }
 else {
          lowIndex=1;
          highIndex=listSize;
        }
      }
 else {
        List<EntityCondition> mainCondList=FastList.newInstance();
        mainCondList.add(EntityCondition.makeCondition("productCategoryId",EntityOperator.EQUALS,productCategory.getString("productCategoryId")));
        if (activeOnly) {
          mainCondList.add(EntityCondition.makeCondition("fromDate",EntityOperator.LESS_THAN_EQUAL_TO,nowTimestamp));
          mainCondList.add(EntityCondition.makeCondition(EntityCondition.makeCondition("thruDate",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("thruDate",EntityOperator.GREATER_THAN,nowTimestamp)));
        }
        if (introductionDateLimit != null) {
          mainCondList.add(EntityCondition.makeCondition(EntityCondition.makeCondition("introductionDate",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("introductionDate",EntityOperator.LESS_THAN_EQUAL_TO,introductionDateLimit)));
        }
        if (releaseDateLimit != null) {
          mainCondList.add(EntityCondition.makeCondition(EntityCondition.makeCondition("releaseDate",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("releaseDate",EntityOperator.LESS_THAN_EQUAL_TO,releaseDateLimit)));
        }
        EntityCondition mainCond=EntityCondition.makeCondition(mainCondList,EntityOperator.AND);
        EntityFindOptions findOpts=new EntityFindOptions(true,EntityFindOptions.TYPE_SCROLL_INSENSITIVE,EntityFindOptions.CONCUR_READ_ONLY,false);
        findOpts.setMaxRows(highIndex);
        EntityListIterator pli=delegator.find(entityName,mainCond,null,null,orderByFields,findOpts);
        if (limitView) {
          if (viewProductCategoryId != null) {
            productCategoryMembers=FastList.newInstance();
            GenericValue nextValue;
            int chunkSize=0;
            listSize=0;
            while ((nextValue=pli.next()) != null) {
              String productId=nextValue.getString("productId");
              if (CategoryWorker.isProductInCategory(delegator,productId,viewProductCategoryId)) {
                if (listSize + 1 >= lowIndex && chunkSize < viewSize) {
                  productCategoryMembers.add(nextValue);
                  chunkSize++;
                }
                listSize++;
              }
            }
          }
 else {
            productCategoryMembers=pli.getPartialList(lowIndex,viewSize);
            listSize=pli.getResultsSizeAfterPartialList();
          }
        }
 else {
          productCategoryMembers=pli.getCompleteList();
          if (UtilValidate.isNotEmpty(viewProductCategoryId)) {
            productCategoryMembers=CategoryWorker.filterProductsInCategory(delegator,productCategoryMembers,viewProductCategoryId);
          }
          listSize=productCategoryMembers.size();
          lowIndex=1;
          highIndex=listSize;
        }
        if (productCategoryMembers == null) {
          productCategoryMembers=FastList.newInstance();
        }
        if (highIndex > listSize) {
          highIndex=listSize;
        }
        pli.close();
      }
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,module);
    }
  }
  Map<String,Object> result=FastMap.newInstance();
  result.put("viewIndex",Integer.valueOf(viewIndex));
  result.put("viewSize",Integer.valueOf(viewSize));
  result.put("lowIndex",Integer.valueOf(lowIndex));
  result.put("highIndex",Integer.valueOf(highIndex));
  result.put("listSize",Integer.valueOf(listSize));
  if (productCategory != null)   result.put("productCategory",productCategory);
  if (productCategoryMembers != null)   result.put("productCategoryMembers",productCategoryMembers);
  return result;
}
