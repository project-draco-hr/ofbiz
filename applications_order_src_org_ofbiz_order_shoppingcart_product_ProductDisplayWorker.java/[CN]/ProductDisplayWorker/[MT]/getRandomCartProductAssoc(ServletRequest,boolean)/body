{
  Delegator delegator=(Delegator)request.getAttribute("delegator");
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  ShoppingCart cart=(ShoppingCart)httpRequest.getSession().getAttribute("shoppingCart");
  if (cart == null || cart.size() <= 0)   return null;
  List<GenericValue> cartAssocs=null;
  try {
    Map<String,GenericValue> products=FastMap.newInstance();
    Iterator<ShoppingCartItem> cartiter=cart.iterator();
    while (cartiter != null && cartiter.hasNext()) {
      ShoppingCartItem item=cartiter.next();
      List<GenericValue> complementProducts=delegator.findByAndCache("ProductAssoc",UtilMisc.toMap("productId",item.getProductId(),"productAssocTypeId","PRODUCT_COMPLEMENT"),null);
      complementProducts=EntityUtil.filterByDate(complementProducts);
      List<GenericValue> productsCategories=delegator.findByAndCache("ProductCategoryMember",UtilMisc.toMap("productId",item.getProductId()),null);
      productsCategories=EntityUtil.filterByDate(productsCategories,true);
      if (productsCategories != null) {
        Iterator<GenericValue> productsCategoriesIter=productsCategories.iterator();
        while (productsCategoriesIter.hasNext()) {
          GenericValue productsCategoryMember=productsCategoriesIter.next();
          GenericValue productsCategory=productsCategoryMember.getRelatedOneCache("ProductCategory");
          if ("CROSS_SELL_CATEGORY".equals(productsCategory.getString("productCategoryTypeId"))) {
            List<GenericValue> curPcms=productsCategory.getRelatedCache("ProductCategoryMember");
            if (curPcms != null) {
              Iterator<GenericValue> curPcmsIter=curPcms.iterator();
              while (curPcmsIter.hasNext()) {
                GenericValue curPcm=curPcmsIter.next();
                if (!products.containsKey(curPcm.getString("productId"))) {
                  GenericValue product=curPcm.getRelatedOneCache("Product");
                  products.put(product.getString("productId"),product);
                }
              }
            }
          }
        }
      }
      if (UtilValidate.isNotEmpty(complementProducts)) {
        Iterator<GenericValue> complIter=complementProducts.iterator();
        while (complIter.hasNext()) {
          GenericValue productAssoc=complIter.next();
          if (!products.containsKey(productAssoc.getString("productIdTo"))) {
            GenericValue product=productAssoc.getRelatedOneCache("AssocProduct");
            products.put(product.getString("productId"),product);
          }
        }
      }
    }
    cartiter=cart.iterator();
    while (cartiter != null && cartiter.hasNext()) {
      ShoppingCartItem item=cartiter.next();
      products.remove(item.getProductId());
    }
    if (checkViewAllow) {
      String currentCatalogId=CatalogWorker.getCurrentCatalogId(request);
      String viewProductCategoryId=CatalogWorker.getCatalogViewAllowCategoryId(delegator,currentCatalogId);
      if (viewProductCategoryId != null) {
        List<GenericValue> tempList=FastList.newInstance();
        tempList.addAll(products.values());
        tempList=CategoryWorker.filterProductsInCategory(delegator,tempList,viewProductCategoryId,"productId");
        cartAssocs=FastList.newInstance();
        cartAssocs.addAll(tempList);
      }
    }
    if (cartAssocs == null) {
      cartAssocs=FastList.newInstance();
      cartAssocs.addAll(products.values());
    }
    while (cartAssocs.size() > 3) {
      int toRemove=(int)(Math.random() * cartAssocs.size());
      cartAssocs.remove(toRemove);
    }
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e,module);
  }
  if (UtilValidate.isNotEmpty(cartAssocs)) {
    return cartAssocs;
  }
 else {
    return null;
  }
}
