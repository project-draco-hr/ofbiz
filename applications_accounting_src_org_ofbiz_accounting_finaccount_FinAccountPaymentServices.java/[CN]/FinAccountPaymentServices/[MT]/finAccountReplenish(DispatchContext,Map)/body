{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  GenericDelegator delegator=dctx.getDelegator();
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  String productStoreId=(String)context.get("productStoreId");
  String finAccountId=(String)context.get("finAccountId");
  GenericValue finAccount;
  try {
    finAccount=delegator.findByPrimaryKey("FinAccount",UtilMisc.toMap("finAccountId",finAccountId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (finAccount == null) {
    return ServiceUtil.returnError("Invalid financial account [" + finAccountId + "]");
  }
  String currency=finAccount.getString("currencyUomId");
  GenericValue finAccountType;
  try {
    finAccountType=finAccount.getRelatedOne("FinAccountType");
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  String replenishEnumId=finAccountType.getString("replenishEnumId");
  if (!"FARP_AUTOMATIC".equals(replenishEnumId)) {
    return ServiceUtil.returnSuccess();
  }
  if (productStoreId == null) {
    productStoreId=getLastProductStoreId(delegator,finAccountId);
    if (productStoreId == null) {
      return ServiceUtil.returnError("Cannot locate product store from previous deposits; product store cannot be empty");
    }
  }
  GenericValue finAccountSettings;
  try {
    finAccountSettings=delegator.findByPrimaryKeyCache("ProductStoreFinActSetting",UtilMisc.toMap("productStoreId",productStoreId,"finAccountTypeId",finAccount.getString("finAccountTypeId")));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (finAccountSettings == null) {
    return ServiceUtil.returnSuccess();
  }
  Double replThres=finAccountSettings.getDouble("replenishThreshold");
  if (replThres == null) {
    return ServiceUtil.returnSuccess();
  }
  BigDecimal replenishThreshold=new BigDecimal(replThres);
  BigDecimal replenishLevel=finAccount.getBigDecimal("replenishLevel");
  if (replenishLevel == null || replenishLevel.compareTo(FinAccountHelper.ZERO) == 0) {
    return ServiceUtil.returnSuccess();
  }
  BigDecimal balance=finAccount.getBigDecimal("actualBalance");
  if (balance.compareTo(replenishThreshold) > -1) {
    return ServiceUtil.returnSuccess();
  }
  Map rollbackCtx=UtilMisc.toMap("userLogin",userLogin,"finAccountId",finAccountId,"inGoodStanding","N");
  try {
    dispatcher.addRollbackService("updateFinAccount",rollbackCtx,true);
  }
 catch (  GenericServiceException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  BigDecimal depositAmount=replenishLevel.subtract(balance);
  String ownerPartyId=finAccount.getString("ownerPartyId");
  if (ownerPartyId == null) {
    Debug.logWarning("No owner attached to financial account [" + finAccountId + "] cannot auto-replenish",module);
    return ServiceUtil.returnSuccess();
  }
  String paymentMethodId=finAccount.getString("replenishPaymentId");
  if (paymentMethodId == null) {
    Debug.logError("No payment method attached to financial account [" + finAccountId + "] cannot auto-replenish",module);
    return ServiceUtil.returnError("No payment method associated with replenish account");
  }
  GenericValue paymentMethod;
  try {
    paymentMethod=delegator.findByPrimaryKey("PaymentMethod",UtilMisc.toMap("paymentMethodId",paymentMethodId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (paymentMethod == null) {
    Debug.logWarning("No payment method found for ID [" + paymentMethodId + "] for party ["+ ownerPartyId+ "] cannot auto-replenish",module);
    return ServiceUtil.returnError("Cannot locate payment method ID [" + paymentMethodId + "]");
  }
  Map orderItemMap=UtilMisc.toMap("Auto-Replenishment FA #" + finAccountId,depositAmount.doubleValue());
  Map replOrderCtx=FastMap.newInstance();
  replOrderCtx.put("productStoreId",productStoreId);
  replOrderCtx.put("paymentMethodId",paymentMethod.getString("paymentMethodId"));
  replOrderCtx.put("currency",currency);
  replOrderCtx.put("partyId",ownerPartyId);
  replOrderCtx.put("itemMap",orderItemMap);
  replOrderCtx.put("userLogin",userLogin);
  Map replResp;
  try {
    replResp=dispatcher.runSync("createSimpleNonProductSalesOrder",replOrderCtx);
  }
 catch (  GenericServiceException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (ServiceUtil.isError(replResp)) {
    return replResp;
  }
  String orderId=(String)replResp.get("orderId");
  Map depositCtx=FastMap.newInstance();
  depositCtx.put("productStoreId",productStoreId);
  depositCtx.put("finAccountId",finAccountId);
  depositCtx.put("currency",currency);
  depositCtx.put("partyId",ownerPartyId);
  depositCtx.put("orderId",orderId);
  depositCtx.put("orderItemSeqId","00001");
  depositCtx.put("amount",new Double(depositAmount.doubleValue()));
  depositCtx.put("userLogin",userLogin);
  Map depositResp;
  try {
    depositResp=dispatcher.runSync("finAccountDeposit",depositCtx);
  }
 catch (  GenericServiceException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (ServiceUtil.isError(depositResp)) {
    return depositResp;
  }
  finAccount.set("inGoodStanding","Y");
  try {
    finAccount.store();
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  return ServiceUtil.returnSuccess();
}
