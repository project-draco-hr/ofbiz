{
  Writer writer=null;
  try {
    boolean useOutputStreamNotWriter=false;
    if (this.servletContext != null) {
      useOutputStreamNotWriter=UtilJ2eeCompat.useOutputStreamNotWriter(this.servletContext);
    }
    if (useOutputStreamNotWriter) {
      ServletOutputStream ros=response.getOutputStream();
      writer=new OutputStreamWriter(ros,"UTF-8");
    }
 else {
      writer=response.getWriter();
    }
    String compressHTML=UtilProperties.getPropertyValue("widget","compress.HTML");
    if (UtilValidate.isEmpty(compressHTML) && this.servletContext != null) {
      compressHTML=(String)this.servletContext.getAttribute("compressHTML");
    }
    if ("true".equals(compressHTML)) {
      writer=new StandardCompress().getWriter(writer,null);
    }
    ScreenRenderer screens=new ScreenRenderer(writer,null,htmlScreenRenderer);
    screens.populateContextForRequest(request,response,servletContext);
    FreeMarkerWorker.getSiteParameters(request,screens.getContext());
    screens.getContext().put("formStringRenderer",new HtmlFormRenderer(request,response));
    screens.getContext().put("simpleEncoder",StringUtil.htmlEncoder);
    htmlScreenRenderer.renderScreenBegin(writer,screens.getContext());
    screens.render(page);
    htmlScreenRenderer.renderScreenEnd(writer,screens.getContext());
  }
 catch (  IOException e) {
    throw new ViewHandlerException("Error in the response writer/output stream: " + e.toString(),e);
  }
catch (  SAXException e) {
    throw new ViewHandlerException("XML Error rendering page: " + e.toString(),e);
  }
catch (  ParserConfigurationException e) {
    throw new ViewHandlerException("XML Error rendering page: " + e.toString(),e);
  }
catch (  GeneralException e) {
    throw new ViewHandlerException("Lower level error rendering page: " + e.toString(),e);
  }
catch (  TemplateModelException e) {
    throw new ViewHandlerException("Whitespace compression error rendering page: " + e.toString(),e);
  }
}
