{
  Locale locale=UtilHttp.getLocale(request);
  HashMap results=new HashMap();
  HashMap formInput=new HashMap();
  results.put("formInput",formInput);
  ServletFileUpload fu=new ServletFileUpload(new DiskFileItemFactory(10240,new File("runtime/tmp")));
  java.util.List lst=null;
  try {
    lst=fu.parseRequest(request);
  }
 catch (  FileUploadException e4) {
    return ServiceUtil.returnError(e4.getMessage());
  }
  if (lst.size() == 0) {
    String errMsg=UtilProperties.getMessage(LayoutWorker.err_resource,"layoutEvents.no_files_uploaded",locale);
    request.setAttribute("_ERROR_MESSAGE_",errMsg);
    return ServiceUtil.returnError("No files uploaded.");
  }
  FileItem fi=null;
  FileItem imageFi=null;
  for (int i=0; i < lst.size(); i++) {
    fi=(FileItem)lst.get(i);
    String fn=fi.getName();
    String fieldName=fi.getFieldName();
    String fieldStr=fi.getString();
    if (fi.isFormField()) {
      formInput.put(fieldName,fieldStr);
    }
    if (fieldName.equals(uploadField))     imageFi=fi;
  }
  if (imageFi == null) {
    Map messageMap=UtilMisc.toMap("imageFi",imageFi);
    String errMsg=UtilProperties.getMessage(LayoutWorker.err_resource,"layoutEvents.image_null",messageMap,locale);
    request.setAttribute("_ERROR_MESSAGE_",errMsg);
    return null;
  }
  byte[] imageBytes=imageFi.get();
  ByteWrapper byteWrap=new ByteWrapper(imageBytes);
  results.put("imageData",byteWrap);
  results.put("imageFileName",imageFi.getName());
  return results;
}
