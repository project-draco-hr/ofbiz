{
  Map<String,Object> result=FastMap.newInstance();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  Delegator delegator=dctx.getDelegator();
  String imageServerPath=FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog","image.server.path"),context);
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  String productId=(String)context.get("productId");
  String imageName=(String)context.get("imageName");
  String imageWidth=(String)context.get("imageWidth");
  String imageHeight=(String)context.get("imageHeight");
  if (UtilValidate.isEmpty(context.get("frameContentId")) || UtilValidate.isEmpty(context.get("frameDataResourceId"))) {
    result=ServiceUtil.returnError("Required frame image content ID or dataResource ID parameters. Please upload new frame image or choose the exist frame.");
    result.putAll(context);
  }
  if (UtilValidate.isEmpty(context.get("imageWidth")) || UtilValidate.isEmpty(context.get("imageHeight"))) {
    result=ServiceUtil.returnError("Image Width and Image Height are required to create the image. Please enter in Image Width and Image Height fields.");
    result.putAll(context);
  }
  String frameContentId=(String)context.get("frameContentId");
  String frameDataResourceId=(String)context.get("frameDataResourceId");
  String frameImageName=null;
  try {
    GenericValue contentDataResourceView=delegator.findByPrimaryKey("ContentDataResourceView",UtilMisc.toMap("contentId",frameContentId,"drDataResourceId",frameDataResourceId));
    frameImageName=contentDataResourceView.getString("contentName");
  }
 catch (  Exception e) {
    Debug.logError(e,module);
    result=ServiceUtil.returnError(e.getMessage());
    result.putAll(context);
  }
  if (UtilValidate.isNotEmpty(imageName)) {
    BufferedImage bufImg1=ImageIO.read(new File(imageServerPath + "/products/management/" + productId+ "/"+ imageName));
    BufferedImage bufImg2=ImageIO.read(new File(imageServerPath + "/products/management/frame/" + frameImageName));
    int bufImgType;
    if (BufferedImage.TYPE_CUSTOM == bufImg1.getType()) {
      bufImgType=BufferedImage.TYPE_INT_ARGB_PRE;
    }
 else {
      bufImgType=bufImg1.getType();
    }
    int width=Integer.parseInt(imageWidth);
    int height=Integer.parseInt(imageHeight);
    Map<String,Object> contentCtx=FastMap.newInstance();
    contentCtx.put("contentTypeId","DOCUMENT");
    contentCtx.put("userLogin",userLogin);
    Map<String,Object> contentResult=FastMap.newInstance();
    try {
      contentResult=dispatcher.runSync("createContent",contentCtx);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      result=ServiceUtil.returnError(e.getMessage());
      result.putAll(context);
    }
    Map<String,Object> contentThumb=FastMap.newInstance();
    contentThumb.put("contentTypeId","DOCUMENT");
    contentThumb.put("userLogin",userLogin);
    Map<String,Object> contentThumbResult=FastMap.newInstance();
    try {
      contentThumbResult=dispatcher.runSync("createContent",contentThumb);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      result=ServiceUtil.returnError(e.getMessage());
      result.putAll(context);
    }
    String contentIdThumb=(String)contentThumbResult.get("contentId");
    String contentId=(String)contentResult.get("contentId");
    String filenameToUse=(String)contentResult.get("contentId") + ".jpg";
    String filenameTouseThumb=(String)contentThumbResult.get("contentId") + ".jpg";
    Image newImg1=bufImg1.getScaledInstance((int)width,(int)height,Image.SCALE_SMOOTH);
    Image newImg2=bufImg2.getScaledInstance((int)width,(int)height,Image.SCALE_SMOOTH);
    BufferedImage bufNewImg=combineBufferedImage(newImg1,newImg2,bufImgType);
    String mimeType=imageName.substring(imageName.lastIndexOf(".") + 1);
    ImageIO.write((RenderedImage)bufNewImg,mimeType,new File(imageServerPath + "/products/management/" + productId+ "/"+ filenameToUse));
    double imgHeight=bufNewImg.getHeight();
    double imgWidth=bufNewImg.getWidth();
    Map<String,Object> resultResize=ImageManagementServices.resizeImageThumbnail(bufNewImg,imgHeight,imgWidth);
    ImageIO.write((RenderedImage)resultResize.get("bufferedImage"),mimeType,new File(imageServerPath + "/products/management/" + productId+ "/"+ filenameTouseThumb));
    String imageUrlResource="/images/products/management/" + productId + "/"+ filenameToUse;
    String imageUrlThumb="/images/products/management/" + productId + "/"+ filenameTouseThumb;
    ImageManagementServices.createContentAndDataResource(dctx,userLogin,filenameToUse,imageUrlResource,contentId);
    ImageManagementServices.createContentAndDataResource(dctx,userLogin,filenameTouseThumb,imageUrlThumb,contentIdThumb);
    Map<String,Object> createContentAssocMap=FastMap.newInstance();
    createContentAssocMap.put("contentAssocTypeId","IMAGE_THUMBNAIL");
    createContentAssocMap.put("contentId",contentId);
    createContentAssocMap.put("contentIdTo",contentIdThumb);
    createContentAssocMap.put("userLogin",userLogin);
    try {
      dispatcher.runSync("createContentAssoc",createContentAssocMap);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      result=ServiceUtil.returnError(e.getMessage());
      result.putAll(context);
    }
    Map<String,Object> productContentCtx=FastMap.newInstance();
    productContentCtx.put("productId",productId);
    productContentCtx.put("productContentTypeId","IMAGE");
    productContentCtx.put("fromDate",UtilDateTime.nowTimestamp());
    productContentCtx.put("userLogin",userLogin);
    productContentCtx.put("contentId",contentId);
    productContentCtx.put("statusId","IM_PENDING");
    try {
      dispatcher.runSync("createProductContent",productContentCtx);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      result=ServiceUtil.returnError(e.getMessage());
      result.putAll(context);
    }
    Map<String,Object> partyContentCtx=FastMap.newInstance();
    partyContentCtx.put("contentId",contentId);
    partyContentCtx.put("userLogin",userLogin);
    try {
      dispatcher.runSync("createImagePartyContent",partyContentCtx);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      result=ServiceUtil.returnError(e.getMessage());
      result.putAll(context);
    }
  }
 else {
    String errMsg="Please select Image.";
    Debug.logFatal(errMsg,module);
    result=ServiceUtil.returnError(errMsg);
    result.putAll(context);
  }
  String successMsg="Frame image successfully.";
  result=ServiceUtil.returnSuccess(successMsg);
  return result;
}
