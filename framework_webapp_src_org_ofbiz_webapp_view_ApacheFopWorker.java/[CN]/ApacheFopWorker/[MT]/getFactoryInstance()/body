{
  if (fopFactory == null) {
synchronized (ApacheFopWorker.class) {
      if (fopFactory != null) {
        return fopFactory;
      }
      fopFactory=FopFactory.newInstance();
      fopFactory.setStrictValidation(false);
      try {
        String ofbizHome=System.getProperty("ofbiz.home");
        String fopPath=UtilProperties.getPropertyValue("fop.properties","fop.path","/framework/webapp/config");
        File userConfigFile=FileUtil.getFile(ofbizHome + fopPath + "/fop.xconf");
        if (userConfigFile.exists()) {
          fopFactory.setUserConfig(userConfigFile);
          URL baseUrl=new URL(fopFactory.getBaseURL());
          Integer baseport=baseUrl.getPort();
          Integer port=baseport + Start.getInstance().getConfig().portOffset;
          fopFactory.setBaseURL("http://localhost:" + port);
        }
 else {
          Debug.logWarning("FOP configuration file not found: " + userConfigFile,module);
        }
        String fopFontBaseProperty=UtilProperties.getPropertyValue("fop.properties","fop.font.base.url","/framework/webapp/config/");
        File fontBaseFile=FileUtil.getFile(ofbizHome + fopFontBaseProperty);
        if (fontBaseFile.isDirectory()) {
          fopFactory.getFontManager().setFontBaseURL(fontBaseFile.toURI().toURL().toString());
        }
 else {
          Debug.logWarning("FOP font base URL not found: " + fontBaseFile,module);
        }
        Debug.logInfo("FOP FontBaseURL: " + fopFactory.getFontManager().getFontBaseURL(),module);
      }
 catch (      Exception e) {
        Debug.logWarning(e,"Error reading FOP configuration: ",module);
      }
    }
  }
  return fopFactory;
}
