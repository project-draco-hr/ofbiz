{
  GenericDelegator delegator=dctx.getDelegator();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  List shipmentIds=(List)context.get("shipmentIds");
  Locale locale=(Locale)context.get("locale");
  Boolean createSalesInvoicesForDropShipments=(Boolean)context.get("createSalesInvoicesForDropShipments");
  if (UtilValidate.isEmpty(createSalesInvoicesForDropShipments))   createSalesInvoicesForDropShipments=Boolean.FALSE;
  boolean salesShipmentFound=false;
  boolean purchaseShipmentFound=false;
  boolean dropShipmentFound=false;
  List invoicesCreated=new ArrayList();
  for (int i=0; i < shipmentIds.size(); i++) {
    String tmpShipmentId=(String)shipmentIds.get(i);
    try {
      GenericValue shipment=delegator.findByPrimaryKey("Shipment",UtilMisc.toMap("shipmentId",tmpShipmentId));
      if ((shipment.getString("shipmentTypeId") != null) && (shipment.getString("shipmentTypeId").equals("PURCHASE_SHIPMENT"))) {
        purchaseShipmentFound=true;
      }
 else       if ((shipment.getString("shipmentTypeId") != null) && (shipment.getString("shipmentTypeId").equals("DROP_SHIPMENT"))) {
        dropShipmentFound=true;
      }
 else {
        salesShipmentFound=true;
      }
      if (purchaseShipmentFound && salesShipmentFound && dropShipmentFound) {
        return ServiceUtil.returnError(UtilProperties.getMessage(resource,"AccountingShipmentsOfDifferentTypes",UtilMisc.toMap("tmpShipmentId",tmpShipmentId,"shipmentTypeId",shipment.getString("shipmentTypeId")),locale));
      }
    }
 catch (    GenericEntityException e) {
      String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleGettingShipmentEntity",UtilMisc.toMap("tmpShipmentId",tmpShipmentId),locale);
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  EntityCondition shipmentIdsCond=new EntityExpr("shipmentId",EntityOperator.IN,shipmentIds);
  List items=null;
  List orderItemAssocs=null;
  try {
    if (purchaseShipmentFound) {
      items=delegator.findByCondition("ShipmentReceipt",shipmentIdsCond,null,UtilMisc.toList("shipmentId"));
      if (items != null) {
        Iterator itemsIter=items.iterator();
        while (itemsIter.hasNext()) {
          GenericValue item=(GenericValue)itemsIter.next();
          GenericValue inventoryItem=item.getRelatedOne("InventoryItem");
          GenericValue ownerPartyRole=delegator.findByPrimaryKeyCache("PartyRole",UtilMisc.toMap("partyId",inventoryItem.getString("ownerPartyId"),"roleTypeId","INTERNAL_ORGANIZATIO"));
          if (UtilValidate.isEmpty(ownerPartyRole)) {
            items.remove(item);
          }
        }
      }
    }
 else     if (dropShipmentFound) {
      List shipments=delegator.findByCondition("Shipment",shipmentIdsCond,null,null);
      List purchaseOrderIds=EntityUtil.getFieldListFromEntityList(shipments,"primaryOrderId",true);
      if (createSalesInvoicesForDropShipments.booleanValue()) {
        orderItemAssocs=delegator.findByCondition("OrderItemAssoc",new EntityExpr("toOrderId",EntityOperator.IN,purchaseOrderIds),null,null);
        items=EntityUtil.getRelated("FromOrderItem",orderItemAssocs);
      }
 else {
        items=delegator.findByCondition("OrderItem",new EntityExpr("orderId",EntityOperator.IN,purchaseOrderIds),null,null);
      }
    }
 else {
      items=delegator.findByCondition("ItemIssuance",shipmentIdsCond,null,UtilMisc.toList("shipmentId"));
    }
  }
 catch (  GenericEntityException e) {
    String errMsg=UtilProperties.getMessage(resource,"AccountingProblemGettingItemsFromShipments",locale);
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
  if (items == null) {
    Debug.logInfo("No items issued for shipments",module);
    return ServiceUtil.returnSuccess();
  }
  Map shippedOrderItems=new HashMap();
  Iterator itemsIter=items.iterator();
  while (itemsIter.hasNext()) {
    GenericValue item=(GenericValue)itemsIter.next();
    String orderId=item.getString("orderId");
    String orderItemSeqId=item.getString("orderItemSeqId");
    List itemsByOrder=(List)shippedOrderItems.get(orderId);
    if (itemsByOrder == null) {
      itemsByOrder=new ArrayList();
    }
    Map billFields=UtilMisc.toMap("orderId",orderId,"orderItemSeqId",orderItemSeqId);
    if (dropShipmentFound) {
      itemsByOrder.add(item);
      shippedOrderItems.put(orderId,itemsByOrder);
      continue;
    }
 else     if (item.getEntityName().equals("ItemIssuance")) {
      billFields.put("itemIssuanceId",item.get("itemIssuanceId"));
    }
 else     if (item.getEntityName().equals("ShipmentReceipt")) {
      billFields.put("shipmentReceiptId",item.getString("receiptId"));
    }
    List itemBillings=null;
    try {
      itemBillings=delegator.findByAnd("OrderItemBilling",billFields);
    }
 catch (    GenericEntityException e) {
      String errMsg=UtilProperties.getMessage(resource,"AccountingProblemLookingUpOrderItemBilling",UtilMisc.toMap("billFields",billFields),locale);
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
    if (itemBillings == null || itemBillings.size() == 0) {
      itemsByOrder.add(item);
    }
    shippedOrderItems.put(orderId,itemsByOrder);
  }
  Set orders=shippedOrderItems.keySet();
  Iterator ordersIter=orders.iterator();
  while (ordersIter.hasNext()) {
    String orderId=(String)ordersIter.next();
    List billItems=(List)shippedOrderItems.get(orderId);
    List toBillItems=new ArrayList();
    Map itemQtyAvail=new HashMap();
    Iterator billIt=billItems.iterator();
    while (billIt.hasNext()) {
      GenericValue issue=(GenericValue)billIt.next();
      BigDecimal issueQty=ZERO;
      if (issue.getEntityName().equals("ShipmentReceipt")) {
        issueQty=issue.getBigDecimal("quantityAccepted");
      }
 else {
        issueQty=issue.getBigDecimal("quantity");
      }
      BigDecimal billAvail=(BigDecimal)itemQtyAvail.get(issue.getString("orderItemSeqId"));
      if (billAvail == null) {
        Map lookup=UtilMisc.toMap("orderId",orderId,"orderItemSeqId",issue.get("orderItemSeqId"));
        GenericValue orderItem=null;
        List billed=null;
        BigDecimal orderedQty=null;
        try {
          orderItem=issue.getEntityName().equals("OrderItem") ? issue : issue.getRelatedOne("OrderItem");
          orderedQty=orderItem.getBigDecimal("quantity");
          if (dropShipmentFound && createSalesInvoicesForDropShipments.booleanValue()) {
            GenericValue orderItemAssoc=EntityUtil.getFirst(EntityUtil.filterByAnd(orderItemAssocs,UtilMisc.toMap("orderId",issue.getString("orderId"),"orderItemSeqId",issue.getString("orderItemSeqId"))));
            GenericValue purchaseOrderItem=orderItemAssoc.getRelatedOne("ToOrderItem");
            orderItem.set("quantity",purchaseOrderItem.getDouble("quantity"));
            issueQty=purchaseOrderItem.getBigDecimal("quantity");
          }
          billed=delegator.findByAnd("OrderItemBilling",lookup);
        }
 catch (        GenericEntityException e) {
          String errMsg=UtilProperties.getMessage(resource,"AccountingProblemGettingOrderItemOrderItemBilling",UtilMisc.toMap("lookup",lookup),locale);
          Debug.logError(e,errMsg,module);
          return ServiceUtil.returnError(errMsg);
        }
        if (billed != null && billed.size() > 0) {
          BigDecimal billedQuantity=ZERO;
          Iterator bi=billed.iterator();
          while (bi.hasNext()) {
            GenericValue oib=(GenericValue)bi.next();
            BigDecimal qty=oib.getBigDecimal("quantity");
            if (qty != null) {
              billedQuantity=billedQuantity.add(qty).setScale(decimals,rounding);
            }
          }
          BigDecimal leftToBill=orderedQty.subtract(billedQuantity).setScale(decimals,rounding);
          billAvail=leftToBill;
        }
 else {
          billAvail=orderedQty;
        }
      }
      if (billAvail != null && billAvail.signum() == 1) {
        if (issueQty != null && issueQty.doubleValue() > billAvail.doubleValue()) {
          issue.set("quantity",new Double(billAvail.doubleValue()));
          billAvail=ZERO;
        }
 else {
          billAvail=billAvail.subtract(issueQty).setScale(decimals,rounding);
        }
        toBillItems.add(issue);
      }
      itemQtyAvail.put(issue.getString("orderItemSeqId"),billAvail);
    }
    OrderReadHelper orh=new OrderReadHelper(delegator,orderId);
    GenericValue productStore=orh.getProductStore();
    if ("N".equalsIgnoreCase(productStore.getString("prorateShipping"))) {
      List invoiceableShipments=null;
      try {
        if (dropShipmentFound) {
          List invoiceablePrimaryOrderIds=null;
          if (createSalesInvoicesForDropShipments.booleanValue()) {
            List invoiceableLinkedOrderIds=EntityUtil.getFieldListFromEntityList(toBillItems,"orderId",true);
            List reverseOrderItemAssocs=EntityUtil.filterByCondition(orderItemAssocs,new EntityExpr("orderId",EntityOperator.IN,invoiceableLinkedOrderIds));
            invoiceablePrimaryOrderIds=EntityUtil.getFieldListFromEntityList(reverseOrderItemAssocs,"toOrderId",true);
          }
 else {
            invoiceablePrimaryOrderIds=EntityUtil.getFieldListFromEntityList(toBillItems,"orderId",true);
          }
          if (!UtilValidate.isEmpty(invoiceablePrimaryOrderIds)) {
            List invoiceableShipmentConds=UtilMisc.toList(new EntityExpr("primaryOrderId",EntityOperator.IN,invoiceablePrimaryOrderIds),new EntityExpr("shipmentId",EntityOperator.IN,shipmentIds));
            invoiceableShipments=delegator.findByCondition("Shipment",new EntityConditionList(invoiceableShipmentConds,EntityOperator.AND),null,null);
          }
        }
 else {
          List invoiceableShipmentIds=EntityUtil.getFieldListFromEntityList(toBillItems,"shipmentId",true);
          if (!UtilValidate.isEmpty(invoiceableShipmentIds)) {
            invoiceableShipments=delegator.findByCondition("Shipment",new EntityExpr("shipmentId",EntityOperator.IN,invoiceableShipmentIds),null,null);
          }
        }
      }
 catch (      GenericEntityException e) {
        String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingCreateInvoicesFromShipmentsService",locale);
        Debug.logError(e,errMsg,module);
        return ServiceUtil.returnError(errMsg);
      }
      Map additionalShippingCharges=new HashMap();
      BigDecimal totalAdditionalShippingCharges=ZERO;
      if (!UtilValidate.isEmpty(invoiceableShipments)) {
        Iterator isit=invoiceableShipments.iterator();
        while (isit.hasNext()) {
          GenericValue shipment=(GenericValue)isit.next();
          if (shipment.get("additionalShippingCharge") == null)           continue;
          BigDecimal shipmentAdditionalShippingCharges=shipment.getBigDecimal("additionalShippingCharge").setScale(decimals,rounding);
          additionalShippingCharges.put(shipment,shipmentAdditionalShippingCharges);
          totalAdditionalShippingCharges=totalAdditionalShippingCharges.add(shipmentAdditionalShippingCharges);
        }
      }
      if (totalAdditionalShippingCharges.signum() == 1) {
        Iterator ascit=additionalShippingCharges.keySet().iterator();
        while (ascit.hasNext()) {
          GenericValue shipment=(GenericValue)ascit.next();
          String shipmentId=shipment.getString("shipmentId");
          BigDecimal additionalShippingCharge=(BigDecimal)additionalShippingCharges.get(shipment);
          Map createOrderAdjustmentContext=new HashMap();
          createOrderAdjustmentContext.put("orderId",orderId);
          createOrderAdjustmentContext.put("orderAdjustmentTypeId","SHIPPING_CHARGES");
          String addtlChargeDescription=shipment.getString("addtlShippingChargeDesc");
          if (UtilValidate.isEmpty(addtlChargeDescription)) {
            addtlChargeDescription=UtilProperties.getMessage(resource,"AccountingAdditionalShippingChargeForShipment",UtilMisc.toMap("shipmentId",shipmentId),locale);
          }
          createOrderAdjustmentContext.put("description",addtlChargeDescription);
          createOrderAdjustmentContext.put("sourceReferenceId",shipmentId);
          createOrderAdjustmentContext.put("amount",new Double(additionalShippingCharge.doubleValue()));
          createOrderAdjustmentContext.put("userLogin",context.get("userLogin"));
          String shippingOrderAdjustmentId=null;
          try {
            Map createOrderAdjustmentResult=dispatcher.runSync("createOrderAdjustment",createOrderAdjustmentContext);
            shippingOrderAdjustmentId=(String)createOrderAdjustmentResult.get("orderAdjustmentId");
          }
 catch (          GenericServiceException e) {
            String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingCreateOrderAdjustmentService",locale);
            Debug.logError(e,errMsg,module);
            return ServiceUtil.returnError(errMsg);
          }
          GenericValue billToParty=orh.getBillToParty();
          GenericValue payToParty=orh.getBillFromParty();
          GenericValue destinationContactMech=null;
          try {
            destinationContactMech=shipment.getRelatedOne("DestinationPostalAddress");
          }
 catch (          GenericEntityException e) {
            String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingCreateInvoicesFromShipmentService",locale);
            Debug.logError(e,errMsg,module);
            return ServiceUtil.returnError(errMsg);
          }
          List emptyList=new ArrayList();
          Map calcTaxContext=new HashMap();
          calcTaxContext.put("productStoreId",orh.getProductStoreId());
          calcTaxContext.put("payToPartyId",payToParty.getString("partyId"));
          calcTaxContext.put("billToPartyId",billToParty.getString("partyId"));
          calcTaxContext.put("orderShippingAmount",totalAdditionalShippingCharges);
          calcTaxContext.put("shippingAddress",destinationContactMech);
          calcTaxContext.put("itemProductList",emptyList);
          calcTaxContext.put("itemAmountList",emptyList);
          calcTaxContext.put("itemPriceList",emptyList);
          calcTaxContext.put("itemShippingList",emptyList);
          List orderAdjustments=null;
          Map calcTaxResult=null;
          try {
            calcTaxResult=dispatcher.runSync("calcTax",calcTaxContext);
          }
 catch (          GenericServiceException e) {
            String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingCalcTaxService",locale);
            Debug.logError(e,errMsg,module);
            return ServiceUtil.returnError(errMsg);
          }
          orderAdjustments=(List)calcTaxResult.get("orderAdjustments");
          if (calcTaxResult != null && orderAdjustments != null) {
            Iterator oait=orderAdjustments.iterator();
            while (oait.hasNext()) {
              GenericValue orderAdjustment=(GenericValue)oait.next();
              totalAdditionalShippingCharges=totalAdditionalShippingCharges.add(orderAdjustment.getBigDecimal("amount").setScale(decimals,rounding));
              orderAdjustment.set("orderAdjustmentId",delegator.getNextSeqId("OrderAdjustment"));
              orderAdjustment.set("orderId",orderId);
              orderAdjustment.set("orderItemSeqId","_NA_");
              orderAdjustment.set("shipGroupSeqId",shipment.getString("primaryShipGroupSeqId"));
              orderAdjustment.set("originalAdjustmentId",shippingOrderAdjustmentId);
            }
            try {
              delegator.storeAll(orderAdjustments);
            }
 catch (            GenericEntityException e) {
              String errMsg=UtilProperties.getMessage(resource,"AccountingProblemStoringOrderAdjustments",UtilMisc.toMap("orderAdjustments",orderAdjustments),locale);
              Debug.logError(e,errMsg,module);
              return ServiceUtil.returnError(errMsg);
            }
          }
          List orderPaymentPreferences=new ArrayList();
          try {
            orderPaymentPreferences=delegator.findByAnd("OrderPaymentPreference",UtilMisc.toMap("orderId",orderId,"paymentMethodTypeId","CREDIT_CARD"));
          }
 catch (          GenericEntityException e) {
            String errMsg=UtilProperties.getMessage(resource,"AccountingProblemGettingOrderPaymentPreferences",locale);
            Debug.logError(e,errMsg,module);
            return ServiceUtil.returnError(errMsg);
          }
          String paymentMethodId=null;
          GenericValue cardOrderPaymentPref=EntityUtil.getFirst(orderPaymentPreferences);
          if (cardOrderPaymentPref != null) {
            paymentMethodId=cardOrderPaymentPref.getString("paymentMethodId");
          }
          if (paymentMethodId != null) {
            BigDecimal totalNewAuthAmount=new BigDecimal(totalAdditionalShippingCharges.doubleValue()).setScale(decimals,rounding);
            Iterator oppit=orderPaymentPreferences.iterator();
            while (oppit.hasNext()) {
              GenericValue orderPaymentPreference=(GenericValue)oppit.next();
              if (!(orderPaymentPreference.getString("statusId").equals("PAYMENT_SETTLED") || orderPaymentPreference.getString("statusId").equals("PAYMENT_CANCELLED"))) {
                GenericValue authTransaction=PaymentGatewayServices.getAuthTransaction(orderPaymentPreference);
                if (authTransaction != null && authTransaction.get("amount") != null) {
                  totalNewAuthAmount=totalNewAuthAmount.add(authTransaction.getBigDecimal("amount").setScale(decimals,rounding));
                  Map prefReleaseResult=null;
                  try {
                    prefReleaseResult=dispatcher.runSync("releaseOrderPaymentPreference",UtilMisc.toMap("orderPaymentPreferenceId",orderPaymentPreference.getString("orderPaymentPreferenceId"),"userLogin",context.get("userLogin")));
                  }
 catch (                  GenericServiceException e) {
                    String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingReleaseOrderPaymentPreferenceService",locale);
                    Debug.logError(e,errMsg,module);
                    return ServiceUtil.returnError(errMsg);
                  }
                  if (ServiceUtil.isError(prefReleaseResult) || ServiceUtil.isFailure(prefReleaseResult)) {
                    String errMsg=ServiceUtil.getErrorMessage(prefReleaseResult);
                    Debug.logError(errMsg,module);
                    return ServiceUtil.returnError(errMsg);
                  }
                }
              }
            }
            Map serviceContext=UtilMisc.toMap("orderId",orderId,"paymentMethodId",paymentMethodId,"paymentMethodTypeId","CREDIT_CARD","userLogin",context.get("userLogin"));
            String orderPaymentPreferenceId=null;
            try {
              Map result=dispatcher.runSync("createOrderPaymentPreference",serviceContext);
              orderPaymentPreferenceId=(String)result.get("orderPaymentPreferenceId");
            }
 catch (            GenericServiceException e) {
              String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingCreateOrderPaymentPreferenceService",locale);
              Debug.logError(e,errMsg,module);
              return ServiceUtil.returnError(errMsg);
            }
            Map authResult=null;
            try {
              authResult=dispatcher.runSync("authOrderPaymentPreference",UtilMisc.toMap("orderPaymentPreferenceId",orderPaymentPreferenceId,"overrideAmount",new Double(totalNewAuthAmount.doubleValue()),"userLogin",context.get("userLogin")));
            }
 catch (            GenericServiceException e) {
              String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingAuthOrderPaymentPreferenceService",locale);
              Debug.logError(e,errMsg,module);
              return ServiceUtil.returnError(errMsg);
            }
            boolean authFinished=((Boolean)authResult.get("finished")).booleanValue();
            boolean authErrors=((Boolean)authResult.get("errors")).booleanValue();
            if (authErrors || !authFinished) {
              String errMsg=UtilProperties.getMessage(resource,"AccountingUnableToAuthAdditionalShipCharges",UtilMisc.toMap("shipmentId",shipmentId,"paymentMethodId",paymentMethodId,"orderPaymentPreferenceId",orderPaymentPreferenceId),locale);
              Debug.logError(errMsg,module);
            }
          }
        }
      }
    }
 else {
      Debug.logInfo(UtilProperties.getMessage(resource,"AccountingIgnoringAdditionalShipCharges",productStore.getAllFields(),locale),module);
    }
    Map serviceContext=UtilMisc.toMap("orderId",orderId,"billItems",toBillItems,"userLogin",context.get("userLogin"));
    try {
      Map result=dispatcher.runSync("createInvoiceForOrder",serviceContext);
      invoicesCreated.add(result.get("invoiceId"));
    }
 catch (    GenericServiceException e) {
      String errMsg=UtilProperties.getMessage(resource,"AccountingTroubleCallingCreateInvoiceForOrderService",locale);
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  Map response=ServiceUtil.returnSuccess();
  response.put("invoicesCreated",invoicesCreated);
  return response;
}
