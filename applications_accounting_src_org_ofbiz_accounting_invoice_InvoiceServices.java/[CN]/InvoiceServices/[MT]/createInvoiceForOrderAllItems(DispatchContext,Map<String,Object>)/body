{
  Delegator delegator=dctx.getDelegator();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  try {
    List<GenericValue> orderItems=delegator.findByAnd("OrderItem",UtilMisc.toMap("orderId",(String)context.get("orderId")));
    if (orderItems.size() > 0) {
      context.put("billItems",orderItems);
    }
    GenericValue userLogin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","system"));
    if (userLogin != null) {
      context.put("userLogin",userLogin);
    }
    Map<String,Object> result=dispatcher.runSync("createInvoiceForOrder",context);
    result.remove("invoiceTypeId");
    return result;
  }
 catch (  GenericServiceException e) {
    String errMsg=UtilProperties.getMessage(resource,"AccountingEntityDataProblemCreatingInvoiceFromOrderItems",UtilMisc.toMap("reason",e.toString()),(Locale)context.get("locale"));
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
catch (  GenericEntityException e) {
    String errMsg=UtilProperties.getMessage(resource,"AccountingEntityDataProblemCreatingInvoiceFromOrderItems",UtilMisc.toMap("reason",e.toString()),(Locale)context.get("locale"));
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
}
