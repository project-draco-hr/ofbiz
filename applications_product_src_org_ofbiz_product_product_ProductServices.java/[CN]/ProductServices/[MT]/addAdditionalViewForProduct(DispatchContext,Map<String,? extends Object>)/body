{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  Delegator delegator=dctx.getDelegator();
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  String productId=(String)context.get("productId");
  String productContentTypeId=(String)context.get("productContentTypeId");
  ByteBuffer imageData=(ByteBuffer)context.get("uploadedFile");
  if (UtilValidate.isNotEmpty(context.get("_uploadedFile_fileName"))) {
    String imageFilenameFormat=UtilProperties.getPropertyValue("catalog","image.filename.format");
    String imageServerPath=FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog","image.server.path"),context);
    String imageUrlPrefix=UtilProperties.getPropertyValue("catalog","image.url.prefix");
    FlexibleStringExpander filenameExpander=FlexibleStringExpander.getInstance(imageFilenameFormat);
    String id=productId + "_View_" + productContentTypeId.charAt(productContentTypeId.length() - 1);
    String fileLocation=filenameExpander.expandString(UtilMisc.toMap("location","products","type","additional","id",id));
    String filePathPrefix="";
    String filenameToUse=fileLocation;
    if (fileLocation.lastIndexOf("/") != -1) {
      filePathPrefix=fileLocation.substring(0,fileLocation.lastIndexOf("/") + 1);
      filenameToUse=fileLocation.substring(fileLocation.lastIndexOf("/") + 1);
    }
    List<GenericValue> fileExtension=FastList.newInstance();
    try {
      fileExtension=delegator.findByAnd("FileExtension",UtilMisc.toMap("mimeTypeId",(String)context.get("_uploadedFile_contentType")));
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError(e.getMessage());
    }
    GenericValue extension=EntityUtil.getFirst(fileExtension);
    if (extension != null) {
      filenameToUse+="." + extension.getString("fileExtensionId");
    }
    File file=new File(imageServerPath + "/" + filePathPrefix+ filenameToUse);
    try {
      RandomAccessFile out=new RandomAccessFile(file,"rw");
      out.write(imageData.array());
      out.close();
    }
 catch (    FileNotFoundException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError("Unable to open file for writing: " + file.getAbsolutePath());
    }
catch (    IOException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError("Unable to write binary data to: " + file.getAbsolutePath());
    }
    String viewNumber=String.valueOf(productContentTypeId.charAt(productContentTypeId.length() - 1));
    Map<String,Object> resultResize=FastMap.newInstance();
    try {
      resultResize.putAll(ScaleImage.scaleImageInAllSize(context,filenameToUse,"additional",viewNumber));
    }
 catch (    IOException e) {
      String errMsg="Scale additional image in all different sizes is impossible : " + e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
catch (    JDOMException e) {
      String errMsg="Errors occur in parsing ImageProperties.xml : " + e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
    String imageUrl=imageUrlPrefix + "/" + filePathPrefix+ filenameToUse;
    if (UtilValidate.isNotEmpty(imageUrl) && imageUrl.length() > 0) {
      String contentId=(String)context.get("contentId");
      Map<String,Object> dataResourceCtx=FastMap.newInstance();
      dataResourceCtx.put("objectInfo",imageUrl);
      dataResourceCtx.put("dataResourceName",(String)context.get("_uploadedFile_fileName"));
      dataResourceCtx.put("userLogin",userLogin);
      Map<String,Object> productContentCtx=FastMap.newInstance();
      productContentCtx.put("productId",productId);
      productContentCtx.put("productContentTypeId",productContentTypeId);
      productContentCtx.put("fromDate",(Timestamp)context.get("fromDate"));
      productContentCtx.put("thruDate",(Timestamp)context.get("thruDate"));
      productContentCtx.put("userLogin",userLogin);
      if (UtilValidate.isNotEmpty(contentId)) {
        GenericValue content=null;
        try {
          content=delegator.findOne("Content",UtilMisc.toMap("contentId",contentId),false);
        }
 catch (        GenericEntityException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(e.getMessage());
        }
        if (content != null) {
          GenericValue dataResource=null;
          try {
            dataResource=content.getRelatedOne("DataResource");
          }
 catch (          GenericEntityException e) {
            Debug.logError(e,module);
            return ServiceUtil.returnError(e.getMessage());
          }
          if (dataResource != null) {
            dataResourceCtx.put("dataResourceId",dataResource.getString("dataResourceId"));
            try {
              dispatcher.runSync("updateDataResource",dataResourceCtx);
            }
 catch (            GenericServiceException e) {
              Debug.logError(e,module);
              return ServiceUtil.returnError(e.getMessage());
            }
          }
 else {
            dataResourceCtx.put("dataResourceTypeId","SHORT_TEXT");
            dataResourceCtx.put("mimeTypeId","text/html");
            Map<String,Object> dataResourceResult=FastMap.newInstance();
            try {
              dataResourceResult=dispatcher.runSync("createDataResource",dataResourceCtx);
            }
 catch (            GenericServiceException e) {
              Debug.logError(e,module);
              return ServiceUtil.returnError(e.getMessage());
            }
            Map<String,Object> contentCtx=FastMap.newInstance();
            contentCtx.put("contentId",contentId);
            contentCtx.put("dataResourceId",dataResourceResult.get("dataResourceId"));
            contentCtx.put("userLogin",userLogin);
            try {
              dispatcher.runSync("updateContent",contentCtx);
            }
 catch (            GenericServiceException e) {
              Debug.logError(e,module);
              return ServiceUtil.returnError(e.getMessage());
            }
          }
          productContentCtx.put("contentId",contentId);
          try {
            dispatcher.runSync("updateProductContent",productContentCtx);
          }
 catch (          GenericServiceException e) {
            Debug.logError(e,module);
            return ServiceUtil.returnError(e.getMessage());
          }
        }
      }
 else {
        dataResourceCtx.put("dataResourceTypeId","SHORT_TEXT");
        dataResourceCtx.put("mimeTypeId","text/html");
        Map<String,Object> dataResourceResult=FastMap.newInstance();
        try {
          dataResourceResult=dispatcher.runSync("createDataResource",dataResourceCtx);
        }
 catch (        GenericServiceException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(e.getMessage());
        }
        Map<String,Object> contentCtx=FastMap.newInstance();
        contentCtx.put("contentTypeId","DOCUMENT");
        contentCtx.put("dataResourceId",dataResourceResult.get("dataResourceId"));
        contentCtx.put("userLogin",userLogin);
        Map<String,Object> contentResult=FastMap.newInstance();
        try {
          contentResult=dispatcher.runSync("createContent",contentCtx);
        }
 catch (        GenericServiceException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(e.getMessage());
        }
        productContentCtx.put("contentId",contentResult.get("contentId"));
        try {
          dispatcher.runSync("createProductContent",productContentCtx);
        }
 catch (        GenericServiceException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(e.getMessage());
        }
      }
    }
  }
  return ServiceUtil.returnSuccess();
}
