{
  String variantProductId=null;
  try {
    for (    String paramValue : selectedFeatures) {
      List<GenericValue> incompatibilityVariants=delegator.findByAndCache("ProductFeatureIactn",UtilMisc.toMap("productId",productId,"productFeatureIactnTypeId","FEATURE_IACTN_INCOMP"));
      for (      GenericValue incompatibilityVariant : incompatibilityVariants) {
        String featur=incompatibilityVariant.getString("productFeatureId");
        if (paramValue.equals(featur)) {
          String featurTo=incompatibilityVariant.getString("productFeatureIdTo");
          for (          String paramValueTo : selectedFeatures) {
            if (featurTo.equals(paramValueTo)) {
              Debug.logWarning("Incompatible features",module);
              return null;
            }
          }
        }
      }
      List<GenericValue> dependenciesVariants=delegator.findByAndCache("ProductFeatureIactn",UtilMisc.toMap("productId",productId,"productFeatureIactnTypeId","FEATURE_IACTN_DEPEND"));
      for (      GenericValue dpVariant : dependenciesVariants) {
        String featur=dpVariant.getString("productFeatureId");
        if (paramValue.equals(featur)) {
          String featurTo=dpVariant.getString("productFeatureIdTo");
          boolean found=false;
          for (          String paramValueTo : selectedFeatures) {
            if (featurTo.equals(paramValueTo)) {
              found=true;
              break;
            }
          }
          if (!found) {
            Debug.logWarning("Dependency features",module);
            return null;
          }
        }
      }
    }
    List<GenericValue> productAssocs=EntityUtil.filterByDate(delegator.findByAnd("ProductAssoc",UtilMisc.toMap("productId",productId,"productAssocTypeId","PRODUCT_VARIANT")));
    boolean productFound=false;
    nextProd:     for (    GenericValue productAssoc : productAssocs) {
      for (      String featureId : selectedFeatures) {
        List<GenericValue> pAppls=delegator.findByAndCache("ProductFeatureAppl",UtilMisc.toMap("productId",productAssoc.getString("productIdTo"),"productFeatureId",featureId,"productFeatureApplTypeId","STANDARD_FEATURE"));
        if (UtilValidate.isEmpty(pAppls)) {
          continue nextProd;
        }
      }
      productFound=true;
      variantProductId=productAssoc.getString("productIdTo");
      break;
    }
    if (!productFound) {
      GenericValue product=delegator.findOne("Product",UtilMisc.toMap("productId",productId),false);
      product.put("isVariant","Y");
      product.put("isVirtual","N");
      product.put("productId",delegator.getNextSeqId("Product"));
      product.remove("virtualVariantMethodEnum");
      product.create();
      GenericValue productFeatureAppl=delegator.makeValue("ProductFeatureAppl",UtilMisc.toMap("productId",product.getString("productId"),"productFeatureApplTypeId","STANDARD_FEATURE"));
      productFeatureAppl.put("fromDate",UtilDateTime.nowTimestamp());
      for (      String productFeatureId : selectedFeatures) {
        productFeatureAppl.put("productFeatureId",productFeatureId);
        productFeatureAppl.create();
      }
      List<GenericValue> stdFeaturesAppls=EntityUtil.filterByDate(delegator.findByAnd("ProductFeatureAppl",UtilMisc.toMap("productId",productId,"productFeatureApplTypeId","STANDARD_FEATURE")));
      for (      GenericValue stdFeaturesAppl : stdFeaturesAppls) {
        stdFeaturesAppl.put("productId",product.getString("productId"));
        stdFeaturesAppl.create();
      }
      List<GenericValue> productPrices=EntityUtil.filterByDate(delegator.findByAnd("ProductPrice",UtilMisc.toMap("productId",productId)));
      for (      GenericValue productPrice : productPrices) {
        for (        String selectedFeaturedId : selectedFeatures) {
          List<GenericValue> productFeaturePrices=EntityUtil.filterByDate(delegator.findByAnd("ProductFeaturePrice",UtilMisc.toMap("productFeatureId",selectedFeaturedId,"productPriceTypeId",productPrice.getString("productPriceTypeId"))));
          if (UtilValidate.isNotEmpty(productFeaturePrices)) {
            GenericValue productFeaturePrice=productFeaturePrices.get(0);
            if (UtilValidate.isNotEmpty(productFeaturePrice)) {
              productPrice.put("price",productPrice.getBigDecimal("price").add(productFeaturePrice.getBigDecimal("price")));
            }
          }
        }
        if (productPrice.get("price") == null) {
          productPrice.put("price",productPrice.getBigDecimal("price"));
        }
        productPrice.put("productId",product.getString("productId"));
        productPrice.create();
      }
      GenericValue productAssoc=delegator.makeValue("ProductAssoc",UtilMisc.toMap("productId",productId,"productIdTo",product.getString("productId"),"productAssocTypeId","PRODUCT_VARIANT"));
      productAssoc.put("fromDate",UtilDateTime.nowTimestamp());
      productAssoc.create();
      Debug.logInfo("set the productId to: " + product.getString("productId"),module);
      List<GenericValue> supplierProducts=delegator.findByAndCache("SupplierProduct",UtilMisc.toMap("productId",productId));
      for (      GenericValue supplierProduct : supplierProducts) {
        supplierProduct.set("productId",product.getString("productId"));
        supplierProduct.create();
      }
      List<GenericValue> productContents=delegator.findByAndCache("ProductContent",UtilMisc.toMap("productId",productId));
      for (      GenericValue productContent : productContents) {
        productContent.set("productId",product.getString("productId"));
        productContent.create();
      }
      variantProductId=product.getString("productId");
    }
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
  }
  return variantProductId;
}
