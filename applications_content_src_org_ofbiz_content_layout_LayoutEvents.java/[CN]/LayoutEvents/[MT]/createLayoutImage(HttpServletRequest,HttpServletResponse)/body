{
  Locale locale=UtilHttp.getLocale(request);
  try {
    GenericDelegator delegator=(GenericDelegator)request.getAttribute("delegator");
    LocalDispatcher dispatcher=(LocalDispatcher)request.getAttribute("dispatcher");
    HttpSession session=request.getSession();
    Map uploadResults=LayoutWorker.uploadImageAndParameters(request,"imageData");
    Map formInput=(Map)uploadResults.get("formInput");
    Map context=FastMap.newInstance();
    ByteBuffer byteWrap=(ByteBuffer)uploadResults.get("imageData");
    if (byteWrap == null) {
      String errMsg=UtilProperties.getMessage(LayoutEvents.err_resource,"layoutEvents.image_data_null",locale);
      request.setAttribute("_ERROR_MESSAGE_",errMsg);
      return "error";
    }
    String imageFileName=(String)uploadResults.get("imageFileName");
    String imageFileNameExt=null;
    if (UtilValidate.isNotEmpty(imageFileName)) {
      int pos=imageFileName.lastIndexOf(".");
      if (pos >= 0)       imageFileNameExt=imageFileName.substring(pos + 1);
    }
    String mimeTypeId="image/" + imageFileNameExt;
    List errorMessages=FastList.newInstance();
    if (locale == null)     locale=Locale.getDefault();
    context.put("locale",locale);
    try {
      SimpleMapProcessor.runSimpleMapProcessor("org/ofbiz/content/ContentManagementMapProcessors.xml","contentIn",formInput,context,errorMessages,locale);
      SimpleMapProcessor.runSimpleMapProcessor("org/ofbiz/content/ContentManagementMapProcessors.xml","dataResourceIn",formInput,context,errorMessages,locale);
      SimpleMapProcessor.runSimpleMapProcessor("org/ofbiz/content/ContentManagementMapProcessors.xml","contentAssocIn",formInput,context,errorMessages,locale);
    }
 catch (    MiniLangException e) {
      request.setAttribute("_ERROR_MESSAGE_",e.getMessage());
      return "error";
    }
    context.put("dataResourceName",context.get("contentName"));
    context.put("userLogin",session.getAttribute("userLogin"));
    context.put("dataResourceTypeId","IMAGE_OBJECT");
    context.put("contentAssocTypeId","SUB_CONTENT");
    context.put("contentTypeId","DOCUMENT");
    context.put("contentIdTo",formInput.get("contentIdTo"));
    context.put("textData",formInput.get("textData"));
    String contentPurposeTypeId=(String)formInput.get("contentPurposeTypeId");
    if (UtilValidate.isNotEmpty(contentPurposeTypeId)) {
      context.put("contentPurposeList",UtilMisc.toList(contentPurposeTypeId));
    }
    Map result=dispatcher.runSync("persistContentAndAssoc",context);
    String dataResourceId=(String)result.get("dataResourceId");
    String activeContentId=(String)result.get("contentId");
    if (UtilValidate.isNotEmpty(activeContentId)) {
      Map context2=FastMap.newInstance();
      context2.put("activeContentId",activeContentId);
      context2.put("contentAssocTypeId",result.get("contentAssocTypeId"));
      context2.put("fromDate",result.get("fromDate"));
      request.setAttribute("contentId",result.get("contentId"));
      request.setAttribute("drDataResourceId",dataResourceId);
      request.setAttribute("currentEntityName","SubContentDataResourceId");
      context2.put("contentIdTo",formInput.get("contentIdTo"));
      context2.put("mapKey",formInput.get("mapKey"));
      Map result2=dispatcher.runSync("deactivateAssocs",context2);
    }
    GenericValue dataResource=delegator.findByPrimaryKey("DataResource",UtilMisc.toMap("dataResourceId",dataResourceId));
    if (dataResource != null) {
      dataResource.set("objectInfo",imageFileName);
      dataResource.set("mimeTypeId",mimeTypeId);
      dataResource.store();
    }
    GenericValue imageDataResource=delegator.findByPrimaryKey("ImageDataResource",UtilMisc.toMap("dataResourceId",dataResourceId));
    if (imageDataResource == null) {
      imageDataResource=delegator.makeValue("ImageDataResource",UtilMisc.toMap("dataResourceId",dataResourceId));
      imageDataResource.set("imageData",byteWrap.array());
      imageDataResource.create();
    }
 else {
      imageDataResource.set("imageData",byteWrap.array());
      imageDataResource.store();
    }
  }
 catch (  GenericEntityException e3) {
    request.setAttribute("_ERROR_MESSAGE_",e3.getMessage());
    return "error";
  }
catch (  GenericServiceException e) {
    request.setAttribute("_ERROR_MESSAGE_",e.getMessage());
    return "error";
  }
  return "success";
}
