{
  PosTransaction trans=PosTransaction.getCurrentTx(pos.getSession());
  if (!trans.isOpen()) {
    pos.showDialog("dialog/error/terminalclosed");
  }
 else {
    String index=null;
    try {
      index=getSelectedIdx(pos);
    }
 catch (    ArrayIndexOutOfBoundsException e) {
    }
    if (index == null) {
      pos.getOutput().print("Invalid Selection!");
      pos.getJournal().refresh(pos);
      pos.getInput().clear();
    }
    Input input=pos.getInput();
    String value=input.value();
    if (UtilValidate.isNotEmpty(value)) {
      BigDecimal amount=ZERO;
      boolean percent=false;
      if (value.endsWith("%")) {
        percent=true;
        value=value.substring(0,value.length() - 1);
      }
      try {
        amount=new BigDecimal(value);
      }
 catch (      NumberFormatException e) {
      }
      amount=amount.movePointLeft(2).negate();
      trans.addDiscount(index,amount,percent);
      trans.calcTax();
    }
  }
  pos.refresh();
}
