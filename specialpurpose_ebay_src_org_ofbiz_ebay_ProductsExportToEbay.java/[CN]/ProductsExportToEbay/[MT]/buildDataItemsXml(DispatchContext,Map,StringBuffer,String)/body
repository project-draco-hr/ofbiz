{
  Locale locale=(Locale)context.get("locale");
  try {
    GenericDelegator delegator=dctx.getDelegator();
    List selectResult=(List)context.get("selectResult");
    List productsList=delegator.findList("Product",EntityCondition.makeCondition("productId",EntityOperator.IN,selectResult),null,null,null,false);
    try {
      Document itemDocument=UtilXml.makeEmptyXmlDocument("AddItemRequest");
      Element itemRequestElem=itemDocument.getDocumentElement();
      itemRequestElem.setAttribute("xmlns","urn:ebay:apis:eBLBaseComponents");
      appendRequesterCredentials(itemRequestElem,itemDocument,token);
      Iterator productsListItr=productsList.iterator();
      while (productsListItr.hasNext()) {
        GenericValue prod=(GenericValue)productsListItr.next();
        String title=parseText(prod.getString("internalName"));
        String description=parseText(prod.getString("internalName"));
        String qnt=(String)context.get("quantity");
        if (UtilValidate.isEmpty(qnt)) {
          qnt="1";
        }
        String startPrice=(String)context.get("startPrice");
        if (UtilValidate.isEmpty(startPrice)) {
          GenericValue startPriceValue=EntityUtil.getFirst(EntityUtil.filterByDate(prod.getRelatedByAnd("ProductPrice",UtilMisc.toMap("productPricePurposeId","EBAY","productPriceTypeId","MINIMUM_PRICE"))));
          if (UtilValidate.isNotEmpty(startPriceValue)) {
            startPrice=startPriceValue.getString("price");
          }
 else {
            return ServiceUtil.returnFailure("Unable to find a starting price for auction of product with id [" + prod.getString("productId") + "]");
          }
        }
        Element itemElem=UtilXml.addChildElement(itemRequestElem,"Item",itemDocument);
        UtilXml.addChildElementValue(itemElem,"Country",(String)context.get("country"),itemDocument);
        UtilXml.addChildElementValue(itemElem,"Location",(String)context.get("location"),itemDocument);
        UtilXml.addChildElementValue(itemElem,"Currency","USD",itemDocument);
        UtilXml.addChildElementValue(itemElem,"ApplicationData",prod.getString("productId"),itemDocument);
        UtilXml.addChildElementValue(itemElem,"SKU",prod.getString("productId"),itemDocument);
        UtilXml.addChildElementValue(itemElem,"Title",title,itemDocument);
        UtilXml.addChildElementValue(itemElem,"Description",description,itemDocument);
        UtilXml.addChildElementValue(itemElem,"ListingDuration",(String)context.get("listingDuration"),itemDocument);
        UtilXml.addChildElementValue(itemElem,"Quantity",qnt,itemDocument);
        setPaymentMethodAccepted(itemDocument,itemElem,context);
        setMiscDetails(itemDocument,itemElem,context);
        String categoryCode=(String)context.get("ebayCategory");
        String categoryParent="";
        if (categoryCode != null) {
          String[] params=categoryCode.split("_");
          if (params == null || params.length != 3) {
            ServiceUtil.returnFailure(UtilProperties.getMessage(resource,"productsExportToEbay.parametersNotCorrectInGetEbayCategories",locale));
          }
 else {
            categoryParent=params[1];
          }
        }
        Element primaryCatElem=UtilXml.addChildElement(itemElem,"PrimaryCategory",itemDocument);
        UtilXml.addChildElementValue(primaryCatElem,"CategoryID",categoryParent,itemDocument);
        Element startPriceElem=UtilXml.addChildElementValue(itemElem,"StartPrice",startPrice,itemDocument);
        startPriceElem.setAttribute("currencyID","USD");
      }
      dataItemsXml.append(UtilXml.writeXmlDocument(itemDocument));
    }
 catch (    Exception e) {
      Debug.logError("Exception during building data items to eBay: " + e.getMessage(),module);
      return ServiceUtil.returnFailure(UtilProperties.getMessage(resource,"productsExportToEbay.exceptionDuringBuildingDataItemsToEbay",locale));
    }
  }
 catch (  Exception e) {
    Debug.logError("Exception during building data items to eBay: " + e.getMessage(),module);
    return ServiceUtil.returnFailure(UtilProperties.getMessage(resource,"productsExportToEbay.exceptionDuringBuildingDataItemsToEbay",locale));
  }
  return ServiceUtil.returnSuccess();
}
