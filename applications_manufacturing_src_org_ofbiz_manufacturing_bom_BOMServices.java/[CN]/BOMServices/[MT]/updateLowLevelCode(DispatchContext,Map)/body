{
  Map result=new HashMap();
  GenericDelegator delegator=dctx.getDelegator();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  String productId=(String)context.get("productIdTo");
  Boolean alsoComponents=(Boolean)context.get("alsoComponents");
  if (alsoComponents == null) {
    alsoComponents=Boolean.TRUE;
  }
  Boolean alsoVariants=(Boolean)context.get("alsoVariants");
  if (alsoVariants == null) {
    alsoVariants=Boolean.TRUE;
  }
  Long llc=null;
  try {
    GenericValue product=delegator.findByPrimaryKey("Product",UtilMisc.toMap("productId",productId));
    Map depthResult=dispatcher.runSync("getMaxDepth",UtilMisc.toMap("productId",productId,"bomType","MANUF_COMPONENT"));
    llc=(Long)depthResult.get("depth");
    List virtualProducts=delegator.findByAnd("ProductAssoc",UtilMisc.toMap("productIdTo",productId,"productAssocTypeId","PRODUCT_VARIANT"));
    virtualProducts=EntityUtil.filterByDate(virtualProducts);
    int virtualMaxDepth=0;
    Iterator virtualProductsIt=virtualProducts.iterator();
    while (virtualProductsIt.hasNext()) {
      int virtualDepth=0;
      GenericValue oneVirtualProductAssoc=(GenericValue)virtualProductsIt.next();
      GenericValue virtualProduct=delegator.findByPrimaryKey("Product",UtilMisc.toMap("productId",oneVirtualProductAssoc.getString("productId")));
      if (virtualProduct.get("billOfMaterialLevel") != null) {
        virtualDepth=virtualProduct.getLong("billOfMaterialLevel").intValue();
      }
 else {
        virtualDepth=0;
      }
      if (virtualDepth > virtualMaxDepth) {
        virtualMaxDepth=virtualDepth;
      }
    }
    if (virtualMaxDepth > llc.intValue()) {
      llc=new Long(virtualMaxDepth);
    }
    product.set("billOfMaterialLevel",llc);
    product.store();
    if (alsoComponents.booleanValue()) {
      Map treeResult=dispatcher.runSync("getBOMTree",UtilMisc.toMap("productId",productId,"bomType","MANUF_COMPONENT"));
      BOMTree tree=(BOMTree)treeResult.get("tree");
      ArrayList products=new ArrayList();
      tree.print(products,llc.intValue());
      for (int i=0; i < products.size(); i++) {
        BOMNode oneNode=(BOMNode)products.get(i);
        GenericValue oneProduct=oneNode.getProduct();
        int lev=0;
        if (oneProduct.get("billOfMaterialLevel") != null) {
          lev=oneProduct.getLong("billOfMaterialLevel").intValue();
        }
        if (lev < oneNode.getDepth()) {
          oneProduct.set("billOfMaterialLevel",new Long(oneNode.getDepth()));
          oneProduct.store();
        }
      }
    }
    if (alsoVariants.booleanValue()) {
      List variantProducts=delegator.findByAnd("ProductAssoc",UtilMisc.toMap("productId",productId,"productAssocTypeId","PRODUCT_VARIANT"));
      variantProducts=EntityUtil.filterByDate(variantProducts,true);
      Iterator variantProductsIt=variantProducts.iterator();
      while (variantProductsIt.hasNext()) {
        GenericValue oneVariantProductAssoc=(GenericValue)variantProductsIt.next();
        GenericValue variantProduct=delegator.findByPrimaryKey("Product",UtilMisc.toMap("productId",oneVariantProductAssoc.getString("productId")));
        variantProduct.set("billOfMaterialLevel",llc);
        variantProduct.store();
      }
    }
  }
 catch (  Exception e) {
    return ServiceUtil.returnError("Error running updateLowLevelCode: " + e.getMessage());
  }
  result.put("lowLevelCode",llc);
  return result;
}
