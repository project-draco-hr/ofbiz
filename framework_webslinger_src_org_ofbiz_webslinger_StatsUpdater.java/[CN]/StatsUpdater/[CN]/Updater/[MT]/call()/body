{
  EntityHolder oldEntities;
  EntityHolder newEntities=new EntityHolder(Updater.class,"entities",null);
  do {
    oldEntities=entities.get();
  }
 while (!entities.compareAndSet(oldEntities,newEntities));
synchronized (Updater.class) {
    for (    GenericPK pk : oldEntities.keys()) {
      try {
        Map<String,Long> add=oldEntities.get(pk);
        GenericValue existing=pk.getDelegator().findOne(pk.getEntityName(),pk,false);
        if (existing == null) {
          existing=pk.getDelegator().create(pk.getEntityName(),pk);
        }
        for (        Map.Entry<String,Long> entry : add.entrySet()) {
          Long value=entry.getValue();
          Long oldValue=existing.getLong(entry.getKey());
          if (oldValue != null) {
            existing.put(entry.getKey(),Long.valueOf(value.longValue() + oldValue.longValue()));
          }
 else {
            existing.put(entry.getKey(),value);
          }
        }
        existing.store();
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
  }
  return null;
}
