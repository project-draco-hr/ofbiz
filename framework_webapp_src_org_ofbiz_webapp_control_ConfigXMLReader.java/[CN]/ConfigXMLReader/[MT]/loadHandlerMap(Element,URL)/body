{
  long startTime=System.currentTimeMillis();
  Map<String,Map<String,String>> map=FastMap.newInstance();
  if (root == null) {
    root=loadDocument(xml);
  }
  if (root == null) {
    return map;
  }
  for (  Element includeElement : UtilXml.childElementList(root,INCLUDE)) {
    String includeLocation=includeElement.getAttribute(INCLUDE_LOCATION);
    if ((includeLocation != null) && (includeLocation.length() > 0)) {
      try {
        Map<String,Map<String,String>> subMap=loadHandlerMap(null,FlexibleLocation.resolveLocation(includeLocation));
        Map<String,String> newViewHandlerMap=checkMap(subMap.get("view"),String.class,String.class);
        Map<String,String> viewHandlerMap=checkMap(map.get("view"),String.class,String.class);
        if (viewHandlerMap == null) {
          map.put("view",newViewHandlerMap);
        }
 else {
          if (newViewHandlerMap != null) {
            viewHandlerMap.putAll(newViewHandlerMap);
          }
        }
        Map<String,String> newEventHandlerMap=checkMap(subMap.get("event"),String.class,String.class);
        Map<String,String> eventHandlerMap=checkMap(map.get("event"),String.class,String.class);
        if (eventHandlerMap == null) {
          map.put("event",newEventHandlerMap);
        }
 else {
          if (newEventHandlerMap != null) {
            eventHandlerMap.putAll(newEventHandlerMap);
          }
        }
      }
 catch (      MalformedURLException mue) {
        Debug.logError(mue,"Error processing include at [" + includeLocation + "]:"+ mue.toString(),module);
      }
    }
  }
  Map<String,String> eventMap=FastMap.newInstance();
  Map<String,String> viewMap=FastMap.newInstance();
  for (  Element handlerElement : UtilXml.childElementList(root,HANDLER)) {
    String hName=checkEmpty(handlerElement.getAttribute(HANDLER_NAME));
    String hClass=checkEmpty(handlerElement.getAttribute(HANDLER_CLASS));
    String hType=checkEmpty(handlerElement.getAttribute(HANDLER_TYPE));
    if (hType.equals("view")) {
      viewMap.put(hName,hClass);
    }
 else {
      eventMap.put(hName,hClass);
    }
  }
  Map<String,String> viewHandlerMap=checkMap(map.get("view"),String.class,String.class);
  if (viewHandlerMap == null) {
    map.put("view",viewMap);
  }
 else {
    if (viewMap != null) {
      viewHandlerMap.putAll(viewMap);
    }
  }
  Map<String,String> eventHandlerMap=checkMap(map.get("event"),String.class,String.class);
  if (eventHandlerMap == null) {
    map.put("event",eventMap);
  }
 else {
    if (eventMap != null) {
      eventHandlerMap.putAll(eventMap);
    }
  }
  if (Debug.verboseOn()) {
    Debug.logVerbose("-------- Handler Mappings --------",module);
    Map<String,String> debugMap=checkMap(map.get("event"),String.class,String.class);
    if (debugMap != null && debugMap.size() > 0) {
      Debug.logVerbose("-------------- EVENT -------------",module);
      for (      Map.Entry<String,String> entry : debugMap.entrySet()) {
        String handlerName=entry.getKey();
        String className=entry.getValue();
        Debug.logVerbose("[EH] : " + handlerName + " => "+ className,module);
      }
    }
    debugMap=checkMap(map.get("view"),String.class,String.class);
    if (debugMap != null && debugMap.size() > 0) {
      Debug.logVerbose("-------------- VIEW --------------",module);
      for (      Map.Entry<String,String> entry : debugMap.entrySet()) {
        String handlerName=entry.getKey();
        String className=entry.getValue();
        Debug.logVerbose("[VH] : " + handlerName + " => "+ className,module);
      }
    }
    Debug.logVerbose("------ End Handler Mappings ------",module);
  }
  double totalSeconds=(System.currentTimeMillis() - startTime) / 1000.0;
  if (Debug.infoOn())   Debug.logInfo("HandlerMap Created: (" + ((Map)map.get("view")).size() + ") view handlers and ("+ ((Map)map.get("event")).size()+ ") request/event handlers in "+ totalSeconds+ "s",module);
  return map;
}
