{
  IteratorTag iteratorTag=(IteratorTag)findAncestorWithClass(this,IteratorTag.class);
  if (iteratorTag == null)   throw new JspTagException("IterateNextTag not inside IteratorTag.");
  Iterator<? extends Object> iterator=iteratorTag.getIterator();
  if (iterator == null || !iterator.hasNext())   return SKIP_BODY;
  if (name == null)   name="next";
  Object element=iterator.next();
  pageContext.setAttribute(name,element);
  if (expandMap) {
    Map<String,?> tempMap=UtilGenerics.cast(element);
    Iterator<Map.Entry<String,?>> mapEntries=UtilGenerics.cast(tempMap.entrySet().iterator());
    while (mapEntries.hasNext()) {
      Map.Entry<String,?> entry=mapEntries.next();
      Object value=entry.getValue();
      if (value == null)       value="";
      pageContext.setAttribute(entry.getKey(),value);
    }
  }
  iteratorTag.setIterator(iterator);
  return EVAL_BODY_AGAIN;
}
