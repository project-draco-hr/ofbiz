{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  GenericDelegator delegator=dctx.getDelegator();
  String orderId=(String)context.get("orderId");
  Locale locale=(Locale)context.get("locale");
  GenericValue orderHeader=null;
  try {
    orderHeader=delegator.findByPrimaryKey("OrderHeader",UtilMisc.toMap("orderId",orderId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorUnableToGetReturnItemInformation",locale));
  }
  Map returnable=new LinkedHashMap();
  if (orderHeader != null) {
    OrderReadHelper orh=new OrderReadHelper(orderHeader);
    EntityConditionList whereConditions=new EntityConditionList(UtilMisc.toList(new EntityExpr("orderId",EntityOperator.EQUALS,orderHeader.getString("orderId")),new EntityExpr("orderItemStatusId",EntityOperator.IN,UtilMisc.toList("ITEM_APPROVED","ITEM_COMPLETED"))),EntityOperator.AND);
    List orderItemQuantitiesIssued=null;
    try {
      orderItemQuantitiesIssued=delegator.findByCondition("OrderItemQuantityReportGroupByItem",whereConditions,null,UtilMisc.toList("orderId","orderItemSeqId","quantityIssued"),UtilMisc.toList("orderItemSeqId"),null);
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorUnableToGetReturnHeaderFromItem",locale));
    }
    if (orderItemQuantitiesIssued != null) {
      Iterator i=orderItemQuantitiesIssued.iterator();
      while (i.hasNext()) {
        GenericValue orderItemQuantityIssued=(GenericValue)i.next();
        GenericValue item=null;
        try {
          item=orderItemQuantityIssued.getRelatedOne("OrderItem");
        }
 catch (        GenericEntityException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorUnableToGetOrderItemInformation",locale));
        }
        Double quantityIssued=orderItemQuantityIssued.getDouble("quantityIssued");
        if (UtilValidate.isEmpty(quantityIssued) || quantityIssued.doubleValue() == 0) {
          try {
            GenericValue itemProduct=item.getRelatedOne("Product");
            if (ProductWorker.isPhysical(itemProduct)) {
              continue;
            }
          }
 catch (          GenericEntityException e) {
            Debug.logError(e,"Problems looking up returnable product type information",module);
            return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorUnableToGetTheItemReturnableProduct",locale));
          }
        }
        Map serviceResult=null;
        try {
          serviceResult=dispatcher.runSync("getReturnableQuantity",UtilMisc.toMap("orderItem",item));
        }
 catch (        GenericServiceException e) {
          Debug.logError(e,module);
          return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorUnableToGetTheItemReturnableQuantity",locale));
        }
        if (serviceResult.containsKey(ModelService.ERROR_MESSAGE)) {
          return ServiceUtil.returnError((String)serviceResult.get(ModelService.ERROR_MESSAGE));
        }
 else {
          if (((Double)serviceResult.get("returnableQuantity")).doubleValue() == 0) {
            continue;
          }
          Map returnInfo=new HashMap();
          returnInfo.put("returnableQuantity",serviceResult.get("returnableQuantity"));
          returnInfo.put("returnablePrice",serviceResult.get("returnablePrice"));
          String itemTypeKey="FINISHED_GOOD";
          GenericValue product=null;
          if (item.get("productId") != null) {
            try {
              product=item.getRelatedOne("Product");
            }
 catch (            GenericEntityException e) {
              Debug.logError(e,module);
              return ServiceUtil.returnError("Unable to obtain order item information!");
            }
          }
          if (product != null) {
            itemTypeKey=product.getString("productTypeId");
          }
 else           if (item != null && item.getString("orderItemTypeId") != null) {
            itemTypeKey=item.getString("orderItemTypeId");
          }
          returnInfo.put("itemTypeKey",itemTypeKey);
          returnable.put(item,returnInfo);
          List itemAdjustments=null;
          try {
            itemAdjustments=orderItem.getRelated("OrderAdjustment");
          }
 catch (          GenericEntityException e) {
            Debug.logError(e,module);
            return ServiceUtil.returnError("Unable to obtain order item adjustments");
          }
          if (UtilValidate.isNotEmpty(itemAdjustments)) {
            Iterator itemAdjustmentsIt=itemAdjustments.iterator();
            while (itemAdjustmentsIt.hasNext()) {
              GenericValue itemAdjustment=(GenericValue)itemAdjustmentsIt.next();
              returnInfo=new HashMap();
              returnInfo.put("returnableQuantity",new Double(1.0));
              returnInfo.put("returnablePrice",itemAdjustment.get("amount"));
              returnInfo.put("itemTypeKey",itemTypeKey);
              returnable.put(itemAdjustment,returnInfo);
            }
          }
        }
      }
    }
 else {
      return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorNoOrderItemsFound",locale));
    }
  }
 else {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource_error,"OrderErrorUnableToFindOrderHeader",locale));
  }
  Map result=ServiceUtil.returnSuccess();
  result.put("returnableItems",returnable);
  return result;
}
