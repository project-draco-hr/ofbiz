{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  GenericDelegator delegator=dctx.getDelegator();
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  String responseId=(String)context.get("returnItemResponseId");
  String errorMsg="Failed to create payment applications for return item response [" + responseId + "]. ";
  try {
    GenericValue response=delegator.findByPrimaryKey("ReturnItemResponse",UtilMisc.toMap("returnItemResponseId",responseId));
    if (response == null) {
      return ServiceUtil.returnError(errorMsg + "Return Item Response not found with ID [" + responseId+ "].");
    }
    BigDecimal responseAmount=response.getBigDecimal("responseAmount").setScale(decimals,rounding);
    String paymentId=response.getString("paymentId");
    Map returnInvoices=FastMap.newInstance();
    List items=response.getRelated("ReturnItem");
    for (Iterator itemIter=items.iterator(); itemIter.hasNext(); ) {
      GenericValue item=(GenericValue)itemIter.next();
      List billings=item.getRelated("ReturnItemBilling");
      for (Iterator billIter=billings.iterator(); billIter.hasNext(); ) {
        GenericValue billing=(GenericValue)billIter.next();
        GenericValue invoice=billing.getRelatedOne("Invoice");
        if (returnInvoices.get(invoice.getString("invoiceId")) == null) {
          returnInvoices.put(invoice.getString("invoiceId"),invoice);
        }
      }
    }
    Map invoiceTotals=FastMap.newInstance();
    BigDecimal grandTotal=ZERO;
    for (Iterator iter=returnInvoices.values().iterator(); iter.hasNext(); ) {
      GenericValue invoice=(GenericValue)iter.next();
      List billings=invoice.getRelated("ReturnItemBilling");
      BigDecimal runningTotal=ZERO;
      for (Iterator billIter=billings.iterator(); billIter.hasNext(); ) {
        GenericValue billing=(GenericValue)billIter.next();
        runningTotal=runningTotal.add(billing.getBigDecimal("amount").multiply(billing.getBigDecimal("quantity")).setScale(decimals,rounding));
      }
      invoiceTotals.put(invoice.getString("invoiceId"),runningTotal);
      grandTotal=grandTotal.add(runningTotal);
    }
    for (Iterator iter=returnInvoices.values().iterator(); iter.hasNext(); ) {
      GenericValue invoice=(GenericValue)iter.next();
      String invoiceId=invoice.getString("invoiceId");
      BigDecimal invoiceTotal=(BigDecimal)invoiceTotals.get(invoiceId);
      BigDecimal amountApplied=responseAmount.multiply(invoiceTotal).divide(grandTotal,decimals,rounding).setScale(decimals,rounding);
      if (paymentId != null) {
        Map input=UtilMisc.toMap("paymentId",paymentId,"invoiceId",invoice.getString("invoiceId"));
        input.put("amountApplied",new Double(amountApplied.doubleValue()));
        input.put("userLogin",userLogin);
        if (response.get("billingAccountId") != null) {
          GenericValue billingAccount=response.getRelatedOne("BillingAccount");
          if (billingAccount != null) {
            input.put("billingAccountId",response.get("billingAccountId"));
          }
        }
        Map serviceResults=dispatcher.runSync("createPaymentApplication",input);
        if (ServiceUtil.isError(serviceResults)) {
          return ServiceUtil.returnError(errorMsg,null,null,serviceResults);
        }
        if (Debug.verboseOn()) {
          Debug.logInfo("Created PaymentApplication for response with amountApplied " + amountApplied.toString(),module);
        }
      }
    }
  }
 catch (  GenericServiceException e) {
    Debug.logError(e,errorMsg + e.getMessage(),module);
    return ServiceUtil.returnError(errorMsg + e.getMessage());
  }
catch (  GenericEntityException e) {
    Debug.logError(e,errorMsg + e.getMessage(),module);
    return ServiceUtil.returnError(errorMsg + e.getMessage());
  }
  return ServiceUtil.returnSuccess();
}
