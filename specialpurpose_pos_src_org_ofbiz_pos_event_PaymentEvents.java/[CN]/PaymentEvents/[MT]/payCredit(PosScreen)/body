{
  PosTransaction trans=PosTransaction.getCurrentTx(pos.getSession());
  Input input=pos.getInput();
  String[] msrInfo=input.getFunction("MSRINFO");
  String[] crtInfo=input.getFunction("CREDIT");
  int paymentCheck=trans.checkPaymentMethodType("CREDIT_CARD");
  if (paymentCheck == PosTransaction.NO_PAYMENT) {
    processNoPayment(pos,"CREDIT_CARD");
    return;
  }
 else   if (paymentCheck == PosTransaction.EXTERNAL_PAYMENT) {
    if (crtInfo == null) {
      input.setFunction("CREDIT");
      pos.getOutput().print(UtilProperties.getMessage("pos","REFNUM",Locale.getDefault()));
      return;
    }
 else {
      processExternalPayment(pos,"CREDIT_CARD",crtInfo[1]);
      return;
    }
  }
  if (crtInfo == null) {
    input.setFunction("CREDIT");
    pos.getOutput().print(UtilProperties.getMessage("pos","CREDNO",Locale.getDefault()));
  }
 else {
    Debug.log("Credit Func Info : " + crtInfo[1],module);
    if (msrInfo == null) {
      if (UtilValidate.isCreditCard(input.value())) {
        input.setFunction("MSRINFO");
        pos.getOutput().print(UtilProperties.getMessage("pos","CREDEX",Locale.getDefault()));
      }
 else {
        Debug.log("Invalid card number - " + input.value(),module);
        input.clearFunction("CREDIT");
        input.clearInput();
        pos.showDialog("dialog/error/invalidcardnumber");
      }
    }
 else {
      String msrInfoStr=msrInfo[1];
      if (UtilValidate.isNotEmpty(input.value())) {
        if (UtilValidate.isNotEmpty(msrInfoStr)) {
          msrInfoStr=msrInfoStr + "|" + input.value();
        }
 else {
          msrInfoStr=input.value();
        }
      }
      input.setFunction("MSRINFO",msrInfoStr);
      String[] msrInfoArr=msrInfoStr.split("\\|");
      int allInfo=msrInfoArr.length;
      String firstName=null;
      String lastName=null;
switch (allInfo) {
case 4:
        lastName=msrInfoArr[3];
case 3:
      firstName=msrInfoArr[2];
case 2:
    double amount=0;
  try {
    amount=processAmount(trans,pos,crtInfo[1]);
    Debug.log("Processing Credit Card Amount : " + amount,module);
  }
 catch (  GeneralException e) {
  }
String cardNumber=msrInfoArr[0];
String expDate=msrInfoArr[1];
String pmId=trans.makeCreditCardVo(cardNumber,expDate,firstName,lastName);
if (pmId != null) {
trans.addPayment(pmId,amount);
}
pos.refresh();
break;
case 1:
pos.getOutput().print(UtilProperties.getMessage("pos","CREDEX",Locale.getDefault()));
break;
default :
Debug.log("Hit the default switch case [" + allInfo + "] refreshing.",module);
input.clearFunction("MSRINFO");
pos.getOutput().print(UtilProperties.getMessage("pos","CREDNO",Locale.getDefault()));
break;
}
}
}
}
