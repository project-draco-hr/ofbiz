{
  PosTransaction trans=PosTransaction.getCurrentTx(pos.getSession());
  if (trans.isEmpty()) {
    PosScreen newPos=pos.showPage("pospanel");
    newPos.showDialog("dialog/error/noitems");
  }
 else   if (trans.getTotalDue().compareTo(BigDecimal.ZERO) > 0) {
    pos.showDialog("dialog/error/notenoughfunds");
    trans.clearPayment("CASH");
  }
 else {
    pos.setWaitCursor();
    PosScreen.currentScreen.getOutput().print(UtilProperties.getMessage(PosTransaction.resource,"PosProcessing",Locale.getDefault()));
    pos.getInput().setLock(true);
    pos.getButtons().setLock(true);
    pos.refresh(false);
    try {
      trans.processSale(pos.getOutput());
      pos.getInput().setFunction("PAID");
    }
 catch (    GeneralException e) {
      Debug.logError(e,e.getMessage(),module);
      pos.getInput().setLock(false);
      pos.getButtons().setLock(false);
      pos.showDialog("dialog/error/exception",e.getMessage());
    }
    clearInputPaymentFunctions(pos);
    pos.setNormalCursor();
  }
}
