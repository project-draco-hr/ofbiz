{
  if (location == null || location.length() == 0) {
    return null;
  }
  String locationType=getLocationType(location);
  LocationResolver resolver=(LocationResolver)locationResolvers.get(locationType);
  if (resolver == null) {
synchronized (FlexibleLocation.class) {
      resolver=(LocationResolver)locationResolvers.get(locationType);
      if (resolver == null) {
        String locationResolverName=UtilProperties.getPropertyValue("locationresolvers",locationType);
        if (locationResolverName == null || locationResolverName.length() == 0) {
          locationResolverName=(String)defaultResolvers.get(locationType);
        }
        if (locationResolverName == null || locationResolverName.length() == 0) {
          throw new MalformedURLException("Could not find a LocationResolver class name for the location type: " + locationType);
        }
        try {
          Class lClass=null;
          try {
            ClassLoader classLoader=Thread.currentThread().getContextClassLoader();
            lClass=classLoader.loadClass(locationResolverName);
          }
 catch (          ClassNotFoundException e) {
            throw new MalformedURLException("Error loading Location Resolver class \"" + locationResolverName + "\": "+ e.toString());
          }
          try {
            resolver=(LocationResolver)lClass.newInstance();
          }
 catch (          IllegalAccessException e) {
            throw new MalformedURLException("Error loading Location Resolver class \"" + locationResolverName + "\": "+ e.toString());
          }
catch (          InstantiationException e) {
            throw new MalformedURLException("Error loading Location Resolver class \"" + locationResolverName + "\": "+ e.toString());
          }
        }
 catch (        SecurityException e) {
          throw new MalformedURLException("Error loading Location Resolver class \"" + locationResolverName + "\": "+ e.toString());
        }
        if (resolver != null) {
          locationResolvers.put(locationType,resolver);
        }
      }
    }
  }
  if (resolver != null) {
    if (loader != null && resolver instanceof ClasspathLocationResolver) {
      ClasspathLocationResolver cplResolver=(ClasspathLocationResolver)resolver;
      return cplResolver.resolveLocation(location,loader);
    }
 else {
      return resolver.resolveLocation(location);
    }
  }
 else {
    throw new MalformedURLException("Could not find a LocationResolver for the location type: " + locationType);
  }
}
