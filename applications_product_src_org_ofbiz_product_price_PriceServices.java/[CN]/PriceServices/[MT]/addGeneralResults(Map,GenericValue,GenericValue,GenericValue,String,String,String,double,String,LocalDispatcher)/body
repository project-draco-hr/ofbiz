{
  result.put("competitivePrice",competitivePriceValue != null ? competitivePriceValue.getDouble("price") : null);
  result.put("specialPromoPrice",specialPromoPriceValue != null ? specialPromoPriceValue.getDouble("price") : null);
  result.put("currencyUsed",currencyUomId);
  if ("Y".equals(checkIncludeVat) && productStore != null && "Y".equals(productStore.getString("showPricesWithVatTax"))) {
    Map calcTaxForDisplayContext=UtilMisc.toMap("productStoreId",productStore.get("productStoreId"),"productId",productId,"quantity",BigDecimal.valueOf(quantity),"basePrice",BigDecimal.valueOf(((Double)result.get("price")).doubleValue()));
    if (UtilValidate.isNotEmpty(partyId)) {
      calcTaxForDisplayContext.put("billToPartyId",partyId);
    }
    try {
      Map calcTaxForDisplayResult=dispatcher.runSync("calcTaxForDisplay",calcTaxForDisplayContext);
      if (ServiceUtil.isError(calcTaxForDisplayResult)) {
        return ServiceUtil.returnError("Error calculating VAT tax (with calcTaxForDisplay service)",null,null,calcTaxForDisplayResult);
      }
      result.put("price",Double.valueOf(((BigDecimal)calcTaxForDisplayResult.get("priceWithTax")).doubleValue()));
      BigDecimal taxPercentage=(BigDecimal)calcTaxForDisplayResult.get("taxPercentage");
      BigDecimal taxMultiplier=ONE_BASE.add(taxPercentage.divide(PERCENT_SCALE,taxCalcScale));
      if (result.get("listPrice") != null) {
        result.put("listPrice",Double.valueOf(BigDecimal.valueOf(((Double)result.get("listPrice")).doubleValue()).multiply(taxMultiplier).setScale(taxFinalScale,taxRounding).doubleValue()));
      }
      if (result.get("defaultPrice") != null) {
        result.put("defaultPrice",Double.valueOf(BigDecimal.valueOf(((Double)result.get("defaultPrice")).doubleValue()).multiply(taxMultiplier).setScale(taxFinalScale,taxRounding).doubleValue()));
      }
      if (result.get("averageCost") != null) {
        result.put("averageCost",Double.valueOf(BigDecimal.valueOf(((Double)result.get("averageCost")).doubleValue()).multiply(taxMultiplier).setScale(taxFinalScale,taxRounding).doubleValue()));
      }
      if (result.get("promoPrice") != null) {
        result.put("promoPrice",Double.valueOf(BigDecimal.valueOf(((Double)result.get("promoPrice")).doubleValue()).multiply(taxMultiplier).setScale(taxFinalScale,taxRounding).doubleValue()));
      }
      if (result.get("competitivePrice") != null) {
        result.put("competitivePrice",Double.valueOf(BigDecimal.valueOf(((Double)result.get("competitivePrice")).doubleValue()).multiply(taxMultiplier).setScale(taxFinalScale,taxRounding).doubleValue()));
      }
    }
 catch (    GenericServiceException e) {
      String errMsg="Error calculating VAT tax (with calcTaxForDisplay service): " + e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  return null;
}
