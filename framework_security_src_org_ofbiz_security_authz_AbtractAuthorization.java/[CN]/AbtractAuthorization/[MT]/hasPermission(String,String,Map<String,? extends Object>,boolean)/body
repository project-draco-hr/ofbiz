{
  String expandedPermission;
  if (!expanded) {
    expandedPermission=FlexibleStringExpander.expandString(permission,context);
  }
 else {
    expandedPermission=permission;
  }
  String threadUid=uid.get();
  if (threadUid != null && !userId.equals(threadUid)) {
    origPermission.remove();
    autoGrant.remove();
    uid.remove();
    threadUid=null;
  }
  if (UtilValidate.isEmpty(threadUid)) {
    origPermission.set(permission);
    uid.set(userId);
  }
  String[] permSplit=expandedPermission.split(":");
  StringBuffer joined=new StringBuffer();
  int index=1;
  if (permSplit != null && permSplit.length > 1) {
    if (Debug.infoOn())     Debug.logInfo("Security 2.0 schema found -- walking tree : " + expandedPermission,module);
    for (    String perm : permSplit) {
      if (permSplit.length >= index) {
        if (joined.length() > 0) {
          joined.append(":");
        }
        joined.append(perm);
        List<String> grantedPerms=autoGrant.get();
        if (grantedPerms != null && grantedPerms.size() > 0) {
          for (          String granted : grantedPerms) {
            if (joined.toString().equals(granted)) {
              handleAutoGrantPermissions(userId,expandedPermission,context);
              return true;
            }
          }
        }
        if (hasStaticPermission(userId,joined.toString(),context)) {
          handleAutoGrantPermissions(userId,expandedPermission,context);
          return true;
        }
      }
      index++;
    }
    String threadPerm=origPermission.get();
    if (!permission.equals(threadPerm)) {
      if (hasDynamicPermission(userId,expandedPermission,context)) {
        handleAutoGrantPermissions(userId,expandedPermission,context);
        return true;
      }
    }
 else {
      Debug.logWarning("Recursive permission check detected; do not call hasPermission() from a dynamic access implementation!",module);
    }
  }
 else {
    Debug.logVerbose("Legacy permission detected; falling back to static permission check",module);
    return hasStaticPermission(userId,expandedPermission,context);
  }
  return false;
}
