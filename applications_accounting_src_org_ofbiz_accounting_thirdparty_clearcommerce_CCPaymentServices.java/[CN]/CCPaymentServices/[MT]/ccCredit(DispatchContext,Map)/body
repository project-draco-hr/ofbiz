{
  String action=new String("Credit");
  if (context.get("pbOrder") != null) {
    action=new String("Auth");
  }
  Document creditRequestDoc=buildPrimaryTxRequest(context,action,(Double)context.get("creditAmount"),(String)context.get("referenceCode"));
  Document creditResponseDoc=null;
  try {
    creditResponseDoc=sendRequest(creditRequestDoc,(String)context.get("paymentConfig"));
  }
 catch (  ClearCommerceException cce) {
    return ServiceUtil.returnError(cce.getMessage());
  }
  if (getMessageListMaxSev(creditResponseDoc) > 4) {
    Map result=ServiceUtil.returnSuccess();
    result.put("creditResult",new Boolean(false));
    result.put("creditAmount",new Double(0.00));
    result.put("creditRefNum",getReferenceNum(creditResponseDoc));
    List messages=getMessageList(creditResponseDoc);
    if (UtilValidate.isNotEmpty(messages)) {
      result.put("internalRespMsgs",messages);
    }
    return result;
  }
  return processCreditResponse(creditResponseDoc);
}
