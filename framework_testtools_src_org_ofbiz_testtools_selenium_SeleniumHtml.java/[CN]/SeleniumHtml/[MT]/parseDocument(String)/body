{
  FileReader reader=new FileReader(filename);
  String firstLine=new BufferedReader(reader).readLine();
  reader.close();
  Document document=null;
  if (firstLine.startsWith("<?xml")) {
    Debug.logInfo("XML detected; using default XML parser.",module);
  }
 else {
    try {
      Class nekoParserClass=Class.forName("org.cyberneko.html.parsers.DOMParser");
      Object parser=nekoParserClass.newInstance();
      Method parse=nekoParserClass.getMethod("parse",new Class[]{String.class});
      Method getDocument=nekoParserClass.getMethod("getDocument",new Class[0]);
      parse.invoke(parser,filename);
      document=(Document)getDocument.invoke(parser);
    }
 catch (    Exception e) {
      Debug.logInfo("NekoHTML HTML parser not found; HTML4 support disabled.",module);
    }
  }
  if (document == null) {
    DocumentBuilderFactory factory=DocumentBuilderFactory.newInstance();
    try {
      factory.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd",false);
    }
 catch (    ParserConfigurationException e) {
      Debug.logInfo("Warning: Could not disable external DTD loading",module);
    }
    DocumentBuilder builder=factory.newDocumentBuilder();
    document=builder.parse(filename);
  }
  return document;
}
