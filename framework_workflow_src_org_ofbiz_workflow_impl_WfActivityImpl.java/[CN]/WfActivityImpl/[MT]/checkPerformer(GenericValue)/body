{
  GenericValue newPerformer=GenericValue.create(performer);
  Map context=processContext();
  String performerType=performer.getString("participantTypeId");
  String partyId=performer.getString("partyId");
  String roleTypeId=performer.getString("roleTypeId");
  if (partyId != null && partyId.trim().toLowerCase().startsWith("expr:")) {
    if (Debug.verboseOn())     Debug.logVerbose("Dynamic performer: Found a party expression",module);
    Object value=null;
    try {
      value=BshUtil.eval(partyId.trim().substring(5).trim(),context);
    }
 catch (    bsh.EvalError e) {
      throw new WfException("Bsh evaluation error occurred.",e);
    }
    if (value != null) {
      if (value instanceof String) {
        newPerformer.set("partyId",value);
      }
 else {
        throw new WfException("Expression did not return a String");
      }
    }
  }
  if (roleTypeId != null && roleTypeId.trim().toLowerCase().startsWith("expr:")) {
    if (Debug.verboseOn())     Debug.logVerbose("Dynamic performer: Found a role expression",module);
    Object value=null;
    try {
      value=BshUtil.eval(roleTypeId.trim().substring(5).trim(),context);
    }
 catch (    bsh.EvalError e) {
      throw new WfException("Bsh evaluation error occurred.",e);
    }
    if (value != null) {
      if (value instanceof String) {
        newPerformer.set("roleTypeId",value);
      }
 else {
        throw new WfException("Expression did not return a String");
      }
    }
  }
  if (performerType.equals("HUMAN") || performerType.equals("ORGANIZATIONAL_UNIT")) {
    if (partyId == null) {
      newPerformer.set("partyId",performer.getString("participantId"));
    }
  }
  if (performerType.equals("ROLE")) {
    if (roleTypeId == null) {
      newPerformer.set("roleTypeId",performer.getString("participantId"));
    }
  }
  return newPerformer;
}
