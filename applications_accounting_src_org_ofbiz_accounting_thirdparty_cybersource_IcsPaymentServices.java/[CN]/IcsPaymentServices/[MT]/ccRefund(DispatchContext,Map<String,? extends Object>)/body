{
  Delegator delegator=dctx.getDelegator();
  GenericValue orderPaymentPreference=(GenericValue)context.get("orderPaymentPreference");
  GenericValue authTransaction=PaymentGatewayServices.getAuthTransaction(orderPaymentPreference);
  if (authTransaction == null) {
    return ServiceUtil.returnError("No authorization transaction found for the OrderPaymentPreference; cannot refund");
  }
  Properties props=buildCsProperties(context,delegator);
  if (props == null) {
    return ServiceUtil.returnError("ERROR: Getting Cybersource property configuration");
  }
  Map<String,Object> request=buildRefundRequest(context,authTransaction,delegator);
  request.put("merchantID",props.get("merchantID"));
  Map<String,Object> reply;
  try {
    reply=UtilGenerics.cast(Client.runTransaction(request,props));
  }
 catch (  FaultException e) {
    Debug.logError(e,"ERROR: Fault from CyberSource",module);
    return ServiceUtil.returnError("Unable to communicate with CyberSource");
  }
catch (  ClientException e) {
    Debug.logError(e,"ERROR: CyberSource Client exception : " + e.getMessage(),module);
    return ServiceUtil.returnError("Unable to communicate with CyberSource");
  }
  Map<String,Object> result=ServiceUtil.returnSuccess();
  processRefundResult(reply,result);
  return result;
}
