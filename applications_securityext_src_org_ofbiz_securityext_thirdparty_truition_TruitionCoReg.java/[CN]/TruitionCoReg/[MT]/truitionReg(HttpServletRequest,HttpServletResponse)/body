{
  HttpSession session=req.getSession();
  GenericValue userLogin=(GenericValue)session.getAttribute("userLogin");
  StringBuffer cookieNameB=new StringBuffer();
  StringBuffer cookieValue=new StringBuffer();
  if (!truitionEnabled()) {
    return "success";
  }
  boolean cookieOk=false;
  if (userLogin != null) {
    cookieOk=TruitionCoReg.makeTruitionCookie(userLogin,cookieNameB,cookieValue);
  }
  String domainName=UtilProperties.getPropertyValue("truition.properties","truition.domain.name");
  String cookiePath=UtilProperties.getPropertyValue("truition.properties","truition.cookie.path");
  String cookieName=UtilProperties.getPropertyValue("truition.properties","truition.cookie.name");
  int time=(int)UtilProperties.getPropertyNumber("truition.properties","truition.cookie.time");
  if (UtilValidate.isEmpty(domainName)) {
    Debug.logError("Truition is not properly configured; domainName missing; see truition.properties",module);
    return "error";
  }
  if (UtilValidate.isEmpty(cookiePath)) {
    Debug.logError("Truition is not properly configured; cookiePath missing; see truition.properties",module);
    return "error";
  }
  if (UtilValidate.isEmpty(cookieName)) {
    Debug.logError("Truition is not properly configured; cookieName missing; see truition.properties",module);
    return "error";
  }
  if (time == 0) {
    Debug.logError("Truition is not properly configured; cookieTime missing; see trution.properties",module);
    return "error";
  }
  String thisValue=cookieValue.toString();
  thisValue=thisValue.replaceAll("\n","");
  thisValue=thisValue.replaceAll("\r","");
  if (cookieOk) {
    try {
      Cookie tru=new Cookie(cookieName,URLEncoder.encode(thisValue,"UTF-8"));
      tru.setDomain(domainName);
      tru.setPath(cookiePath);
      tru.setMaxAge(time);
      resp.addCookie(tru);
      Debug.logInfo("Set Truition Cookie [" + tru.getName() + "/"+ tru.getDomain()+ " @ "+ tru.getPath()+ "] - "+ tru.getValue(),module);
    }
 catch (    UnsupportedEncodingException e) {
      Debug.logError(e,module);
      return "error";
    }
  }
  return "success";
}
