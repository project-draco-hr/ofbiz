{
  GenericValue adjustment=session.getDelegator().makeValue("OrderAdjustment");
  adjustment.set("orderAdjustmentTypeId","DISCOUNT_ADJUSTMENT");
  if (percent) {
    adjustment.set("sourcePercentage",discount.movePointRight(2));
  }
 else {
    adjustment.set("amount",discount);
  }
  if (cartIndex != null) {
    trace("add item adjustment");
    int iCartIndex=Integer.parseInt(cartIndex);
    ShoppingCartItem item=cart.findCartItem(iCartIndex);
    List<GenericValue> adjustments=item.getAdjustments();
    for (    GenericValue gvAdjustment : adjustments) {
      item.removeAdjustment(gvAdjustment);
    }
    item.addAdjustment(adjustment);
  }
 else {
    trace("add sale adjustment");
    if (cartDiscount > -1) {
      cart.removeAdjustment(cartDiscount);
    }
    cartDiscount=cart.addAdjustment(adjustment);
  }
}
