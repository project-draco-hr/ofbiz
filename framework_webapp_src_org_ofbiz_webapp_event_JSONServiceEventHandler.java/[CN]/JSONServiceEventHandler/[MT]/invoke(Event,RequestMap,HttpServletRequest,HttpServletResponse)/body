{
  String respCode=service.invoke(event,requestMap,request,response);
  Map<String,Object> attrMap=UtilHttp.getJSONAttributeMap(request);
  JSONObject json=JSONObject.fromObject(attrMap);
  String jsonStr=json.toString();
  if (jsonStr == null) {
    throw new EventHandlerException("JSON Object was empty; fatal error!");
  }
  response.setContentType("application/x-json");
  try {
    response.setContentLength(jsonStr.getBytes("UTF8").length);
  }
 catch (  UnsupportedEncodingException e) {
    throw new EventHandlerException("Problems with Json encoding",e);
  }
  Writer out;
  try {
    out=response.getWriter();
    out.write(jsonStr);
    out.flush();
  }
 catch (  IOException e) {
    throw new EventHandlerException("Unable to get response writer",e);
  }
  return respCode;
}
