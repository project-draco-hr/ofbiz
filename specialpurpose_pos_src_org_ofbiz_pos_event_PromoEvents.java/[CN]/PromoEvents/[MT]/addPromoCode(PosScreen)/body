{
  PosTransaction trans=PosTransaction.getCurrentTx(pos.getSession());
  if (!trans.isOpen()) {
    pos.showDialog("dialog/error/terminalclosed");
    return;
  }
  Input input=pos.getInput();
  String[] lastFunc=input.getLastFunction();
  if (lastFunc == null || !"PROMOCODE".equals(lastFunc[0])) {
    Output output=pos.getOutput();
    input.setFunction("PROMOCODE");
    output.print(UtilProperties.getMessage(PosTransaction.resource,"PosEntPromoCode",Locale.getDefault()));
  }
 else   if ("PROMOCODE".equals(lastFunc[0])) {
    String promoCode=input.value();
    if (UtilValidate.isNotEmpty(promoCode)) {
      StatusBar statusbar=new StatusBar(pos);
      statusbar.clearPromoCode();
      String result=trans.addProductPromoCode(promoCode);
      if (result != null) {
        pos.showDialog("dialog/error/exception",result);
        input.clearFunction("PROMOCODE");
      }
 else {
        input.clearFunction("PROMOCODE");
        statusbar.printPromoCode(promoCode);
        NavagationEvents.showPosScreen(pos);
        pos.refresh();
      }
    }
  }
}
