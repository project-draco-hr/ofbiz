{
  GenericDelegator delegator=dctx.getDelegator();
  Properties props=getProperties(context);
  String cardNumber=(String)context.get("cardNumber");
  String pin=(String)context.get("pin");
  String currency=(String)context.get("currency");
  String orderId=(String)context.get("orderId");
  String partyId=(String)context.get("partyId");
  ValueLinkApi vl=ValueLinkApi.getInstance(delegator,props);
  Map request=vl.getInitialRequestMap(context);
  request.put("Interface","Balance");
  request.put("CardNo",cardNumber);
  request.put("PIN",vl.encryptPin(pin));
  request.put("LocalCurr",vl.getCurrency(currency));
  if (orderId != null && orderId.length() > 0) {
    request.put("User1",orderId);
  }
  if (partyId != null && partyId.length() > 0) {
    request.put("User2",partyId);
  }
  Map response=null;
  try {
    response=vl.send(request);
  }
 catch (  HttpClientException e) {
    Debug.logError(e,"Problem communicating with VL");
    return ServiceUtil.returnError("Unable to call balance inquire");
  }
  if (response != null) {
    String responseCode=(String)response.get("responsecode");
    Map result=ServiceUtil.returnSuccess();
    if (responseCode.equals("00")) {
      result.put("processResult",Boolean.TRUE);
    }
 else {
      result.put("processResult",Boolean.FALSE);
    }
    result.put("responseCode",responseCode);
    result.put("balance",vl.getAmount((String)response.get("currbal")));
    result.put("expireDate",response.get("expiredate"));
    result.put("cardClass",response.get("cardclass"));
    result.put("referenceNum",response.get("traceno"));
    Debug.log("Balance Result : " + result,module);
    return result;
  }
 else {
    return ServiceUtil.returnError("Empty response returned from ValueLink");
  }
}
