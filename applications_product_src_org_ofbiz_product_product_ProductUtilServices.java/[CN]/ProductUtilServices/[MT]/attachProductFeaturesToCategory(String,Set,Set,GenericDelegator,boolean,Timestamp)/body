{
  if (nowTimestamp == null) {
    nowTimestamp=UtilDateTime.nowTimestamp();
  }
  List subCategoryList=delegator.findByAnd("ProductCategoryRollup",UtilMisc.toMap("parentProductCategoryId",productCategoryId));
  if (doSubCategories) {
    Iterator subCategoryIter=subCategoryList.iterator();
    while (subCategoryIter.hasNext()) {
      GenericValue productCategoryRollup=(GenericValue)subCategoryIter.next();
      attachProductFeaturesToCategory(productCategoryRollup.getString("productCategoryId"),productFeatureTypeIdsToInclude,productFeatureTypeIdsToExclude,delegator,true,nowTimestamp);
    }
  }
  Map productFeatureIdByTypeIdSetMap=new HashMap();
  List productCategoryMemberList=delegator.findByAnd("ProductCategoryMember",UtilMisc.toMap("productCategoryId",productCategoryId));
  Iterator productCategoryMemberIter=productCategoryMemberList.iterator();
  while (productCategoryMemberIter.hasNext()) {
    GenericValue productCategoryMember=(GenericValue)productCategoryMemberIter.next();
    String productId=productCategoryMember.getString("productId");
    EntityCondition condition=new EntityConditionList(UtilMisc.toList(new EntityExpr("productId",EntityOperator.EQUALS,productId),new EntityExpr("fromDate",EntityOperator.LESS_THAN_EQUAL_TO,nowTimestamp),new EntityExpr(new EntityExpr("thruDate",EntityOperator.EQUALS,null),EntityOperator.OR,new EntityExpr("thruDate",EntityOperator.GREATER_THAN_EQUAL_TO,nowTimestamp))),EntityOperator.AND);
    EntityListIterator productFeatureAndApplEli=delegator.findListIteratorByCondition("ProductFeatureAndAppl",condition,null,null);
    GenericValue productFeatureAndAppl=null;
    while ((productFeatureAndAppl=(GenericValue)productFeatureAndApplEli.next()) != null) {
      String productFeatureId=productFeatureAndAppl.getString("productFeatureId");
      String productFeatureTypeId=productFeatureAndAppl.getString("productFeatureTypeId");
      if (productFeatureTypeIdsToInclude != null && productFeatureTypeIdsToInclude.size() > 0 && !productFeatureTypeIdsToInclude.contains(productFeatureTypeId)) {
        continue;
      }
      if (productFeatureTypeIdsToExclude != null && productFeatureTypeIdsToExclude.contains(productFeatureTypeId)) {
        continue;
      }
      Set productFeatureIdSet=(Set)productFeatureIdByTypeIdSetMap.get(productFeatureTypeId);
      if (productFeatureIdSet == null) {
        productFeatureIdSet=new HashSet();
        productFeatureIdByTypeIdSetMap.put(productFeatureTypeId,productFeatureIdSet);
      }
      productFeatureIdSet.add(productFeatureId);
    }
    productFeatureAndApplEli.close();
  }
  Iterator productFeatureIdByTypeIdSetIter=productFeatureIdByTypeIdSetMap.entrySet().iterator();
  while (productFeatureIdByTypeIdSetIter.hasNext()) {
    Map.Entry entry=(Map.Entry)productFeatureIdByTypeIdSetIter.next();
    String productFeatureTypeId=(String)entry.getKey();
    Set productFeatureIdSet=(Set)entry.getValue();
    String productFeatureGroupId=productCategoryId + "_" + productFeatureTypeId;
    if (productFeatureGroupId.length() > 20) {
      Debug.logWarning("Manufactured productFeatureGroupId was greater than 20 characters, means that we had some long productCategoryId and/or productFeatureTypeId values, at the category part should be unique since it is first, so if the feature type isn't unique it just means more than one type of feature will go into the category...",module);
      productFeatureGroupId=productFeatureGroupId.substring(0,20);
    }
    GenericValue productFeatureGroup=delegator.findByPrimaryKey("ProductFeatureGroup",UtilMisc.toMap("productFeatureGroupId",productFeatureGroupId));
    if (productFeatureGroup == null) {
      String description="Feature Group for type [" + productFeatureTypeId + "] features in category ["+ productCategoryId+ "]";
      productFeatureGroup=delegator.makeValue("ProductFeatureGroup",UtilMisc.toMap("productFeatureGroupId",productFeatureGroupId,"description",description));
      productFeatureGroup.create();
      GenericValue productFeatureCatGrpAppl=delegator.makeValue("ProductFeatureCatGrpAppl",UtilMisc.toMap("productFeatureGroupId",productFeatureGroupId,"productCategoryId",productCategoryId,"fromDate",nowTimestamp));
      productFeatureCatGrpAppl.create();
    }
    Iterator productFeatureIdIter=productFeatureIdSet.iterator();
    while (productFeatureIdIter.hasNext()) {
      String productFeatureId=(String)productFeatureIdIter.next();
      EntityCondition condition=new EntityConditionList(UtilMisc.toList(new EntityExpr("productFeatureId",EntityOperator.EQUALS,productFeatureId),new EntityExpr("productFeatureGroupId",EntityOperator.EQUALS,productFeatureGroupId),new EntityExpr("fromDate",EntityOperator.LESS_THAN_EQUAL_TO,nowTimestamp),new EntityExpr(new EntityExpr("thruDate",EntityOperator.EQUALS,null),EntityOperator.OR,new EntityExpr("thruDate",EntityOperator.GREATER_THAN_EQUAL_TO,nowTimestamp))),EntityOperator.AND);
      if (delegator.findCountByCondition("ProductFeatureGroupAppl",condition,null) == 0) {
        GenericValue productFeatureGroupAppl=delegator.makeValue("ProductFeatureGroupAppl",UtilMisc.toMap("productFeatureGroupId",productFeatureGroupId,"productFeatureId",productFeatureId,"fromDate",nowTimestamp));
        productFeatureGroupAppl.create();
      }
    }
  }
  Iterator subCategoryIter=subCategoryList.iterator();
  while (subCategoryIter.hasNext()) {
    GenericValue productCategoryRollup=(GenericValue)subCategoryIter.next();
    String subProductCategoryId=productCategoryRollup.getString("productCategoryId");
    EntityCondition condition=new EntityConditionList(UtilMisc.toList(new EntityExpr("productCategoryId",EntityOperator.EQUALS,subProductCategoryId),new EntityExpr("fromDate",EntityOperator.LESS_THAN_EQUAL_TO,nowTimestamp),new EntityExpr(new EntityExpr("thruDate",EntityOperator.EQUALS,null),EntityOperator.OR,new EntityExpr("thruDate",EntityOperator.GREATER_THAN_EQUAL_TO,nowTimestamp))),EntityOperator.AND);
    EntityListIterator productFeatureCatGrpApplEli=delegator.findListIteratorByCondition("ProductFeatureCatGrpAppl",condition,null,null);
    GenericValue productFeatureCatGrpAppl=null;
    while ((productFeatureCatGrpAppl=(GenericValue)productFeatureCatGrpApplEli.next()) != null) {
      String productFeatureGroupId=productFeatureCatGrpAppl.getString("productFeatureGroupId");
      EntityCondition checkCondition=new EntityConditionList(UtilMisc.toList(new EntityExpr("productCategoryId",EntityOperator.EQUALS,productCategoryId),new EntityExpr("productFeatureGroupId",EntityOperator.EQUALS,productFeatureGroupId),new EntityExpr("fromDate",EntityOperator.LESS_THAN_EQUAL_TO,nowTimestamp),new EntityExpr(new EntityExpr("thruDate",EntityOperator.EQUALS,null),EntityOperator.OR,new EntityExpr("thruDate",EntityOperator.GREATER_THAN_EQUAL_TO,nowTimestamp))),EntityOperator.AND);
      if (delegator.findCountByCondition("ProductFeatureCatGrpAppl",checkCondition,null) == 0) {
        GenericValue productFeatureGroupAppl=delegator.makeValue("ProductFeatureCatGrpAppl",UtilMisc.toMap("productFeatureGroupId",productFeatureGroupId,"productCategoryId",productCategoryId,"fromDate",nowTimestamp));
        productFeatureGroupAppl.create();
      }
    }
    productFeatureCatGrpApplEli.close();
  }
}
