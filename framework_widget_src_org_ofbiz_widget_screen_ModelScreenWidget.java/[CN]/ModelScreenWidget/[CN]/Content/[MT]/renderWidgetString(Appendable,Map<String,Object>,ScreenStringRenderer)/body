{
  try {
    GenericDelegator delegator=(GenericDelegator)context.get("delegator");
    GenericValue content=null;
    String expandedDataResourceId=getDataResourceId(context);
    String expandedContentId=getContentId(context);
    if (!(context instanceof MapStack)) {
      context=MapStack.create(context);
    }
    ((MapStack)context).push();
    context.put("contentId",expandedContentId);
    if (UtilValidate.isEmpty(expandedDataResourceId)) {
      if (UtilValidate.isNotEmpty(expandedContentId)) {
        content=delegator.findByPrimaryKeyCache("Content",UtilMisc.toMap("contentId",expandedContentId));
      }
 else {
        String errMsg="contentId is empty.";
        Debug.logError(errMsg,module);
        return;
      }
      if (content != null) {
        expandedDataResourceId=content.getString("dataResourceId");
      }
 else {
        String errMsg="Could not find content with contentId [" + expandedContentId + "] ";
        Debug.logError(errMsg,module);
        throw new RuntimeException(errMsg);
      }
    }
    GenericValue dataResource=null;
    if (UtilValidate.isNotEmpty(expandedDataResourceId)) {
      dataResource=delegator.findByPrimaryKeyCache("DataResource",UtilMisc.toMap("dataResourceId",expandedDataResourceId));
      this.dataResourceId=FlexibleStringExpander.getInstance(expandedDataResourceId);
    }
    String mimeTypeId=null;
    if (dataResource != null) {
      mimeTypeId=dataResource.getString("mimeTypeId");
    }
    if (UtilValidate.isNotEmpty(content)) {
      mimeTypeId=content.getString("mimeTypeId");
    }
    if (UtilValidate.isNotEmpty(mimeTypeId) && ((mimeTypeId.indexOf("application") >= 0) || (mimeTypeId.indexOf("image")) >= 0)) {
      if (mimeTypeId.equals("application/pdf")) {
        TransformerFactory tfactory=TransformerFactory.newInstance();
        try {
          SAXParserFactory pfactory=SAXParserFactory.newInstance();
          pfactory.setNamespaceAware(true);
          pfactory.setValidating(true);
          pfactory.setXIncludeAware(true);
          XMLReader reader=null;
          try {
            reader=pfactory.newSAXParser().getXMLReader();
          }
 catch (          Exception e) {
            throw new TransformerException("Error creating SAX parser/reader",e);
          }
          String fileName="/home/hans/ofbiz/svn/applications/commonext/documents/ApacheOfbiz.xml";
          SAXSource source=new SAXSource(reader,new InputSource(fileName));
          Transformer transformer1=tfactory.newTransformer(new StreamSource("/home/hans/ofbiz/svn/applications/content/template/docbook/fo/docbook.xsl"));
          StringWriter sw=new StringWriter();
          StreamResult sr=new StreamResult(sw);
          transformer1.transform(source,sr);
          FopFactory fopFactory=FopFactory.newInstance();
          FOUserAgent foUserAgent=fopFactory.newFOUserAgent();
          ByteArrayOutputStream out=new ByteArrayOutputStream();
          Fop fop=fopFactory.newFop(MimeConstants.MIME_PDF,foUserAgent,out);
          TransformerFactory factory=TransformerFactory.newInstance();
          Transformer transformer=factory.newTransformer();
          Source src=new StreamSource(new ByteArrayInputStream(sw.toString().getBytes()));
          Result result=new SAXResult(fop.getDefaultHandler());
          transformer.transform(src,result);
          out.flush();
          out.close();
          FileOutputStream fw=new FileOutputStream("/tmp/file.pdf");
          fw.write(out.toByteArray());
          fw.close();
          HttpServletResponse response=(HttpServletResponse)context.get("response");
          response.setContentType("application/pdf");
          response.setContentLength(out.size());
          response.setHeader("Content-Disposition","attachment;filename=" + fileName);
          writer.append(new String(out.toByteArray()));
        }
 catch (        Exception e) {
          Debug.logError("Exception converting from FO to PDF: " + e,module);
        }
      }
 else {
        screenStringRenderer.renderContentFrame(writer,context,this);
      }
    }
 else {
      screenStringRenderer.renderContentBegin(writer,context,this);
      screenStringRenderer.renderContentBody(writer,context,this);
      screenStringRenderer.renderContentEnd(writer,context,this);
    }
    ((MapStack)context).pop();
  }
 catch (  IOException e) {
    String errMsg="Error rendering content with contentId [" + getContentId(context) + "]: "+ e.toString();
    Debug.logError(e,errMsg,module);
    throw new RuntimeException(errMsg);
  }
catch (  GenericEntityException e) {
    String errMsg="Error obtaining content with contentId [" + getContentId(context) + "]: "+ e.toString();
    Debug.logError(e,errMsg,module);
    throw new RuntimeException(errMsg);
  }
}
