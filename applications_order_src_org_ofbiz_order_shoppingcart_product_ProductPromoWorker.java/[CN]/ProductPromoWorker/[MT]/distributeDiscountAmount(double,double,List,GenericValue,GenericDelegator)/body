{
  double discountAmount=discountAmountTotal;
  Iterator cartItemsUsedIter=cartItemsUsed.iterator();
  while (cartItemsUsedIter.hasNext()) {
    ShoppingCartItem cartItem=(ShoppingCartItem)cartItemsUsedIter.next();
    if (cartItemsUsedIter.hasNext()) {
      double quantityUsed=cartItem.getPromoQuantityCandidateUseActionAndAllConds(productPromoAction);
      double ratioOfTotal=(quantityUsed * cartItem.getBasePrice()) / totalAmount;
      double weightedAmount=ratioOfTotal * discountAmountTotal;
      weightedAmount=weightedAmount * 100.0;
      long roundedAmount=Math.round(weightedAmount);
      weightedAmount=((double)roundedAmount) / 100.0;
      discountAmount-=weightedAmount;
      doOrderItemPromoAction(productPromoAction,cartItem,weightedAmount,"amount",delegator);
    }
 else {
      doOrderItemPromoAction(productPromoAction,cartItem,discountAmount,"amount",delegator);
    }
  }
}
