{
  String productPromoCodeId=productPromoCode.getString("productPromoCodeId");
  Long codeUseLimit=null;
  Long codeUseLimitPerCustomer=productPromoCode.getLong("useLimitPerCustomer");
  if (codeUseLimitPerCustomer != null) {
    long productPromoCustomerUseSize=0;
    if (UtilValidate.isNotEmpty(partyId)) {
      EntityCondition checkCondition=new EntityConditionList(UtilMisc.toList(new EntityExpr("productPromoCodeId",EntityOperator.EQUALS,productPromoCodeId),new EntityExpr("partyId",EntityOperator.EQUALS,partyId),new EntityExpr("statusId",EntityOperator.NOT_EQUAL,"ORDER_REJECTED"),new EntityExpr("statusId",EntityOperator.NOT_EQUAL,"ORDER_CANCELLED")),EntityOperator.AND);
      productPromoCustomerUseSize=delegator.findCountByCondition("ProductPromoUseCheck",checkCondition,null);
    }
    long perCustomerThisOrder=codeUseLimitPerCustomer.longValue() - productPromoCustomerUseSize;
    if (codeUseLimit == null || codeUseLimit.longValue() > perCustomerThisOrder) {
      codeUseLimit=new Long(perCustomerThisOrder);
    }
  }
  Long codeUseLimitPerCode=productPromoCode.getLong("useLimitPerCode");
  if (codeUseLimitPerCode != null) {
    EntityCondition checkCondition=new EntityConditionList(UtilMisc.toList(new EntityExpr("productPromoCodeId",EntityOperator.EQUALS,productPromoCodeId),new EntityExpr("statusId",EntityOperator.NOT_EQUAL,"ORDER_REJECTED"),new EntityExpr("statusId",EntityOperator.NOT_EQUAL,"ORDER_CANCELLED")),EntityOperator.AND);
    long productPromoCodeUseSize=delegator.findCountByCondition("ProductPromoUseCheck",checkCondition,null);
    long perCodeThisOrder=codeUseLimitPerCode.longValue() - productPromoCodeUseSize;
    if (codeUseLimit == null || codeUseLimit.longValue() > perCodeThisOrder) {
      codeUseLimit=new Long(perCodeThisOrder);
    }
  }
  return codeUseLimit;
}
