{
  String partyId=cart.getPartyId();
  long maxIterations=1000;
  long numberOfIterations=0;
  long maxUseLimit=2 * Math.round(cart.getTotalQuantity());
  try {
    boolean cartChanged=true;
    while (cartChanged) {
      cartChanged=false;
      numberOfIterations++;
      if (numberOfIterations > maxIterations) {
        Debug.logError("ERROR: While calculating promotions the promotion rules where run more than " + maxIterations + " times, so the calculation has been ended. This should generally never happen unless you have bad rule definitions.",module);
        break;
      }
      Iterator productPromoIter=productPromoList.iterator();
      while (productPromoIter.hasNext()) {
        GenericValue productPromo=(GenericValue)productPromoIter.next();
        String productPromoId=productPromo.getString("productPromoId");
        List productPromoRules=productPromo.getRelatedCache("ProductPromoRule",null,null);
        if (productPromoRules != null && productPromoRules.size() > 0) {
          Long candidateUseLimit=getProductPromoUseLimit(productPromo,partyId,delegator);
          Long useLimit=candidateUseLimit;
          if (Debug.verboseOn())           Debug.logVerbose("Running promotion [" + productPromoId + "], useLimit="+ useLimit+ ", # of rules="+ productPromoRules.size(),module);
          boolean requireCode="Y".equals(productPromo.getString("requireCode"));
          if (requireCode) {
            Set enteredCodes=cart.getProductPromoCodesEntered();
            if (enteredCodes.size() > 0) {
              EntityCondition codeCondition=EntityCondition.makeCondition(EntityCondition.makeCondition("productPromoId",EntityOperator.EQUALS,productPromoId),EntityOperator.AND,EntityCondition.makeCondition("productPromoCodeId",EntityOperator.IN,enteredCodes));
              List productPromoCodeList=delegator.findList("ProductPromoCode",codeCondition,null,UtilMisc.toList("productPromoCodeId"),null,false);
              Iterator productPromoCodeIter=productPromoCodeList.iterator();
              while ((useLimit == null || useLimit.longValue() > cart.getProductPromoUseCount(productPromoId)) && productPromoCodeIter.hasNext()) {
                GenericValue productPromoCode=(GenericValue)productPromoCodeIter.next();
                String productPromoCodeId=productPromoCode.getString("productPromoCodeId");
                Long codeUseLimit=getProductPromoCodeUseLimit(productPromoCode,partyId,delegator);
                if (runProductPromoRules(cart,cartChanged,useLimit,true,productPromoCodeId,codeUseLimit,maxUseLimit,productPromo,productPromoRules,dispatcher,delegator,nowTimestamp)) {
                  cartChanged=true;
                }
                if (cart.getProductPromoUseCount(productPromoId) > maxUseLimit) {
                  Debug.logError("ERROR: While calculating promotions the promotion [" + productPromoId + "] action was applied more than "+ maxUseLimit+ " times, so the calculation has been ended. This should generally never happen unless you have bad rule definitions.",module);
                  break;
                }
              }
            }
          }
 else {
            try {
              if (runProductPromoRules(cart,cartChanged,useLimit,false,null,null,maxUseLimit,productPromo,productPromoRules,dispatcher,delegator,nowTimestamp)) {
                cartChanged=true;
              }
            }
 catch (            RuntimeException e) {
              throw new GeneralException("Error running promotion with ID [" + productPromoId + "]",e);
            }
          }
        }
        if (isolatedTestRun) {
          cart.clearAllPromotionAdjustments();
          cart.clearCartItemUseInPromoInfo();
        }
      }
      if (isolatedTestRun) {
        cartChanged=false;
      }
    }
  }
 catch (  UseLimitException e) {
    Debug.logError(e,e.toString(),module);
  }
}
