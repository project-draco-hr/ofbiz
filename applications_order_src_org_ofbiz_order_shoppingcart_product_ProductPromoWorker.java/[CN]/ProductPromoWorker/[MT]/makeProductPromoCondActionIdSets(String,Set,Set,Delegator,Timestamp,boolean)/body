{
  if (nowTimestamp == null) {
    nowTimestamp=UtilDateTime.nowTimestamp();
  }
  List productPromoCategoriesAll=delegator.findByAndCache("ProductPromoCategory",UtilMisc.toMap("productPromoId",productPromoId));
  List productPromoProductsAll=delegator.findByAndCache("ProductPromoProduct",UtilMisc.toMap("productPromoId",productPromoId));
  List productPromoProductsCond=FastList.newInstance();
  List productPromoCategoriesCond=FastList.newInstance();
  List productPromoProductsAction=FastList.newInstance();
  List productPromoCategoriesAction=FastList.newInstance();
  Iterator productPromoProductsAllIter=productPromoProductsAll.iterator();
  while (productPromoProductsAllIter.hasNext()) {
    GenericValue productPromoProduct=(GenericValue)productPromoProductsAllIter.next();
    if (!"_NA_".equals(productPromoProduct.getString("productPromoCondSeqId")) || "_NA_".equals(productPromoProduct.getString("productPromoRuleId"))) {
      productPromoProductsCond.add(productPromoProduct);
    }
    if (!"_NA_".equals(productPromoProduct.getString("productPromoActionSeqId")) || "_NA_".equals(productPromoProduct.getString("productPromoRuleId"))) {
      productPromoProductsAction.add(productPromoProduct);
    }
  }
  Iterator productPromoCategoriesAllIter=productPromoCategoriesAll.iterator();
  while (productPromoCategoriesAllIter.hasNext()) {
    GenericValue productPromoCategory=(GenericValue)productPromoCategoriesAllIter.next();
    if (!"_NA_".equals(productPromoCategory.getString("productPromoCondSeqId")) || "_NA_".equals(productPromoCategory.getString("productPromoRuleId"))) {
      productPromoCategoriesCond.add(productPromoCategory);
    }
    if (!"_NA_".equals(productPromoCategory.getString("productPromoActionSeqId")) || "_NA_".equals(productPromoCategory.getString("productPromoRuleId"))) {
      productPromoCategoriesAction.add(productPromoCategory);
    }
  }
  makeProductPromoIdSet(productIdsCond,productPromoCategoriesCond,productPromoProductsCond,delegator,nowTimestamp,filterOldProducts);
  makeProductPromoIdSet(productIdsAction,productPromoCategoriesAction,productPromoProductsAction,delegator,nowTimestamp,filterOldProducts);
  if (filterOldProducts) {
    Iterator productIdsCondIter=productIdsCond.iterator();
    while (productIdsCondIter.hasNext()) {
      String productId=(String)productIdsCondIter.next();
      if (isProductOld(productId,delegator,nowTimestamp)) {
        productIdsCondIter.remove();
      }
    }
    Iterator productIdsActionIter=productIdsAction.iterator();
    while (productIdsActionIter.hasNext()) {
      String productId=(String)productIdsActionIter.next();
      if (isProductOld(productId,delegator,nowTimestamp)) {
        productIdsActionIter.remove();
      }
    }
  }
}
