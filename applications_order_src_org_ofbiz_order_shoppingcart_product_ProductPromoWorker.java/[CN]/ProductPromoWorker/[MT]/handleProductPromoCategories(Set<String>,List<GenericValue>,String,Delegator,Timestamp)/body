{
  boolean include=!"PPPA_EXCLUDE".equals(productPromoApplEnumId);
  Set<String> productCategoryIds=FastSet.newInstance();
  Map<String,List<Set<String>>> productCategoryGroupSetListMap=FastMap.newInstance();
  Iterator<GenericValue> productPromoCategoryIter=productPromoCategories.iterator();
  while (productPromoCategoryIter.hasNext()) {
    GenericValue productPromoCategory=productPromoCategoryIter.next();
    if (productPromoApplEnumId.equals(productPromoCategory.getString("productPromoApplEnumId"))) {
      Set<String> tempCatIdSet=FastSet.newInstance();
      if ("Y".equals(productPromoCategory.getString("includeSubCategories"))) {
        ProductSearch.getAllSubCategoryIds(productPromoCategory.getString("productCategoryId"),tempCatIdSet,delegator,nowTimestamp);
      }
 else {
        tempCatIdSet.add(productPromoCategory.getString("productCategoryId"));
      }
      String andGroupId=productPromoCategory.getString("andGroupId");
      if ("_NA_".equals(andGroupId)) {
        productCategoryIds.addAll(tempCatIdSet);
      }
 else {
        List<Set<String>> catIdSetList=productCategoryGroupSetListMap.get(andGroupId);
        if (catIdSetList == null) {
          catIdSetList=FastList.newInstance();
        }
        catIdSetList.add(tempCatIdSet);
      }
    }
  }
  Iterator<Map.Entry<String,List<Set<String>>>> pcgslmeIter=productCategoryGroupSetListMap.entrySet().iterator();
  while (pcgslmeIter.hasNext()) {
    Map.Entry<String,List<Set<String>>> entry=pcgslmeIter.next();
    List<Set<String>> catIdSetList=entry.getValue();
    if (catIdSetList.size() == 0) {
      pcgslmeIter.remove();
    }
 else     if (catIdSetList.size() == 1) {
      Set<String> catIdSet=catIdSetList.iterator().next();
      if (catIdSet.size() == 0) {
        pcgslmeIter.remove();
      }
 else {
        productCategoryIds.addAll(catIdSet);
        pcgslmeIter.remove();
      }
    }
  }
  getAllProductIds(productCategoryIds,productIds,delegator,nowTimestamp,include);
  Iterator<Map.Entry<String,List<Set<String>>>> pcgslmIter=productCategoryGroupSetListMap.entrySet().iterator();
  while (pcgslmIter.hasNext()) {
    Map.Entry<String,List<Set<String>>> entry=pcgslmIter.next();
    List<Set<String>> catIdSetList=entry.getValue();
    List<Set<String>> productIdSetList=FastList.newInstance();
    Iterator<Set<String>> cidslIter=catIdSetList.iterator();
    while (cidslIter.hasNext()) {
      Set<String> catIdSet=cidslIter.next();
      Set<String> groupProductIdSet=FastSet.newInstance();
      getAllProductIds(catIdSet,groupProductIdSet,delegator,nowTimestamp,true);
      productIdSetList.add(groupProductIdSet);
    }
    Set<String> firstProductIdSet=productIdSetList.remove(0);
    Iterator<Set<String>> productIdSetIter=productIdSetList.iterator();
    while (productIdSetIter.hasNext()) {
      Set<String> productIdSet=productIdSetIter.next();
      firstProductIdSet.retainAll(productIdSet);
    }
    if (firstProductIdSet.size() >= 0) {
      if (include) {
        productIds.addAll(firstProductIdSet);
      }
 else {
        productIds.removeAll(firstProductIdSet);
      }
    }
  }
}
