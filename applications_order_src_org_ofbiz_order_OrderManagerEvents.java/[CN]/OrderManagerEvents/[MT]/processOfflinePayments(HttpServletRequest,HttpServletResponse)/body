{
  HttpSession session=request.getSession();
  ServletContext application=((ServletContext)request.getAttribute("servletContext"));
  LocalDispatcher dispatcher=(LocalDispatcher)request.getAttribute("dispatcher");
  GenericDelegator delegator=(GenericDelegator)request.getAttribute("delegator");
  GenericValue userLogin=(GenericValue)session.getAttribute("userLogin");
  Locale locale=UtilHttp.getLocale(request);
  if (session.getAttribute("OFFLINE_PAYMENTS") != null) {
    String orderId=(String)request.getAttribute("orderId");
    List toBeStored=new LinkedList();
    List paymentPrefs=null;
    GenericValue placingCustomer=null;
    try {
      paymentPrefs=delegator.findByAnd("OrderPaymentPreference",UtilMisc.toMap("orderId",orderId));
      List pRoles=delegator.findByAnd("OrderRole",UtilMisc.toMap("orderId",orderId,"roleTypeId","PLACING_CUSTOMER"));
      if (pRoles != null && pRoles.size() > 0)       placingCustomer=EntityUtil.getFirst(pRoles);
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,"Problems looking up order payment preferences",module);
      request.setAttribute("_ERROR_MESSAGE_",UtilProperties.getMessage(resource_error,"OrderErrorProcessingOfflinePayments",locale));
      return "error";
    }
    if (paymentPrefs != null) {
      Iterator i=paymentPrefs.iterator();
      while (i.hasNext()) {
        GenericValue ppref=(GenericValue)i.next();
        ppref.set("statusId","PAYMENT_RECEIVED");
        ppref.set("authDate",UtilDateTime.nowTimestamp());
        toBeStored.add(ppref);
        Map results=null;
        try {
          results=dispatcher.runSync("createPaymentFromPreference",UtilMisc.toMap("orderPaymentPreferenceId",ppref.get("orderPaymentPreferenceId"),"paymentFromId",placingCustomer.getString("partyId"),"comments","Payment received offline and manually entered."));
        }
 catch (        GenericServiceException e) {
          Debug.logError(e,"Failed to execute service createPaymentFromPreference",module);
          request.setAttribute("_ERROR_MESSAGE_",e.getMessage());
          return "error";
        }
        if ((results == null) || (results.get(ModelService.RESPONSE_MESSAGE).equals(ModelService.RESPOND_ERROR))) {
          Debug.logError((String)results.get(ModelService.ERROR_MESSAGE),module);
          request.setAttribute("_ERROR_MESSAGE_",(String)results.get(ModelService.ERROR_MESSAGE));
          return "error";
        }
      }
      try {
        delegator.storeAll(toBeStored);
      }
 catch (      GenericEntityException e) {
        Debug.logError(e,"Problems storing payment information",module);
        request.setAttribute("_ERROR_MESSAGE_",UtilProperties.getMessage(resource_error,"OrderProblemStoringReceivedPaymentInformation",locale));
        return "error";
      }
      OrderChangeHelper.approveOrder(dispatcher,userLogin,orderId);
    }
  }
  return "success";
}
