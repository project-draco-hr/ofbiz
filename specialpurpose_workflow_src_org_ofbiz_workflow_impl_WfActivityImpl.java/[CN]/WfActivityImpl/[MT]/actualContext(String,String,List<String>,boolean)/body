{
  Map<String,Object> actualContext=new HashMap<String,Object>();
  Map<String,Object> context=processContext();
  Map<String,String> extendedAttributes=StringUtil.strToMap(extendedAttr);
  if (UtilValidate.isNotEmpty(extendedAttributes)) {
    context.putAll(extendedAttributes);
  }
  GenericValue userLogin=null;
  if (context.containsKey("runAsUser")) {
    userLogin=getUserLogin((String)context.get("runAsUser"));
    actualContext.put("userLogin",userLogin);
  }
 else   if (context.containsKey("workflowOwnerId")) {
    userLogin=getUserLogin((String)context.get("workflowOwnerId"));
  }
  context.put("userLogin",userLogin);
  context.put("workEffortId",runtimeKey());
  if (howManyAssignment() == 1) {
    Debug.logVerbose("Single assignment; getting assignment info.",module);
    List<WfAssignment> assignments=getAssignments();
    WfAssignment assign=assignments.iterator().next();
    WfResource res=assign.assignee();
    context.put("assignedPartyId",res.resourcePartyId());
    context.put("assignedRoleTypeId",res.resourceRoleId());
  }
  if (actualParameters != null) {
    List<String> params=StringUtil.split(actualParameters,",");
    for (    String key : params) {
      if (key != null && key.trim().toLowerCase().startsWith("expr:")) {
        try {
          BshUtil.eval(key.trim().substring(5).trim(),context);
        }
 catch (        bsh.EvalError e) {
          throw new WfException("Bsh evaluation error.",e);
        }
      }
 else       if (key != null && key.trim().toLowerCase().startsWith("name:")) {
        List<String> couple=StringUtil.split(key.trim().substring(5).trim(),"=");
        String mName=couple.get(0);
        String cName=couple.get(1);
        if (mName != null)         mName=mName.trim();
        if (cName != null)         cName=cName.trim();
        if (mName != null && cName != null && context.containsKey(cName)) {
          actualContext.put(mName,context.get(cName));
        }
      }
 else       if (context.containsKey(key)) {
        actualContext.put(key,context.get(key));
      }
 else       if (!actualContext.containsKey(key) && !ignoreUnknown) {
        throw new WfException("Context does not contain the key: '" + key + "'");
      }
    }
  }
  if (serviceSignature != null) {
    for (    String key : serviceSignature) {
      if (!actualContext.containsKey(key) && context.containsKey(key)) {
        actualContext.put(key,context.get(key));
      }
    }
  }
  return actualContext;
}
