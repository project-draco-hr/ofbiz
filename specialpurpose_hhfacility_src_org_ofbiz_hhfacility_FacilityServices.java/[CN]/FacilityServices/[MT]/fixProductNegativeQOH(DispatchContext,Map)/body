{
  GenericDelegator delegator=dctx.getDelegator();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  String facilityId=(String)context.get("facilityId");
  String productId=(String)context.get("productId");
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  List invItemList=null;
  try {
    invItemList=delegator.findByAnd("InventoryItem",UtilMisc.toMap("productId",productId,"facilityId",facilityId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    throw new GeneralRuntimeException(e.getMessage());
  }
  Map locations=new HashMap();
  Iterator invItemListIter=invItemList.iterator();
  while (invItemListIter.hasNext()) {
    GenericValue invItem=(GenericValue)invItemListIter.next();
    if (invItem != null) {
      int qoh=((Double)invItem.get("quantityOnHandTotal")).intValue();
      if (qoh < 0) {
        Map contextInput=UtilMisc.toMap("userLogin",userLogin,"inventoryItemId",invItem.get("inventoryItemId"),"varianceReasonId","VAR_LOST","availableToPromiseVar",new Double(qoh * -1),"quantityOnHandVar",new Double(qoh * -1),"comments","QOH < 0 stocktake correction");
        try {
          dispatcher.runSync("createPhysicalInventoryAndVariance",contextInput);
        }
 catch (        GenericServiceException e) {
          Debug.logError(e,"fixProductNegativeQOH failed on createPhysicalInventoryAndVariance invItemId" + invItem.get("inventoryItemId"),module);
          return ServiceUtil.returnError("fixProductNegativeQOH failed on createPhysicalInventoryAndVariance invItemId" + invItem.get("inventoryItemId"));
        }
      }
    }
  }
  Map result=ServiceUtil.returnSuccess();
  return result;
}
