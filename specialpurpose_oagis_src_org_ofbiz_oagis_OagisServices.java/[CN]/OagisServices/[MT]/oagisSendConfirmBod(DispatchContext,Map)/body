{
  GenericDelegator delegator=ctx.getDelegator();
  LocalDispatcher dispatcher=ctx.getDispatcher();
  String sendToUrl=(String)context.get("sendToUrl");
  String saveToFilename=(String)context.get("saveToFilename");
  String saveToDirectory=(String)context.get("saveToDirectory");
  OutputStream out=(OutputStream)context.get("outputStream");
  GenericValue userLogin=null;
  try {
    userLogin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","admin"));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,"Error getting userLogin",module);
  }
  String logicalId=UtilProperties.getPropertyValue("oagis.properties","CNTROLAREA.SENDER.LOGICALID");
  String authId=UtilProperties.getPropertyValue("oagis.properties","CNTROLAREA.SENDER.AUTHID");
  MapStack bodyParameters=MapStack.create();
  bodyParameters.put("logicalId",logicalId);
  bodyParameters.put("authId",authId);
  String referenceId=delegator.getNextSeqId("OagisMessageInfo");
  bodyParameters.put("referenceId",referenceId);
  DateFormat dateFormat=new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSS'Z'Z");
  Timestamp timestamp=UtilDateTime.nowTimestamp();
  String sentDate=dateFormat.format(timestamp);
  bodyParameters.put("sentDate",sentDate);
  bodyParameters.put("errorLogicalId",context.get("logicalId"));
  bodyParameters.put("errorComponent",context.get("component"));
  bodyParameters.put("errorTask",context.get("task"));
  bodyParameters.put("errorReferenceId",context.get("referenceId"));
  bodyParameters.put("errorMapList",(List)context.get("errorMapList"));
  bodyParameters.put("origRef",context.get("origRefId"));
  String bodyScreenUri=UtilProperties.getPropertyValue("oagis.properties","Oagis.Template.ConfirmBod");
  Writer writer=null;
  if (out != null) {
    writer=new OutputStreamWriter(out);
  }
 else   if (UtilValidate.isNotEmpty(saveToFilename)) {
    try {
      File outdir=new File(saveToDirectory);
      if (!outdir.exists()) {
        outdir.mkdir();
      }
      writer=new PrintWriter(new BufferedWriter(new OutputStreamWriter(new FileOutputStream(new File(outdir,saveToFilename)),"UTF-8")));
    }
 catch (    Exception e) {
      String errMsg="Error opening file to save message to [" + saveToFilename + "]: "+ e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
 else   if (UtilValidate.isNotEmpty(sendToUrl)) {
    writer=new StringWriter();
  }
  ScreenRenderer screens=new ScreenRenderer(writer,bodyParameters,new HtmlScreenRenderer());
  try {
    screens.render(bodyScreenUri);
    writer.close();
  }
 catch (  Exception e) {
    String errMsg="Error rendering message: " + e.toString();
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
  Map oagisMsgInfoContext=new HashMap();
  oagisMsgInfoContext.put("logicalId",logicalId);
  oagisMsgInfoContext.put("component","EXCEPTION");
  oagisMsgInfoContext.put("task","RECIEPT");
  oagisMsgInfoContext.put("referenceId",referenceId);
  oagisMsgInfoContext.put("authId",authId);
  oagisMsgInfoContext.put("sentDate",timestamp);
  oagisMsgInfoContext.put("confirmation","0");
  oagisMsgInfoContext.put("bsrVerb","CONFIRM");
  oagisMsgInfoContext.put("bsrNoun","BOD");
  oagisMsgInfoContext.put("bsrRevision","004");
  oagisMsgInfoContext.put("userLogin",userLogin);
  try {
    Map oagisMsgInfoResult=dispatcher.runSync("createOagisMessageInfo",oagisMsgInfoContext);
    if (ServiceUtil.isError(oagisMsgInfoResult))     return ServiceUtil.returnError("Error creating OagisMessageInfo");
  }
 catch (  GenericServiceException e) {
    Debug.logError(e,"Saving message to database failed",module);
  }
  if (UtilValidate.isNotEmpty(sendToUrl)) {
    HttpClient http=new HttpClient(sendToUrl);
    http.setHostVerificationLevel(SSLUtil.HOSTCERT_NO_CHECK);
    http.setAllowUntrusted(true);
    http.setDebug(true);
    if (UtilValidate.isNotEmpty(certAlias)) {
      http.setClientCertificateAlias(certAlias);
    }
    if (UtilValidate.isNotEmpty(basicAuthUsername)) {
      http.setBasicAuthInfo(basicAuthUsername,basicAuthPassword);
    }
    http.setContentType("text/xml");
    http.setKeepAlive(true);
    try {
      String resp=http.post(writer.toString());
    }
 catch (    Exception e) {
      String errMsg="Error posting message to server with UTL [" + sendToUrl + "]: "+ e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  return ServiceUtil.returnSuccess("Service Completed Successfully");
}
