{
  LocalDispatcher dispatcher=ctx.getDispatcher();
  InputStream in=(InputStream)context.get("inputStream");
  List errorList=FastList.newInstance();
  Document doc=null;
  String xmlText=null;
  try {
    BufferedReader br=new BufferedReader(new InputStreamReader(in,"UTF-8"));
    StringBuffer xmlTextBuf=new StringBuffer();
    String currentLine=null;
    while ((currentLine=br.readLine()) != null) {
      xmlTextBuf.append(currentLine);
      xmlTextBuf.append('\n');
    }
    xmlText=xmlTextBuf.toString();
    Debug.logWarning("Received OAGIS XML message, here is the text: \n" + xmlText,module);
    ByteArrayInputStream bis=new ByteArrayInputStream(xmlText.getBytes("UTF-8"));
    doc=UtilXml.readXmlDocument(bis,true,"OagisMessage");
  }
 catch (  SAXException e) {
    String errMsg="XML Error parsing the Received Message [" + e.toString() + "]; The text received we could not parse is: ["+ xmlText+ "]";
    errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","SAXException"));
    Debug.logError(e,errMsg,module);
  }
catch (  ParserConfigurationException e) {
    String errMsg="Parser Configuration Error parsing the Received Message: " + e.toString();
    errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","ParserConfigurationException"));
    Debug.logError(e,errMsg,module);
  }
catch (  IOException e) {
    String errMsg="IO Error parsing the Received Message: " + e.toString();
    errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","IOException"));
    Debug.logError(e,errMsg,module);
  }
  if (UtilValidate.isNotEmpty(errorList)) {
    return ServiceUtil.returnError("Unable to parse received message");
  }
  Element rootElement=doc.getDocumentElement();
  rootElement.normalize();
  Element controlAreaElement=UtilXml.firstChildElement(rootElement,"os:CNTROLAREA");
  Element bsrElement=UtilXml.firstChildElement(controlAreaElement,"os:BSR");
  String bsrVerb=UtilXml.childElementValue(bsrElement,"of:VERB");
  String bsrNoun=UtilXml.childElementValue(bsrElement,"of:NOUN");
  if (UtilValidate.isEmpty(bsrVerb) || UtilValidate.isEmpty(bsrNoun)) {
    return ServiceUtil.returnError("Was able to receive and parse the XML message, but BSR->NOUN [" + bsrNoun + "] and/or BSR->VERB ["+ bsrVerb+ "] are empty");
  }
  Map subServiceResult=FastMap.newInstance();
  if (bsrVerb.equalsIgnoreCase("CONFIRM") && bsrNoun.equalsIgnoreCase("BOD")) {
    try {
      subServiceResult=dispatcher.runSync("receiveConfirmBod",UtilMisc.toMap("document",doc));
    }
 catch (    GenericServiceException e) {
      String errMsg="Error running service receiveConfirmBod: " + e.toString();
      errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","GenericServiceException"));
      Debug.logError(e,errMsg,module);
    }
  }
 else   if (bsrVerb.equalsIgnoreCase("SHOW") && bsrNoun.equalsIgnoreCase("SHIPMENT")) {
    try {
      subServiceResult=dispatcher.runSync("showShipment",UtilMisc.toMap("document",doc));
    }
 catch (    GenericServiceException e) {
      String errMsg="Error running service showShipment: " + e.toString();
      errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","GenericServiceException"));
      Debug.logError(e,errMsg,module);
    }
  }
 else   if (bsrVerb.equalsIgnoreCase("SYNC") && bsrNoun.equalsIgnoreCase("INVENTORY")) {
    try {
      subServiceResult=dispatcher.runSync("syncInventory",UtilMisc.toMap("document",doc));
    }
 catch (    GenericServiceException e) {
      String errMsg="Error running service syncInventory: " + e.toString();
      errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","GenericServiceException"));
      Debug.logError(e,errMsg,module);
    }
  }
 else   if (bsrVerb.equalsIgnoreCase("ACKNOWLEDGE") && bsrNoun.equalsIgnoreCase("DELIVERY")) {
    Element dataAreaElement=UtilXml.firstChildElement(rootElement,"ns:DATAAREA");
    Element ackDeliveryElement=UtilXml.firstChildElement(dataAreaElement,"ns:ACKNOWLEDGE_DELIVERY");
    Element receiptlnElement=UtilXml.firstChildElement(ackDeliveryElement,"ns:RECEIPTLN");
    Element docRefElement=UtilXml.firstChildElement(receiptlnElement,"os:DOCUMNTREF");
    String docType=UtilXml.childElementValue(docRefElement,"of:DOCTYPE");
    if ("PO".equals(docType)) {
      try {
        subServiceResult=dispatcher.runSync("receivePoAcknowledge",UtilMisc.toMap("document",doc));
      }
 catch (      GenericServiceException e) {
        String errMsg="Error running service receivePoAcknowledge: " + e.toString();
        errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","GenericServiceException"));
        Debug.logError(e,errMsg,module);
      }
    }
 else     if ("RMA".equals(docType)) {
      try {
        subServiceResult=dispatcher.runSync("receiveRmaAcknowledge",UtilMisc.toMap("document",doc));
      }
 catch (      GenericServiceException e) {
        String errMsg="Error running service receiveRmaAcknowledge: " + e.toString();
        errorList.add(UtilMisc.toMap("description",errMsg,"reasonCode","GenericServiceException"));
        Debug.logError(e,errMsg,module);
      }
    }
 else {
      return ServiceUtil.returnError("For Acknowledge Delivery message could not determine if it is for a PO or RMA. DOCTYPE from message is " + docType);
    }
  }
 else {
    String errMsg="Unknown Message Received";
    Debug.logError(errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
  Map result=ServiceUtil.returnSuccess();
  result.putAll(subServiceResult);
  result.put("contentType","text/plain");
  List errorMapList=(List)subServiceResult.get("errorMapList");
  if (UtilValidate.isNotEmpty(errorList)) {
    Iterator errListItr=errorList.iterator();
    while (errListItr.hasNext()) {
      Map errorMap=(Map)errListItr.next();
      errorMapList.add(UtilMisc.toMap("description",errorMap.get("description"),"reasonCode",errorMap.get("reasonCode")));
    }
    result.put("errorMapList",errorMapList);
  }
  return result;
}
