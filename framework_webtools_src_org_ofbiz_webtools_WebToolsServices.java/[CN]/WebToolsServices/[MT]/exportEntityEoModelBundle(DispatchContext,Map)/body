{
  String eomodeldFullPath=(String)context.get("eomodeldFullPath");
  String entityPackageName=(String)context.get("entityPackageName");
  String entityGroupId=(String)context.get("entityGroupId");
  String datasourceName=(String)context.get("datasourceName");
  String entityNamePrefix=(String)context.get("entityNamePrefix");
  ModelReader reader=dctx.getDelegator().getModelReader();
  try {
    if (!eomodeldFullPath.endsWith(".eomodeld")) {
      eomodeldFullPath=eomodeldFullPath + ".eomodeld";
    }
    File outdir=new File(eomodeldFullPath);
    if (!outdir.exists()) {
      outdir.mkdir();
    }
    if (!outdir.isDirectory()) {
      return ServiceUtil.returnError("eomodel Full Path is not a directory: " + eomodeldFullPath);
    }
    if (!outdir.canWrite()) {
      return ServiceUtil.returnError("eomodel Full Path is not write-able: " + eomodeldFullPath);
    }
    Set<String> entityNames=new TreeSet();
    if (UtilValidate.isNotEmpty(entityPackageName)) {
      Map<String,TreeSet<String>> entitiesByPackage=reader.getEntitiesByPackage(UtilMisc.toSet(entityPackageName),null);
      for (      Map.Entry<String,TreeSet<String>> entitiesByPackageMapEntry : entitiesByPackage.entrySet()) {
        if (entitiesByPackageMapEntry.getKey().contains(entityPackageName)) {
          entityNames.addAll(entitiesByPackageMapEntry.getValue());
        }
      }
      Debug.logInfo("Exporting the following entities: " + entityNames,module);
    }
 else     if (UtilValidate.isNotEmpty(entityGroupId)) {
      entityNames.addAll(EntityGroupUtil.getEntityNamesByGroup(entityGroupId,dctx.getDelegator()));
    }
 else {
      entityNames.addAll(reader.getEntityNames());
    }
    Iterator<String> filterEntityNameIter=entityNames.iterator();
    while (filterEntityNameIter.hasNext()) {
      String entityName=filterEntityNameIter.next();
      ModelEntity modelEntity=reader.getModelEntity(entityName);
      if (modelEntity instanceof ModelViewEntity) {
        filterEntityNameIter.remove();
      }
    }
    Map<String,Object> topLevelMap=FastMap.newInstance();
    topLevelMap.put("EOModelVersion","\"2.1\"");
    List<Map<String,Object>> entitiesMapList=FastList.newInstance();
    topLevelMap.put("entities",entitiesMapList);
    for (    String entityName : entityNames) {
      Map<String,Object> entitiesMap=FastMap.newInstance();
      entitiesMapList.add(entitiesMap);
      entitiesMap.put("className","EOGenericRecord");
      entitiesMap.put("name",entityName);
    }
    PrintWriter writer=new PrintWriter(new BufferedWriter(new OutputStreamWriter(new FileOutputStream(new File(eomodeldFullPath,"index.eomodeld")),"UTF-8")));
    UtilFormatOut.writePlistPropertyMap(topLevelMap,0,writer,false);
    writer.close();
    for (    String curEntityName : entityNames) {
      ModelEntity modelEntity=reader.getModelEntity(curEntityName);
      PrintWriter entityWriter=new PrintWriter(new BufferedWriter(new OutputStreamWriter(new FileOutputStream(new File(eomodeldFullPath,curEntityName + ".plist")),"UTF-8")));
      modelEntity.writeEoModelText(entityWriter,entityNamePrefix,datasourceName,entityNames);
      entityWriter.close();
    }
  }
 catch (  UnsupportedEncodingException e) {
    return ServiceUtil.returnError("ERROR saving file: " + e.toString());
  }
catch (  FileNotFoundException e) {
    return ServiceUtil.returnError("ERROR: file/directory not found: " + e.toString());
  }
catch (  GenericEntityException e) {
    return ServiceUtil.returnError("ERROR: getting entity names: " + e.toString());
  }
  return ServiceUtil.returnSuccess();
}
