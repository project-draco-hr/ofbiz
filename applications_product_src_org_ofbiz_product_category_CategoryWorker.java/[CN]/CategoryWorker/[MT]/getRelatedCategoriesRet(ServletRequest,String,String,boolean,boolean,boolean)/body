{
  List categories=FastList.newInstance();
  if (Debug.verboseOn())   Debug.logVerbose("[CategoryWorker.getRelatedCategories] ParentID: " + parentId,module);
  GenericDelegator delegator=(GenericDelegator)request.getAttribute("delegator");
  List rollups=null;
  try {
    rollups=delegator.findByAndCache("ProductCategoryRollup",UtilMisc.toMap("parentProductCategoryId",parentId),UtilMisc.toList("sequenceNum"));
    if (limitView) {
      rollups=EntityUtil.filterByDate(rollups,true);
    }
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e.getMessage(),module);
    rollups=null;
  }
  if (rollups != null && rollups.size() > 0) {
    Iterator ri=rollups.iterator();
    while (ri.hasNext()) {
      GenericValue parent=(GenericValue)ri.next();
      GenericValue cv=null;
      try {
        cv=parent.getRelatedOneCache("CurrentProductCategory");
      }
 catch (      GenericEntityException e) {
        Debug.logWarning(e.getMessage(),module);
        cv=null;
      }
      if (cv != null) {
        if (excludeEmpty) {
          if (!isCategoryEmpty(cv)) {
            categories.add(cv);
            if (recursive) {
              categories.addAll(getRelatedCategoriesRet(request,attributeName,cv.getString("productCategoryId"),limitView,excludeEmpty,recursive));
            }
          }
        }
 else {
          categories.add(cv);
          if (recursive) {
            categories.addAll(getRelatedCategoriesRet(request,attributeName,cv.getString("productCategoryId"),limitView,excludeEmpty,recursive));
          }
        }
      }
    }
  }
  return categories;
}
