{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  GenericDelegator _delegator=dctx.getDelegator();
  GenericDelegator delegator=_delegator.cloneDelegator();
  delegator.setEntityEcaHandler(null);
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  String partyIdTo=(String)context.get("partyIdTo");
  String partyId=(String)context.get("partyId");
  Timestamp now=UtilDateTime.nowTimestamp();
  if (partyIdTo.equals(partyId)) {
    return ServiceUtil.returnError("Cannot link the same party with itself");
  }
  GenericValue partyTo;
  try {
    partyTo=delegator.findByPrimaryKey("Party",UtilMisc.toMap("partyId",partyIdTo));
  }
 catch (  GenericEntityException e) {
    Debug.log(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (partyTo == null) {
    return ServiceUtil.returnError("Party To does not exist!");
  }
  if ("PARTY_DISABLED".equals(partyTo.get("statusId"))) {
    return ServiceUtil.returnError("Cannot merge records into a disabled party!");
  }
  GenericValue party;
  try {
    party=delegator.findByPrimaryKey("Party",UtilMisc.toMap("partyId",partyId));
  }
 catch (  GenericEntityException e) {
    Debug.log(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  if (party == null) {
    return ServiceUtil.returnError("Party FROM does not exist!");
  }
  try {
    delegator.storeByCondition("PartyContactMech",UtilMisc.<String,Object>toMap("partyId",partyIdTo,"thruDate",now),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("PartyContactMechPurpose",UtilMisc.<String,Object>toMap("partyId",partyIdTo,"thruDate",now),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("PartyNote",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("InventoryItem",UtilMisc.toMap("ownerPartyId",partyIdTo),new EntityExpr("ownerPartyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("Subscription",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("UserLogin",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  List rolesToMove;
  try {
    rolesToMove=delegator.findByAnd("PartyRole",UtilMisc.toMap("partyId",partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  Iterator rtmi=rolesToMove.iterator();
  while (rtmi.hasNext()) {
    GenericValue attr=(GenericValue)rtmi.next();
    attr.set("partyId",partyIdTo);
    try {
      if (delegator.findByPrimaryKey("PartyRole",attr.getPrimaryKey()) == null) {
        attr.create();
      }
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError(e.getMessage());
    }
  }
  try {
    delegator.storeByCondition("OrderRole",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("InvoiceRole",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("DataResourceRole",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("ContentRole",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.storeByCondition("FinAccountRole",UtilMisc.toMap("partyId",partyIdTo),new EntityExpr("partyId",EntityOperator.EQUALS,partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  try {
    delegator.removeByAnd("PartyRole",UtilMisc.toMap("partyId",partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e,module);
  }
  List attrsToMove;
  try {
    attrsToMove=delegator.findByAnd("PartyAttribute",UtilMisc.toMap("partyId",partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  Iterator atmi=attrsToMove.iterator();
  while (atmi.hasNext()) {
    GenericValue attr=(GenericValue)atmi.next();
    attr.set("partyId",partyIdTo);
    try {
      if (delegator.findByPrimaryKey("PartyAttribute",attr.getPrimaryKey()) == null) {
        attr.create();
      }
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError(e.getMessage());
    }
  }
  try {
    delegator.removeByAnd("PartyAttribute",UtilMisc.toMap("partyId",partyId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  GenericValue linkAttr=delegator.makeValue("PartyAttribute");
  linkAttr.set("partyId",partyId);
  linkAttr.set("attrName","LINKED_TO");
  linkAttr.set("attrValue",partyIdTo);
  try {
    delegator.create(linkAttr);
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError(e.getMessage());
  }
  String currentStatus=party.getString("statusId");
  if (currentStatus == null || !"PARTY_DISABLED".equals(currentStatus)) {
    party.set("statusId","PARTY_DISABLED");
    try {
      party.store();
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,"Error setting disable mode on partyId: " + partyId,module);
      return ServiceUtil.returnError(e.getMessage());
    }
  }
  Map resp=ServiceUtil.returnSuccess();
  resp.put("partyId",partyIdTo);
  return resp;
}
