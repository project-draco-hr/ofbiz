{
  OfbizUrlBuilder builder=(OfbizUrlBuilder)request.getAttribute("_OFBIZ_URL_BUILDER_");
  if (builder == null) {
    try {
      builder=OfbizUrlBuilder.from(request);
      request.setAttribute("_OFBIZ_URL_BUILDER_",builder);
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,"Exception thrown while getting web site properties: ",module);
      return null;
    }
catch (    WebAppConfigurationException e) {
      Debug.logError(e,"Exception thrown while parsing controller.xml file: ",module);
      return null;
    }
  }
  boolean didFullSecure=false;
  boolean didFullStandard=false;
  StringBuilder newURL=new StringBuilder(250);
  if (fullPath) {
    try {
      boolean usesHttps=builder.buildHostPart(newURL,url,secure);
      if (usesHttps) {
        didFullSecure=true;
      }
 else {
        didFullStandard=true;
      }
    }
 catch (    WebAppConfigurationException e) {
      Debug.logError(e,"Exception thrown while parsing controller.xml file: ",module);
      return null;
    }
catch (    IOException e) {
      Debug.logError(e,"Exception thrown while appending to StringBuilder: ",module);
      return null;
    }
  }
  String controlPath=(String)request.getAttribute("_CONTROL_PATH_");
  newURL.append(controlPath);
  if (!url.startsWith("/")) {
    newURL.append("/");
  }
  newURL.append(url);
  String encodedUrl;
  if (encode) {
    boolean forceManualJsessionid="false".equals(getServletContext().getInitParameter("cookies")) ? true : false;
    boolean isSpider=false;
    if (UtilHttp.checkURLforSpiders(request)) {
      isSpider=true;
    }
    if (!request.isSecure() && didFullSecure) {
      forceManualJsessionid=true;
    }
    if (request.isSecure() && didFullStandard) {
      forceManualJsessionid=true;
    }
    if (response != null && !forceManualJsessionid && !isSpider) {
      encodedUrl=response.encodeURL(newURL.toString());
    }
 else {
      if (!isSpider) {
        String sessionId=";jsessionid=" + request.getSession().getId();
        int questionIndex=newURL.indexOf("?");
        if (questionIndex == -1) {
          newURL.append(sessionId);
        }
 else {
          newURL.insert(questionIndex,sessionId);
        }
      }
      if (response != null) {
        encodedUrl=response.encodeURL(newURL.toString());
      }
 else {
        encodedUrl=newURL.toString();
      }
    }
  }
 else {
    encodedUrl=newURL.toString();
  }
  return encodedUrl;
}
