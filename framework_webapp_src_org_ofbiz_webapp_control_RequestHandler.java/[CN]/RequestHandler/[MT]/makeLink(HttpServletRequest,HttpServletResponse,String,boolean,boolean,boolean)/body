{
  Delegator delegator=(Delegator)request.getAttribute("delegator");
  String webSiteId=WebSiteWorker.getWebSiteId(request);
  String httpsPort=null;
  String httpsServer=null;
  String httpPort=null;
  String httpServer=null;
  Boolean enableHttps=null;
  GenericValue webSite;
  if (webSiteId != null) {
    try {
      webSite=delegator.findOne("WebSite",UtilMisc.toMap("webSiteId",webSiteId),true);
      if (webSite != null) {
        httpsPort=webSite.getString("httpsPort");
        httpsServer=webSite.getString("httpsHost");
        httpPort=webSite.getString("httpPort");
        httpServer=webSite.getString("httpHost");
        enableHttps=webSite.getBoolean("enableHttps");
      }
    }
 catch (    GenericEntityException e) {
      Debug.logWarning(e,"Problems with WebSite entity; using global defaults",module);
    }
  }
  if (UtilValidate.isEmpty(httpsPort)) {
    httpsPort=UtilProperties.getPropertyValue("url.properties","port.https","443");
  }
  if (UtilValidate.isEmpty(httpsServer)) {
    httpsServer=UtilProperties.getPropertyValue("url.properties","force.https.host");
  }
  if (UtilValidate.isEmpty(httpPort)) {
    httpPort=UtilProperties.getPropertyValue("url.properties","port.http","80");
  }
  if (UtilValidate.isEmpty(httpServer)) {
    httpServer=UtilProperties.getPropertyValue("url.properties","force.http.host");
  }
  if (enableHttps == null) {
    enableHttps=UtilProperties.propertyValueEqualsIgnoreCase("url.properties","port.https.enabled","Y");
  }
  String controlPath=(String)request.getAttribute("_CONTROL_PATH_");
  String requestUri=RequestHandler.getRequestUri(url);
  ConfigXMLReader.RequestMap requestMap=null;
  if (requestUri != null) {
    requestMap=getControllerConfig().getRequestMapMap().get(requestUri);
  }
  StringBuilder newURL=new StringBuilder();
  boolean didFullSecure=false;
  boolean didFullStandard=false;
  if (requestMap != null && (enableHttps || fullPath || secure)) {
    if (Debug.verboseOn())     Debug.logVerbose("In makeLink requestUri=" + requestUri,module);
    if (secure || (enableHttps && requestMap.securityHttps && !request.isSecure())) {
      String server=httpsServer;
      if (UtilValidate.isEmpty(server)) {
        server=request.getServerName();
      }
      newURL.append("https://");
      newURL.append(server);
      if (!httpsPort.equals("443")) {
        newURL.append(":").append(httpsPort);
      }
      didFullSecure=true;
    }
 else     if (fullPath || (enableHttps && !requestMap.securityHttps && request.isSecure())) {
      String server=httpServer;
      if (UtilValidate.isEmpty(server)) {
        server=request.getServerName();
      }
      newURL.append("http://");
      newURL.append(server);
      if (!httpPort.equals("80")) {
        newURL.append(":").append(httpPort);
      }
      didFullStandard=true;
    }
  }
  newURL.append(controlPath);
  if (!url.startsWith("/")) {
    newURL.append("/");
  }
  newURL.append(url);
  String encodedUrl;
  if (encode) {
    boolean forceManualJsessionid="false".equals(getServletContext().getInitParameter("cookies")) ? true : false;
    boolean isSpider=false;
    if (UtilHttp.checkURLforSpiders(request)) {
      isSpider=true;
    }
    if (!request.isSecure() && didFullSecure) {
      forceManualJsessionid=true;
    }
    if (request.isSecure() && didFullStandard) {
      forceManualJsessionid=true;
    }
    if (response != null && !forceManualJsessionid && !isSpider) {
      encodedUrl=response.encodeURL(newURL.toString());
    }
 else {
      if (!isSpider) {
        String sessionId=";jsessionid=" + request.getSession().getId();
        int questionIndex=newURL.indexOf("?");
        if (questionIndex == -1) {
          newURL.append(sessionId);
        }
 else {
          newURL.insert(questionIndex,sessionId);
        }
      }
      if (response != null) {
        encodedUrl=response.encodeURL(newURL.toString());
      }
 else {
        encodedUrl=newURL.toString();
      }
    }
  }
 else {
    encodedUrl=newURL.toString();
  }
  return encodedUrl;
}
