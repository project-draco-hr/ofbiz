{
  HttpSession session=request.getSession();
  String cname=UtilHttp.getApplicationName(request);
  String defaultRequestUri=RequestHandler.getRequestUri(request.getPathInfo());
  if (request.getAttribute("targetRequestUri") == null) {
    if (request.getSession().getAttribute("_PREVIOUS_REQUEST_") != null) {
      request.setAttribute("targetRequestUri",request.getSession().getAttribute("_PREVIOUS_REQUEST_"));
    }
 else {
      request.setAttribute("targetRequestUri","/" + defaultRequestUri);
    }
  }
  String overrideViewUri=RequestHandler.getOverrideViewUri(request.getPathInfo());
  String requestMissingErrorMessage="Unknown request [" + defaultRequestUri + "]; this request does not exist or cannot be called directly.";
  ConfigXMLReader.RequestMap requestMap=controllerConfig.requestMapMap.get(defaultRequestUri);
  if (requestMap == null) {
    throw new RequestHandlerException(requestMissingErrorMessage);
  }
  String eventReturn=null;
  boolean interruptRequest=false;
  if (chain != null) {
    String chainRequestUri=RequestHandler.getRequestUri(chain);
    requestMap=controllerConfig.requestMapMap.get(chainRequestUri);
    if (request.getAttribute("_POST_CHAIN_VIEW_") != null) {
      overrideViewUri=(String)request.getAttribute("_POST_CHAIN_VIEW_");
    }
 else {
      overrideViewUri=RequestHandler.getOverrideViewUri(chain);
    }
    if (Debug.infoOn())     Debug.logInfo("[RequestHandler]: Chain in place: requestUri=" + chainRequestUri + " overrideViewUri="+ overrideViewUri+ " sessionId="+ UtilHttp.getSessionId(request),module);
  }
 else {
    if (!request.isSecure() && requestMap.securityCert) {
      throw new RequestHandlerException(requestMissingErrorMessage);
    }
    if (!requestMap.securityDirectRequest) {
      if (!controllerConfig.requestMapMap.get(controllerConfig.defaultRequest).securityDirectRequest) {
        throw new RequestHandlerException(requestMissingErrorMessage);
      }
 else {
        requestMap=controllerConfig.requestMapMap.get(controllerConfig.defaultRequest);
      }
    }
    if (!request.isSecure() && requestMap.securityHttps && !request.getMethod().equalsIgnoreCase("POST")) {
      StringBuilder urlBuf=new StringBuilder();
      urlBuf.append(request.getPathInfo());
      if (request.getQueryString() != null) {
        urlBuf.append("?").append(request.getQueryString());
      }
      String newUrl=RequestHandler.makeUrl(request,response,urlBuf.toString());
      if (newUrl.toUpperCase().startsWith("HTTPS")) {
        callRedirect(newUrl,response,request);
      }
    }
    if (request.isSecure() && requestMap.securityCert) {
      X509Certificate[] clientCerts=(X509Certificate[])request.getAttribute("javax.servlet.request.X509Certificate");
      if (clientCerts == null) {
        clientCerts=(X509Certificate[])request.getAttribute("javax.net.ssl.peer_certificates");
      }
      if (clientCerts == null) {
        Debug.logWarning("Received no client certificates from browser",module);
      }
      boolean foundTrustedCert=false;
      if (clientCerts == null) {
        throw new RequestHandlerException(requestMissingErrorMessage);
      }
 else {
        if (Debug.infoOn()) {
          for (int i=0; i < clientCerts.length; i++) {
            Debug.logInfo(clientCerts[i].getSubjectX500Principal().getName(),module);
          }
        }
        if (SSLUtil.isClientTrusted(clientCerts,null)) {
          foundTrustedCert=true;
        }
      }
      if (!foundTrustedCert) {
        Debug.logWarning(requestMissingErrorMessage,module);
        throw new RequestHandlerException(requestMissingErrorMessage);
      }
    }
    if (this.trackVisit(request) && session.getAttribute("visit") == null) {
      if (Debug.infoOn())       Debug.logInfo("This is the first request in this visit." + " sessionId=" + UtilHttp.getSessionId(request),module);
      GenericValue visit=VisitHandler.getVisit(session);
      if (visit != null) {
        for (        ConfigXMLReader.Event event : controllerConfig.firstVisitEventList) {
          try {
            String returnString=this.runEvent(request,response,event.type,event.path,event.invoke);
            if (returnString != null && !returnString.equalsIgnoreCase("success")) {
              throw new EventHandlerException("First-Visit event did not return 'success'.");
            }
 else             if (returnString == null) {
              interruptRequest=true;
            }
          }
 catch (          EventHandlerException e) {
            Debug.logError(e,module);
          }
        }
      }
    }
    for (    ConfigXMLReader.Event event : controllerConfig.preprocessorEventList) {
      try {
        String returnString=this.runEvent(request,response,event.type,event.path,event.invoke);
        if (returnString != null && !returnString.equalsIgnoreCase("success")) {
          if (!returnString.contains(":_protect_:")) {
            throw new EventHandlerException("Pre-Processor event did not return 'success'.");
          }
 else {
            returnString=returnString.replace(":_protect_:","");
            if (returnString.length() > 0) {
              request.setAttribute("_ERROR_MESSAGE_",returnString);
            }
            eventReturn="protect";
            if (!requestMap.requestResponseMap.containsKey("protect")) {
              if (controllerConfig.protectView != null) {
                overrideViewUri=controllerConfig.protectView;
              }
 else {
                overrideViewUri=UtilProperties.getPropertyValue("security.properties","default.error.response.view");
              }
            }
          }
        }
 else         if (returnString == null) {
          interruptRequest=true;
        }
      }
 catch (      EventHandlerException e) {
        Debug.logError(e,module);
      }
    }
  }
  if (interruptRequest) {
    if (Debug.infoOn())     Debug.logInfo("[Pre-Processor Interrupted Request, not running: " + requestMap.uri + " sessionId="+ UtilHttp.getSessionId(request),module);
    return;
  }
  if (Debug.infoOn())   Debug.logInfo("[Processing Request]: " + requestMap.uri + " sessionId="+ UtilHttp.getSessionId(request),module);
  request.setAttribute("thisRequestUri",requestMap.uri);
  if (requestMap.securityAuth) {
    Debug.logVerbose("[RequestHandler]: AuthRequired. Running security check." + " sessionId=" + UtilHttp.getSessionId(request),module);
    ConfigXMLReader.Event checkLoginEvent=controllerConfig.requestMapMap.get("checkLogin").event;
    String checkLoginReturnString=null;
    try {
      checkLoginReturnString=this.runEvent(request,response,checkLoginEvent.type,checkLoginEvent.path,checkLoginEvent.invoke);
    }
 catch (    EventHandlerException e) {
      throw new RequestHandlerException(e.getMessage(),e);
    }
    if (!"success".equalsIgnoreCase(checkLoginReturnString)) {
      eventReturn=checkLoginReturnString;
      requestMap=controllerConfig.requestMapMap.get("checkLogin");
    }
  }
  if (request.getSession().getAttribute("_PREVIOUS_PARAM_MAP_FORM_") != null && request.getSession().getAttribute("_PREVIOUS_REQUEST_") == null) {
    Map<String,Object> previousParamMap=(Map<String,Object>)request.getSession().getAttribute("_PREVIOUS_PARAM_MAP_FORM_");
    for (    Map.Entry<String,Object> previousParamEntry : previousParamMap.entrySet()) {
      request.setAttribute(previousParamEntry.getKey(),previousParamEntry.getValue());
    }
    request.getSession().removeAttribute("_PREVIOUS_PARAM_MAP_FORM_");
  }
  ConfigXMLReader.RequestResponse nextRequestResponse=null;
  if (eventReturn == null && requestMap.event != null) {
    if (requestMap.event.type != null && requestMap.event.path != null && requestMap.event.invoke != null) {
      try {
        long eventStartTime=System.currentTimeMillis();
        eventReturn=this.runEvent(request,response,requestMap.event.type,requestMap.event.path,requestMap.event.invoke);
        if (this.trackStats(request)) {
          ServerHitBin.countEvent(cname + "." + requestMap.event.invoke,request,eventStartTime,System.currentTimeMillis() - eventStartTime,userLogin,delegator);
        }
        if (eventReturn == null) {
          nextRequestResponse=ConfigXMLReader.emptyNoneRequestResponse;
        }
      }
 catch (      EventHandlerException e) {
        if (requestMap.requestResponseMap.containsKey("error")) {
          eventReturn="error";
          Locale locale=UtilHttp.getLocale(request);
          String errMsg=UtilProperties.getMessage(RequestHandler.err_resource,"requestHandler.error_call_event",locale);
          request.setAttribute("_ERROR_MESSAGE_",errMsg + ": " + e.toString());
        }
 else {
          throw new RequestHandlerException("Error calling event and no error response was specified",e);
        }
      }
    }
  }
  ConfigXMLReader.RequestResponse eventReturnBasedRequestResponse=eventReturn == null ? null : requestMap.requestResponseMap.get(eventReturn);
  if (eventReturnBasedRequestResponse != null) {
    if (Debug.verboseOn())     Debug.logVerbose("[Response Qualified]: " + eventReturnBasedRequestResponse.name + ", "+ eventReturnBasedRequestResponse.type+ ":"+ eventReturnBasedRequestResponse.value+ " sessionId="+ UtilHttp.getSessionId(request),module);
    if ("error".equals(eventReturnBasedRequestResponse.name)) {
      if (Debug.errorOn()) {
        String errorMessageHeader="Request " + requestMap.uri + " caused an error with the following message: ";
        if (request.getAttribute("_ERROR_MESSAGE_") != null) {
          Debug.logError(errorMessageHeader + request.getAttribute("_ERROR_MESSAGE_"),module);
        }
        if (request.getAttribute("_ERROR_MESSAGE_LIST_") != null) {
          Debug.logError(errorMessageHeader + request.getAttribute("_ERROR_MESSAGE_LIST_"),module);
        }
      }
    }
  }
 else {
    Debug.logWarning("Could not find response in request [" + requestMap.uri + "] for event return ["+ eventReturn+ "]",module);
  }
  if (eventReturnBasedRequestResponse != null && (!"success".equals(eventReturnBasedRequestResponse.name) || "none".equals(eventReturnBasedRequestResponse.type)))   nextRequestResponse=eventReturnBasedRequestResponse;
  String previousRequest=(String)request.getSession().getAttribute("_PREVIOUS_REQUEST_");
  String loginPass=(String)request.getAttribute("_LOGIN_PASSED_");
  String preReqAttStr=(String)request.getSession().getAttribute("_REQ_ATTR_MAP_");
  Map<String,Object> previousRequestAttrMap=null;
  if (preReqAttStr != null) {
    previousRequestAttrMap=FastMap.newInstance();
    request.getSession().removeAttribute("_REQ_ATTR_MAP_");
    byte[] reqAttrMapBytes=StringUtil.fromHexString(preReqAttStr);
    Map<String,Object> preRequestMap=checkMap(UtilObject.getObject(reqAttrMapBytes),String.class,Object.class);
    if (UtilValidate.isNotEmpty(preRequestMap)) {
      for (      Map.Entry<String,Object> entry : preRequestMap.entrySet()) {
        String key=entry.getKey();
        if ("_ERROR_MESSAGE_LIST_".equals(key) || "_ERROR_MESSAGE_MAP_".equals(key) || "_ERROR_MESSAGE_".equals(key)|| "_EVENT_MESSAGE_LIST_".equals(key)|| "_EVENT_MESSAGE_".equals(key)) {
          request.setAttribute(key,entry.getValue());
          previousRequestAttrMap.put(key,entry.getValue());
        }
      }
    }
  }
  if (Debug.verboseOn())   Debug.logVerbose("[RequestHandler]: previousRequest - " + previousRequest + " ("+ loginPass+ ")"+ " sessionId="+ UtilHttp.getSessionId(request),module);
  if (previousRequest != null && loginPass != null && loginPass.equalsIgnoreCase("TRUE")) {
    request.getSession().removeAttribute("_PREVIOUS_REQUEST_");
    if ("logout".equals(previousRequest) || "/logout".equals(previousRequest) || "login".equals(previousRequest)|| "/login".equals(previousRequest)|| "checkLogin".equals(previousRequest)|| "/checkLogin".equals(previousRequest)|| "/checkLogin/login".equals(previousRequest)) {
      Debug.logWarning("Found special _PREVIOUS_REQUEST_ of [" + previousRequest + "], setting to null to avoid problems, not running request again",module);
    }
 else {
      if (Debug.infoOn())       Debug.logInfo("[Doing Previous Request]: " + previousRequest + " sessionId="+ UtilHttp.getSessionId(request),module);
      Map<String,Object> previousParamMap=(Map<String,Object>)request.getSession().getAttribute("_PREVIOUS_PARAM_MAP_URL_");
      String queryString=UtilHttp.urlEncodeArgs(previousParamMap,false);
      String redirectTarget=previousRequest;
      if (UtilValidate.isNotEmpty(queryString)) {
        redirectTarget+="?" + queryString;
      }
      callRedirect(makeLink(request,response,redirectTarget),response,request);
      return;
    }
  }
  ConfigXMLReader.RequestResponse successResponse=requestMap.requestResponseMap.get("success");
  if ("success".equals(eventReturn) && successResponse != null && "request".equals(successResponse.type)) {
    if (nextRequestResponse != null) {
      request.setAttribute("_POST_CHAIN_VIEW_",nextRequestResponse.value);
    }
    nextRequestResponse=successResponse;
  }
  if (nextRequestResponse == null)   nextRequestResponse=successResponse;
  if (nextRequestResponse == null) {
    throw new RequestHandlerException("Illegal response; handler could not process request [" + requestMap.uri + "] and event return ["+ eventReturn+ "].");
  }
  if (Debug.verboseOn())   Debug.logVerbose("[Event Response Selected]  type=" + nextRequestResponse.type + ", value="+ nextRequestResponse.value+ ", sessionId="+ UtilHttp.getSessionId(request),module);
  if (nextRequestResponse != null && "request".equals(nextRequestResponse.type)) {
    Debug.logInfo("[RequestHandler.doRequest]: Response is a chained request." + " sessionId=" + UtilHttp.getSessionId(request),module);
    doRequest(request,response,nextRequestResponse.value,userLogin,delegator);
  }
 else {
    for (    ConfigXMLReader.Event event : this.controllerConfig.postprocessorEventList) {
      try {
        String returnString=this.runEvent(request,response,event.type,event.path,event.invoke);
        if (returnString != null && !returnString.equalsIgnoreCase("success")) {
          throw new EventHandlerException("Post-Processor event did not return 'success'.");
        }
      }
 catch (      EventHandlerException e) {
        Debug.logError(e,module);
      }
    }
    if ("url".equals(nextRequestResponse.type)) {
      Debug.logInfo("[RequestHandler.doRequest]: Response is a URL redirect." + " sessionId=" + UtilHttp.getSessionId(request),module);
      callRedirect(nextRequestResponse.value,response,request);
    }
 else     if ("cross-redirect".equals(nextRequestResponse.type)) {
      Debug.logInfo("[RequestHandler.doRequest]: Response is a Cross-Application redirect." + " sessionId=" + UtilHttp.getSessionId(request),module);
      String url=nextRequestResponse.value.startsWith("/") ? nextRequestResponse.value : "/" + nextRequestResponse.value;
      callRedirect(url + this.makeQueryString(request,nextRequestResponse),response,request);
    }
 else     if ("request-redirect".equals(nextRequestResponse.type)) {
      Debug.logInfo("[RequestHandler.doRequest]: Response is a Request redirect." + " sessionId=" + UtilHttp.getSessionId(request),module);
      callRedirect(makeLinkWithQueryString(request,response,"/" + nextRequestResponse.value,nextRequestResponse),response,request);
    }
 else     if ("request-redirect-noparam".equals(nextRequestResponse.type)) {
      Debug.logInfo("[RequestHandler.doRequest]: Response is a Request redirect with no parameters." + " sessionId=" + UtilHttp.getSessionId(request),module);
      callRedirect(makeLink(request,response,nextRequestResponse.value),response,request);
    }
 else     if ("view".equals(nextRequestResponse.type)) {
      Debug.logInfo("[RequestHandler.doRequest]: Response is a view." + " sessionId=" + UtilHttp.getSessionId(request),module);
      String viewName=(UtilValidate.isNotEmpty(overrideViewUri) && (eventReturn == null || "success".equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;
      renderView(viewName,requestMap.securityExternalView,request,response);
    }
 else     if ("none".equals(nextRequestResponse.type)) {
      Debug.logInfo("[RequestHandler.doRequest]: Response is handled by the event." + " sessionId=" + UtilHttp.getSessionId(request),module);
    }
  }
}
