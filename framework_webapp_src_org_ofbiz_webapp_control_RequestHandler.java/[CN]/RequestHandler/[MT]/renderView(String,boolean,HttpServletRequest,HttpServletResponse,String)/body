{
  GenericValue userLogin=(GenericValue)req.getSession().getAttribute("userLogin");
  String cname=UtilHttp.getApplicationName(req);
  String oldView=view;
  if (UtilValidate.isNotEmpty(view) && view.charAt(0) == '/') {
    view=view.substring(1);
  }
  String servletName=req.getServletPath().substring(1);
  if (Debug.infoOn())   Debug.logInfo("Rendering View [" + view + "], sessionId="+ UtilHttp.getSessionId(req),module);
  if (view.startsWith(servletName + "/")) {
    view=view.substring(servletName.length() + 1);
    if (Debug.infoOn())     Debug.logInfo("a manual control servlet request was received, removing control servlet path resulting in: view=" + view,module);
  }
  if (Debug.verboseOn())   Debug.logVerbose("[Getting View Map]: " + view + " sessionId="+ UtilHttp.getSessionId(req),module);
  req.setAttribute("_CURRENT_VIEW_",view);
  Map<String,Object> paramMap=UtilHttp.getParameterMap(req);
  paramMap.putAll(UtilHttp.getAttributeMap(req));
  UtilMisc.makeMapSerializable(paramMap);
  if (paramMap.containsKey("_LAST_VIEW_NAME_")) {
    req.getSession().setAttribute("_LAST_VIEW_NAME_",paramMap.get("_LAST_VIEW_NAME_"));
  }
 else {
    req.getSession().setAttribute("_LAST_VIEW_NAME_",view);
  }
  req.getSession().setAttribute("_LAST_VIEW_PARAMS_",paramMap);
  if ("SAVED".equals(saveName)) {
    req.getSession().setAttribute("_SAVED_VIEW_NAME_",view);
    req.getSession().setAttribute("_SAVED_VIEW_PARAMS_",paramMap);
  }
  if ("HOME".equals(saveName)) {
    req.getSession().setAttribute("_HOME_VIEW_NAME_",view);
    req.getSession().setAttribute("_HOME_VIEW_PARAMS_",paramMap);
    req.getSession().removeAttribute("_SAVED_VIEW_NAME_");
    req.getSession().removeAttribute("_SAVED_VIEW_PARAMS_");
  }
  ConfigXMLReader.ViewMap viewMap=(view == null ? null : getControllerConfig().getViewMapMap().get(view));
  if (viewMap == null) {
    throw new RequestHandlerException("No definition found for view with name [" + view + "]");
  }
  String nextPage;
  if (viewMap.page == null) {
    if (!allowExtView) {
      throw new RequestHandlerException("No view to render.");
    }
 else {
      nextPage="/" + oldView;
    }
  }
 else {
    nextPage=viewMap.page;
  }
  if (Debug.verboseOn())   Debug.logVerbose("[Mapped To]: " + nextPage + " sessionId="+ UtilHttp.getSessionId(req),module);
  long viewStartTime=System.currentTimeMillis();
  String charset=UtilFormatOut.checkEmpty(getServletContext().getInitParameter("charset"),req.getCharacterEncoding(),"UTF-8");
  String viewCharset=viewMap.encoding;
  if (UtilValidate.isNotEmpty(viewCharset)) {
    charset=viewCharset;
  }
  if (!"none".equals(charset)) {
    try {
      req.setCharacterEncoding(charset);
    }
 catch (    UnsupportedEncodingException e) {
      throw new RequestHandlerException("Could not set character encoding to " + charset,e);
    }
catch (    IllegalStateException e) {
      Debug.logInfo(e,"Could not set character encoding to " + charset + ", something has probably already committed the stream",module);
    }
  }
  String contentType="text/html";
  String viewContentType=viewMap.contentType;
  if (UtilValidate.isNotEmpty(viewContentType)) {
    contentType=viewContentType;
  }
  if (charset.length() > 0 && !"none".equals(charset)) {
    resp.setContentType(contentType + "; charset=" + charset);
  }
 else {
    resp.setContentType(contentType);
  }
  if (Debug.verboseOn())   Debug.logVerbose("The ContentType for the " + view + " view is: "+ contentType,module);
  boolean viewNoCache=viewMap.noCache;
  if (viewNoCache) {
    UtilHttp.setResponseBrowserProxyNoCache(resp);
    if (Debug.verboseOn())     Debug.logVerbose("Sending no-cache headers for view [" + nextPage + "]",module);
  }
  try {
    if (Debug.verboseOn())     Debug.logVerbose("Rendering view [" + nextPage + "] of type ["+ viewMap.type+ "]",module);
    ViewHandler vh=viewFactory.getViewHandler(viewMap.type);
    vh.render(view,nextPage,viewMap.info,contentType,charset,req,resp);
  }
 catch (  ViewHandlerException e) {
    Throwable throwable=e.getNested() != null ? e.getNested() : e;
    throw new RequestHandlerException(e.getNonNestedMessage(),throwable);
  }
  try {
    resp.flushBuffer();
  }
 catch (  java.io.IOException e) {
    throw new RequestHandlerException("Error flushing response buffer",e);
  }
  String vname=(String)req.getAttribute("_CURRENT_VIEW_");
  if (this.trackStats(req) && vname != null) {
    ServerHitBin.countView(cname + "." + vname,req,viewStartTime,System.currentTimeMillis() - viewStartTime,userLogin);
  }
}
