{
  Delegator delegator=dctx.getDelegator();
  String productStoreId=(String)context.get("productStoreId");
  String payToPartyId=(String)context.get("payToPartyId");
  String billToPartyId=(String)context.get("billToPartyId");
  List<GenericValue> itemProductList=UtilGenerics.cast(context.get("itemProductList"));
  List<BigDecimal> itemAmountList=UtilGenerics.cast(context.get("itemAmountList"));
  List<BigDecimal> itemPriceList=UtilGenerics.cast(context.get("itemPriceList"));
  List<BigDecimal> itemShippingList=UtilGenerics.cast(context.get("itemShippingList"));
  BigDecimal orderShippingAmount=(BigDecimal)context.get("orderShippingAmount");
  BigDecimal orderPromotionsAmount=(BigDecimal)context.get("orderPromotionsAmount");
  GenericValue shippingAddress=(GenericValue)context.get("shippingAddress");
  if (shippingAddress == null || (shippingAddress.get("countryGeoId") == null && shippingAddress.get("stateProvinceGeoId") == null && shippingAddress.get("postalCodeGeoId") == null)) {
    return ServiceUtil.returnError("The address(es) used for tax calculation did not have State/Province or Country or other tax jurisdiction values set, so we cannot determine the taxes to charge.");
  }
  Set<GenericValue> taxAuthoritySet=FastSet.newInstance();
  GenericValue productStore=null;
  if (productStoreId != null) {
    try {
      getTaxAuthorities(delegator,shippingAddress,taxAuthoritySet);
      if (productStoreId != null) {
        productStore=delegator.findByPrimaryKey("ProductStore",UtilMisc.toMap("productStoreId",productStoreId));
      }
    }
 catch (    GenericEntityException e) {
      String errMsg="Data error getting tax settings: " + e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
    if (productStore == null && payToPartyId == null) {
      throw new IllegalArgumentException("Could not find payToPartyId [" + payToPartyId + "] or ProductStore ["+ productStoreId+ "] for tax calculation");
    }
  }
 else {
    try {
      getTaxAuthorities(delegator,shippingAddress,taxAuthoritySet);
    }
 catch (    GenericEntityException e) {
      String errMsg="Data error getting tax settings: " + e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  List<GenericValue> orderAdjustments=FastList.newInstance();
  List<List<GenericValue>> itemAdjustments=FastList.newInstance();
  for (int i=0; i < itemProductList.size(); i++) {
    GenericValue product=itemProductList.get(i);
    BigDecimal itemAmount=itemAmountList.get(i);
    BigDecimal itemPrice=itemPriceList.get(i);
    BigDecimal shippingAmount=itemShippingList.get(i);
    List<GenericValue> taxList=null;
    if (shippingAddress != null) {
      taxList=getTaxAdjustments(delegator,product,productStore,payToPartyId,billToPartyId,taxAuthoritySet,itemPrice,itemAmount,shippingAmount,ZERO_BASE);
    }
    itemAdjustments.add(taxList);
  }
  if (orderShippingAmount != null && orderShippingAmount.compareTo(BigDecimal.ZERO) > 0) {
    List<GenericValue> taxList=getTaxAdjustments(delegator,null,productStore,payToPartyId,billToPartyId,taxAuthoritySet,ZERO_BASE,ZERO_BASE,orderShippingAmount,ZERO_BASE);
    orderAdjustments.addAll(taxList);
  }
  if (orderPromotionsAmount != null && orderPromotionsAmount.compareTo(BigDecimal.ZERO) != 0) {
    List<GenericValue> taxList=getTaxAdjustments(delegator,null,productStore,payToPartyId,billToPartyId,taxAuthoritySet,ZERO_BASE,ZERO_BASE,ZERO_BASE,orderPromotionsAmount);
    orderAdjustments.addAll(taxList);
  }
  Map<String,Object> result=ServiceUtil.returnSuccess();
  result.put("orderAdjustments",orderAdjustments);
  result.put("itemAdjustments",itemAdjustments);
  return result;
}
