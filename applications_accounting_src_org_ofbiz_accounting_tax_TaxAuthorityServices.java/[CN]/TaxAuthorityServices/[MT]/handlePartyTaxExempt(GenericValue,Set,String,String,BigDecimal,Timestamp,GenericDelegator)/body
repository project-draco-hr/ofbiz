{
  Debug.log("Checking for tax exemption : " + taxAuthGeoId + " / "+ taxAuthPartyId,module);
  List ptiConditionList=UtilMisc.toList(new EntityExpr("partyId",EntityOperator.IN,billToPartyIdSet),new EntityExpr("taxAuthGeoId",EntityOperator.EQUALS,taxAuthGeoId),new EntityExpr("taxAuthPartyId",EntityOperator.EQUALS,taxAuthPartyId));
  ptiConditionList.add(new EntityExpr("fromDate",EntityOperator.LESS_THAN_EQUAL_TO,nowTimestamp));
  ptiConditionList.add(new EntityExpr(new EntityExpr("thruDate",EntityOperator.EQUALS,null),EntityOperator.OR,new EntityExpr("thruDate",EntityOperator.GREATER_THAN,nowTimestamp)));
  EntityCondition ptiCondition=new EntityConditionList(ptiConditionList,EntityOperator.AND);
  List partyTaxInfos=delegator.findByCondition("PartyTaxAuthInfo",ptiCondition,null,UtilMisc.toList("-fromDate"));
  boolean foundExemption=false;
  if (partyTaxInfos.size() > 0) {
    GenericValue partyTaxInfo=(GenericValue)partyTaxInfos.get(0);
    adjValue.set("customerReferenceId",partyTaxInfo.get("partyTaxId"));
    if ("Y".equals(partyTaxInfo.getString("isExempt"))) {
      adjValue.set("amount",new Double(0));
      adjValue.set("exemptAmount",taxAmount);
      foundExemption=true;
    }
  }
  if (!foundExemption) {
    List taxAuthorityAssocList=delegator.findByAndCache("TaxAuthorityAssoc",UtilMisc.toMap("toTaxAuthGeoId",taxAuthGeoId,"toTaxAuthPartyId",taxAuthPartyId,"taxAuthorityAssocTypeId","EXEMPT_INHER"),UtilMisc.toList("-fromDate"));
    taxAuthorityAssocList=EntityUtil.filterByDate(taxAuthorityAssocList,true);
    GenericValue taxAuthorityAssoc=EntityUtil.getFirst(taxAuthorityAssocList);
    Debug.log("Parent assoc to " + taxAuthGeoId + " : "+ taxAuthorityAssoc,module);
    if (taxAuthorityAssoc != null) {
      handlePartyTaxExempt(adjValue,billToPartyIdSet,taxAuthorityAssoc.getString("taxAuthGeoId"),taxAuthorityAssoc.getString("taxAuthPartyId"),taxAmount,nowTimestamp,delegator);
    }
  }
}
