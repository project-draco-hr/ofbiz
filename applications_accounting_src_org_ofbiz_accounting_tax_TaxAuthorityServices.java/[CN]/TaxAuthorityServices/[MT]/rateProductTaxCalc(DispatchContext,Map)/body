{
  Delegator delegator=dctx.getDelegator();
  String productStoreId=(String)context.get("productStoreId");
  String facilityId=(String)context.get("facilityId");
  String payToPartyId=(String)context.get("payToPartyId");
  String billToPartyId=(String)context.get("billToPartyId");
  List itemProductList=(List)context.get("itemProductList");
  List itemAmountList=(List)context.get("itemAmountList");
  List itemPriceList=(List)context.get("itemPriceList");
  List itemShippingList=(List)context.get("itemShippingList");
  BigDecimal orderShippingAmount=(BigDecimal)context.get("orderShippingAmount");
  BigDecimal orderPromotionsAmount=(BigDecimal)context.get("orderPromotionsAmount");
  GenericValue shippingAddress=(GenericValue)context.get("shippingAddress");
  Timestamp nowTimestamp=UtilDateTime.nowTimestamp();
  GenericValue productStore=null;
  GenericValue facility=null;
  try {
    if (productStoreId != null) {
      productStore=delegator.findByPrimaryKey("ProductStore",UtilMisc.toMap("productStoreId",productStoreId));
    }
    if (facilityId != null) {
      facility=delegator.findByPrimaryKey("Facility",UtilMisc.toMap("facilityId",facilityId));
    }
  }
 catch (  GenericEntityException e) {
    String errMsg="Data error getting tax settings: " + e.toString();
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
  if (productStore == null && payToPartyId == null) {
    throw new IllegalArgumentException("Could not find payToPartyId [" + payToPartyId + "] or ProductStore ["+ productStoreId+ "] for tax calculation");
  }
  if (shippingAddress == null && facility != null) {
    try {
      GenericValue facilityContactMech=ContactMechWorker.getFacilityContactMechByPurpose(delegator,facilityId,UtilMisc.toList("SHIP_ORIG_LOCATION","PRIMARY_LOCATION"));
      if (facilityContactMech != null) {
        shippingAddress=delegator.findByPrimaryKey("PostalAddress",UtilMisc.toMap("contactMechId",facilityContactMech.getString("contactMechId")));
      }
    }
 catch (    GenericEntityException e) {
      String errMsg="Data error getting tax settings: " + e.toString();
      Debug.logError(e,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  if (shippingAddress == null || (shippingAddress.get("countryGeoId") == null && shippingAddress.get("stateProvinceGeoId") == null && shippingAddress.get("postalCodeGeoId") == null)) {
    String errMsg="The address(es) used for tax calculation did not have State/Province or Country or other tax jurisdiction values set, so we cannot determine the taxes to charge.";
    if (shippingAddress != null) {
      errMsg+=" [ID:" + shippingAddress.getString("contactMechId") + ", Address 1: "+ shippingAddress.get("address1")+ ", Postal Code/ID: "+ shippingAddress.get("postalCodeGeoId")+ "/"+ shippingAddress.get("postalCodeGeoId")+ ", State/Province: "+ shippingAddress.get("stateProvinceGeoId")+ ", Country: "+ shippingAddress.get("countryGeoId")+ "]";
      Debug.logError(errMsg,module);
    }
    return ServiceUtil.returnError(errMsg);
  }
  Set taxAuthoritySet=FastSet.newInstance();
  try {
    getTaxAuthorities(delegator,shippingAddress,taxAuthoritySet);
  }
 catch (  GenericEntityException e) {
    String errMsg="Data error getting tax settings: " + e.toString();
    Debug.logError(e,errMsg,module);
    return ServiceUtil.returnError(errMsg);
  }
  List orderAdjustments=FastList.newInstance();
  List itemAdjustments=FastList.newInstance();
  for (int i=0; i < itemProductList.size(); i++) {
    GenericValue product=(GenericValue)itemProductList.get(i);
    BigDecimal itemAmount=(BigDecimal)itemAmountList.get(i);
    BigDecimal itemPrice=(BigDecimal)itemPriceList.get(i);
    BigDecimal shippingAmount=(BigDecimal)itemShippingList.get(i);
    List taxList=null;
    if (shippingAddress != null) {
      taxList=getTaxAdjustments(delegator,product,productStore,payToPartyId,billToPartyId,taxAuthoritySet,itemPrice,itemAmount,shippingAmount,ZERO_BASE);
    }
    itemAdjustments.add(taxList);
  }
  if (orderShippingAmount != null && orderShippingAmount.compareTo(BigDecimal.ZERO) > 0) {
    List taxList=getTaxAdjustments(delegator,null,productStore,payToPartyId,billToPartyId,taxAuthoritySet,ZERO_BASE,ZERO_BASE,orderShippingAmount,ZERO_BASE);
    orderAdjustments.addAll(taxList);
  }
  if (orderPromotionsAmount != null && orderPromotionsAmount.compareTo(BigDecimal.ZERO) != 0) {
    List taxList=getTaxAdjustments(delegator,null,productStore,payToPartyId,billToPartyId,taxAuthoritySet,ZERO_BASE,ZERO_BASE,ZERO_BASE,orderPromotionsAmount);
    orderAdjustments.addAll(taxList);
  }
  Map result=ServiceUtil.returnSuccess();
  result.put("orderAdjustments",orderAdjustments);
  result.put("itemAdjustments",itemAdjustments);
  return result;
}
