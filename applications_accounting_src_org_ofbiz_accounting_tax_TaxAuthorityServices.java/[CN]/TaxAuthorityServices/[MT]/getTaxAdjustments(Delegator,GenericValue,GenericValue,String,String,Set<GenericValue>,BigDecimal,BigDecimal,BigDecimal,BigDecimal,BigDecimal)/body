{
  Timestamp nowTimestamp=UtilDateTime.nowTimestamp();
  List<GenericValue> adjustments=FastList.newInstance();
  if (payToPartyId == null) {
    if (productStore != null) {
      payToPartyId=productStore.getString("payToPartyId");
    }
  }
  EntityCondition storeCond=null;
  if (productStore != null) {
    storeCond=EntityCondition.makeCondition(EntityCondition.makeCondition("productStoreId",EntityOperator.EQUALS,productStore.get("productStoreId")),EntityOperator.OR,EntityCondition.makeCondition("productStoreId",EntityOperator.EQUALS,null));
  }
 else {
    storeCond=EntityCondition.makeCondition("productStoreId",EntityOperator.EQUALS,null);
  }
  List<EntityCondition> taxAuthCondOrList=FastList.newInstance();
  taxAuthCondOrList.add(EntityCondition.makeCondition(EntityCondition.makeCondition("taxAuthPartyId",EntityOperator.EQUALS,"_NA_"),EntityOperator.AND,EntityCondition.makeCondition("taxAuthGeoId",EntityOperator.EQUALS,"_NA_")));
  Iterator<GenericValue> taxAuthorityIter=taxAuthoritySet.iterator();
  while (taxAuthorityIter.hasNext()) {
    GenericValue taxAuthority=(GenericValue)taxAuthorityIter.next();
    EntityCondition taxAuthCond=EntityCondition.makeCondition(EntityCondition.makeCondition("taxAuthPartyId",EntityOperator.EQUALS,taxAuthority.getString("taxAuthPartyId")),EntityOperator.AND,EntityCondition.makeCondition("taxAuthGeoId",EntityOperator.EQUALS,taxAuthority.getString("taxAuthGeoId")));
    taxAuthCondOrList.add(taxAuthCond);
  }
  EntityCondition taxAuthoritiesCond=EntityCondition.makeCondition(taxAuthCondOrList,EntityOperator.OR);
  try {
    EntityCondition productCategoryCond=null;
    if (product != null) {
      String virtualProductId=null;
      if ("Y".equals(product.getString("isVariant"))) {
        virtualProductId=ProductWorker.getVariantVirtualId(product);
      }
      Set<String> productCategoryIdSet=FastSet.newInstance();
      EntityCondition productIdCond=null;
      if (virtualProductId != null) {
        productIdCond=EntityCondition.makeCondition(EntityCondition.makeCondition("productId",EntityOperator.EQUALS,product.getString("productId")),EntityOperator.OR,EntityCondition.makeCondition("productId",EntityOperator.EQUALS,virtualProductId));
      }
 else {
        productIdCond=EntityCondition.makeCondition("productId",EntityOperator.EQUALS,product.getString("productId"));
      }
      List<GenericValue> pcmList=delegator.findList("ProductCategoryMember",productIdCond,UtilMisc.toSet("productCategoryId"),null,null,true);
      pcmList=EntityUtil.filterByDate(pcmList,true);
      Iterator<GenericValue> pcmIter=pcmList.iterator();
      while (pcmIter.hasNext()) {
        GenericValue pcm=(GenericValue)pcmIter.next();
        productCategoryIdSet.add(pcm.getString("productCategoryId"));
      }
      if (productCategoryIdSet.size() == 0) {
        productCategoryCond=EntityCondition.makeCondition("productCategoryId",EntityOperator.EQUALS,null);
      }
 else {
        productCategoryCond=EntityCondition.makeCondition(EntityCondition.makeCondition("productCategoryId",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("productCategoryId",EntityOperator.IN,productCategoryIdSet));
      }
    }
 else {
      productCategoryCond=EntityCondition.makeCondition("productCategoryId",EntityOperator.EQUALS,null);
    }
    List<EntityCondition> mainExprs=UtilMisc.toList(storeCond,taxAuthoritiesCond,productCategoryCond);
    mainExprs.add(EntityCondition.makeCondition(EntityCondition.makeCondition("minItemPrice",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("minItemPrice",EntityOperator.LESS_THAN_EQUAL_TO,itemPrice)));
    mainExprs.add(EntityCondition.makeCondition(EntityCondition.makeCondition("minPurchase",EntityOperator.EQUALS,null),EntityOperator.OR,EntityCondition.makeCondition("minPurchase",EntityOperator.LESS_THAN_EQUAL_TO,itemAmount)));
    EntityCondition mainCondition=EntityCondition.makeCondition(mainExprs,EntityOperator.AND);
    List<String> orderList=UtilMisc.<String>toList("minItemPrice","minPurchase","fromDate");
    List<GenericValue> lookupList=delegator.findList("TaxAuthorityRateProduct",mainCondition,null,orderList,null,false);
    List<GenericValue> filteredList=EntityUtil.filterByDate(lookupList,true);
    if (filteredList.size() == 0) {
      Debug.logWarning("In TaxAuthority Product Rate no records were found for condition:" + mainCondition.toString(),module);
      return adjustments;
    }
    Iterator<GenericValue> flIt=filteredList.iterator();
    while (flIt.hasNext()) {
      GenericValue taxAuthorityRateProduct=(GenericValue)flIt.next();
      BigDecimal taxRate=taxAuthorityRateProduct.get("taxPercentage") != null ? taxAuthorityRateProduct.getBigDecimal("taxPercentage") : ZERO_BASE;
      BigDecimal taxable=ZERO_BASE;
      if (product != null && (product.get("taxable") == null || (product.get("taxable") != null && product.getBoolean("taxable").booleanValue()))) {
        taxable=taxable.add(itemAmount);
      }
      if (shippingAmount != null && taxAuthorityRateProduct != null && (taxAuthorityRateProduct.get("taxShipping") == null || (taxAuthorityRateProduct.get("taxShipping") != null && taxAuthorityRateProduct.getBoolean("taxShipping").booleanValue()))) {
        taxable=taxable.add(shippingAmount);
      }
      if (orderPromotionsAmount != null && taxAuthorityRateProduct != null && (taxAuthorityRateProduct.get("taxPromotions") == null || (taxAuthorityRateProduct.get("taxPromotions") != null && taxAuthorityRateProduct.getBoolean("taxPromotions").booleanValue()))) {
        taxable=taxable.add(orderPromotionsAmount);
      }
      if (taxable.compareTo(BigDecimal.ZERO) == 0) {
        continue;
      }
      BigDecimal taxAmount=(taxable.multiply(taxRate)).divide(PERCENT_SCALE,salestaxCalcDecimals,salestaxRounding);
      String taxAuthGeoId=taxAuthorityRateProduct.getString("taxAuthGeoId");
      String taxAuthPartyId=taxAuthorityRateProduct.getString("taxAuthPartyId");
      GenericValue taxAuthorityGlAccount=delegator.findByPrimaryKey("TaxAuthorityGlAccount",UtilMisc.toMap("taxAuthPartyId",taxAuthPartyId,"taxAuthGeoId",taxAuthGeoId,"organizationPartyId",payToPartyId));
      String taxAuthGlAccountId=null;
      if (taxAuthorityGlAccount != null) {
        taxAuthGlAccountId=taxAuthorityGlAccount.getString("glAccountId");
      }
 else {
      }
      GenericValue productPrice=null;
      if (product != null && taxAuthPartyId != null && taxAuthGeoId != null) {
        Map<String,String> priceFindMap=UtilMisc.toMap("productId",product.getString("productId"),"taxAuthPartyId",taxAuthPartyId,"taxAuthGeoId",taxAuthGeoId,"productPricePurposeId","PURCHASE");
        List<GenericValue> productPriceList=delegator.findByAnd("ProductPrice",priceFindMap,UtilMisc.toList("-fromDate"));
        productPriceList=EntityUtil.filterByDate(productPriceList,true);
        productPrice=(productPriceList != null && productPriceList.size() > 0) ? productPriceList.get(0) : null;
      }
      GenericValue taxAdjValue=delegator.makeValue("OrderAdjustment");
      if (productPrice != null && "Y".equals(productPrice.getString("taxInPrice"))) {
        taxAdjValue.set("orderAdjustmentTypeId","VAT_TAX");
        BigDecimal taxAmountIncluded=itemAmount.subtract(itemAmount.divide(BigDecimal.ONE.add(taxRate.divide(PERCENT_SCALE,4,BigDecimal.ROUND_HALF_UP)),3,BigDecimal.ROUND_HALF_UP));
        taxAdjValue.set("amountAlreadyIncluded",taxAmountIncluded);
        taxAdjValue.set("amount",BigDecimal.ZERO);
      }
 else {
        taxAdjValue.set("orderAdjustmentTypeId","SALES_TAX");
        taxAdjValue.set("amount",taxAmount);
      }
      taxAdjValue.set("sourcePercentage",taxRate);
      taxAdjValue.set("taxAuthorityRateSeqId",taxAuthorityRateProduct.getString("taxAuthorityRateSeqId"));
      taxAdjValue.set("primaryGeoId",taxAuthGeoId);
      taxAdjValue.set("comments",taxAuthorityRateProduct.getString("description"));
      if (taxAuthPartyId != null)       taxAdjValue.set("taxAuthPartyId",taxAuthPartyId);
      if (taxAuthGlAccountId != null)       taxAdjValue.set("overrideGlAccountId",taxAuthGlAccountId);
      if (taxAuthGeoId != null)       taxAdjValue.set("taxAuthGeoId",taxAuthGeoId);
      if (UtilValidate.isNotEmpty(billToPartyId) && UtilValidate.isNotEmpty(taxAuthGeoId)) {
        Set<String> billToPartyIdSet=FastSet.newInstance();
        billToPartyIdSet.add(billToPartyId);
        List<GenericValue> partyRelationshipList=EntityUtil.filterByDate(delegator.findByAndCache("PartyRelationship",UtilMisc.toMap("partyIdTo",billToPartyId,"partyRelationshipTypeId","GROUP_ROLLUP")),true);
        Iterator<GenericValue> partyRelationshipIter=partyRelationshipList.iterator();
        while (partyRelationshipIter.hasNext()) {
          GenericValue partyRelationship=(GenericValue)partyRelationshipIter.next();
          billToPartyIdSet.add(partyRelationship.getString("partyIdFrom"));
        }
        handlePartyTaxExempt(taxAdjValue,billToPartyIdSet,taxAuthGeoId,taxAuthPartyId,taxAmount,nowTimestamp,delegator);
      }
 else {
        Debug.logInfo("NOTE: A tax calculation was done without a billToPartyId or taxAuthGeoId, so no tax exemptions or tax IDs considered; billToPartyId=[" + billToPartyId + "] taxAuthGeoId=["+ taxAuthGeoId+ "]",module);
      }
      adjustments.add(taxAdjValue);
      if (productPrice != null && itemQuantity != null && productPrice.getBigDecimal("priceWithTax") != null && !"Y".equals(productPrice.getString("taxInPrice"))) {
        BigDecimal priceWithTax=productPrice.getBigDecimal("priceWithTax");
        BigDecimal price=productPrice.getBigDecimal("price");
        BigDecimal baseSubtotal=price.multiply(itemQuantity);
        BigDecimal baseTaxAmount=(baseSubtotal.multiply(taxRate)).divide(PERCENT_SCALE,salestaxCalcDecimals,salestaxRounding);
        BigDecimal enteredTotalPriceWithTax=priceWithTax.multiply(itemQuantity);
        BigDecimal calcedTotalPriceWithTax=(baseSubtotal).add(baseTaxAmount);
        if (!enteredTotalPriceWithTax.equals(calcedTotalPriceWithTax)) {
          BigDecimal correctionAmount=enteredTotalPriceWithTax.subtract(calcedTotalPriceWithTax);
          GenericValue correctionAdjValue=delegator.makeValue("OrderAdjustment");
          correctionAdjValue.set("taxAuthorityRateSeqId",taxAuthorityRateProduct.getString("taxAuthorityRateSeqId"));
          correctionAdjValue.set("amount",correctionAmount);
          correctionAdjValue.set("orderAdjustmentTypeId","VAT_PRICE_CORRECT");
          correctionAdjValue.set("primaryGeoId",taxAuthGeoId);
          correctionAdjValue.set("comments",taxAuthorityRateProduct.getString("description"));
          if (taxAuthPartyId != null)           correctionAdjValue.set("taxAuthPartyId",taxAuthPartyId);
          if (taxAuthGlAccountId != null)           correctionAdjValue.set("overrideGlAccountId",taxAuthGlAccountId);
          if (taxAuthGeoId != null)           correctionAdjValue.set("taxAuthGeoId",taxAuthGeoId);
          adjustments.add(correctionAdjValue);
        }
      }
    }
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,"Problems looking up tax rates",module);
    return FastList.newInstance();
  }
  return adjustments;
}
