{
  if (entityCache == null) {
synchronized (ModelReader.class) {
      if (entityCache == null) {
        numEntities=0;
        numViewEntities=0;
        numFields=0;
        numRelations=0;
        numAutoRelations=0;
        entityCache=FastMap.newInstance();
        List<ModelViewEntity> tempViewEntityList=FastList.newInstance();
        List<Element> tempExtendEntityElementList=FastList.newInstance();
        UtilTimer utilTimer=new UtilTimer();
        for (        ResourceHandler entityResourceHandler : entityResourceHandlers) {
          Document document=null;
          try {
            document=entityResourceHandler.getDocument();
          }
 catch (          GenericConfigException e) {
            throw new GenericEntityConfException("Error getting document from resource handler",e);
          }
          if (document == null) {
            throw new GenericEntityConfException("Could not get document for " + entityResourceHandler.toString());
          }
          Element docElement=document.getDocumentElement();
          if (docElement == null) {
            entityCache=null;
            return null;
          }
          docElement.normalize();
          Node curChild=docElement.getFirstChild();
          ModelInfo def=new ModelInfo();
          def.populateFromElements(docElement);
          int i=0;
          if (curChild != null) {
            utilTimer.timerString("Before start of entity loop in " + entityResourceHandler.toString());
            do {
              boolean isEntity="entity".equals(curChild.getNodeName());
              boolean isViewEntity="view-entity".equals(curChild.getNodeName());
              boolean isExtendEntity="extend-entity".equals(curChild.getNodeName());
              if ((isEntity || isViewEntity) && curChild.getNodeType() == Node.ELEMENT_NODE) {
                i++;
                ModelEntity modelEntity=buildEntity(entityResourceHandler,(Element)curChild,i,def);
                if (isViewEntity)                 tempViewEntityList.add((ModelViewEntity)modelEntity);
              }
 else               if (isExtendEntity && curChild.getNodeType() == Node.ELEMENT_NODE) {
                tempExtendEntityElementList.add((Element)curChild);
              }
            }
 while ((curChild=curChild.getNextSibling()) != null);
          }
 else {
            Debug.logWarning("No child nodes found.",module);
          }
          utilTimer.timerString("Finished " + entityResourceHandler.toString() + " - Total Entities: "+ i+ " FINISHED");
        }
        for (        Element extendEntityElement : tempExtendEntityElementList) {
          String entityName=UtilXml.checkEmpty(extendEntityElement.getAttribute("entity-name"));
          ModelEntity modelEntity=(ModelEntity)entityCache.get(entityName);
          if (modelEntity == null)           throw new GenericEntityConfException("Entity to extend does not exist: " + entityName);
          modelEntity.addExtendEntity(this,extendEntityElement);
        }
        for (        ModelViewEntity curViewEntity : tempViewEntityList) {
          curViewEntity.populateFields(this);
          for (          ModelViewEntity.ModelMemberEntity mve : curViewEntity.getAllModelMemberEntities()) {
            ModelEntity me=(ModelEntity)entityCache.get(mve.getEntityName());
            if (me == null)             throw new GenericEntityConfException("View " + curViewEntity.getEntityName() + " references non-existant entity: "+ mve.getEntityName());
            me.addViewEntity(curViewEntity);
          }
        }
        TreeSet<String> orderedMessages=new TreeSet<String>();
        for (        String curEntityName : new TreeSet<String>(this.getEntityNames())) {
          ModelEntity curModelEntity=this.getModelEntity(curEntityName);
          if (curModelEntity instanceof ModelViewEntity) {
          }
 else {
            List<ModelRelation> newSameEntityRelations=FastList.newInstance();
            Iterator<ModelRelation> relationsIter=curModelEntity.getRelationsIterator();
            while (relationsIter.hasNext()) {
              ModelRelation modelRelation=relationsIter.next();
              if (("one".equals(modelRelation.getType()) || "one-nofk".equals(modelRelation.getType())) && !modelRelation.isAutoRelation()) {
                ModelEntity relatedEnt=null;
                try {
                  relatedEnt=this.getModelEntity(modelRelation.getRelEntityName());
                }
 catch (                GenericModelException e) {
                  throw new GenericModelException("Error getting related entity [" + modelRelation.getRelEntityName() + "] definition from entity ["+ curEntityName+ "]",e);
                }
                if (relatedEnt != null) {
                  String targetTitle=modelRelation.getTitle();
                  if (curModelEntity.getEntityName().equals(relatedEnt.getEntityName()) && "Parent".equals(targetTitle)) {
                    targetTitle="Child";
                  }
                  ModelRelation newRel=new ModelRelation();
                  newRel.setModelEntity(relatedEnt);
                  newRel.setRelEntityName(curModelEntity.getEntityName());
                  newRel.setTitle(targetTitle);
                  newRel.setAutoRelation(true);
                  Set<String> curEntityKeyFields=FastSet.newInstance();
                  for (int kmn=0; kmn < modelRelation.getKeyMapsSize(); kmn++) {
                    ModelKeyMap curkm=modelRelation.getKeyMap(kmn);
                    ModelKeyMap newkm=new ModelKeyMap();
                    newRel.addKeyMap(newkm);
                    newkm.setFieldName(curkm.getRelFieldName());
                    newkm.setRelFieldName(curkm.getFieldName());
                    curEntityKeyFields.add(curkm.getFieldName());
                  }
                  if (curModelEntity.containsAllPkFieldNames(curEntityKeyFields)) {
                    newRel.setType("one-nofk");
                    List<String> curPkFieldNames=curModelEntity.getPkFieldNames();
                    Iterator<ModelKeyMap> nrkmIter=newRel.getKeyMapsIterator();
                    while (nrkmIter.hasNext()) {
                      ModelKeyMap nrkm=nrkmIter.next();
                      String checkField=nrkm.getRelFieldName();
                      if (!curPkFieldNames.contains(checkField)) {
                        nrkmIter.remove();
                      }
                    }
                  }
 else {
                    newRel.setType("many");
                  }
                  ModelRelation existingRelation=relatedEnt.getRelation(targetTitle + curModelEntity.getEntityName());
                  if (existingRelation == null) {
                    numAutoRelations++;
                    if (curModelEntity.getEntityName().equals(relatedEnt.getEntityName())) {
                      newSameEntityRelations.add(newRel);
                    }
 else {
                      relatedEnt.addRelation(newRel);
                    }
                  }
 else {
                    if (newRel.equals(existingRelation)) {
                      if (!(targetTitle + curModelEntity.getEntityName()).equals(modelRelation.getTitle() + modelRelation.getRelEntityName())) {
                        String message="Entity [" + relatedEnt.getPackageName() + ":"+ relatedEnt.getEntityName()+ "] already has identical relationship to entity ["+ curModelEntity.getEntityName()+ "] title ["+ targetTitle+ "]; would auto-create: type ["+ newRel.getType()+ "] and fields ["+ newRel.keyMapString(",","")+ "]";
                        orderedMessages.add(message);
                      }
                    }
 else {
                      String message="Existing relationship with the same name, but different specs found from what would be auto-created for Entity [" + relatedEnt.getEntityName() + "] and relationship to entity ["+ curModelEntity.getEntityName()+ "] title ["+ targetTitle+ "]; would auto-create: type ["+ newRel.getType()+ "] and fields ["+ newRel.keyMapString(",","")+ "]";
                      Debug.logVerbose(message,module);
                    }
                  }
                }
 else {
                  String errorMsg="Could not find related entity [" + modelRelation.getRelEntityName() + "], no reverse relation added.";
                  Debug.logWarning(errorMsg,module);
                }
              }
            }
            if (newSameEntityRelations.size() > 0) {
              for (              ModelRelation newRel : newSameEntityRelations) {
                curModelEntity.addRelation(newRel);
              }
            }
          }
        }
        for (        String message : orderedMessages) {
          Debug.logInfo(message,module);
        }
        Debug.log("FINISHED LOADING ENTITIES - ALL FILES; #Entities=" + numEntities + " #ViewEntities="+ numViewEntities+ " #Fields="+ numFields+ " #Relationships="+ numRelations+ " #AutoRelationships="+ numAutoRelations,module);
      }
    }
  }
  return entityCache;
}
