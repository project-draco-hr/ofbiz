{
  String errorMsg=null;
  String parentCategoryId=(String)categoryNode.get("id");
  String currentDataCategoryId=null;
  int sz=categoryTypeIds.size();
  if (depth >= 0 && (sz - depth) > 0) {
    currentDataCategoryId=categoryTypeIds.get(sz - depth - 1);
  }
  String matchValue=null;
  if (parentCategoryId != null) {
    matchValue=parentCategoryId;
  }
  List<GenericValue> categoryValues=delegator.findByAnd("DataCategory",UtilMisc.toMap("parentCategoryId",matchValue),null,true);
  categoryNode.put("count",Integer.valueOf(categoryValues.size()));
  List<Map<String,Object>> subCategoryIds=FastList.newInstance();
  for (int i=0; i < categoryValues.size(); i++) {
    GenericValue category=categoryValues.get(i);
    String id=(String)category.get("dataCategoryId");
    String categoryName=(String)category.get("categoryName");
    Map<String,Object> newNode=FastMap.newInstance();
    newNode.put("id",id);
    newNode.put("name",categoryName);
    errorMsg=getDataCategoryMap(delegator,depth + 1,newNode,categoryTypeIds,getAll);
    if (errorMsg != null)     break;
    subCategoryIds.add(newNode);
  }
  if (parentCategoryId == null || parentCategoryId.equals("ROOT") || (currentDataCategoryId != null && currentDataCategoryId.equals(parentCategoryId)) || getAll) {
    categoryNode.put("kids",subCategoryIds);
  }
  return errorMsg;
}
