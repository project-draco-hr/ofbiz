{
  String initialPath=UtilProperties.getPropertyValue("content.properties","content.upload.path.prefix");
  double maxFiles=UtilProperties.getPropertyNumber("content.properties","content.upload.max.files");
  if (maxFiles < 1) {
    maxFiles=250;
  }
  String ofbizHome=System.getProperty("ofbiz.home");
  if (!initialPath.startsWith("/")) {
    initialPath="/" + initialPath;
  }
  Comparator desc=new Comparator(){
    public int compare(    Object o1,    Object o2){
      if (((Long)o1).longValue() > ((Long)o2).longValue()) {
        return -1;
      }
 else       if (((Long)o1).longValue() < ((Long)o2).longValue()) {
        return 1;
      }
      return 0;
    }
  }
;
  String parentDir=ofbizHome + initialPath;
  File parent=new File(parentDir);
  TreeMap dirMap=new TreeMap(desc);
  if (parent.exists()) {
    File[] subs=parent.listFiles();
    for (int i=0; i < subs.length; i++) {
      if (subs[i].isDirectory()) {
        dirMap.put(new Long(subs[0].lastModified()),subs[i]);
      }
    }
  }
 else {
    boolean created=parent.mkdir();
    if (!created) {
      Debug.logWarning("Unable to create top level upload directory [" + parentDir + "].",module);
    }
  }
  File latestDir=null;
  if (dirMap != null && dirMap.size() > 0) {
    latestDir=(File)dirMap.values().iterator().next();
    if (latestDir != null) {
      File[] dirList=latestDir.listFiles();
      if (dirList.length >= maxFiles) {
        latestDir=makeNewDirectory(parent);
      }
    }
  }
 else {
    latestDir=makeNewDirectory(parent);
  }
  Debug.log("Directory Name : " + latestDir.getName(),module);
  return latestDir.getAbsolutePath().replace('\\','/');
}
