{
  if (dataResourceId == null) {
    throw new GeneralException("Cannot lookup data resource with for a null dataResourceId");
  }
  if (templateContext == null) {
    templateContext=FastMap.newInstance();
  }
  if (UtilValidate.isEmpty(targetMimeTypeId)) {
    targetMimeTypeId="text/html";
  }
  if (locale == null) {
    locale=Locale.getDefault();
  }
  if (cache) {
    String disableCache=UtilProperties.getPropertyValue("content","disable.ftl.template.cache");
    if (disableCache == null || !disableCache.equalsIgnoreCase("true")) {
      try {
        Template cachedTemplate=FreeMarkerWorker.getTemplate("DataResource:" + dataResourceId);
        if (cachedTemplate != null) {
          String subContentId=(String)templateContext.get("subContentId");
          if (UtilValidate.isNotEmpty(subContentId)) {
            templateContext.put("contentId",subContentId);
            templateContext.put("subContentId",null);
            templateContext.put("globalNodeTrail",null);
          }
          FreeMarkerWorker.renderTemplate(cachedTemplate,templateContext,out);
        }
      }
 catch (      TemplateException e) {
        Debug.logError("Error rendering FTL template. " + e.getMessage(),module);
        throw new GeneralException("Error rendering FTL template",e);
      }
      return;
    }
  }
  if (!targetMimeTypeId.startsWith("text/")) {
    throw new GeneralException("The desired mime-type is not a text type, cannot render as text: " + targetMimeTypeId);
  }
  GenericValue dataResource=null;
  if (cache) {
    dataResource=delegator.findByPrimaryKeyCache("DataResource",UtilMisc.toMap("dataResourceId",dataResourceId));
  }
 else {
    dataResource=delegator.findByPrimaryKey("DataResource",UtilMisc.toMap("dataResourceId",dataResourceId));
  }
  if (dataResource == null) {
    throw new GeneralException("No data resource object found for dataResourceId: [" + dataResourceId + "]");
  }
  String dataTemplateTypeId=dataResource.getString("dataTemplateTypeId");
  if (UtilValidate.isEmpty(dataTemplateTypeId) || "NONE".equals(dataTemplateTypeId)) {
    DataResourceWorker.writeDataResourceText(dataResource,targetMimeTypeId,locale,templateContext,delegator,out,true);
  }
 else {
    templateContext.put("mimeTypeId",targetMimeTypeId);
    if ("FTL".equals(dataTemplateTypeId)) {
      try {
        String templateText=getDataResourceText(dataResource,targetMimeTypeId,locale,templateContext,delegator,cache);
        FreeMarkerWorker.renderTemplate("DataResource:" + dataResourceId,templateText,templateContext,out);
      }
 catch (      TemplateException e) {
        throw new GeneralException("Error rendering FTL template",e);
      }
    }
 else     if ("XSLT".equals(dataTemplateTypeId)) {
      String templateLocation=DataResourceWorker.getContentFile(dataResource.getString("dataResourceTypeId"),dataResource.getString("objectInfo"),(String)templateContext.get("contextRoot")).toString();
      String outDoc=null;
      try {
        outDoc=XslTransform.renderTemplate(templateLocation,(String)templateContext.get("docFile"));
      }
 catch (      TransformerException c) {
        Debug.logError("XSL TransformerException: " + c.getMessage(),module);
      }
      out.append(outDoc);
    }
 else     if ("SCREEN_COMBINED".equals(dataTemplateTypeId)) {
      try {
        MapStack context=MapStack.create(templateContext);
        context.put("locale",locale);
        String textData=(String)context.get("textData");
        if (UtilValidate.isNotEmpty(textData)) {
          Map prc=FastMap.newInstance();
          String mapKey=(String)context.get("mapKey");
          if (mapKey != null) {
            prc.put(mapKey,mapKey);
          }
          prc.put("body",textData);
          context.put("preRenderedContent",prc);
        }
        ScreenRenderer screens=(ScreenRenderer)context.get("screens");
        if (screens == null) {
          screens=new ScreenRenderer(out,context,new HtmlScreenRenderer());
          screens.getContext().put("screens",screens);
        }
        ModelScreen modelScreen=null;
        ScreenStringRenderer renderer=screens.getScreenStringRenderer();
        String combinedName=dataResource.getString("objectInfo");
        if ("URL_RESOURCE".equals(dataResource.getString("dataResourceTypeId")) && UtilValidate.isNotEmpty(combinedName) && combinedName.startsWith("component://")) {
          modelScreen=ScreenFactory.getScreenFromLocation(combinedName);
        }
 else {
          Document screenXml=UtilXml.readXmlDocument(getDataResourceText(dataResource,targetMimeTypeId,locale,templateContext,delegator,cache),true);
          Map modelScreenMap=ScreenFactory.readScreenDocument(screenXml,"DataResourceId: " + dataResource.getString("dataResourceId"));
          if (UtilValidate.isNotEmpty(modelScreenMap)) {
            Map.Entry entry=(Map.Entry)(modelScreenMap.entrySet().iterator().next());
            modelScreen=(ModelScreen)entry.getValue();
          }
        }
        if (UtilValidate.isNotEmpty(modelScreen)) {
          modelScreen.renderScreenString(out,context,renderer);
        }
 else {
          throw new GeneralException("The dataResource file [" + dataResourceId + "] could not be found");
        }
      }
 catch (      SAXException e) {
        throw new GeneralException("Error rendering Screen template",e);
      }
catch (      ParserConfigurationException e) {
        throw new GeneralException("Error rendering Screen template",e);
      }
    }
 else {
      throw new GeneralException("The dataTemplateTypeId [" + dataTemplateTypeId + "] is not yet supported");
    }
  }
}
