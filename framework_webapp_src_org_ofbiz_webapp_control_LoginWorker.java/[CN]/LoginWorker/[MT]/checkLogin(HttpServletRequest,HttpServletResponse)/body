{
  GenericValue userLogin=(GenericValue)request.getSession().getAttribute("userLogin");
  HttpSession session=request.getSession();
  if (userLogin != null && "anonymous".equals(userLogin.getString("userLoginId"))) {
    userLogin=null;
  }
  if (userLogin != null) {
    if (!hasBasePermission(userLogin,request) || isFlaggedLoggedOut(userLogin)) {
      Debug.logInfo("User does not have permission or is flagged as logged out",module);
      doBasicLogout(userLogin,request);
      userLogin=null;
      session=request.getSession();
    }
  }
  String username=null;
  String password=null;
  if (userLogin == null) {
    if (username == null)     username=request.getParameter("USERNAME");
    if (password == null)     password=request.getParameter("PASSWORD");
    if (username == null)     username=(String)session.getAttribute("USERNAME");
    if (password == null)     password=(String)session.getAttribute("PASSWORD");
    if ((username != null) && ("true".equalsIgnoreCase(UtilProperties.getPropertyValue("security.properties","username.lowercase")))) {
      username=username.toLowerCase();
    }
    if ((password != null) && ("true".equalsIgnoreCase(UtilProperties.getPropertyValue("security.properties","password.lowercase")))) {
      password=password.toLowerCase();
    }
    if ((username == null) || (password == null) || ("error".equals(login(request,response)))) {
      Map<String,Object> reqParams=UtilHttp.getParameterMap(request);
      String queryString=UtilHttp.urlEncodeArgs(reqParams);
      Debug.logInfo("reqParams Map: " + reqParams,module);
      Debug.logInfo("queryString: " + queryString,module);
      request.removeAttribute("_LOGIN_PASSED_");
      session.setAttribute("_PREVIOUS_REQUEST_",request.getPathInfo());
      if (queryString != null && queryString.length() > 0) {
        session.setAttribute("_PREVIOUS_PARAMS_",queryString);
      }
      if (Debug.infoOn())       Debug.logInfo("checkLogin: queryString=" + queryString,module);
      if (Debug.infoOn())       Debug.logInfo("checkLogin: PathInfo=" + request.getPathInfo(),module);
      return "error";
    }
  }
  return "success";
}
