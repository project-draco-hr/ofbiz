{
  GenericValue userLogin=(GenericValue)request.getAttribute("userLogin");
  String externalKey=(String)request.getAttribute(EXTERNAL_LOGIN_KEY_ATTR);
  if (externalKey != null)   return externalKey;
  HttpSession session=request.getSession();
synchronized (session) {
    String sesExtKey=(String)session.getAttribute(EXTERNAL_LOGIN_KEY_ATTR);
    if (sesExtKey != null) {
      if (isAjax(request))       return sesExtKey;
      externalLoginKeys.remove(sesExtKey);
    }
    if (userLogin == null)     return "";
    while (externalKey == null || externalLoginKeys.containsKey(externalKey)) {
      externalKey="EL" + Long.toString(Math.round(Math.random() * 1000000)) + Long.toString(Math.round(Math.random() * 1000000));
    }
    request.setAttribute(EXTERNAL_LOGIN_KEY_ATTR,externalKey);
    session.setAttribute(EXTERNAL_LOGIN_KEY_ATTR,externalKey);
    externalLoginKeys.put(externalKey,userLogin);
    return externalKey;
  }
}
