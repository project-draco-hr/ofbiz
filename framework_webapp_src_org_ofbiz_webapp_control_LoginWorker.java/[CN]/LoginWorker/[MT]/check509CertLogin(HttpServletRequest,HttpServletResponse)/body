{
  GenericDelegator delegator=(GenericDelegator)request.getAttribute("delegator");
  HttpSession session=request.getSession();
  GenericValue currentUserLogin=(GenericValue)session.getAttribute("userLogin");
  if (currentUserLogin != null) {
    String hasLoggedOut=currentUserLogin.getString("hasLoggedOut");
    if (hasLoggedOut != null && "Y".equals(hasLoggedOut)) {
      currentUserLogin=null;
    }
  }
  if (currentUserLogin == null) {
    X509Certificate[] clientCerts=(X509Certificate[])request.getAttribute("javax.servlet.request.X509Certificate");
    if (clientCerts == null) {
      clientCerts=(X509Certificate[])request.getAttribute("javax.net.ssl.peer_certificates");
    }
    if (clientCerts != null) {
      for (int i=0; i < clientCerts.length; i++) {
        String certKeyHex=StringUtil.toHexString(clientCerts[i].getPublicKey().getEncoded());
        String certSn=clientCerts[i].getSerialNumber().toString(16);
        List userLogins=null;
        try {
          userLogins=delegator.findByAnd("UserLogin",UtilMisc.toMap("x509CertSn",certSn));
        }
 catch (        GenericEntityException e) {
          Debug.logError(e,module);
        }
        if (userLogins != null && userLogins.size() > 0) {
          Iterator it=userLogins.iterator();
          while (it.hasNext()) {
            GenericValue ul=(GenericValue)it.next();
            String certKey=ul.getString("x509CertKey");
            String enabled=ul.getString("enabled");
            if ((enabled == null || "Y".equals(enabled)) && certKey.equals(certKeyHex)) {
              ul.set("hasLoggedOut","N");
              try {
                ul.store();
              }
 catch (              GenericEntityException e) {
                Debug.logWarning(e,module);
              }
              Map ulSessionMap=LoginServices.getUserLoginSession(ul);
              return doMainLogin(request,response,ul,ulSessionMap);
            }
          }
        }
      }
    }
  }
  return "success";
}
