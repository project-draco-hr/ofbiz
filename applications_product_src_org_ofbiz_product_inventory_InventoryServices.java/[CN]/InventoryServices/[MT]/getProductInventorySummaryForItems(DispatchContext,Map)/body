{
  GenericDelegator delegator=dctx.getDelegator();
  LocalDispatcher dispatcher=dctx.getDispatcher();
  List orderItems=(List)context.get("orderItems");
  Map atpMap=new HashMap();
  Map qohMap=new HashMap();
  Map mktgPkgAtpMap=new HashMap();
  Map mktgPkgQohMap=new HashMap();
  Map results=ServiceUtil.returnSuccess();
  List facilities=null;
  try {
    facilities=delegator.findAll("Facility");
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,"Couldn't get list of facilities.",module);
    return ServiceUtil.returnError("Unable to locate facilities.");
  }
  Iterator iter=orderItems.iterator();
  while (iter.hasNext()) {
    GenericValue orderItem=(GenericValue)iter.next();
    String productId=orderItem.getString("productId");
    if ((productId == null) || productId.equals(""))     continue;
    GenericValue product=null;
    try {
      product=orderItem.getRelatedOneCache("Product");
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,"Couldn't get product.",module);
      return ServiceUtil.returnError("Unable to retrive product with id [" + productId + "]");
    }
    double atp=0.0;
    double qoh=0.0;
    double mktgPkgAtp=0.0;
    double mktgPkgQoh=0.0;
    Iterator facilityIter=facilities.iterator();
    while (facilityIter.hasNext()) {
      GenericValue facility=(GenericValue)facilityIter.next();
      Map invResult=null;
      Map mktgPkgInvResult=null;
      try {
        if ("MARKETING_PKG_AUTO".equals(product.getString("productTypeId"))) {
          mktgPkgInvResult=dispatcher.runSync("getMktgPackagesAvailable",UtilMisc.toMap("productId",productId,"facilityId",facility.getString("facilityId")));
        }
        invResult=dispatcher.runSync("getInventoryAvailableByFacility",UtilMisc.toMap("productId",productId,"facilityId",facility.getString("facilityId")));
      }
 catch (      GenericServiceException e) {
        String msg="Could not find inventory for facility [" + facility.getString("facilityId") + "]";
        Debug.logError(e,msg,module);
        return ServiceUtil.returnError(msg);
      }
      if (!ServiceUtil.isError(invResult)) {
        Double fatp=(Double)invResult.get("availableToPromiseTotal");
        Double fqoh=(Double)invResult.get("quantityOnHandTotal");
        if (fatp != null)         atp+=fatp.doubleValue();
        if (fqoh != null)         qoh+=fqoh.doubleValue();
      }
      if (("MARKETING_PKG_AUTO".equals(product.getString("productTypeId"))) && (!ServiceUtil.isError(mktgPkgInvResult))) {
        Double fatp=(Double)mktgPkgInvResult.get("availableToPromiseTotal");
        Double fqoh=(Double)mktgPkgInvResult.get("quantityOnHandTotal");
        if (fatp != null)         mktgPkgAtp+=fatp.doubleValue();
        if (fqoh != null)         mktgPkgQoh+=fqoh.doubleValue();
      }
    }
    atpMap.put(productId,new Double(atp));
    qohMap.put(productId,new Double(qoh));
    mktgPkgAtpMap.put(productId,new Double(mktgPkgAtp));
    mktgPkgQohMap.put(productId,new Double(mktgPkgQoh));
  }
  results.put("availableToPromiseMap",atpMap);
  results.put("quantityOnHandMap",qohMap);
  results.put("mktgPkgATPMap",mktgPkgAtpMap);
  results.put("mktgPkgQOHMap",mktgPkgQohMap);
  return results;
}
