{
  List allOpPrefs=new LinkedList();
  BigDecimal remainingAmount=new BigDecimal(this.getGrandTotal() - this.getPaymentTotal());
  remainingAmount=remainingAmount.setScale(2,BigDecimal.ROUND_HALF_UP);
  if (getBillingAccountId() != null) {
    double billingAccountAvailableAmount=CheckOutHelper.availableAccountBalance(getBillingAccountId(),dispatcher);
    if (this.billingAccountAmt == 0.0 && billingAccountAvailableAmount > 0) {
      this.billingAccountAmt=billingAccountAvailableAmount;
    }
    if (remainingAmount.doubleValue() < getBillingAccountAmount()) {
      this.billingAccountAmt=remainingAmount.doubleValue();
    }
    if (billingAccountAvailableAmount < getBillingAccountAmount()) {
      this.billingAccountAmt=billingAccountAvailableAmount;
    }
    BigDecimal billingAccountAmountSelected=new BigDecimal(getBillingAccountAmount());
    GenericValue opp=delegator.makeValue("OrderPaymentPreference",new HashMap());
    opp.set("paymentMethodTypeId","EXT_BILLACT");
    opp.set("presentFlag","N");
    opp.set("overflowFlag","N");
    opp.set("maxAmount",new Double(billingAccountAmountSelected.doubleValue()));
    opp.set("statusId","PAYMENT_NOT_RECEIVED");
    allOpPrefs.add(opp);
    remainingAmount=remainingAmount.subtract(billingAccountAmountSelected);
    if (remainingAmount.compareTo(BigDecimal.ZERO) < 0) {
      remainingAmount=BigDecimal.ZERO;
    }
  }
  Iterator i=paymentInfo.iterator();
  while (i.hasNext()) {
    CartPaymentInfo inf=(CartPaymentInfo)i.next();
    if (inf.amount == null) {
      inf.amount=new Double(remainingAmount.doubleValue());
      remainingAmount=BigDecimal.ZERO;
    }
    allOpPrefs.addAll(inf.makeOrderPaymentInfos(this.getDelegator()));
  }
  return allOpPrefs;
}
