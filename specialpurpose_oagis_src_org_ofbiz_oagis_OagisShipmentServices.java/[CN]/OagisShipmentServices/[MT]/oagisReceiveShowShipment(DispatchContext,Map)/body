{
  Document doc=(Document)context.get("document");
  boolean isErrorRetry=Boolean.TRUE.equals(context.get("isErrorRetry"));
  LocalDispatcher dispatcher=ctx.getDispatcher();
  GenericDelegator delegator=ctx.getDelegator();
  Timestamp nowTimestamp=UtilDateTime.nowTimestamp();
  List errorMapList=FastList.newInstance();
  GenericValue userLogin=null;
  try {
    userLogin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","system"));
  }
 catch (  GenericEntityException e) {
    String errMsg="Error Getting UserLogin with userLoginId system: " + e.toString();
    Debug.logError(e,errMsg,module);
  }
  Element showShipmentElement=doc.getDocumentElement();
  showShipmentElement.normalize();
  Element controlAreaElement=UtilXml.firstChildElement(showShipmentElement,"os:CNTROLAREA");
  Element bsrElement=UtilXml.firstChildElement(controlAreaElement,"os:BSR");
  String bsrVerb=UtilXml.childElementValue(bsrElement,"of:VERB");
  String bsrNoun=UtilXml.childElementValue(bsrElement,"of:NOUN");
  String bsrRevision=UtilXml.childElementValue(bsrElement,"of:REVISION");
  Map oagisMsgInfoCtx=UtilMisc.toMap("bsrVerb",bsrVerb,"bsrNoun",bsrNoun,"bsrRevision",bsrRevision);
  Element senderElement=UtilXml.firstChildElement(controlAreaElement,"os:SENDER");
  String logicalId=UtilXml.childElementValue(senderElement,"of:LOGICALID");
  String component=UtilXml.childElementValue(senderElement,"of:COMPONENT");
  String task=UtilXml.childElementValue(senderElement,"of:TASK");
  String referenceId=UtilXml.childElementValue(senderElement,"of:REFERENCEID");
  String confirmation=UtilXml.childElementValue(senderElement,"of:CONFIRMATION");
  String authId=UtilXml.childElementValue(senderElement,"of:AUTHID");
  String sentDate=UtilXml.childElementValue(controlAreaElement,"os:DATETIMEISO");
  Timestamp sentTimestamp=OagisServices.parseIsoDateString(sentDate,errorMapList);
  Element dataAreaElement=UtilXml.firstChildElement(showShipmentElement,"ns:DATAAREA");
  Element daShowShipmentElement=UtilXml.firstChildElement(dataAreaElement,"ns:SHOW_SHIPMENT");
  Element shipmentElement=UtilXml.firstChildElement(daShowShipmentElement,"ns:SHIPMENT");
  String shipmentId=UtilXml.childElementValue(shipmentElement,"of:DOCUMENTID");
  Map omiPkMap=UtilMisc.toMap("logicalId",logicalId,"component",component,"task",task,"referenceId",referenceId);
  Debug.log("Processing oagisReceiveShowShipment for shipmentId [" + shipmentId + "] message ID ["+ omiPkMap+ "]",module);
  GenericValue previousOagisMessageInfo=null;
  try {
    previousOagisMessageInfo=delegator.findByPrimaryKey("OagisMessageInfo",omiPkMap);
  }
 catch (  GenericEntityException e) {
    String errMsg="Error getting OagisMessageInfo from database for shipment ID [" + shipmentId + "] message ID ["+ omiPkMap+ "]: "+ e.toString();
    Debug.logInfo(e,errMsg,module);
  }
  if (previousOagisMessageInfo != null && !isErrorRetry) {
    if ("OAGMP_SYS_ERROR".equals(previousOagisMessageInfo.getString("processingStatusId"))) {
      isErrorRetry=true;
    }
 else {
      String errMsg="Message received for shipmentId [" + shipmentId + "] message ID ["+ omiPkMap+ "] was already partially processed but is not in a system error state, needs manual review; message ID: "+ omiPkMap;
      Debug.logError(errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  oagisMsgInfoCtx.putAll(omiPkMap);
  oagisMsgInfoCtx.put("confirmation",confirmation);
  oagisMsgInfoCtx.put("authId",authId);
  oagisMsgInfoCtx.put("outgoingMessage","N");
  oagisMsgInfoCtx.put("receivedDate",nowTimestamp);
  oagisMsgInfoCtx.put("sentDate",sentTimestamp);
  oagisMsgInfoCtx.put("shipmentId",shipmentId);
  oagisMsgInfoCtx.put("userLogin",userLogin);
  oagisMsgInfoCtx.put("processingStatusId","OAGMP_RECEIVED");
  if (OagisServices.debugSaveXmlIn) {
    try {
      oagisMsgInfoCtx.put("fullMessageXml",UtilXml.writeXmlDocument(doc));
    }
 catch (    IOException e) {
      String errMsg="Warning: error creating text from XML Document for saving to database: " + e.toString();
      Debug.logWarning(errMsg,module);
    }
  }
  try {
    if (isErrorRetry) {
      dispatcher.runSync("updateOagisMessageInfo",oagisMsgInfoCtx,60,true);
    }
 else {
      dispatcher.runSync("createOagisMessageInfo",oagisMsgInfoCtx,60,true);
    }
  }
 catch (  GenericServiceException e) {
    String errMsg="Error creating OagisMessageInfo for the Incoming Message: " + e.toString();
    Debug.logError(e,errMsg,module);
  }
  GenericValue shipment=null;
  try {
    shipment=delegator.findByPrimaryKey("Shipment",UtilMisc.toMap("shipmentId",shipmentId));
  }
 catch (  GenericEntityException e) {
    String errMsg="Error getting Shipment from database for ID [" + shipmentId + "]: "+ e.toString();
    Debug.logInfo(e,errMsg,module);
    errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","GenericEntityException"));
  }
  if (shipment == null) {
    String errMsg="Could not find Shipment ID [" + shipmentId + "]";
    errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","ShipmentIdNotValid"));
  }
 else {
    if (invalidShipmentStatusSet.contains(shipment.get("statusId"))) {
      String errMsg="Shipment with ID [" + shipmentId + "] is in a status ["+ shipment.get("statusId")+ "] that means it has been or is being shipped, so this Show Shipment message may be a duplicate.";
      errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","ShipmentInBadStatus"));
    }
  }
  List shipUnitElementList=UtilXml.childElementList(daShowShipmentElement,"ns:SHIPUNIT");
  if (errorMapList.size() == 0 && UtilValidate.isNotEmpty(shipUnitElementList)) {
    try {
      String shipGroupSeqId=shipment.getString("primaryShipGroupSeqId");
      String originFacilityId=shipment.getString("originFacilityId");
      Element shipUnitElement=(Element)shipUnitElementList.get(0);
      String trackingNum=UtilXml.childElementValue(shipUnitElement,"of:TRACKINGID");
      String carrierCode=UtilXml.childElementValue(shipUnitElement,"of:CARRIER");
      if (UtilValidate.isNotEmpty(carrierCode)) {
        String carrierPartyId=null;
        if (carrierCode.startsWith("F") || carrierCode.startsWith("f")) {
          carrierPartyId="FEDEX";
        }
 else         if (carrierCode.startsWith("U") || carrierCode.startsWith("u")) {
          carrierPartyId="UPS";
        }
        Map resultMap=dispatcher.runSync("updateShipmentRouteSegment",UtilMisc.<String,Object>toMap("shipmentId",shipmentId,"shipmentRouteSegmentId","00001","carrierPartyId",carrierPartyId,"trackingIdNumber",trackingNum,"userLogin",userLogin));
        if (ServiceUtil.isError(resultMap)) {
          String errMsg=ServiceUtil.getErrorMessage(resultMap);
          errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","updateShipmentRouteSegmentError"));
          Debug.logError(errMsg,module);
        }
      }
      Iterator shipUnitElementItr=shipUnitElementList.iterator();
      while (shipUnitElementItr.hasNext()) {
        shipUnitElement=(Element)shipUnitElementItr.next();
        String shipmentPackageSeqId=UtilXml.childElementValue(shipUnitElement,"of:SHPUNITSEQ");
        List invItemElementList=UtilXml.childElementList(shipUnitElement,"ns:INVITEM");
        if (UtilValidate.isNotEmpty(invItemElementList)) {
          List invitemMapList=FastList.newInstance();
          Iterator invItemElementIter=invItemElementList.iterator();
          boolean foundBadProductId=false;
          while (invItemElementIter.hasNext()) {
            Element invItemElement=(Element)invItemElementIter.next();
            String productId=UtilXml.childElementValue(invItemElement,"of:ITEM");
            GenericValue product=delegator.findByPrimaryKeyCache("Product",UtilMisc.toMap("productId",productId));
            if (product == null) {
              String errMsg="Product with ID [" + productId + "] not found (invalid Product ID).";
              errorMapList.add(UtilMisc.toMap("reasonCode","ProductIdNotValid","description",errMsg));
              Debug.logError(errMsg,module);
              foundBadProductId=true;
              continue;
            }
            Map invitemMap=FastMap.newInstance();
            invitemMap.put("productId",productId);
            UtilMisc.addToListInMap(invItemElement,invitemMap,"invItemElementList");
            invitemMapList.add(invitemMap);
          }
          if (foundBadProductId) {
            continue;
          }
          UtilMisc.sortMaps(invitemMapList,UtilMisc.toList("productId"));
          Iterator invitemMapIter=invitemMapList.iterator();
          while (invitemMapIter.hasNext()) {
            Map invitemMap=(Map)invitemMapIter.next();
            List localInvItemElementList=(List)invitemMap.get("invItemElementList");
            Iterator localInvItemElementIter=localInvItemElementList.iterator();
            while (localInvItemElementIter.hasNext()) {
              Element invItemElement=(Element)localInvItemElementIter.next();
              String productId=UtilXml.childElementValue(invItemElement,"of:ITEM");
              String possibleShipmentItemSeqId=null;
              if (UtilValidate.isNotEmpty(shipmentPackageSeqId)) {
                possibleShipmentItemSeqId=UtilFormatOut.formatPaddedNumber(Long.parseLong(shipmentPackageSeqId),5);
              }
              Element quantityElement=UtilXml.firstChildElement(invItemElement,"os:QUANTITY");
              String quantityValueStr=UtilXml.childElementValue(quantityElement,"of:VALUE");
              Integer messageQuantity=Integer.valueOf(quantityValueStr);
              List shipmentItemList=null;
              if (invitemMapList.size() == 1 && localInvItemElementList.size() == 1 && UtilValidate.isNotEmpty(possibleShipmentItemSeqId)) {
                GenericValue shipmentItem=delegator.findByPrimaryKey("ShipmentItem",UtilMisc.toMap("shipmentId",shipmentId,"shipmentItemSeqId",possibleShipmentItemSeqId));
                if (shipmentItem != null && !productId.equals(shipmentItem.getString("productId"))) {
                  shipmentItem=null;
                }
                if (shipmentItem != null) {
                  Debug.logInfo("For Shipment [" + shipmentId + "] found ShipmentItem based on Package/Unit ID, possibleShipmentItemSeqId is ["+ possibleShipmentItemSeqId+ "]",module);
                  shipmentItemList=UtilMisc.toList(shipmentItem);
                }
              }
              if (UtilValidate.isEmpty(shipmentItemList)) {
                shipmentItemList=delegator.findByAnd("ShipmentItem",UtilMisc.toMap("shipmentId",shipmentId,"productId",productId));
                if (UtilValidate.isEmpty(shipmentItemList)) {
                  String errMsg="Could not find Shipment Item for Shipment with ID [" + shipmentId + "] and Product with ID ["+ productId+ "].";
                  errorMapList.add(UtilMisc.toMap("reasonCode","ShipmentItemForProductNotFound","description",errMsg));
                  Debug.logError(errMsg,module);
                  continue;
                }
                Iterator shipmentItemIter=shipmentItemList.iterator();
                while (shipmentItemIter.hasNext()) {
                  GenericValue shipmentItem=(GenericValue)shipmentItemIter.next();
                  if (messageQuantity.intValue() == shipmentItem.getDouble("quantity").intValue()) {
                    List itemIssuanceList=delegator.findByAnd("ItemIssuance",UtilMisc.toMap("shipmentId",shipmentId,"shipmentItemSeqId",shipmentItem.get("shipmentItemSeqId")));
                    if (itemIssuanceList.size() == 0) {
                      shipmentItemList=UtilMisc.toList(shipmentItem);
                      break;
                    }
                  }
                }
              }
              if (shipmentItemList.size() > 1) {
                String errMsg="Could not find single Shipment Item for Shipment with ID [" + shipmentId + "] and Product with ID ["+ productId+ "], found ["+ shipmentItemList.size()+ "] and could not narrow down to one.";
                errorMapList.add(UtilMisc.toMap("reasonCode","SingleShipmentItemForProductNotFound","description",errMsg));
                Debug.logError(errMsg,module);
                continue;
              }
              GenericValue shipmentItem=(GenericValue)shipmentItemList.get(0);
              String shipmentItemSeqId=shipmentItem.getString("shipmentItemSeqId");
              GenericValue orderShipment=EntityUtil.getFirst(delegator.findByAnd("OrderShipment",UtilMisc.toMap("shipmentId",shipmentId,"shipmentItemSeqId",shipmentItemSeqId)));
              if (orderShipment == null) {
                String errMsg="Could not find Order-Shipment record for ShipmentItem with ID [" + shipmentId + "] and Item Seq-ID ["+ shipmentItemSeqId+ "].";
                errorMapList.add(UtilMisc.toMap("reasonCode","OrderShipmentNotFound","description",errMsg));
                Debug.logError(errMsg,module);
                continue;
              }
              String orderId=orderShipment.getString("orderId");
              String orderItemSeqId=orderShipment.getString("orderItemSeqId");
              GenericValue product=delegator.findByPrimaryKey("Product",UtilMisc.toMap("productId",productId));
              String requireInventory=product.getString("requireInventory");
              if (requireInventory == null) {
                requireInventory="N";
              }
              List orderItemShipGrpInvReservationList=delegator.findByAnd("OrderItemShipGrpInvRes",UtilMisc.toMap("orderId",orderId,"orderItemSeqId",orderItemSeqId,"shipGroupSeqId",shipGroupSeqId));
              int totalReserved=0;
              Iterator orderItemShipGrpInvReservationCountIter=orderItemShipGrpInvReservationList.iterator();
              while (orderItemShipGrpInvReservationCountIter.hasNext()) {
                GenericValue orderItemShipGrpInvReservation=(GenericValue)orderItemShipGrpInvReservationCountIter.next();
                if (orderItemShipGrpInvReservation.getDouble("quantity") != null) {
                  totalReserved+=orderItemShipGrpInvReservation.getDouble("quantity").doubleValue();
                }
              }
              List serialNumberList=FastList.newInstance();
              List invDetailElementList=UtilXml.childElementList(invItemElement,"ns:INVDETAIL");
              Iterator invDetailElementItr=invDetailElementList.iterator();
              while (invDetailElementItr.hasNext()) {
                Element invDetailElement=(Element)invDetailElementItr.next();
                String serialNumber=UtilXml.childElementValue(invDetailElement,"of:SERIALNUM");
                if (UtilValidate.isNotEmpty(serialNumber)) {
                  serialNumberList.add(serialNumber);
                }
              }
              if (UtilValidate.isNotEmpty(serialNumberList)) {
                if (messageQuantity.intValue() != serialNumberList.size()) {
                  String errMsg="Error: the quantity in the message [" + messageQuantity.intValue() + "] did not match the number of serial numbers passed ["+ serialNumberList.size()+ "] for ShipmentItem with ID ["+ shipmentId+ "] and Item Seq-ID ["+ shipmentItemSeqId+ "].";
                  errorMapList.add(UtilMisc.toMap("reasonCode","QuantitySerialMismatch","description",errMsg));
                  Debug.logInfo(errMsg,module);
                  continue;
                }
              }
              if ((int)totalReserved < messageQuantity.intValue()) {
                String errMsg="Inventory reservation quantity [" + totalReserved + "] was less than the message quantity ["+ messageQuantity.intValue()+ "] so cannot receive against reservations for ShipmentItem with ID ["+ shipmentId+ ":"+ shipmentItemSeqId+ "], and OrderItem ["+ orderShipment.getString("orderId")+ ":"+ orderShipment.getString("orderItemSeqId")+ "]";
                errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","SerialNumbersMissing"));
                Debug.logInfo(errMsg,module);
                continue;
              }
              int quantityLeft;
              int shipmentItemQuantity=shipmentItem.getDouble("quantity").intValue();
              if (shipmentItemQuantity <= messageQuantity.intValue()) {
                quantityLeft=shipmentItemQuantity;
              }
 else {
                quantityLeft=messageQuantity.intValue();
              }
              Iterator serialNumberIter=serialNumberList.iterator();
              Iterator orderItemShipGrpInvReservationIter=orderItemShipGrpInvReservationList.iterator();
              while (orderItemShipGrpInvReservationIter.hasNext() && quantityLeft > 0) {
                GenericValue orderItemShipGrpInvReservation=(GenericValue)orderItemShipGrpInvReservationIter.next();
                int currentInvResQuantity=orderItemShipGrpInvReservation.getDouble("quantity").intValue();
                int quantityToUse;
                if (quantityLeft > currentInvResQuantity) {
                  quantityToUse=currentInvResQuantity;
                  quantityLeft-=currentInvResQuantity;
                }
 else {
                  quantityToUse=quantityLeft;
                  quantityLeft=0;
                }
                Map isitspastCtx=UtilMisc.toMap("orderId",orderId,"shipGroupSeqId",shipGroupSeqId,"orderItemSeqId",orderItemSeqId);
                isitspastCtx.put("productId",productId);
                isitspastCtx.put("reservedDatetime",orderItemShipGrpInvReservation.get("reservedDatetime"));
                isitspastCtx.put("requireInventory",requireInventory);
                isitspastCtx.put("reserveOrderEnumId",orderItemShipGrpInvReservation.get("reserveOrderEnumId"));
                isitspastCtx.put("sequenceId",orderItemShipGrpInvReservation.get("sequenceId"));
                isitspastCtx.put("originFacilityId",originFacilityId);
                isitspastCtx.put("userLogin",userLogin);
                isitspastCtx.put("trackingNum",trackingNum);
                isitspastCtx.put("inventoryItemId",orderItemShipGrpInvReservation.get("inventoryItemId"));
                isitspastCtx.put("shipmentId",shipmentId);
                isitspastCtx.put("shipmentPackageSeqId",shipmentPackageSeqId);
                isitspastCtx.put("promisedDatetime",orderItemShipGrpInvReservation.get("promisedDatetime"));
                if (UtilValidate.isNotEmpty(serialNumberList)) {
                  for (int i=0; i < quantityToUse; i++) {
                    String serialNumber=(String)serialNumberIter.next();
                    if (OagisServices.requireSerialNumberExist != null) {
                      Set productIdSet=ProductWorker.getRefurbishedProductIdSet(productId,delegator);
                      productIdSet.add(productId);
                      EntityCondition bySerialNumberCondition=new EntityExpr(new EntityExpr("serialNumber",EntityOperator.EQUALS,serialNumber),EntityOperator.AND,new EntityExpr("productId",EntityOperator.IN,productIdSet));
                      List inventoryItemsBySerialNumber=delegator.findList("InventoryItem",bySerialNumberCondition,null,null,null,false);
                      if (OagisServices.requireSerialNumberExist.booleanValue()) {
                        if (inventoryItemsBySerialNumber.size() == 0) {
                          String errMsg="Referenced serial numbers must already exist, but serial number [" + serialNumber + "] was not found. Product ID(s) considered are: "+ productIdSet;
                          errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","SerialNumberRequiredButNotFound"));
                          continue;
                        }
                      }
 else {
                        if (inventoryItemsBySerialNumber.size() > 0) {
                          String errMsg="Referenced serial numbers must NOT already exist, but serial number [" + serialNumber + "] already exists. Product ID(s) considered are: "+ productIdSet;
                          errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","SerialNumberRequiredNotExistButFound"));
                          continue;
                        }
                      }
                    }
                    isitspastCtx.put("serialNumber",serialNumber);
                    isitspastCtx.put("quantity",new Double(1));
                    isitspastCtx.put("inventoryItemId",orderItemShipGrpInvReservation.get("inventoryItemId"));
                    isitspastCtx.remove("itemIssuanceId");
                    Map resultMap=dispatcher.runSync("issueSerializedInvToShipmentPackageAndSetTracking",isitspastCtx);
                    if (ServiceUtil.isError(resultMap)) {
                      String errMsg=ServiceUtil.getErrorMessage(resultMap);
                      errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","IssueSerializedInvServiceError"));
                      Debug.logError(errMsg,module);
                    }
                  }
                }
 else {
                  isitspastCtx.put("quantity",new Double(quantityToUse));
                  Map resultMap=dispatcher.runSync("issueSerializedInvToShipmentPackageAndSetTracking",isitspastCtx);
                  if (ServiceUtil.isError(resultMap)) {
                    String errMsg=ServiceUtil.getErrorMessage(resultMap);
                    errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","IssueSerializedInvServiceError"));
                    Debug.logError(errMsg,module);
                  }
                }
              }
            }
          }
        }
      }
      if (errorMapList.size() == 0) {
        List shipmentItemList=delegator.findByAnd("ShipmentItem",UtilMisc.toMap("shipmentId",shipmentId));
        Iterator shipmentItemIter=shipmentItemList.iterator();
        while (shipmentItemIter.hasNext()) {
          GenericValue shipmentItem=(GenericValue)shipmentItemIter.next();
          int shipmentItemQuantity=shipmentItem.getDouble("quantity").intValue();
          int totalItemIssuanceQuantity=0;
          List itemIssuanceList=delegator.findByAnd("ItemIssuance",UtilMisc.toMap("shipmentId",shipmentId,"shipmentItemSeqId",shipmentItem.get("shipmentItemSeqId")));
          Iterator itemIssuanceIter=itemIssuanceList.iterator();
          while (itemIssuanceIter.hasNext()) {
            GenericValue itemIssuance=(GenericValue)itemIssuanceIter.next();
            totalItemIssuanceQuantity+=itemIssuance.getDouble("quantity").intValue();
          }
          if (shipmentItemQuantity > totalItemIssuanceQuantity) {
            String errMsg="ShipmentItem [" + shipmentId + ":"+ shipmentItem.get("shipmentItemSeqId")+ "] was not completely fulfilled; shipment item quantity was ["+ shipmentItemQuantity+ "], but total fulfilled is only ["+ totalItemIssuanceQuantity+ "]";
            errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","ShipmentItemNotCompletelyFulfilled"));
            Debug.logError(errMsg,module);
          }
        }
      }
      if (errorMapList.size() == 0) {
        Map resultMap=dispatcher.runSync("setShipmentStatusPackedAndShipped",UtilMisc.<String,Object>toMap("shipmentId",shipmentId,"userLogin",userLogin));
        if (ServiceUtil.isError(resultMap)) {
          String errMsg=ServiceUtil.getErrorMessage(resultMap);
          errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","SetShipmentStatusPackedAndShippedError"));
          Debug.logError(errMsg,module);
        }
      }
    }
 catch (    Throwable t) {
      String errMsg="System Error processing Show Shipment message for shipmentId [" + shipmentId + "] message ["+ omiPkMap+ "]: "+ t.toString();
      errorMapList.add(UtilMisc.toMap("description",errMsg,"reasonCode","SystemError"));
      try {
        oagisMsgInfoCtx.put("processingStatusId","OAGMP_SYS_ERROR");
        dispatcher.runSync("updateOagisMessageInfo",oagisMsgInfoCtx,60,true);
        Map saveErrorMapListCtx=FastMap.newInstance();
        saveErrorMapListCtx.putAll(omiPkMap);
        saveErrorMapListCtx.put("errorMapList",errorMapList);
        saveErrorMapListCtx.put("userLogin",userLogin);
        dispatcher.runSync("createOagisMsgErrInfosFromErrMapList",saveErrorMapListCtx,60,true);
      }
 catch (      GenericServiceException e) {
        String errMsg2="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
        Debug.logError(e,errMsg2,module);
      }
      Debug.logInfo(t,errMsg,module);
      return ServiceUtil.returnError(errMsg);
    }
  }
  Map result=FastMap.newInstance();
  result.putAll(omiPkMap);
  result.put("userLogin",userLogin);
  if (errorMapList.size() > 0) {
    try {
      oagisMsgInfoCtx.put("processingStatusId","OAGMP_PROC_ERROR");
      dispatcher.runSync("updateOagisMessageInfo",oagisMsgInfoCtx,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
    try {
      Map saveErrorMapListCtx=FastMap.newInstance();
      saveErrorMapListCtx.putAll(omiPkMap);
      saveErrorMapListCtx.put("errorMapList",errorMapList);
      saveErrorMapListCtx.put("userLogin",userLogin);
      dispatcher.runSync("createOagisMsgErrInfosFromErrMapList",saveErrorMapListCtx,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
    try {
      Map sendConfirmBodCtx=FastMap.newInstance();
      sendConfirmBodCtx.putAll(omiPkMap);
      sendConfirmBodCtx.put("errorMapList",errorMapList);
      sendConfirmBodCtx.put("userLogin",userLogin);
      sendConfirmBodCtx.put("origRefId",shipmentId);
      dispatcher.runAsync("oagisSendConfirmBod",sendConfirmBodCtx,null,true,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error sending Confirm BOD: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
    String errMsg="Found business level errors in message processing, not saving those changes but saving error messages; first error is: " + errorMapList.get(0);
    result.putAll(ServiceUtil.returnSuccess(errMsg));
    try {
      TransactionUtil.setRollbackOnly(errMsg,null);
    }
 catch (    GenericTransactionException e) {
      Debug.logError(e,"Error setting rollback only ",module);
    }
    return result;
  }
 else {
    try {
      oagisMsgInfoCtx.put("processingStatusId","OAGMP_PROC_SUCCESS");
      dispatcher.runSync("updateOagisMessageInfo",oagisMsgInfoCtx,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
  }
  result.putAll(ServiceUtil.returnSuccess("Service Completed Successfully"));
  return result;
}
