{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  GenericDelegator delegator=dctx.getDelegator();
  String returnId=(String)context.get("returnId");
  String sendToUrl=(String)context.get("sendToUrl");
  if (UtilValidate.isEmpty(sendToUrl)) {
    sendToUrl=UtilProperties.getPropertyValue("oagis.properties","url.send.receiveDelivery");
  }
  String saveToFilename=(String)context.get("saveToFilename");
  if (UtilValidate.isEmpty(saveToFilename)) {
    String saveToFilenameBase=UtilProperties.getPropertyValue("oagis.properties","test.save.outgoing.filename.base","");
    if (UtilValidate.isNotEmpty(saveToFilenameBase)) {
      saveToFilename=saveToFilenameBase + "ReceiveDelivery" + returnId+ ".xml";
    }
  }
  String saveToDirectory=(String)context.get("saveToDirectory");
  if (UtilValidate.isEmpty(saveToDirectory)) {
    saveToDirectory=UtilProperties.getPropertyValue("oagis.properties","test.save.outgoing.directory");
  }
  GenericValue userLogin=null;
  try {
    userLogin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","system"));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,"Error getting system userLogin",module);
  }
  OutputStream out=(OutputStream)context.get("outputStream");
  Map result=ServiceUtil.returnSuccess();
  MapStack bodyParameters=MapStack.create();
  GenericValue returnHeader=null;
  try {
    returnHeader=delegator.findByPrimaryKey("ReturnHeader",UtilMisc.toMap("returnId",returnId));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
  }
  if (returnHeader != null) {
    String statusId=returnHeader.getString("statusId");
    if ("RETURN_ACCEPTED".equals(statusId)) {
      Map comiCtx=FastMap.newInstance();
      String logicalId=UtilProperties.getPropertyValue("oagis.properties","CNTROLAREA.SENDER.LOGICALID");
      bodyParameters.put("logicalId",logicalId);
      comiCtx.put("logicalId",logicalId);
      String authId=UtilProperties.getPropertyValue("oagis.properties","CNTROLAREA.SENDER.AUTHID");
      bodyParameters.put("authId",authId);
      comiCtx.put("authId",authId);
      String referenceId=delegator.getNextSeqId("OagisMessageInfo");
      bodyParameters.put("referenceId",referenceId);
      comiCtx.put("referenceId",referenceId);
      Timestamp nowTimestamp=UtilDateTime.nowTimestamp();
      String sentDate=OagisServices.isoDateFormat.format(nowTimestamp);
      bodyParameters.put("sentDate",sentDate);
      comiCtx.put("component","INVENTORY");
      comiCtx.put("task","RMA");
      comiCtx.put("outgoingMessage","Y");
      comiCtx.put("confirmation","1");
      comiCtx.put("bsrVerb","RECEIVE");
      comiCtx.put("bsrNoun","DELIVERY");
      comiCtx.put("bsrRevision","001");
      comiCtx.put("returnId",returnId);
      comiCtx.put("sentDate",nowTimestamp);
      comiCtx.put("userLogin",userLogin);
      comiCtx.put("processingStatusId","OAGMP_TRIGGERED");
      try {
        dispatcher.runSync("createOagisMessageInfo",comiCtx,60,true);
      }
 catch (      GenericServiceException e) {
        String errMsg=UtilProperties.getMessage(ServiceUtil.resource,"OagisErrorInCreatingDataForOagisMessageInfoEntity",(Locale)context.get("locale"));
        Debug.logError(e,errMsg,module);
      }
      List returnItems=null;
      try {
        returnItems=delegator.findByAnd("ReturnItem",UtilMisc.toMap("returnId",returnId));
        bodyParameters.put("returnItems",returnItems);
      }
 catch (      GenericEntityException e) {
        Debug.logError(e,module);
      }
      GenericValue orderHeader=null;
      String orderId=null;
      try {
        orderId=EntityUtil.getFirst(returnItems).getString("orderId");
        orderHeader=delegator.findByPrimaryKey("OrderHeader",UtilMisc.toMap("orderId",orderId));
        if (orderHeader == null) {
          return ServiceUtil.returnError("No valid Order with [" + orderId + "] found, cannot process Return");
        }
      }
 catch (      GenericEntityException e) {
        String errMsg="Cannot process Return: " + e.toString();
        Debug.logError(e,errMsg,module);
        return ServiceUtil.returnError(errMsg);
      }
      String partyId=returnHeader.getString("fromPartyId");
      try {
        GenericValue postalAddress=delegator.findByPrimaryKey("PostalAddress",UtilMisc.toMap("contactMechId",returnHeader.getString("originContactMechId")));
        bodyParameters.put("postalAddress",postalAddress);
        bodyParameters.put("partyNameView",delegator.findByPrimaryKey("PartyNameView",UtilMisc.toMap("partyId",partyId)));
      }
 catch (      GenericEntityException e) {
        Debug.logError(e,module);
      }
      double totalQty=0.0;
      Map serialNumberListByReturnItemSeqIdMap=FastMap.newInstance();
      bodyParameters.put("serialNumberListByReturnItemSeqIdMap",serialNumberListByReturnItemSeqIdMap);
      Iterator riIter=returnItems.iterator();
      while (riIter.hasNext()) {
        GenericValue returnItem=(GenericValue)riIter.next();
        double itemQty=returnItem.getDouble("returnQuantity").doubleValue();
        totalQty+=itemQty;
        try {
          GenericValue orderItem=returnItem.getRelatedOne("OrderItem");
          if (orderItem != null) {
            if (orderItem.getDouble("quantity").doubleValue() == itemQty) {
              List itemIssuanceAndInventoryItemList=delegator.findByAnd("ItemIssuanceAndInventoryItem",UtilMisc.toMap("orderId",orderItem.get("orderId"),"orderItemSeqId",orderItem.get("orderItemSeqId"),"inventoryItemTypeId","SERIALIZED_INV_ITEM"));
              if (itemIssuanceAndInventoryItemList.size() == itemQty) {
                List serialNumberList=FastList.newInstance();
                serialNumberListByReturnItemSeqIdMap.put(returnItem.get("returnItemSeqId"),serialNumberList);
                Iterator itemIssuanceAndInventoryItemIter=itemIssuanceAndInventoryItemList.iterator();
                while (itemIssuanceAndInventoryItemIter.hasNext()) {
                  GenericValue itemIssuanceAndInventoryItem=(GenericValue)itemIssuanceAndInventoryItemIter.next();
                  serialNumberList.add(itemIssuanceAndInventoryItem.get("serialNumber"));
                }
              }
 else {
                Debug.logWarning("Number of serial numbers [" + itemIssuanceAndInventoryItemList.size() + "] did not match quantity ["+ itemQty+ "] for return item: "+ returnItem.getPrimaryKey(),module);
              }
            }
 else {
              Debug.logWarning("Could not get matching serial numbers because order item quantity [" + orderItem.getDouble("quantity") + "] did not match quantity ["+ itemQty+ "] for return item: "+ returnItem.getPrimaryKey(),module);
            }
          }
        }
 catch (        GenericEntityException e) {
          String errMsg="Error getting data for processing return message: " + e.toString();
          Debug.logError(e,errMsg,module);
          return ServiceUtil.returnError(errMsg);
        }
      }
      bodyParameters.put("totalQty",new Double(totalQty));
      String emailString=PartyWorker.findPartyLatestContactMech(partyId,"EMAIL_ADDRESS",delegator).getString("infoString");
      bodyParameters.put("emailString",emailString);
      GenericValue telecomNumber=PartyWorker.findPartyLatestTelecomNumber(partyId,delegator);
      bodyParameters.put("telecomNumber",telecomNumber);
      String entryDate=OagisServices.isoDateFormat.format(returnHeader.getTimestamp("entryDate"));
      bodyParameters.put("entryDate",entryDate);
      bodyParameters.put("returnId",returnId);
      String bodyScreenUri=UtilProperties.getPropertyValue("oagis.properties","Oagis.Template.ReceiveDelivery");
      String outText=null;
      try {
        Writer writer=new StringWriter();
        ScreenRenderer screens=new ScreenRenderer(writer,bodyParameters,htmlScreenRenderer);
        screens.render(bodyScreenUri);
        writer.close();
        outText=writer.toString();
      }
 catch (      Exception e) {
        String errMsg="Error rendering message: " + e.toString();
        Debug.logError(e,errMsg,module);
        return ServiceUtil.returnError(errMsg);
      }
      try {
        comiCtx.put("orderId",orderId);
        comiCtx.put("processingStatusId","OAGMP_OGEN_SUCCESS");
        if (OagisServices.debugSaveXmlOut) {
          comiCtx.put("fullMessageXml",outText);
        }
        dispatcher.runSync("updateOagisMessageInfo",comiCtx,60,true);
      }
 catch (      GenericServiceException e) {
        String errMsg=UtilProperties.getMessage(ServiceUtil.resource,"OagisErrorInCreatingDataForOagisMessageInfoEntity",(Locale)context.get("locale"));
        Debug.logError(e,errMsg,module);
      }
      Map sendMessageReturn=OagisServices.sendMessageText(outText,out,sendToUrl,saveToDirectory,saveToFilename);
      try {
        comiCtx.put("processingStatusId","OAGMP_SENT");
        dispatcher.runSync("updateOagisMessageInfo",comiCtx,60,true);
      }
 catch (      GenericServiceException e) {
        String errMsg=UtilProperties.getMessage(ServiceUtil.resource,"OagisErrorInCreatingDataForOagisMessageInfoEntity",(Locale)context.get("locale"));
        Debug.logError(e,errMsg,module);
      }
      if (sendMessageReturn != null) {
        return sendMessageReturn;
      }
    }
  }
  return result;
}
