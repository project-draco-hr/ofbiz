{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  Delegator delegator=dctx.getDelegator();
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  BigDecimal amount=(BigDecimal)context.get("processAmount");
  String currency=(String)context.get("currency");
  if (currency == null) {
    currency=UtilProperties.getPropertyValue("general.properties","currency.uom.id.default","USD");
  }
  GenericValue orderPaymentPreference=(GenericValue)context.get("orderPaymentPreference");
  GenericValue authTransaction=(GenericValue)context.get("authTrans");
  if (authTransaction == null) {
    authTransaction=PaymentGatewayServices.getAuthTransaction(orderPaymentPreference);
  }
  if (authTransaction == null) {
    return ServiceUtil.returnError("No authorization transaction found for the OrderPaymentPreference; cannot capture");
  }
  String finAccountAuthId=authTransaction.getString("referenceNum");
  try {
    GenericValue finAccountAuth=delegator.findByPrimaryKey("FinAccountAuth",UtilMisc.toMap("finAccountAuthId",finAccountAuthId));
    GenericValue giftCard=finAccountAuth.getRelatedOne("FinAccount");
    Timestamp authExpiration=finAccountAuth.getTimestamp("thruDate");
    if ((authExpiration != null) && (authExpiration.before(UtilDateTime.nowTimestamp()))) {
      return ServiceUtil.returnError("Authorization transaction [" + authTransaction.getString("paymentGatewayResponseId") + "] has expired as of "+ authExpiration);
    }
    if ((giftCard.getTimestamp("thruDate") != null) && (giftCard.getTimestamp("thruDate").before(UtilDateTime.nowTimestamp()))) {
      return ServiceUtil.returnError("Gift certificate has expired as of " + giftCard.getTimestamp("thruDate"));
    }
    OrderReadHelper orh=new OrderReadHelper(delegator,orderPaymentPreference.getString("orderId"));
    Map redeemCtx=new HashMap();
    redeemCtx.put("userLogin",userLogin);
    redeemCtx.put("productStoreId",orh.getProductStoreId());
    redeemCtx.put("cardNumber",giftCard.get("finAccountId"));
    redeemCtx.put("pinNumber",giftCard.get("finAccountCode"));
    redeemCtx.put("currency",currency);
    if (orh.getBillToParty() != null) {
      redeemCtx.put("partyId",orh.getBillToParty().get("partyId"));
    }
    redeemCtx.put("amount",amount);
    Map redeemResult=null;
    redeemResult=dispatcher.runSync("redeemGiftCertificate",redeemCtx);
    if (ServiceUtil.isError(redeemResult)) {
      return redeemResult;
    }
    Map releaseResult=dispatcher.runSync("expireFinAccountAuth",UtilMisc.<String,Object>toMap("userLogin",userLogin,"finAccountAuthId",finAccountAuthId));
    if (ServiceUtil.isError(releaseResult)) {
      return releaseResult;
    }
    String authRefNum=authTransaction.getString("referenceNum");
    Map result=ServiceUtil.returnSuccess();
    if (redeemResult != null) {
      Boolean processResult=(Boolean)redeemResult.get("processResult");
      result.put("processAmount",amount);
      result.put("captureResult",processResult);
      result.put("captureCode","C");
      result.put("captureRefNum",redeemResult.get("referenceNum"));
      result.put("authRefNum",authRefNum);
    }
    return result;
  }
 catch (  GenericEntityException ex) {
    return ServiceUtil.returnError("Cannot process gift card: " + ex.getMessage());
  }
catch (  GenericServiceException ex) {
    return ServiceUtil.returnError("Cannot process gift card: " + ex.getMessage());
  }
}
