{
  LocalDispatcher dispatcher=dctx.getDispatcher();
  Delegator delegator=dctx.getDelegator();
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  GenericValue orderItem=(GenericValue)context.get("orderItem");
  String partyId=(String)context.get("partyId");
  try {
    orderItem.refresh();
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
  }
  Map<String,Object> returnableInfo=null;
  try {
    returnableInfo=dispatcher.runSync("getReturnableQuantity",UtilMisc.toMap("orderItem",orderItem,"userLogin",userLogin));
  }
 catch (  GenericServiceException e) {
    Debug.logError(e,module);
    return ServiceUtil.returnError("Unable to get returnable infomation for order item : " + orderItem);
  }
  if (returnableInfo != null) {
    BigDecimal returnableQuantity=(BigDecimal)returnableInfo.get("returnableQuantity");
    BigDecimal returnablePrice=(BigDecimal)returnableInfo.get("returnablePrice");
    Debug.logInfo("Returnable INFO : " + returnableQuantity + " @ "+ returnablePrice+ " :: "+ orderItem,module);
    Map<String,Object> returnHeaderInfo=new HashMap<String,Object>();
    returnHeaderInfo.put("fromPartyId",partyId);
    returnHeaderInfo.put("userLogin",userLogin);
    Map<String,Object> returnHeaderResp=null;
    try {
      returnHeaderResp=dispatcher.runSync("createReturnHeader",returnHeaderInfo);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError("Unable to create return header");
    }
    if (returnHeaderResp != null) {
      String errorMessage=ServiceUtil.getErrorMessage(returnHeaderResp);
      if (errorMessage != null) {
        return ServiceUtil.returnError(errorMessage);
      }
    }
    String returnId=null;
    if (returnHeaderResp != null) {
      returnId=(String)returnHeaderResp.get("returnId");
    }
    if (returnId == null) {
      return ServiceUtil.returnError("Create return did not return a valid return id");
    }
    Map<String,Object> returnItemInfo=new HashMap<String,Object>();
    returnItemInfo.put("returnId",returnId);
    returnItemInfo.put("returnReasonId","RTN_DIG_FILL_FAIL");
    returnItemInfo.put("returnTypeId","RTN_REFUND");
    returnItemInfo.put("returnItemType","ITEM");
    returnItemInfo.put("description",orderItem.get("itemDescription"));
    returnItemInfo.put("orderId",orderItem.get("orderId"));
    returnItemInfo.put("orderItemSeqId",orderItem.get("orderItemSeqId"));
    returnItemInfo.put("returnQuantity",returnableQuantity);
    returnItemInfo.put("returnPrice",returnablePrice);
    returnItemInfo.put("userLogin",userLogin);
    Map<String,Object> returnItemResp=null;
    try {
      returnItemResp=dispatcher.runSync("createReturnItem",returnItemInfo);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError("Unable to create return item");
    }
    if (returnItemResp != null) {
      String errorMessage=ServiceUtil.getErrorMessage(returnItemResp);
      if (errorMessage != null) {
        return ServiceUtil.returnError(errorMessage);
      }
    }
    String returnItemSeqId=null;
    if (returnItemResp != null) {
      returnItemSeqId=(String)returnItemResp.get("returnItemSeqId");
    }
    if (returnItemSeqId == null) {
      return ServiceUtil.returnError("Create return item did not return a valid sequence id");
    }
 else {
      Debug.logVerbose("Created return item : " + returnId + " / "+ returnItemSeqId,module);
    }
    GenericValue admin=null;
    try {
      admin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","admin"));
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError("Unable to look up UserLogin from database");
    }
    Map<String,Object> updateReturnInfo=new HashMap<String,Object>();
    updateReturnInfo.put("returnId",returnId);
    updateReturnInfo.put("statusId","RETURN_RECEIVED");
    updateReturnInfo.put("currentStatusId","RETURN_REQUESTED");
    updateReturnInfo.put("userLogin",admin);
    Map<String,Object> updateReturnResp=null;
    try {
      updateReturnResp=dispatcher.runSync("updateReturnHeader",updateReturnInfo);
    }
 catch (    GenericServiceException e) {
      Debug.logError(e,module);
      return ServiceUtil.returnError("Unable to update return header status");
    }
    if (updateReturnResp != null) {
      String errorMessage=ServiceUtil.getErrorMessage(updateReturnResp);
      if (errorMessage != null) {
        return ServiceUtil.returnError(errorMessage);
      }
    }
  }
  return ServiceUtil.returnSuccess();
}
