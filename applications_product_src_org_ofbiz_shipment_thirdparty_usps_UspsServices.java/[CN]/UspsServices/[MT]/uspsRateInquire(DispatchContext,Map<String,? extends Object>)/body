{
  GenericDelegator delegator=dctx.getDelegator();
  Double shippableWeight=(Double)context.get("shippableWeight");
  if (shippableWeight.doubleValue() == 0) {
    return ServiceUtil.returnFailure("shippableWeight must be greater than 0");
  }
  String originationZip=null;
  GenericValue productStore=ProductStoreWorker.getProductStore(((String)context.get("productStoreId")),delegator);
  if (productStore != null && productStore.get("inventoryFacilityId") != null) {
    GenericValue facilityContactMech=ContactMechWorker.getFacilityContactMechByPurpose(delegator,productStore.getString("inventoryFacilityId"),UtilMisc.toList("SHIP_ORIG_LOCATION","PRIMARY_LOCATION"));
    if (facilityContactMech != null) {
      try {
        GenericValue shipFromAddress=delegator.findByPrimaryKey("PostalAddress",UtilMisc.toMap("contactMechId",facilityContactMech.getString("contactMechId")));
        if (shipFromAddress != null) {
          originationZip=shipFromAddress.getString("postalCode");
        }
      }
 catch (      GenericEntityException e) {
        Debug.logError(e,module);
      }
    }
  }
  if (UtilValidate.isEmpty(originationZip)) {
    return ServiceUtil.returnError("Unable to determine the origination ZIP");
  }
  String destinationZip=null;
  String shippingContactMechId=(String)context.get("shippingContactMechId");
  if (UtilValidate.isNotEmpty(shippingContactMechId)) {
    try {
      GenericValue shipToAddress=delegator.findByPrimaryKey("PostalAddress",UtilMisc.toMap("contactMechId",shippingContactMechId));
      if (shipToAddress != null) {
        destinationZip=shipToAddress.getString("postalCode");
      }
    }
 catch (    GenericEntityException e) {
      Debug.logError(e,module);
    }
  }
  if (UtilValidate.isEmpty(destinationZip)) {
    return ServiceUtil.returnError("Unable to determine the destination ZIP");
  }
  String serviceCode=null;
  try {
    GenericValue carrierShipmentMethod=delegator.findByPrimaryKey("CarrierShipmentMethod",UtilMisc.toMap("shipmentMethodTypeId",(String)context.get("shipmentMethodTypeId"),"partyId",(String)context.get("carrierPartyId"),"roleTypeId",(String)context.get("carrierRoleTypeId")));
    if (carrierShipmentMethod != null) {
      serviceCode=carrierShipmentMethod.getString("carrierServiceCode");
    }
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,module);
  }
  if (UtilValidate.isEmpty(serviceCode)) {
    return ServiceUtil.returnError("Unable to determine the service code");
  }
  Document requestDocument=createUspsRequestDocument("RateV2Request");
  double maxWeight=70;
  String maxWeightStr=UtilProperties.getPropertyValue((String)context.get("serviceConfigProps"),"shipment.usps.max.estimate.weight","70");
  try {
    maxWeight=Double.parseDouble(maxWeightStr);
  }
 catch (  NumberFormatException e) {
    Debug.logWarning("Error parsing max estimate weight string [" + maxWeightStr + "], using default instead",module);
    maxWeight=70;
  }
  List<Map<String,Object>> shippableItemInfo=UtilGenerics.checkList(context.get("shippableItemInfo"));
  List<Map<String,Double>> packages=getPackageSplit(dctx,shippableItemInfo,maxWeight);
  boolean isOnePackage=packages.size() == 1;
  for (ListIterator<Map<String,Double>> li=packages.listIterator(); li.hasNext(); ) {
    Map<String,Double> packageMap=li.next();
    double packageWeight=isOnePackage ? shippableWeight.doubleValue() : calcPackageWeight(dctx,packageMap,shippableItemInfo,0);
    if (packageWeight == 0) {
      continue;
    }
    Element packageElement=UtilXml.addChildElement(requestDocument.getDocumentElement(),"Package",requestDocument);
    packageElement.setAttribute("ID",String.valueOf(li.nextIndex() - 1));
    UtilXml.addChildElementValue(packageElement,"Service",serviceCode,requestDocument);
    UtilXml.addChildElementValue(packageElement,"ZipOrigination",originationZip.substring(0,5),requestDocument);
    UtilXml.addChildElementValue(packageElement,"ZipDestination",destinationZip.substring(0,5),requestDocument);
    double weightPounds=Math.floor(packageWeight);
    if ("PARCEL".equals(serviceCode.toUpperCase()) && (weightPounds < 1.0)) {
      weightPounds=1.0;
      packageWeight=0.0;
    }
    double weightOunces=Math.ceil(packageWeight * 16 % 16);
    DecimalFormat df=new DecimalFormat("#");
    UtilXml.addChildElementValue(packageElement,"Pounds",df.format(weightPounds),requestDocument);
    UtilXml.addChildElementValue(packageElement,"Ounces",df.format(weightOunces),requestDocument);
    if ("Parcel".equalsIgnoreCase(serviceCode)) {
      UtilXml.addChildElementValue(packageElement,"Container","None",requestDocument);
    }
    UtilXml.addChildElementValue(packageElement,"Size","Regular",requestDocument);
    UtilXml.addChildElementValue(packageElement,"Machinable","False",requestDocument);
  }
  Document responseDocument=null;
  try {
    responseDocument=sendUspsRequest("RateV2",requestDocument);
  }
 catch (  UspsRequestException e) {
    Debug.log(e,module);
    return ServiceUtil.returnError("Error sending request for USPS Domestic Rate Calculation service: " + e.getMessage());
  }
  if (responseDocument == null) {
    return ServiceUtil.returnError("No rate available at this time");
  }
  List<? extends Element> rates=UtilXml.childElementList(responseDocument.getDocumentElement(),"Package");
  if (UtilValidate.isEmpty(rates)) {
    return ServiceUtil.returnError("No rate available at this time");
  }
  double estimateAmount=0.00;
  for (Iterator<? extends Element> i=rates.iterator(); i.hasNext(); ) {
    Element packageElement=i.next();
    try {
      Element postageElement=UtilXml.firstChildElement(packageElement,"Postage");
      double packageAmount=Double.parseDouble(UtilXml.childElementValue(postageElement,"Rate"));
      estimateAmount+=packageAmount;
    }
 catch (    NumberFormatException e) {
      Debug.log(e,module);
    }
  }
  Map<String,Object> result=ServiceUtil.returnSuccess();
  result.put("shippingEstimateAmount",Double.valueOf(estimateAmount));
  return result;
}
