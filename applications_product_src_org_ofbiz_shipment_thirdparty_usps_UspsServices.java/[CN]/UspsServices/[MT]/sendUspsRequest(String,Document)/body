{
  String conUrl=null;
  List<String> labelRequestTypes=UtilMisc.toList("PriorityMailIntl","PriorityMailIntlCertify");
  if (labelRequestTypes.contains(requestType)) {
    conUrl=UtilProperties.getPropertyValue("shipment.properties","shipment.usps.connect.url.labels");
  }
 else {
    conUrl=UtilProperties.getPropertyValue("shipment.properties","shipment.usps.connect.url");
  }
  if (UtilValidate.isEmpty(conUrl)) {
    throw new UspsRequestException("Connection URL not specified; please check your configuration");
  }
  OutputStream os=new ByteArrayOutputStream();
  try {
    UtilXml.writeXmlDocument(requestDocument,os,"UTF-8",true,false,0);
  }
 catch (  TransformerException e) {
    throw new UspsRequestException("Error serializing requestDocument: " + e.getMessage());
  }
  String xmlString=os.toString();
  Debug.logInfo("USPS XML request string: " + xmlString,module);
  String timeOutStr=UtilProperties.getPropertyValue("shipment.properties","shipment.usps.connect.timeout","60");
  int timeout=60;
  try {
    timeout=Integer.parseInt(timeOutStr);
  }
 catch (  NumberFormatException e) {
    Debug.logError(e,"Unable to set timeout to " + timeOutStr + " using default "+ timeout);
  }
  HttpClient http=new HttpClient(conUrl);
  http.setTimeout(timeout * 1000);
  http.setParameter("API",requestType);
  http.setParameter("XML",xmlString);
  String responseString=null;
  try {
    responseString=http.get();
  }
 catch (  HttpClientException e) {
    throw new UspsRequestException("Problem connecting with USPS server",e);
  }
  Debug.logInfo("USPS response: " + responseString,module);
  if (UtilValidate.isEmpty(responseString)) {
    return null;
  }
  Document responseDocument=null;
  try {
    responseDocument=UtilXml.readXmlDocument(responseString,false);
  }
 catch (  SAXException se) {
    throw new UspsRequestException("Error reading request Document from a String: " + se.getMessage());
  }
catch (  ParserConfigurationException pce) {
    throw new UspsRequestException("Error reading request Document from a String: " + pce.getMessage());
  }
catch (  IOException xmlReadException) {
    throw new UspsRequestException("Error reading request Document from a String: " + xmlReadException.getMessage());
  }
  Element responseElement=responseDocument.getDocumentElement();
  if ("Error".equals(responseElement.getNodeName())) {
    throw new UspsRequestException(UtilXml.childElementValue(responseElement,"Description"));
  }
  return responseDocument;
}
