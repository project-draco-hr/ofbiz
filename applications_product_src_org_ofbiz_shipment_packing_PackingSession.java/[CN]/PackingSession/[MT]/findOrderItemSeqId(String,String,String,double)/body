{
  Map lookupMap=FastMap.newInstance();
  lookupMap.put("orderId",orderId);
  lookupMap.put("productId",productId);
  lookupMap.put("statusId","ITEM_APPROVED");
  lookupMap.put("shipGroupSeqId",shipGroupSeqId);
  List sort=UtilMisc.toList("-quantity");
  List orderItems=this.getDelegator().findByAnd("OrderItemAndShipGroupAssoc",lookupMap,sort);
  String orderItemSeqId=null;
  if (orderItems != null) {
    Iterator i=orderItems.iterator();
    while (i.hasNext()) {
      GenericValue item=(GenericValue)i.next();
      Map invLookup=FastMap.newInstance();
      invLookup.put("orderId",orderId);
      invLookup.put("orderItemSeqId",item.getString("orderItemSeqId"));
      invLookup.put("shipGroupSeqId",shipGroupSeqId);
      List reservations=this.getDelegator().findByAnd("OrderItemShipGrpInvRes",invLookup);
      Iterator resIter=reservations.iterator();
      while (resIter.hasNext()) {
        GenericValue res=(GenericValue)resIter.next();
        Double qty=res.getDouble("quantity");
        if (quantity <= qty.doubleValue()) {
          orderItemSeqId=item.getString("orderItemSeqId");
          break;
        }
      }
    }
  }
  if (orderItemSeqId != null) {
    return orderItemSeqId;
  }
 else {
    throw new GeneralException("No valid order item found for product [" + productId + "] with quantity: "+ quantity);
  }
}
