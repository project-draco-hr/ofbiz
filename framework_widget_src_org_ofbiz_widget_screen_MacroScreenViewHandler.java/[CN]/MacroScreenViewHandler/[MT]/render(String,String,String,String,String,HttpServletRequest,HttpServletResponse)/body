{
  try {
    Writer writer=response.getWriter();
    Delegator delegator=(Delegator)request.getAttribute("delegator");
    if (UtilValidate.isEmpty(encoding)) {
      encoding=EntityUtilProperties.getPropertyValue("widget",getName() + ".default.encoding","none",delegator);
    }
    boolean compressOutput="compressed".equals(encoding);
    if (!compressOutput) {
      compressOutput="true".equals(EntityUtilProperties.getPropertyValue("widget",getName() + ".compress",delegator));
    }
    if (!compressOutput && this.servletContext != null) {
      compressOutput="true".equals(this.servletContext.getAttribute("compressHTML"));
    }
    if (compressOutput) {
      writer=new StandardCompress().getWriter(writer,null);
    }
    ScreenStringRenderer screenStringRenderer=new MacroScreenRenderer(EntityUtilProperties.getPropertyValue("widget",getName() + ".name",delegator),EntityUtilProperties.getPropertyValue("widget",getName() + ".screenrenderer",delegator));
    ScreenRenderer screens=new ScreenRenderer(writer,null,screenStringRenderer);
    screens.populateContextForRequest(request,response,servletContext);
    String macroLibraryPath=EntityUtilProperties.getPropertyValue("widget",getName() + ".formrenderer",delegator);
    if (UtilValidate.isNotEmpty(macroLibraryPath)) {
      FormStringRenderer formStringRenderer=new MacroFormRenderer(macroLibraryPath,request,response);
      screens.getContext().put("formStringRenderer",formStringRenderer);
    }
    macroLibraryPath=EntityUtilProperties.getPropertyValue("widget",getName() + ".treerenderer",delegator);
    if (UtilValidate.isNotEmpty(macroLibraryPath)) {
      TreeStringRenderer treeStringRenderer=new MacroTreeRenderer(macroLibraryPath,writer);
      screens.getContext().put("treeStringRenderer",treeStringRenderer);
    }
    macroLibraryPath=EntityUtilProperties.getPropertyValue("widget",getName() + ".menurenderer",delegator);
    if (UtilValidate.isNotEmpty(macroLibraryPath)) {
      MenuStringRenderer menuStringRenderer=new MacroMenuRenderer(macroLibraryPath,request,response);
      screens.getContext().put("menuStringRenderer",menuStringRenderer);
    }
    screens.getContext().put("simpleEncoder",StringUtil.getEncoder(EntityUtilProperties.getPropertyValue("widget",getName() + ".encoder",delegator)));
    screenStringRenderer.renderScreenBegin(writer,screens.getContext());
    screens.render(page);
    screenStringRenderer.renderScreenEnd(writer,screens.getContext());
    writer.flush();
  }
 catch (  TemplateException e) {
    Debug.logError(e,"Error initializing screen renderer",module);
    throw new ViewHandlerException(e.getMessage());
  }
catch (  IOException e) {
    throw new ViewHandlerException("Error in the response writer/output stream: " + e.toString(),e);
  }
catch (  SAXException e) {
    throw new ViewHandlerException("XML Error rendering page: " + e.toString(),e);
  }
catch (  ParserConfigurationException e) {
    throw new ViewHandlerException("XML Error rendering page: " + e.toString(),e);
  }
catch (  GeneralException e) {
    throw new ViewHandlerException("Lower level error rendering page: " + e.toString(),e);
  }
}
