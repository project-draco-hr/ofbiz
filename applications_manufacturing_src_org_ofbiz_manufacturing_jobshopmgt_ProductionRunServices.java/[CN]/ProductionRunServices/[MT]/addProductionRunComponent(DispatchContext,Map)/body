{
  Map result=new HashMap();
  GenericDelegator delegator=ctx.getDelegator();
  LocalDispatcher dispatcher=ctx.getDispatcher();
  Timestamp now=UtilDateTime.nowTimestamp();
  Locale locale=(Locale)context.get("locale");
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  String productionRunId=(String)context.get("productionRunId");
  String productId=(String)context.get("productId");
  Double quantity=(Double)context.get("estimatedQuantity");
  String workEffortId=(String)context.get("workEffortId");
  ProductionRun productionRun=new ProductionRun(productionRunId,delegator,dispatcher);
  List tasks=productionRun.getProductionRunRoutingTasks();
  if (tasks == null || tasks.size() == 0) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource,"ManufacturingProductionRunTaskNotExists",locale));
  }
  if (!productionRun.getGenericValue().getString("currentStatusId").equals("PRUN_CREATED")) {
    return ServiceUtil.returnError(UtilProperties.getMessage(resource,"ManufacturingProductionRunPrinted",locale));
  }
  if (workEffortId != null) {
    boolean found=false;
    for (int i=0; i < tasks.size(); i++) {
      GenericValue oneTask=(GenericValue)tasks.get(i);
      if (oneTask.getString("workEffortId").equals(workEffortId)) {
        found=true;
        break;
      }
    }
    if (!found) {
      return ServiceUtil.returnError(UtilProperties.getMessage(resource,"ManufacturingProductionRunTaskNotExists",locale));
    }
  }
 else {
    workEffortId=EntityUtil.getFirst(tasks).getString("workEffortId");
  }
  try {
    GenericValue product=delegator.findByPrimaryKey("Product",UtilMisc.toMap("productId",productId));
    if (product == null) {
      return ServiceUtil.returnError(UtilProperties.getMessage(resource,"ManufacturingProductNotExists",locale));
    }
  }
 catch (  GenericEntityException e) {
    Debug.logWarning(e.getMessage(),module);
    return ServiceUtil.returnError(e.getMessage());
  }
  Map serviceContext=new HashMap();
  serviceContext.clear();
  serviceContext.put("workEffortId",workEffortId);
  serviceContext.put("productId",productId);
  serviceContext.put("workEffortGoodStdTypeId","PRUNT_PROD_NEEDED");
  serviceContext.put("statusId","WEGS_CREATED");
  serviceContext.put("fromDate",now);
  serviceContext.put("estimatedQuantity",quantity);
  serviceContext.put("userLogin",userLogin);
  Map resultService=null;
  try {
    resultService=dispatcher.runSync("createWorkEffortGoodStandard",serviceContext);
  }
 catch (  GenericServiceException e) {
    Debug.logError(e,"Problem calling the createWorkEffortGoodStandard service",module);
    return ServiceUtil.returnError(UtilProperties.getMessage(resource,"ManufacturingProductionRunComponentNotAdded",locale));
  }
  result.put(ModelService.SUCCESS_MESSAGE,UtilProperties.getMessage(resource,"ManufacturingProductionRunComponentAdded",UtilMisc.toMap("productionRunId",productionRunId),locale));
  return result;
}
