{
  BigDecimal balance=ZERO;
  List paymentAppls=delegator.findByAnd("PaymentApplication",UtilMisc.toMap("billingAccountId",billingAccountId));
  if (paymentAppls != null) {
    for (Iterator pAi=paymentAppls.iterator(); pAi.hasNext(); ) {
      GenericValue paymentAppl=(GenericValue)pAi.next();
      BigDecimal amountApplied=paymentAppl.getBigDecimal("amountApplied");
      if (paymentAppl.getString("invoiceId") != null) {
        if (!"INVOICE_CANCELED".equals(paymentAppl.getRelatedOne("Invoice").getString("statusId"))) {
          balance=balance.add(amountApplied);
        }
      }
 else {
        balance=balance.subtract(amountApplied);
      }
    }
  }
  balance=balance.setScale(decimals,rounding);
  return balance;
}
