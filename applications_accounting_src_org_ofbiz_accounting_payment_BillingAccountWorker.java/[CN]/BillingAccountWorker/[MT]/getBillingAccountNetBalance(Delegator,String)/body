{
  BigDecimal balance=ZERO;
  List<GenericValue> paymentAppls=delegator.findByAnd("PaymentApplication",UtilMisc.toMap("billingAccountId",billingAccountId));
  for (Iterator<GenericValue> pAi=paymentAppls.iterator(); pAi.hasNext(); ) {
    GenericValue paymentAppl=pAi.next();
    BigDecimal amountApplied=paymentAppl.getBigDecimal("amountApplied");
    GenericValue invoice=paymentAppl.getRelatedOne("Invoice");
    if (invoice != null) {
      if (!"CUST_RTN_INVOICE".equals(invoice.getString("invoiceTypeId")) && !"INVOICE_CANCELLED".equals(invoice.getString("statusId"))) {
        balance=balance.add(amountApplied);
      }
    }
 else {
      balance=balance.subtract(amountApplied);
    }
  }
  balance=balance.setScale(decimals,rounding);
  return balance;
}
