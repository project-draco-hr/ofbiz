{
  UtilCache<String,String> cache=createUtilCache(0,0,0,false,true);
  Listener<String,String> gotListener=createListener(cache);
  Listener<String,String> wantedListener=new Listener<String,String>();
  for (int i=0; i < 2; i++) {
    assertTrue("UtilCacheTable.keySet",UtilCache.getUtilCacheTableKeySet().contains(cache.getName()));
    assertSame("UtilCache.findCache",cache,UtilCache.findCache(cache.getName()));
    assertSame("UtilCache.getOrCreateUtilCache",cache,UtilCache.getOrCreateUtilCache(cache.getName(),cache.getMaxSize(),cache.getMaxInMemory(),cache.getExpireTime(),cache.getUseSoftReference(),cache.getUseFileSystemStore()));
    assertNoSingleKey(cache,"one");
    long origByteSize=cache.getSizeInBytes();
    wantedListener.noteKeyAddition(cache,"one","uno");
    assertNull("put",cache.put("one","uno"));
    assertHasSingleKey(cache,"one","uno");
    long unoByteSize=cache.getSizeInBytes();
    assertThat(unoByteSize,greaterThan(origByteSize));
    wantedListener.noteKeyUpdate(cache,"one","single","uno");
    assertEquals("replace","uno",cache.put("one","single"));
    assertHasSingleKey(cache,"one","single");
    long singleByteSize=cache.getSizeInBytes();
    assertThat(singleByteSize,greaterThan(origByteSize));
    assertThat(singleByteSize,greaterThan(unoByteSize));
    wantedListener.noteKeyRemoval(cache,"one","single");
    assertEquals("remove","single",cache.remove("one"));
    assertNoSingleKey(cache,"one");
    assertEquals("byteSize",origByteSize,cache.getSizeInBytes());
    wantedListener.noteKeyAddition(cache,"one","uno");
    assertNull("put",cache.put("one","uno"));
    assertHasSingleKey(cache,"one","uno");
    wantedListener.noteKeyUpdate(cache,"one","only","uno");
    assertEquals("replace","uno",cache.put("one","only"));
    assertHasSingleKey(cache,"one","only");
    wantedListener.noteKeyRemoval(cache,"one","only");
    assertEquals("remove","only",cache.remove("one"));
    assertNoSingleKey(cache,"one");
    assertEquals("byteSize",origByteSize,cache.getSizeInBytes());
    cache.setExpireTime(100);
    wantedListener.noteKeyAddition(cache,"one","uno");
    assertNull("put",cache.put("one","uno"));
    assertHasSingleKey(cache,"one","uno");
    wantedListener.noteKeyRemoval(cache,"one","uno");
    Thread.sleep(200);
    assertNoSingleKey(cache,"one");
  }
  assertEquals("get-miss",8,cache.getMissCountNotFound());
  assertEquals("get-miss-total",8,cache.getMissCountTotal());
  assertEquals("get-hit",20,cache.getHitCount());
  assertEquals("remove-hit",4,cache.getRemoveHitCount());
  assertEquals("remove-miss",8,cache.getRemoveMissCount());
  cache.removeListener(gotListener);
  assertEquals("listener",wantedListener,gotListener);
  cache.clear();
}
