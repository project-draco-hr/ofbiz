{
  Document doc=(Document)context.get("document");
  boolean isErrorRetry=Boolean.TRUE.equals(context.get("isErrorRetry"));
  GenericDelegator delegator=ctx.getDelegator();
  LocalDispatcher dispatcher=ctx.getDispatcher();
  Locale locale=(Locale)context.get("locale");
  List errorMapList=FastList.newInstance();
  List inventoryMapList=FastList.newInstance();
  GenericValue userLogin=null;
  try {
    userLogin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","system"));
  }
 catch (  GenericEntityException e) {
    String errMsg="Error Getting UserLogin: " + e.toString();
    Debug.logError(e,errMsg,module);
  }
  Element syncInventoryRootElement=doc.getDocumentElement();
  syncInventoryRootElement.normalize();
  Element docCtrlAreaElement=UtilXml.firstChildElement(syncInventoryRootElement,"os:CNTROLAREA");
  Element docBsrElement=UtilXml.firstChildElement(docCtrlAreaElement,"os:BSR");
  Element docSenderElement=UtilXml.firstChildElement(docCtrlAreaElement,"os:SENDER");
  String bsrVerb=UtilXml.childElementValue(docBsrElement,"of:VERB");
  String bsrNoun=UtilXml.childElementValue(docBsrElement,"of:NOUN");
  String bsrRevision=UtilXml.childElementValue(docBsrElement,"of:REVISION");
  String logicalId=UtilXml.childElementValue(docSenderElement,"of:LOGICALID");
  String component=UtilXml.childElementValue(docSenderElement,"of:COMPONENT");
  String task=UtilXml.childElementValue(docSenderElement,"of:TASK");
  String referenceId=UtilXml.childElementValue(docSenderElement,"of:REFERENCEID");
  String confirmation=UtilXml.childElementValue(docSenderElement,"of:CONFIRMATION");
  String authId=UtilXml.childElementValue(docSenderElement,"of:AUTHID");
  Map comiCtx=FastMap.newInstance();
  comiCtx.put("logicalId",logicalId);
  comiCtx.put("component",component);
  comiCtx.put("task",task);
  comiCtx.put("referenceId",referenceId);
  comiCtx.put("confirmation",confirmation);
  comiCtx.put("authId",authId);
  comiCtx.put("bsrVerb",bsrVerb);
  comiCtx.put("bsrNoun",bsrNoun);
  comiCtx.put("bsrRevision",bsrRevision);
  comiCtx.put("receivedDate",UtilDateTime.nowTimestamp());
  comiCtx.put("outgoingMessage","N");
  comiCtx.put("processingStatusId","OAGMP_RECEIVED");
  comiCtx.put("userLogin",userLogin);
  if (OagisServices.debugSaveXmlIn) {
    try {
      comiCtx.put("fullMessageXml",UtilXml.writeXmlDocument(doc));
    }
 catch (    IOException e) {
      String errMsg="Warning: error creating text from XML Document for saving to database: " + e.toString();
      Debug.logWarning(errMsg,module);
    }
  }
  try {
    if (isErrorRetry) {
      dispatcher.runSync("updateOagisMessageInfo",comiCtx,60,true);
    }
 else {
      dispatcher.runSync("createOagisMessageInfo",comiCtx,60,true);
    }
  }
 catch (  GenericServiceException e) {
    String errMsg="Error creating OagisMessageInfo for the Incoming Message: " + e.toString();
    Debug.logError(e,errMsg,module);
  }
  List dataAreaList=UtilXml.childElementList(syncInventoryRootElement,"ns:DATAAREA");
  if (UtilValidate.isNotEmpty(dataAreaList)) {
    Iterator dataAreaIter=dataAreaList.iterator();
    while (dataAreaIter.hasNext()) {
      Element dataAreaElement=(Element)dataAreaIter.next();
      Element syncInventoryElement=UtilXml.firstChildElement(dataAreaElement,"ns:SYNC_INVENTORY");
      Element inventoryElement=UtilXml.firstChildElement(syncInventoryElement,"ns:INVENTORY");
      Element quantityElement=UtilXml.firstChildElement(inventoryElement,"os:QUANTITY");
      String itemQtyStr=UtilXml.childElementValue(quantityElement,"of:VALUE");
      double itemQty=Double.parseDouble(itemQtyStr);
      String sign=UtilXml.childElementValue(quantityElement,"of:SIGN");
      String productId=UtilXml.childElementValue(inventoryElement,"of:ITEM");
      String itemStatus=UtilXml.childElementValue(inventoryElement,"of:ITEMSTATUS");
      try {
        GenericValue product=delegator.findByPrimaryKeyCache("Product",UtilMisc.toMap("productId",productId));
        if (product == null) {
          String errMsg="Product with ID [" + productId + "] not found (invalid Product ID).";
          errorMapList.add(UtilMisc.toMap("reasonCode","ProductIdNotValid","description",errMsg));
          Debug.logError(errMsg,module);
          continue;
        }
      }
 catch (      GenericEntityException e) {
        String errMsg="Error checking for valid Product ID: " + e.toString();
        errorMapList.add(UtilMisc.toMap("reasonCode","GenericEntityException","description",errMsg));
        Debug.logError(e,errMsg,module);
        continue;
      }
      boolean isAvailable=!"NOTAVAILABLE".equals(itemStatus);
      String statusId="INV_AVAILABLE";
      if (!isAvailable) {
        statusId="INV_ON_HOLD";
      }
      String snapshotDateStr=UtilXml.childElementValue(inventoryElement,"os:DATETIMEISO");
      Timestamp snapshotDate=OagisServices.parseIsoDateString(snapshotDateStr,errorMapList);
      double quantityOnHandTotal=0.0;
      if (isAvailable) {
        EntityCondition condition=new EntityConditionList(UtilMisc.toList(new EntityExpr("effectiveDate",EntityOperator.LESS_THAN_EQUAL_TO,snapshotDate),new EntityExpr("productId",EntityOperator.EQUALS,productId),new EntityExpr("inventoryItemTypeId",EntityOperator.EQUALS,"NON_SERIAL_INV_ITEM"),new EntityExpr("facilityId",EntityOperator.EQUALS,syncInventoryFacilityId)),EntityOperator.AND);
        try {
          List invItemAndDetails=delegator.findByCondition("InventoryItemDetailForSum",condition,UtilMisc.toList("quantityOnHandSum"),null);
          Iterator invItemAndDetailIter=invItemAndDetails.iterator();
          while (invItemAndDetailIter.hasNext()) {
            GenericValue inventoryItemDetailForSum=(GenericValue)invItemAndDetailIter.next();
            quantityOnHandTotal+=inventoryItemDetailForSum.getDouble("quantityOnHandSum").doubleValue();
          }
        }
 catch (        GenericEntityException e) {
          String errMsg="Error Getting Inventory Item And Detail: " + e.toString();
          errorMapList.add(UtilMisc.toMap("reasonCode","GenericEntityException","description",errMsg));
          Debug.logError(e,errMsg,module);
        }
      }
      EntityCondition serInvCondition=new EntityConditionList(UtilMisc.toList(new EntityExpr("statusDatetime",EntityOperator.LESS_THAN_EQUAL_TO,snapshotDate),new EntityExpr(new EntityExpr("statusEndDatetime",EntityOperator.GREATER_THAN,snapshotDate),EntityOperator.OR,new EntityExpr("statusEndDatetime",EntityOperator.EQUALS,null)),new EntityExpr("productId",EntityOperator.EQUALS,productId),new EntityExpr("statusId",EntityOperator.EQUALS,statusId),new EntityExpr("inventoryItemTypeId",EntityOperator.EQUALS,"SERIALIZED_INV_ITEM"),new EntityExpr("facilityId",EntityOperator.EQUALS,syncInventoryFacilityId)),EntityOperator.AND);
      try {
        long invItemQuantCount=delegator.findCountByCondition("InventoryItemStatusForCount",serInvCondition,null);
        quantityOnHandTotal+=invItemQuantCount;
      }
 catch (      GenericEntityException e) {
        String errMsg="Error Getting Inventory Item by Status Count: " + e.toString();
        errorMapList.add(UtilMisc.toMap("reasonCode","GenericEntityException","description",errMsg));
        Debug.logError(e,errMsg,module);
      }
      if (itemQty != quantityOnHandTotal) {
        double quantityDiff=Math.abs((itemQty - quantityOnHandTotal));
        inventoryMapList.add(UtilMisc.toMap("productId",productId,"statusId",statusId,"quantityOnHandTotal",String.valueOf(quantityOnHandTotal),"quantityFromMessage",itemQtyStr,"quantityDiff",String.valueOf(quantityDiff),"timestamp",snapshotDate));
      }
    }
  }
  if (inventoryMapList.size() > 0) {
    Map sendMap=FastMap.newInstance();
    String sendToEmail=UtilProperties.getPropertyValue("oagis.properties","oagis.notification.email.sendTo");
    if (UtilValidate.isNotEmpty(sendToEmail)) {
      String productStoreId=UtilProperties.getPropertyValue("oagis.properties","Oagis.Warehouse.SyncInventoryProductStoreId");
      GenericValue productStoreEmail=null;
      try {
        productStoreEmail=delegator.findByPrimaryKey("ProductStoreEmailSetting",UtilMisc.toMap("productStoreId",productStoreId,"emailType","PRDS_OAGIS_CONFIRM"));
      }
 catch (      GenericEntityException e) {
        String errMsg="Error Getting Entity ProductStoreEmailSetting: " + e.toString();
        errorMapList.add(UtilMisc.toMap("reasonCode","GenericEntityException","description",errMsg));
        Debug.logError(e,errMsg,module);
      }
      if (productStoreEmail != null) {
        String bodyScreenLocation=productStoreEmail.getString("bodyScreenLocation");
        sendMap.put("bodyScreenUri",bodyScreenLocation);
      }
 else {
        sendMap.put("bodyScreenUri","component://oagis/widget/EmailOagisMessageScreens.xml#InventoryMismatchNotice");
      }
      if (locale == null) {
        locale=Locale.getDefault();
      }
      sendMap.put("sendTo",sendToEmail);
      sendMap.put("subject",productStoreEmail.getString("subject"));
      sendMap.put("sendFrom",productStoreEmail.getString("fromAddress"));
      sendMap.put("sendCc",productStoreEmail.getString("ccAddress"));
      sendMap.put("sendBcc",productStoreEmail.getString("bccAddress"));
      sendMap.put("contentType",productStoreEmail.getString("contentType"));
      Map bodyParameters=UtilMisc.toMap("inventoryMapList",inventoryMapList,"locale",locale);
      sendMap.put("bodyParameters",bodyParameters);
      sendMap.put("userLogin",userLogin);
      try {
        dispatcher.runAsync("sendMailFromScreen",sendMap,true);
      }
 catch (      Exception e) {
        String errMsg="Error Running Service sendMailFromScreen: " + e.toString();
        errorMapList.add(UtilMisc.toMap("reasonCode","GenericServiceException","description",errMsg));
        Debug.logError(e,errMsg,module);
      }
    }
 else {
      Debug.logImportant("No sendTo email address found in process syncInventory service: inventoryMapList: " + inventoryMapList,module);
    }
  }
  Map result=FastMap.newInstance();
  result.put("logicalId",logicalId);
  result.put("component",component);
  result.put("task",task);
  result.put("referenceId",referenceId);
  result.put("userLogin",userLogin);
  if (errorMapList.size() > 0) {
    try {
      comiCtx.put("processingStatusId","OAGMP_PROC_ERROR");
      dispatcher.runSync("updateOagisMessageInfo",comiCtx,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
    Map saveErrorMapListCtx=FastMap.newInstance();
    saveErrorMapListCtx.put("logicalId",logicalId);
    saveErrorMapListCtx.put("component",component);
    saveErrorMapListCtx.put("task",task);
    saveErrorMapListCtx.put("referenceId",referenceId);
    saveErrorMapListCtx.put("errorMapList",errorMapList);
    try {
      dispatcher.runSync("createOagisMsgErrInfosFromErrMapList",saveErrorMapListCtx,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
    try {
      Map sendConfirmBodCtx=FastMap.newInstance();
      sendConfirmBodCtx.putAll(saveErrorMapListCtx);
      dispatcher.runAsync("oagisSendConfirmBod",sendConfirmBodCtx,null,true,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
    result.putAll(ServiceUtil.returnError("Errors found processing message; information saved and return error sent back"));
    return result;
  }
 else {
    try {
      comiCtx.put("processingStatusId","OAGMP_PROC_SUCCESS");
      dispatcher.runSync("updateOagisMessageInfo",comiCtx,60,true);
    }
 catch (    GenericServiceException e) {
      String errMsg="Error updating OagisMessageInfo for the Incoming Message: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
  }
  result.putAll(ServiceUtil.returnSuccess("Service Completed Successfully"));
  return result;
}
