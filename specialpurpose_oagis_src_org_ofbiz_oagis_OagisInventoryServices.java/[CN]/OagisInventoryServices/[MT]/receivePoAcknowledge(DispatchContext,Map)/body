{
  Document doc=(Document)context.get("document");
  GenericValue userLogin=(GenericValue)context.get("userLogin");
  LocalDispatcher dispatcher=ctx.getDispatcher();
  GenericDelegator delegator=ctx.getDelegator();
  List errorMapList=FastList.newInstance();
  Map comiCtx=FastMap.newInstance();
  if (userLogin == null) {
    try {
      userLogin=delegator.findByPrimaryKey("UserLogin",UtilMisc.toMap("userLoginId","system"));
    }
 catch (    GenericEntityException e) {
      String errMsg="Error Getting UserLogin: " + e.toString();
      Debug.logError(e,errMsg,module);
    }
  }
  Element receivePoElement=doc.getDocumentElement();
  receivePoElement.normalize();
  Element docCtrlAreaElement=UtilXml.firstChildElement(receivePoElement,"os:CNTROLAREA");
  Element docSenderElement=UtilXml.firstChildElement(docCtrlAreaElement,"os:SENDER");
  Element docBsrElement=UtilXml.firstChildElement(docCtrlAreaElement,"os:BSR");
  String bsrVerb=UtilXml.childElementValue(docBsrElement,"of:VERB");
  String bsrNoun=UtilXml.childElementValue(docBsrElement,"of:NOUN");
  String bsrRevision=UtilXml.childElementValue(docBsrElement,"of:REVISION");
  String logicalId=UtilXml.childElementValue(docSenderElement,"of:LOGICALID");
  String component=UtilXml.childElementValue(docSenderElement,"of:COMPONENT");
  String task=UtilXml.childElementValue(docSenderElement,"of:TASK");
  String referenceId=UtilXml.childElementValue(docSenderElement,"of:REFERENCEID");
  String confirmation=UtilXml.childElementValue(docSenderElement,"of:CONFIRMATION");
  String authId=UtilXml.childElementValue(docSenderElement,"of:AUTHID");
  Element dataAreaElement=UtilXml.firstChildElement(receivePoElement,"n:DATAAREA");
  Element acknowledgeDeliveryElement=UtilXml.firstChildElement(dataAreaElement,"n:ACKNOWLEDGE_DELIVERY");
  String facilityId=UtilProperties.getPropertyValue("oagis.properties","Oagis.Warehouse.PoReceiptFacilityId");
  String productId=null;
  List acknowledgeElementList=UtilXml.childElementList(acknowledgeDeliveryElement,"n:RECEIPTLN");
  if (UtilValidate.isNotEmpty(acknowledgeElementList)) {
    Iterator acknowledgeElementIter=acknowledgeElementList.iterator();
    while (acknowledgeElementIter.hasNext()) {
      Map ripCtx=FastMap.newInstance();
      Element receiptLnElement=(Element)acknowledgeElementIter.next();
      Element qtyElement=UtilXml.firstChildElement(receiptLnElement,"os:QUANTITY");
      String itemQtyStr=UtilXml.childElementValue(qtyElement,"of:VALUE");
      double itemQty=Double.parseDouble(itemQtyStr);
      String sign=UtilXml.childElementValue(qtyElement,"of:SIGN");
      productId=UtilXml.childElementValue(receiptLnElement,"of:ITEM");
      Element documentRefElement=UtilXml.firstChildElement(receiptLnElement,"os:DOCUMNTREF");
      String orderId=UtilXml.childElementValue(documentRefElement,"of:DOCUMENTID");
      String orderTypeId=UtilXml.childElementValue(documentRefElement,"of:DOCTYPE");
      if (orderTypeId.equals("PO")) {
        orderTypeId="PURCHASE_ORDER";
      }
      String datetimeReceived=UtilXml.childElementValue(receiptLnElement,"os:DATETIMEISO");
      SimpleDateFormat sdf=new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSS'Z'Z");
      Timestamp timestamp=null;
      try {
        timestamp=new Timestamp(sdf.parse(datetimeReceived).getTime());
        ripCtx.put("datetimeReceived",timestamp);
      }
 catch (      ParseException e) {
        String errMsg="Error parsing Date: " + e.toString();
        errorMapList.add(UtilMisc.toMap("reasonCode","ParseException","description",errMsg));
        Debug.logError(e,errMsg,module);
      }
      GenericValue orderHeader=null;
      if (orderId != null) {
        try {
          List toStore=FastList.newInstance();
          orderHeader=delegator.findByPrimaryKey("OrderHeader",UtilMisc.toMap("orderId",orderId));
          if (orderHeader != null) {
            ripCtx.put("orderId",orderId);
            comiCtx.put("orderId",orderId);
            GenericValue orderItem=delegator.makeValue("OrderItem",UtilMisc.toMap("orderId",orderId,"productId",productId,"quantity",new Double(itemQtyStr)));
            delegator.setNextSubSeqId(orderItem,"orderItemSeqId",5,1);
            delegator.create(orderItem);
            ripCtx.put("orderItemSeqId",orderItem.get("orderItemSeqId"));
          }
 else {
            orderHeader=delegator.makeValue("OrderHeader",UtilMisc.toMap("orderId",orderId,"orderTypeId",orderTypeId,"orderDate",timestamp,"statusId","ORDER_CREATED","entryDate",UtilDateTime.nowTimestamp(),"productStoreId",UtilProperties.getPropertyValue("oagis.properties","Oagis.Warehouse.SyncInventoryProductStoreId","9001")));
            toStore.add(orderHeader);
            GenericValue orderItem=delegator.makeValue("OrderItem",UtilMisc.toMap("orderId",orderId,"orderItemSeqId",UtilFormatOut.formatPaddedNumber(1L,5),"productId",productId,"quantity",new Double(itemQtyStr)));
            toStore.add(orderItem);
            delegator.storeAll(toStore);
          }
        }
 catch (        GenericEntityException e) {
          String errMsg="Error Getting OrderHeader: " + e.toString();
          errorMapList.add(UtilMisc.toMap("reasonCode","GenericEntityException","description",errMsg));
          Debug.logError(e,errMsg,module);
        }
      }
      String invItemStatus=UtilXml.childElementValue(receiptLnElement,"of:DISPOSITN");
      if (invItemStatus.equals("ReceivedTOAvailable") || invItemStatus.equals("NotAvailableTOAvailable")) {
        ripCtx.put("statusId","INV_AVAILABLE");
      }
 else       if (invItemStatus.equals("ReceivedTONotAvailable") || invItemStatus.equals("AvailableTONotAvailable")) {
        ripCtx.put("statusId","INV_ON_HOLD");
      }
      ripCtx.put("inventoryItemTypeId","NON_SERIAL_INV_ITEM");
      ripCtx.put("productId",productId);
      ripCtx.put("facilityId",facilityId);
      ripCtx.put("userLogin",userLogin);
      double quantityAccepted=0.0;
      double quantityRejected=0.0;
      if (sign.equals("+")) {
        quantityAccepted=itemQty;
        quantityRejected=0.0;
      }
 else {
        quantityRejected=itemQty;
        quantityAccepted=0.0;
      }
      ripCtx.put("quantityAccepted",new Double(quantityAccepted));
      ripCtx.put("quantityRejected",new Double(quantityRejected));
      try {
        Map ripResult=dispatcher.runSync("receiveInventoryProduct",ripCtx);
        if (ServiceUtil.isError(ripResult)) {
          String errMsg=ServiceUtil.getErrorMessage(ripResult);
          errorMapList.add(UtilMisc.toMap("reasonCode","ReceiveInventoryServiceError","description",errMsg));
        }
      }
 catch (      GenericServiceException e) {
        String errMsg="Error running service receiveInventoryProduct: " + e.toString();
        errorMapList.add(UtilMisc.toMap("reasonCode","GenericServiceException","description",errMsg));
        Debug.logError(e,errMsg,module);
      }
    }
  }
  Timestamp timestamp=null;
  timestamp=UtilDateTime.nowTimestamp();
  comiCtx.put("logicalId",logicalId);
  comiCtx.put("authId",authId);
  comiCtx.put("referenceId",referenceId);
  comiCtx.put("receivedDate",timestamp);
  comiCtx.put("component",component);
  comiCtx.put("task",task);
  comiCtx.put("outgoingMessage","N");
  comiCtx.put("confirmation",confirmation);
  comiCtx.put("bsrVerb",bsrVerb);
  comiCtx.put("bsrNoun",bsrNoun);
  comiCtx.put("bsrRevision",bsrRevision);
  comiCtx.put("userLogin",userLogin);
  try {
    Map comiResult=dispatcher.runSync("createOagisMessageInfo",comiCtx);
    if (ServiceUtil.isError(comiResult)) {
      String errMsg=ServiceUtil.getErrorMessage(comiResult);
      errorMapList.add(UtilMisc.toMap("reasonCode","CreateOagisMessageServiceError","description",errMsg));
    }
  }
 catch (  GenericServiceException e) {
    String errMsg="Error creating OagisMessageInfo for the Incoming Message: " + e.toString();
    errorMapList.add(UtilMisc.toMap("reasonCode","CreateOagisMessageInfoError","description",errMsg));
    Debug.logError(e,errMsg,module);
  }
  Map result=FastMap.newInstance();
  result.put("logicalId",logicalId);
  result.put("component",component);
  result.put("task",task);
  result.put("referenceId",referenceId);
  result.put("userLogin",userLogin);
  if (errorMapList.size() > 0) {
    result.put("errorMapList",errorMapList);
    String errMsg="Error Processing Received Messages";
    result.putAll(ServiceUtil.returnError(errMsg));
    return result;
  }
  result.putAll(ServiceUtil.returnSuccess("Action Performed Successfully"));
  return result;
}
