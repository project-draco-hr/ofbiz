{
  List surveys=new LinkedList();
  List storeSurveys=null;
  try {
    storeSurveys=delegator.findByAndCache("ProductStoreSurveyAppl",UtilMisc.toMap("productStoreId",productStoreId,"surveyApplTypeId",surveyApplTypeId),UtilMisc.toList("sequenceNum"));
  }
 catch (  GenericEntityException e) {
    Debug.logError(e,"Unable to get ProductStoreSurveyAppl for store : " + productStoreId,module);
    return surveys;
  }
  storeSurveys=EntityUtil.filterByDate(storeSurveys);
  if (!UtilValidate.isEmpty(groupName)) {
    storeSurveys=EntityUtil.filterByAnd(storeSurveys,UtilMisc.toMap("groupName",groupName));
  }
  Debug.log("getSurvey for product " + productId,module);
  if (!UtilValidate.isEmpty(productId) && !UtilValidate.isEmpty(storeSurveys)) {
    Iterator ssi=storeSurveys.iterator();
    while (ssi.hasNext()) {
      GenericValue surveyAppl=(GenericValue)ssi.next();
      GenericValue product=null;
      String virtualProductId=null;
      try {
        product=delegator.findByPrimaryKeyCache("Product",UtilMisc.toMap("productId",productId));
        if ((product != null) && ("Y".equals(product.get("isVariant")))) {
          if (parentProductId != null)           virtualProductId=parentProductId;
 else           virtualProductId=ProductWorker.getVariantVirtualId(product);
          Debug.log("getSurvey for virtual product " + virtualProductId,module);
        }
      }
 catch (      GenericEntityException e) {
        Debug.logError(e,"Problem finding product from productId " + productId,module);
      }
      if (surveyAppl.get("productId") != null) {
        if (surveyAppl.get("productId").equals(productId)) {
          surveys.add(surveyAppl);
        }
 else         if ((virtualProductId != null) && (surveyAppl.getString("productId").equals(virtualProductId))) {
          surveys.add(surveyAppl);
        }
      }
 else       if (surveyAppl.get("productCategoryId") != null) {
        List categoryMembers=null;
        try {
          categoryMembers=delegator.findByAnd("ProductCategoryMember",UtilMisc.toMap("productCategoryId",surveyAppl.get("productCategoryId")));
        }
 catch (        GenericEntityException e) {
          Debug.logError(e,"Unable to get ProductCategoryMemebr records for survey application : " + surveyAppl,module);
        }
        if (categoryMembers != null) {
          Iterator cmi=categoryMembers.iterator();
          while (cmi.hasNext()) {
            GenericValue member=(GenericValue)cmi.next();
            if (productId != null && productId.equals(member.getString("productId"))) {
              surveys.add(surveyAppl);
              break;
            }
 else             if ((virtualProductId != null) && (virtualProductId.equals(member.getString("productId")))) {
              surveys.add(surveyAppl);
              break;
            }
          }
        }
      }
    }
  }
 else   if (storeSurveys != null) {
    surveys.addAll(storeSurveys);
  }
  return surveys;
}
