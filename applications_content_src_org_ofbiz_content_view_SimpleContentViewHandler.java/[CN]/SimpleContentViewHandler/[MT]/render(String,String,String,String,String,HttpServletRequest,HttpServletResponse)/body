{
  String contentId=request.getParameter("contentId");
  String rootContentId=request.getParameter("rootContentId");
  String mapKey=request.getParameter("mapKey");
  String contentAssocTypeId=request.getParameter("contentAssocTypeId");
  String fromDateStr=request.getParameter("fromDate");
  String dataResourceId=request.getParameter("dataResourceId");
  String contentRevisionSeqId=request.getParameter("contentRevisionSeqId");
  String mimeTypeId=request.getParameter("mimeTypeId");
  Locale locale=UtilHttp.getLocale(request);
  String rootDir=null;
  String webSiteId=null;
  String https=null;
  if (UtilValidate.isEmpty(rootDir)) {
    rootDir=servletContext.getRealPath("/");
  }
  if (UtilValidate.isEmpty(webSiteId)) {
    webSiteId=(String)servletContext.getAttribute("webSiteId");
  }
  if (UtilValidate.isEmpty(https)) {
    https=(String)servletContext.getAttribute("https");
  }
  try {
    if (Debug.verboseOn())     Debug.logVerbose("SCVH(0a)- dataResourceId:" + dataResourceId,module);
    Delegator delegator=(Delegator)request.getAttribute("delegator");
    if (UtilValidate.isEmpty(dataResourceId)) {
      if (UtilValidate.isEmpty(contentRevisionSeqId)) {
        if (UtilValidate.isEmpty(mapKey) && UtilValidate.isEmpty(contentAssocTypeId)) {
          GenericValue content=delegator.findByPrimaryKeyCache("Content",UtilMisc.toMap("contentId",contentId));
          dataResourceId=content.getString("dataResourceId");
          if (Debug.verboseOn())           Debug.logVerbose("SCVH(0b)- dataResourceId:" + dataResourceId,module);
        }
 else {
          Timestamp fromDate=null;
          if (UtilValidate.isNotEmpty(fromDateStr)) {
            try {
              fromDate=UtilDateTime.stringToTimeStamp(fromDateStr,null,locale);
            }
 catch (            ParseException e) {
              fromDate=UtilDateTime.nowTimestamp();
            }
          }
          List<String> assocList=null;
          if (UtilValidate.isNotEmpty(contentAssocTypeId)) {
            assocList=UtilMisc.toList(contentAssocTypeId);
          }
          GenericValue content=ContentWorker.getSubContent(delegator,contentId,mapKey,null,null,assocList,fromDate);
          dataResourceId=content.getString("dataResourceId");
          if (Debug.verboseOn())           Debug.logVerbose("SCVH(0b)- dataResourceId:" + dataResourceId,module);
        }
      }
 else {
        GenericValue contentRevisionItem=delegator.findByPrimaryKeyCache("ContentRevisionItem",UtilMisc.toMap("contentId",rootContentId,"itemContentId",contentId,"contentRevisionSeqId",contentRevisionSeqId));
        if (contentRevisionItem == null) {
          throw new ViewHandlerException("ContentRevisionItem record not found for contentId=" + rootContentId + ", contentRevisionSeqId="+ contentRevisionSeqId+ ", itemContentId="+ contentId);
        }
        dataResourceId=contentRevisionItem.getString("newDataResourceId");
        if (Debug.verboseOn())         Debug.logVerbose("SCVH(1)- contentRevisionItem:" + contentRevisionItem,module);
        if (Debug.verboseOn())         Debug.logVerbose("SCVH(2)-contentId=" + rootContentId + ", contentRevisionSeqId="+ contentRevisionSeqId+ ", itemContentId="+ contentId,module);
        if (Debug.verboseOn())         Debug.logVerbose("SCVH(3)- dataResourceId:" + dataResourceId,module);
      }
    }
    GenericValue dataResource=delegator.findByPrimaryKeyCache("DataResource",UtilMisc.toMap("dataResourceId",dataResourceId));
    ByteBuffer byteBuffer=DataResourceWorker.getContentAsByteBuffer(delegator,dataResourceId,https,webSiteId,locale,rootDir);
    ByteArrayInputStream bais=new ByteArrayInputStream(byteBuffer.array());
    String charset=dataResource.getString("characterSetId");
    mimeTypeId=dataResource.getString("mimeTypeId");
    if (UtilValidate.isEmpty(charset)) {
      charset=servletContext.getInitParameter("charset");
    }
    if (UtilValidate.isEmpty(charset)) {
      charset="UTF-8";
    }
    String contentType2=UtilValidate.isNotEmpty(mimeTypeId) ? mimeTypeId + "; charset=" + charset : contentType;
    String fileName=null;
    if (!UtilValidate.isEmpty(dataResource.getString("dataResourceName"))) {
      fileName=dataResource.getString("dataResourceName").replace(" ","_");
    }
    UtilHttp.streamContentToBrowser(response,bais,byteBuffer.limit(),contentType2,fileName);
  }
 catch (  GenericEntityException e) {
    throw new ViewHandlerException(e.getMessage());
  }
catch (  IOException e) {
    throw new ViewHandlerException(e.getMessage());
  }
catch (  GeneralException e) {
    throw new ViewHandlerException(e.getMessage());
  }
}
