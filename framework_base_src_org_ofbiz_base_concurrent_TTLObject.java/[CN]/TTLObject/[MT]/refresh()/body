{
  ValueAndState<T> container;
  ValueAndState<T> nextContainer=null;
  do {
    container=getContainer();
    if (container.state == State.INVALID) {
      nextContainer=container.refresh(State.GENERATE);
    }
 else     if (container.state == State.REGENERATING) {
      nextContainer=container.refresh(State.REGEN);
    }
 else     if (container.state == State.GENERATING) {
      nextContainer=container.refresh(State.GENERATE);
    }
 else     if (container.state == State.ERROR_INITIAL) {
      nextContainer=container.refresh(State.INVALID);
    }
 else     if (container.state == State.ERROR || container.state == State.VALID) {
      nextContainer=container.refresh(getForeground() ? State.GENERATE : State.REGEN);
    }
 else     if (container.state == State.SET) {
      nextContainer=container.refresh(getForeground() ? State.GENERATE : State.REGEN);
    }
 else {
      return;
    }
    objectAccessor.compareAndSet(this,container,nextContainer);
    cancelFuture(container);
  }
 while (true);
}
