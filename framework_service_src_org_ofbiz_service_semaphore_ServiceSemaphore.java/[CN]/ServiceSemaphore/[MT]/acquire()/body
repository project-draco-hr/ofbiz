{
  if (mode == SEMAPHORE_MODE_NONE)   return;
  String threadName=Thread.currentThread().getName();
  Timestamp lockTime=UtilDateTime.nowTimestamp();
  GenericValue semaphore;
  try {
    semaphore=delegator.findByPrimaryKey("ServiceSemaphore",UtilMisc.toMap("serviceName",model.name));
  }
 catch (  GenericEntityException e) {
    throw new SemaphoreFailException(e);
  }
  if (semaphore == null) {
    Map fields=UtilMisc.toMap("serviceName",model.name,"lockThread",threadName,"lockTime",lockTime);
    semaphore=delegator.makeValue("ServiceSemaphore",fields);
    dbWrite(semaphore,false);
  }
 else {
    waitOrFail(mode);
  }
}
