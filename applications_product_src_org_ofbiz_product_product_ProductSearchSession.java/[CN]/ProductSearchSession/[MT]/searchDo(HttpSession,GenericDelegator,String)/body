{
  String visitId=VisitHandler.getVisitId(session);
  ProductSearchOptions productSearchOptions=getProductSearchOptions(session);
  List productSearchConstraintList=productSearchOptions.getConstraintList();
  if (productSearchConstraintList == null || productSearchConstraintList.size() == 0) {
    return new ArrayList();
  }
  productSearchConstraintList=ensureViewAllowConstraint(productSearchConstraintList,prodCatalogId,delegator);
  ResultSortOrder resultSortOrder=productSearchOptions.getResultSortOrder();
  checkSaveSearchOptionsHistory(session);
  return ProductSearch.searchProducts(productSearchConstraintList,resultSortOrder,delegator,visitId);
}
