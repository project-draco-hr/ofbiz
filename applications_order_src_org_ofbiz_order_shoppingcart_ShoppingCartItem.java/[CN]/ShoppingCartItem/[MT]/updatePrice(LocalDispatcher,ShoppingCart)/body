{
  if (_product != null && isModifiedPrice == false) {
    try {
      Map priceContext=FastMap.newInstance();
      priceContext.put("currencyUomId",cart.getCurrency());
      String partyId=cart.getPartyId();
      if (partyId != null) {
        priceContext.put("partyId",partyId);
      }
      priceContext.put("quantity",new Double(this.getQuantity()));
      priceContext.put("amount",new Double(this.getSelectedAmount()));
      priceContext.put("product",this.getProduct());
      if (cart.getOrderType().equals("PURCHASE_ORDER")) {
        Map priceResult=dispatcher.runSync("calculatePurchasePrice",priceContext);
        if (ServiceUtil.isError(priceResult)) {
          throw new CartItemModifyException("There was an error while calculating the price: " + ServiceUtil.getErrorMessage(priceResult));
        }
        Boolean validPriceFound=(Boolean)priceResult.get("validPriceFound");
        if (!validPriceFound.booleanValue()) {
          throw new CartItemModifyException("Could not find a valid price for the product with ID [" + this.getProductId() + "] and supplier with ID ["+ partyId+ "], not adding to cart.");
        }
        this.setBasePrice(((Double)priceResult.get("price")).doubleValue());
        this.setDisplayPrice(this.basePrice);
        this.orderItemPriceInfos=(List)priceResult.get("orderItemPriceInfos");
      }
 else {
        if (productId != null) {
          String productStoreId=cart.getProductStoreId();
          List productSurvey=ProductStoreWorker.getProductSurveys(delegator,productStoreId,productId,"CART_ADD",parentProductId);
          if (UtilValidate.isNotEmpty(productSurvey) && UtilValidate.isNotEmpty(attributes)) {
            List surveyResponses=(List)attributes.get("surveyResponses");
            if (UtilValidate.isNotEmpty(surveyResponses)) {
              Iterator surveyItr=surveyResponses.iterator();
              while (surveyItr.hasNext()) {
                String surveyResponseId=(String)surveyItr.next();
                if (UtilValidate.isNotEmpty(surveyResponseId)) {
                  priceContext.put("surveyResponseId",surveyResponseId);
                  break;
                }
              }
            }
          }
        }
        priceContext.put("prodCatalogId",this.getProdCatalogId());
        priceContext.put("webSiteId",cart.getWebSiteId());
        priceContext.put("productStoreId",cart.getProductStoreId());
        priceContext.put("agreementId",cart.getAgreementId());
        priceContext.put("productPricePurposeId","PURCHASE");
        priceContext.put("checkIncludeVat","Y");
        Map priceResult=dispatcher.runSync("calculateProductPrice",priceContext);
        if (ServiceUtil.isError(priceResult)) {
          throw new CartItemModifyException("There was an error while calculating the price: " + ServiceUtil.getErrorMessage(priceResult));
        }
        Boolean validPriceFound=(Boolean)priceResult.get("validPriceFound");
        if (Boolean.FALSE.equals(validPriceFound)) {
          throw new CartItemModifyException("Could not find a valid price for the product with ID [" + this.getProductId() + "], not adding to cart.");
        }
        if (priceResult.get("listPrice") != null) {
          this.listPrice=((Double)priceResult.get("listPrice")).doubleValue();
        }
        if (priceResult.get("basePrice") != null) {
          this.setBasePrice(((Double)priceResult.get("basePrice")).doubleValue());
        }
        if (priceResult.get("price") != null) {
          this.setDisplayPrice(((Double)priceResult.get("price")).doubleValue());
        }
        this.setSpecialPromoPrice((Double)priceResult.get("specialPromoPrice"));
        this.orderItemPriceInfos=(List)priceResult.get("orderItemPriceInfos");
        if (configWrapper != null) {
          this.setBasePrice(configWrapper.getTotalPrice());
          this.setDisplayPrice(configWrapper.getTotalPrice());
        }
        Map recurringPriceContext=FastMap.newInstance();
        recurringPriceContext.putAll(priceContext);
        recurringPriceContext.put("productPricePurposeId","RECURRING_CHARGE");
        Map recurringPriceResult=dispatcher.runSync("calculateProductPrice",recurringPriceContext);
        if (ServiceUtil.isError(recurringPriceResult)) {
          throw new CartItemModifyException("There was an error while calculating the price: " + ServiceUtil.getErrorMessage(recurringPriceResult));
        }
        Boolean validRecurringPriceFound=(Boolean)recurringPriceResult.get("validPriceFound");
        if (Boolean.TRUE.equals(validRecurringPriceFound)) {
          if (recurringPriceResult.get("basePrice") != null) {
            this.setRecurringBasePrice((Double)recurringPriceResult.get("basePrice"));
          }
          if (recurringPriceResult.get("price") != null) {
            this.setRecurringDisplayPrice((Double)recurringPriceResult.get("price"));
          }
        }
      }
    }
 catch (    GenericServiceException e) {
      throw new CartItemModifyException("There was an error while calculating the price",e);
    }
  }
}
