{
  if (this.quantity == quantity) {
    return;
  }
  if (this.isPromo) {
    throw new CartItemModifyException("Sorry, you can't change the quantity on the promotion item " + this.getName() + " (product ID: "+ productId+ "), not setting quantity.");
  }
  String productStoreId=cart.getProductStoreId();
  if (!"PURCHASE_ORDER".equals(cart.getOrderType())) {
    if (_product != null && quantity > this.quantity) {
      try {
        Map invReqResult=dispatcher.runSync("isStoreInventoryAvailableOrNotRequired",UtilMisc.toMap("productStoreId",productStoreId,"productId",productId,"product",this.getProduct(),"quantity",new Double(quantity)));
        if (ServiceUtil.isError(invReqResult)) {
          Debug.logError("Error calling isStoreInventoryAvailableOrNotRequired service, result is: " + invReqResult,module);
          throw new CartItemModifyException((String)invReqResult.get(ModelService.ERROR_MESSAGE));
        }
 else         if (!"Y".equals((String)invReqResult.get("availableOrNotRequired"))) {
          String excMsg="Sorry, we do not have enough (you tried " + UtilFormatOut.formatQuantity(quantity) + ") of the product "+ this.getName()+ " (product ID: "+ productId+ ") in stock, not adding to cart. Please try a lower quantity, try again later, or call customer service for more information.";
          Debug.logWarning(excMsg,module);
          throw new CartItemModifyException(excMsg);
        }
      }
 catch (      GenericServiceException e) {
        String errMsg="Fatal error calling inventory checking services: " + e.toString();
        Debug.logError(e,errMsg,module);
        throw new CartItemModifyException(errMsg);
      }
    }
  }
  this.quantity=quantity;
  if (updateProductPrice) {
    this.updatePrice(dispatcher,cart);
  }
  if (triggerExternalOps) {
    ProductPromoWorker.doPromotions(cart,dispatcher);
  }
  if (!"PURCHASE_ORDER".equals(cart.getOrderType())) {
    if (triggerExternalOps && ProductStoreWorker.autoSaveCart(delegator,productStoreId)) {
      try {
        ShoppingListEvents.fillAutoSaveList(cart,dispatcher);
      }
 catch (      GeneralException e) {
        Debug.logWarning(e,UtilProperties.getMessage(resource_error,"OrderUnableToStoreAutoSaveCart",locale));
      }
    }
  }
  if (resetShipGroup) {
    cart.clearItemShipInfo(this);
    int shipGroupIndex=-1;
    if ("PURCHASE_ORDER".equals(cart.getOrderType())) {
      shipGroupIndex=0;
    }
 else {
      if (_product != null && "PRODRQM_DS".equals(_product.getString("requirementMethodEnumId"))) {
        Map supplierProductsResult=null;
        try {
          supplierProductsResult=dispatcher.runSync("getSuppliersForProduct",UtilMisc.toMap("productId",_product.getString("productId"),"quantity",new Double(quantity),"currencyUomId",cart.getCurrency(),"canDropShip","Y","userLogin",cart.getUserLogin()));
          List productSuppliers=(List)supplierProductsResult.get("supplierProducts");
          GenericValue supplierProduct=EntityUtil.getFirst(productSuppliers);
          if (supplierProduct != null) {
            String supplierPartyId=supplierProduct.getString("partyId");
            List shipGroups=cart.getShipGroups();
            for (int i=0; i < shipGroups.size(); i++) {
              ShoppingCart.CartShipInfo csi=(ShoppingCart.CartShipInfo)shipGroups.get(i);
              if (supplierPartyId.equals(csi.getSupplierPartyId())) {
                shipGroupIndex=i;
                break;
              }
            }
            if (shipGroupIndex == -1) {
              shipGroupIndex=cart.addShipInfo();
              cart.setSupplierPartyId(shipGroupIndex,supplierPartyId);
            }
          }
        }
 catch (        Exception e) {
          Debug.logWarning("Error calling getSuppliersForProduct service, result is: " + supplierProductsResult,module);
        }
      }
      if (shipGroupIndex == -1) {
        List shipGroups=cart.getShipGroups();
        for (int i=0; i < shipGroups.size(); i++) {
          ShoppingCart.CartShipInfo csi=(ShoppingCart.CartShipInfo)shipGroups.get(i);
          if (csi.getSupplierPartyId() == null) {
            shipGroupIndex=i;
            break;
          }
        }
        if (shipGroupIndex == -1) {
          shipGroupIndex=cart.addShipInfo();
        }
      }
    }
    cart.setItemShipGroupQty(this,quantity,shipGroupIndex);
  }
}
