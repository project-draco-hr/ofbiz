{
  if (this.quantity == quantity) {
    return;
  }
  if (this.isPromo) {
    throw new CartItemModifyException("Sorry, you can't change the quantity on the promotion item " + this.getName() + " (product ID: "+ productId+ "), not setting quantity.");
  }
  String productStoreId=cart.getProductStoreId();
  if (!"PURCHASE_ORDER".equals(cart.getOrderType())) {
    if (_product != null && quantity > this.quantity) {
      try {
        Map invReqResult=dispatcher.runSync("isStoreInventoryAvailableOrNotRequired",UtilMisc.toMap("productStoreId",productStoreId,"productId",productId,"product",this.getProduct(),"quantity",new Double(quantity)));
        if (ServiceUtil.isError(invReqResult)) {
          Debug.logError("Error calling isStoreInventoryAvailableOrNotRequired service, result is: " + invReqResult,module);
          throw new CartItemModifyException((String)invReqResult.get(ModelService.ERROR_MESSAGE));
        }
 else         if (!"Y".equals((String)invReqResult.get("availableOrNotRequired"))) {
          String excMsg="Sorry, we do not have enough (you tried " + UtilFormatOut.formatQuantity(quantity) + ") of the product "+ this.getName()+ " (product ID: "+ productId+ ") in stock, not adding to cart. Please try a lower quantity, try again later, or call customer service for more information.";
          Debug.logWarning(excMsg,module);
          throw new CartItemModifyException(excMsg);
        }
      }
 catch (      GenericServiceException e) {
        String errMsg="Fatal error calling inventory checking services: " + e.toString();
        Debug.logError(e,errMsg,module);
        throw new CartItemModifyException(errMsg);
      }
    }
  }
  this.quantity=quantity;
  if (updateProductPrice) {
    this.updatePrice(dispatcher,cart);
  }
  if (triggerExternalOps) {
    ProductPromoWorker.doPromotions(cart,dispatcher);
  }
  if (!"PURCHASE_ORDER".equals(cart.getOrderType())) {
    if (triggerExternalOps && ProductStoreWorker.autoSaveCart(delegator,productStoreId)) {
      try {
        ShoppingListEvents.fillAutoSaveList(cart,dispatcher);
      }
 catch (      GeneralException e) {
        Debug.logWarning(e,UtilProperties.getMessage(resource_error,"OrderUnableToStoreAutoSaveCart",locale));
      }
    }
  }
  if (resetShipGroup) {
    cart.clearItemShipInfo(this);
    cart.setItemShipGroupQty(this,quantity,0);
  }
}
