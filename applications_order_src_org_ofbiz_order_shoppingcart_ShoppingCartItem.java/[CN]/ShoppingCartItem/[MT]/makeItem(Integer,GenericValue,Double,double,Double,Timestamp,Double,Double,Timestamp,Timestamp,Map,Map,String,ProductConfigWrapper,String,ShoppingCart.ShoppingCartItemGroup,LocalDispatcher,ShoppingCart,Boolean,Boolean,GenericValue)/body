{
  ShoppingCartItem newItem=new ShoppingCartItem(product,additionalProductFeatureAndAppls,attributes,prodCatalogId,configWrapper,cart.getLocale(),itemType,itemGroup,parentProduct);
  double selectedAmount=selectedAmountDbl == null ? 0.0 : selectedAmountDbl.doubleValue();
  double unitPrice=unitPriceDbl == null ? 0.0 : unitPriceDbl.doubleValue();
  double reservLength=reservLengthDbl == null ? 0.0 : reservLengthDbl.doubleValue();
  double reservPersons=reservPersonsDbl == null ? 0.0 : reservPersonsDbl.doubleValue();
  boolean triggerPriceRules=triggerPriceRulesBool == null ? true : triggerPriceRulesBool.booleanValue();
  boolean triggerExternalOps=triggerExternalOpsBool == null ? true : triggerExternalOpsBool.booleanValue();
  if ("Y".equals(product.getString("isVirtual"))) {
    Map messageMap=UtilMisc.toMap("productName",product.getString("productName"),"productId",product.getString("productId"));
    String excMsg=UtilProperties.getMessage(resource,"item.cannot_add_product_virtual",messageMap,cart.getLocale());
    Debug.logWarning(excMsg,module);
    throw new CartItemModifyException(excMsg);
  }
  java.sql.Timestamp nowTimestamp=UtilDateTime.nowTimestamp();
  if (product.get("introductionDate") != null && nowTimestamp.before(product.getTimestamp("introductionDate"))) {
    Map messageMap=UtilMisc.toMap("productName",product.getString("productName"),"productId",product.getString("productId"));
    String excMsg=UtilProperties.getMessage(resource,"item.cannot_add_product_not_yet_available",messageMap,cart.getLocale());
    Debug.logWarning(excMsg,module);
    throw new CartItemModifyException(excMsg);
  }
  if (product.get("salesDiscontinuationDate") != null && nowTimestamp.after(product.getTimestamp("salesDiscontinuationDate"))) {
    Map messageMap=UtilMisc.toMap("productName",product.getString("productName"),"productId",product.getString("productId"));
    String excMsg=UtilProperties.getMessage(resource,"item.cannot_add_product_no_longer_available",messageMap,cart.getLocale());
    Debug.logWarning(excMsg,module);
    throw new CartItemModifyException(excMsg);
  }
  if ("ASSET_USAGE".equals(product.getString("productTypeId"))) {
    if (reservStart == null) {
      String excMsg=UtilProperties.getMessage(resource,"item.missing_reservation_starting_date",cart.getLocale());
      throw new CartItemModifyException(excMsg);
    }
    if (reservStart.before(UtilDateTime.nowTimestamp())) {
      String excMsg=UtilProperties.getMessage(resource,"item.reservation_from_tomorrow",cart.getLocale());
      throw new CartItemModifyException(excMsg);
    }
    newItem.setReservStart(reservStart);
    if (reservLength < 1) {
      String excMsg=UtilProperties.getMessage(resource,"item.number_of_days",cart.getLocale());
      throw new CartItemModifyException(excMsg);
    }
    newItem.setReservLength(reservLength);
    if (product.get("reservMaxPersons") != null) {
      double reservMaxPersons=product.getDouble("reservMaxPersons").doubleValue();
      if (reservMaxPersons < reservPersons) {
        Map messageMap=UtilMisc.toMap("reservMaxPersons",product.getString("reservMaxPersons"),"reservPersons",(new Double(reservPersons)).toString());
        String excMsg=UtilProperties.getMessage(resource,"item.maximum_number_of_person_renting",messageMap,cart.getLocale());
        Debug.logInfo(excMsg,module);
        throw new CartItemModifyException(excMsg);
      }
    }
    newItem.setReservPersons(reservPersons);
    if (product.get("reserv2ndPPPerc") != null)     newItem.setReserv2ndPPPerc(product.getDouble("reserv2ndPPPerc").doubleValue());
    if (product.get("reservNthPPPerc") != null)     newItem.setReservNthPPPerc(product.getDouble("reservNthPPPerc").doubleValue());
    String isAvailable=checkAvailability(product.getString("productId"),quantity,reservStart,reservLength,cart);
    if (isAvailable.compareTo("OK") != 0) {
      Map messageMap=UtilMisc.toMap("productId",product.getString("productId"),"availableMessage",isAvailable);
      String excMsg=UtilProperties.getMessage(resource,"item.product_not_available",messageMap,cart.getLocale());
      Debug.logInfo(excMsg,module);
      throw new CartItemModifyException(isAvailable);
    }
  }
  if ("AGGREGATED".equals(product.getString("productTypeId"))) {
    if (configWrapper == null || !configWrapper.isCompleted()) {
      Map messageMap=UtilMisc.toMap("productName",product.getString("productName"),"productId",product.getString("productId"));
      String excMsg=UtilProperties.getMessage(resource,"item.cannot_add_product_not_configured_correctly",messageMap,cart.getLocale());
      Debug.logWarning(excMsg,module);
      throw new CartItemModifyException(excMsg);
    }
  }
  newItem.setShipBeforeDate(shipBeforeDate != null ? shipBeforeDate : cart.getDefaultShipBeforeDate());
  newItem.setShipAfterDate(shipAfterDate != null ? shipAfterDate : cart.getDefaultShipAfterDate());
  newItem.setBasePrice(unitPrice);
  if (cartLocation == null) {
    cart.addItemToEnd(newItem);
  }
 else {
    cart.addItem(cartLocation.intValue(),newItem);
  }
  if (selectedAmount > 0) {
    newItem.setSelectedAmount(selectedAmount);
  }
  try {
    newItem.setQuantity(quantity,dispatcher,cart,triggerExternalOps,true,triggerPriceRules);
  }
 catch (  CartItemModifyException e) {
    Debug.logWarning(e.getMessage(),module);
    cart.removeCartItem(cart.getItemIndex(newItem),dispatcher);
    cart.clearItemShipInfo(newItem);
    cart.removeEmptyCartItems();
    throw e;
  }
  return newItem;
}
