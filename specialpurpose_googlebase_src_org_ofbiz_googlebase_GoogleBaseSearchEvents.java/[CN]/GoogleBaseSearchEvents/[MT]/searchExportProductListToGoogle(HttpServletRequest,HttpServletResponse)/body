{
  LocalDispatcher dispatcher=(LocalDispatcher)request.getAttribute("dispatcher");
  Locale locale=UtilHttp.getLocale(request);
  GenericValue userLogin=(GenericValue)request.getSession().getAttribute("userLogin");
  String selectResult=request.getParameter("selectResult");
  List<String> productExportList=FastList.newInstance();
  String errMsg=null;
  try {
    boolean beganTransaction=TransactionUtil.begin(DEFAULT_TX_TIMEOUT);
    try {
      if (UtilValidate.isEmpty(selectResult)) {
        EntityListIterator eli=ProductSearchEvents.getProductSearchResults(request);
        if (eli == null) {
          errMsg=UtilProperties.getMessage(resource,"googlebasesearchevents.no_results_found_probably_error_constraints",UtilHttp.getLocale(request));
          Debug.logError(errMsg,module);
          request.setAttribute("_ERROR_MESSAGE_",errMsg);
          return "error";
        }
        GenericValue searchResultView=null;
        while ((searchResultView=eli.next()) != null) {
          productExportList.add(searchResultView.getString("mainProductId"));
        }
        eli.close();
      }
 else {
        if (selectResult.startsWith("[")) {
          productExportList=StringUtil.toList(selectResult);
        }
 else {
          if (!selectResult.startsWith("{")) {
            productExportList.add(selectResult);
          }
 else {
            List<String> listTemp=FastList.newInstance();
            String temp=selectResult.substring(1,selectResult.length() - 1);
            String arrayTemp[]=temp.split(",");
            for (int i=0; i < arrayTemp.length; i++) {
              listTemp.add(arrayTemp[i].trim());
            }
            productExportList=listTemp;
          }
        }
      }
      String webSiteUrl=request.getParameter("webSiteUrl");
      String imageUrl=request.getParameter("imageUrl");
      String actionType=request.getParameter("actionType");
      String statusId=request.getParameter("statusId");
      String testMode=request.getParameter("testMode");
      String trackingCodeId=request.getParameter("trackingCodeId");
      String webSiteMountPoint=request.getParameter("webSiteMountPoint");
      String countryCode=request.getParameter("countryCode");
      String productStoreId=request.getParameter("productStoreId");
      String allowRecommended=request.getParameter("allowRecommended");
      try {
        Map<String,Object> inMap=UtilMisc.toMap("selectResult",productExportList,"webSiteUrl",webSiteUrl,"imageUrl",imageUrl,"actionType",actionType,"statusId",statusId,"testMode",testMode,"webSiteMountPoint",webSiteMountPoint,"countryCode",countryCode);
        inMap.put("trackingCodeId",trackingCodeId);
        inMap.put("userLogin",userLogin);
        inMap.put("productStoreId",productStoreId);
        inMap.put("allowRecommended",allowRecommended);
        Map<String,Object> exportResult=dispatcher.runSync("exportToGoogle",inMap);
        if (ServiceUtil.isError(exportResult)) {
          List<String> errorMessages=UtilGenerics.checkList(exportResult.get(ModelService.ERROR_MESSAGE_LIST),String.class);
          if (UtilValidate.isNotEmpty(errorMessages)) {
            request.setAttribute("_ERROR_MESSAGE_LIST_",errorMessages);
          }
 else {
            request.setAttribute("_ERROR_MESSAGE_",ServiceUtil.getErrorMessage(exportResult));
          }
          return "error";
        }
 else         if (ServiceUtil.isFailure(exportResult)) {
          List<String> eventMessages=UtilGenerics.checkList(exportResult.get(ModelService.ERROR_MESSAGE_LIST),String.class);
          if (UtilValidate.isNotEmpty(eventMessages)) {
            request.setAttribute("_ERROR_MESSAGE_LIST_",eventMessages);
          }
 else {
            request.setAttribute("_ERROR_MESSAGE_",ServiceUtil.getErrorMessage(exportResult));
          }
          return "error";
        }
 else {
          request.setAttribute("_EVENT_MESSAGE_",exportResult.get("responseMessage"));
        }
      }
 catch (      GenericServiceException e) {
        errMsg=UtilProperties.getMessage(resource,"googlebasesearchevents.exceptionCallingExportToGoogle",locale);
        Debug.logError(e,errMsg,module);
        request.setAttribute("_ERROR_MESSAGE_",errMsg);
        return "error";
      }
    }
 catch (    GenericEntityException e) {
      errMsg=UtilProperties.getMessage(resource,"googlebasesearchevents.error_getting_search_results",locale);
      Debug.logError(e,errMsg,module);
      request.setAttribute("_ERROR_MESSAGE_",errMsg);
      return "error";
    }
 finally {
      TransactionUtil.commit(beganTransaction);
    }
  }
 catch (  GenericTransactionException e) {
    errMsg=UtilProperties.getMessage(resource,"googlebasesearchevents.error_getting_search_results",locale);
    Debug.logError(e,errMsg,module);
    request.setAttribute("_ERROR_MESSAGE_",errMsg);
    return "error";
  }
  return "success";
}
